name: Factory Ops with Artifacts & Dashboard

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  factory-ops-complete:
    runs-on: ubuntu-latest
    
    steps:
    # ------------------------------------------------------------------
    # [1ë‹¨ê³„] ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
    # ------------------------------------------------------------------
    - name: ğŸ§¹ Free Disk Space
      run: |
        echo "::group::Disk Cleanup"
        echo "START_DISK=$(df -h / | awk 'NR==2 {print $4}')" >> $GITHUB_ENV
        
        sudo rm -rf /usr/local/lib/android # Android SDK
        sudo rm -rf /opt/ghc               # Haskell
        sudo rm -rf /usr/share/swift       # Swift
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker system prune -af
        sudo apt-get clean
        
        echo "CLEANED_DISK=$(df -h / | awk 'NR==2 {print $4}')" >> $GITHUB_ENV
        mkdir -p _dist_artifacts # ê²°ê³¼ë¬¼ì„ ëª¨ì„ ì„ì‹œ í´ë” ìƒì„±
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # [2ë‹¨ê³„] í™˜ê²½ ì„¤ì •
    # ------------------------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    # ------------------------------------------------------------------
    # [3ë‹¨ê³„] ğŸ¶ Watchdog (ìì› ê°ì‹œ)
    # ------------------------------------------------------------------
    - name: ğŸ¶ Start Watchdog
      run: |
        cat << 'EOF' > watchdog.sh
        #!/bin/bash
        while true; do
          DISK_AVAIL=$(df -k . | awk 'NR==2 {print $4}')
          if [ "$DISK_AVAIL" -lt 500000 ]; then
             echo "ğŸš¨ Low Disk Space: ${DISK_AVAIL} KB" >> watchdog_alerts.log
          fi
          sleep 10
        done
        EOF
        chmod +x watchdog.sh
        ./watchdog.sh &

    # ------------------------------------------------------------------
    # [4ë‹¨ê³„] ëŒ€ëŸ‰ ë¹Œë“œ ë° ê²°ê³¼ë¬¼ ì¶”ì¶œ (í•µì‹¬ ë³€ê²½ ì‚¬í•­)
    # ------------------------------------------------------------------
    - name: ğŸ­ Build, Harvest & Clean
      id: build_process
      run: |
        echo "Service|Status|Duration|Artifact" > build_results.txt
        GLOBAL_EXIT_CODE=0
        
        # í˜„ì¬ ìœ„ì¹˜(_dist_artifacts ì œì™¸)ì˜ í´ë”ë§Œ ìˆœíšŒ
        find . -maxdepth 1 -type d -not -path '*/.*' -not -path '.' -not -name '_dist_artifacts' | while read service_dir; do
          SERVICE_NAME=$(basename "$service_dir")
          START_TIME=$(date +%s)
          BUILD_STATUS="SUCCESS"
          ARTIFACT_MSG="-"
          
          echo "::group::ğŸ”¨ Processing: $SERVICE_NAME"
          cd "$service_dir"
          
          # --- [A] ë¹Œë“œ ì‹¤í–‰ ---
          if [ -f "pom.xml" ]; then
            mvn clean package -DskipTests || BUILD_STATUS="FAILED"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            chmod +x gradlew || true
            ./gradlew clean build -x test || BUILD_STATUS="FAILED"
          elif [ -f *.csproj ] || ls *.csproj 1> /dev/null 2>&1; then
            dotnet restore && dotnet build -c Release || BUILD_STATUS="FAILED"
          elif [ -f "Makefile" ]; then
            make || BUILD_STATUS="FAILED"
          elif [ -f "run.sh" ]; then
            chmod +x run.sh
            ./run.sh || BUILD_STATUS="FAILED"
          else
            BUILD_STATUS="SKIPPED"
          fi
          
          # --- [B] ê²°ê³¼ë¬¼(Artifact) ì¶”ì¶œ ë° ì´ë™ ---
          if [ "$BUILD_STATUS" == "SUCCESS" ]; then
            mkdir -p ../_dist_artifacts/$SERVICE_NAME
            
            # 1. Java (.jar, .war)
            find target build/libs -name "*.jar" -o -name "*.war" 2>/dev/null | xargs -I {} cp {} ../_dist_artifacts/$SERVICE_NAME/
            
            # 2. .NET (.dll, .exe) - Release í´ë” ìœ„ì£¼
            find bin/Release -name "*.dll" -o -name "*.exe" 2>/dev/null | grep -v "ref/" | xargs -I {} cp {} ../_dist_artifacts/$SERVICE_NAME/
            
            # 3. General Binaries (í™•ì¥ì ì—†ëŠ” ì‹¤í–‰ íŒŒì¼ ë“±) - í•„ìš” ì‹œ ë¡œì§ ì¶”ê°€
            
            # ê²°ê³¼ë¬¼ ê°œìˆ˜ í™•ì¸
            FILE_COUNT=$(ls ../_dist_artifacts/$SERVICE_NAME/ | wc -l)
            if [ "$FILE_COUNT" -gt 0 ]; then
               ARTIFACT_MSG="ğŸ“¦ Saved ($FILE_COUNT files)"
            else
               ARTIFACT_MSG="âš ï¸ No Output Found"
            fi
          else
            ARTIFACT_MSG="âŒ Build Failed"
          fi

          # --- [C] ê³µê°„ í™•ë³´ë¥¼ ìœ„í•œ ì¦‰ì‹œ ì²­ì†Œ (Clean) ---
          # ê²°ê³¼ë¬¼ì„ ì•ˆì „í•œ _dist_artifactsë¡œ ì˜®ê²¼ìœ¼ë¯€ë¡œ ì›ë³¸ ë¹Œë“œ í´ë”ëŠ” ê³¼ê°íˆ ì‚­ì œ
          rm -rf target build bin obj
          
          cd ..
          
          # --- [D] ê¸°ë¡ ---
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          # ì•„ì´ì½˜ ì„¤ì •
          if [ "$BUILD_STATUS" == "SUCCESS" ]; then ICON="âœ…"; elif [ "$BUILD_STATUS" == "SKIPPED" ]; then ICON="âš ï¸"; else ICON="âŒ"; fi
          
          echo "$SERVICE_NAME|$BUILD_STATUS|${DURATION}s|$ARTIFACT_MSG" >> build_results.txt
          echo "::endgroup::"
          
          if [ "$BUILD_STATUS" == "FAILED" ]; then GLOBAL_EXIT_CODE=1; fi
        done
        
        if [ $GLOBAL_EXIT_CODE -ne 0 ]; then echo "BUILD_HAS_FAILURES=true" >> $GITHUB_ENV; fi

    # ------------------------------------------------------------------
    # [5ë‹¨ê³„] ì¶”ì¶œí•œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (GitHub Artifacts)
    # ------------------------------------------------------------------
    - name: ğŸ“¤ Upload All Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: factory-ops-build-outputs
        path: _dist_artifacts/
        retention-days: 3 # ìš©ëŸ‰ ê´€ë¦¬ ìœ„í•´ 3ì¼ë§Œ ë³´ê´€

    # ------------------------------------------------------------------
    # [6ë‹¨ê³„] ëŒ€ì‹œë³´ë“œ ìƒì„±
    # ------------------------------------------------------------------
    - name: ğŸ“ˆ Generate Dashboard
      if: always()
      run: |
        echo "# ğŸ­ Factory Ops Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“… Run ID: $GITHUB_RUN_ID" >> $GITHUB_STEP_SUMMARY
        
        # ì‹œìŠ¤í…œ ìƒíƒœ
        echo "## ğŸ–¥ï¸ System Stats" >> $GITHUB_STEP_SUMMARY
        CURRENT_DISK=$(df -h / | awk 'NR==2 {print $4}')
        echo "- **Start Disk:** $START_DISK / **Cleaned:** $CLEANED_DISK / **End:** $CURRENT_DISK" >> $GITHUB_STEP_SUMMARY
        if [ -f watchdog_alerts.log ]; then echo "- ğŸ”´ **Watchdog Alerts Found**" >> $GITHUB_STEP_SUMMARY; else echo "- ğŸŸ¢ **System Stable**" >> $GITHUB_STEP_SUMMARY; fi

        # ë¹Œë“œ ê²°ê³¼ í…Œì´ë¸”
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ—ï¸ Build & Artifact Report" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status | Time | Artifacts |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
        
        tail -n +2 build_results.txt | while IFS='|' read -r service status duration artifact; do
          if [ "$status" == "SUCCESS" ]; then ICON="âœ…"; elif [ "$status" == "SKIPPED" ]; then ICON="âš ï¸"; else ICON="âŒ"; fi
          echo "| **$service** | $ICON $status | $duration | $artifact |" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> Artifacts are available in the 'Summary' tab under 'Artifacts'." >> $GITHUB_STEP_SUMMARY

    - name: Check Final Status
      if: env.BUILD_HAS_FAILURES == 'true'
      run: exit 1
