name: üåç Galaxy Ops:Global Command (Cache-Free)

on:
  schedule:
    - cron: '*/5 * * * *' # 5Î∂ÑÎßàÎã§ Í∞±Ïã† (ÏµúÎåÄ ÎπàÎèÑ)
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "galaxy-ops-final"
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Setup Python
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }

    - name: üì¶ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] üè≠ Îç∞Ïù¥ÌÑ∞ ÏóîÏßÑ (ÏßÄÏó≠ Ï†ïÎ≥¥ Î∞è Ï¢åÌëú Ï∂îÍ∞Ä)
    # ----------------------------------------------------------------
    - name: üè≠ Run Global Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, datetime
        from faker import Faker
        fake = Faker()
        
        NODE_COUNT = 100
        
        # ÏßÄÏó≠Î≥Ñ Ï¢åÌëú Î∞è ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï†ïÏùò
        REGIONS = {
            "US-EAST": {"lat": 30, "lon": 20, "code": "USE"},
            "EU-WEST": {"lat": 30, "lon": 50, "code": "EUW"},
            "AP-NORT": {"lat": 35, "lon": 80, "code": "APN"},
            "SA-EAST": {"lat": 70, "lon": 25, "code": "SAE"}
        }
        
        TECH_STACK = {
            "PAYMENT": { "db": "PostgreSQL", "store": "Block-NVMe" },
            "AUTH":    { "db": "Redis-Cluster", "store": "Mem-Only" },
            "AI":      { "db": "Vector-DB", "store": "Obj-Store" },
            "CDN":     { "db": "Edge-KV", "store": "SSD-Raid" }
        }

        def gen_nodes():
            nodes = []
            for i in range(NODE_COUNT):
                r_key = random.choice(list(REGIONS.keys()))
                region = REGIONS[r_key]
                svc = random.choice(list(TECH_STACK.keys()))
                
                # Ï¢åÌëú ÎØ∏ÏÑ∏ Ï°∞Ï†ï (Íµ∞Ïßë Ìö®Í≥º)
                lat = region['lat'] + random.randint(-5, 5)
                lon = region['lon'] + random.randint(-5, 5)
                
                nodes.append({
                    "id": f"{svc}-{region['code']}-{i:03d}",
                    "type": svc,
                    "region": r_key,
                    "pos": {"top": f"{lat}%", "left": f"{lon}%"},
                    "status": "ACTIVE" if random.random() > 0.1 else "CRITICAL",
                    "tech": TECH_STACK[svc],
                    "metrics": {
                        "cpu": random.randint(5, 90),
                        "tps": random.randint(100, 5000),
                        "latency": random.randint(10, 200)
                    },
                    "tokens": [fake.sha256()[:8] for _ in range(3)]
                })
            
            return {
                "generated_at": datetime.datetime.now().isoformat(),
                "nodes": nodes
            }

        if __name__ == "__main__":
            data = gen_nodes()
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f, indent=2)
            print("‚úÖ Global Data Generated.")
        EOF
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] Îç∞Ïù¥ÌÑ∞ Ïª§Î∞ã (Ï†ÄÏû•ÏÜå Î∞òÏòÅ)
    # ----------------------------------------------------------------
    - name: üíæ Commit Data
      run: |
        git config --global user.name "Ops-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "üåç Global Ops Update [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped"

    # ----------------------------------------------------------------
    # [Step 3] ÌîÑÎ°†Ìä∏ÏóîÎìú (Cache Busting & Map)
    # ----------------------------------------------------------------
    - name: üé® Build Command Center
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
            <meta http-equiv="Pragma" content="no-cache">
            <meta http-equiv="Expires" content="0">
            
            <title>GALAXY COMMAND</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                body { background-color: #020617; color: #94a3b8; font-family: 'Courier New', monospace; overflow: hidden; }
                
                /* Grid Layout */
                .layout { display: grid; grid-template-rows: 60px 1fr 200px 30px; height: 100vh; }
                
                /* Map Area */
                .map-container { position: relative; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 80%); overflow: hidden; border-bottom: 1px solid #334155; }
                .map-grid { 
                    position: absolute; width: 100%; height: 100%; 
                    background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px);
                    background-size: 40px 40px; opacity: 0.1;
                }
                .node-point { 
                    position: absolute; width: 8px; height: 8px; border-radius: 50%; 
                    background: #3b82f6; box-shadow: 0 0 10px #3b82f6; cursor: pointer; transition: all 0.3s; 
                }
                .node-point:hover { transform: scale(2); z-index: 100; background: #fff; }
                .node-point.crit { background: #ef4444; box-shadow: 0 0 15px #ef4444; animation: pulse 1s infinite; }
                
                /* Server List Area */
                .server-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 4px; padding: 10px; overflow-y: auto; background: #0f172a; }
                .card { background: #1e293b; padding: 8px; border: 1px solid #334155; font-size: 10px; cursor: pointer; }
                .card:hover { border-color: #60a5fa; background: #334155; }
                
                /* Animations */
                @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
                
                /* DR Mode */
                body.dr-mode { border: 4px solid #ef4444; }
                body.dr-mode .map-container { filter: sepia(1) hue-rotate(-50deg) saturate(3); }
            </style>
        </head>
        <body class="layout">
            
            <header class="flex justify-between items-center px-6 bg-slate-950 border-b border-slate-800">
                <div class="flex items-center gap-4">
                    <i class="fas fa-globe-americas text-2xl text-blue-600"></i>
                    <div>
                        <h1 class="text-xl font-bold text-white tracking-widest">GLOBAL <span class="text-blue-500">COMMAND</span></h1>
                        <div class="text-[10px]">SYNC: <span id="sync-time" class="text-green-400">CONNECTING...</span></div>
                    </div>
                </div>
                <div class="flex gap-4 items-center">
                    <button onclick="toggleDR()" class="border border-red-900 bg-red-900/20 text-red-500 px-4 py-2 hover:bg-red-900 hover:text-white transition font-bold text-xs rounded">
                        <i class="fas fa-biohazard mr-2"></i> DR MODE
                    </button>
                    <button onclick="forceRefresh()" class="border border-blue-900 bg-blue-900/20 text-blue-500 px-4 py-2 hover:bg-blue-900 hover:text-white transition font-bold text-xs rounded">
                        <i class="fas fa-sync mr-2"></i> REFRESH DATA
                    </button>
                </div>
            </header>

            <div class="map-container" id="world-map">
                <div class="map-grid"></div>
                <div class="absolute top-4 left-4 text-xs text-slate-500 font-mono">
                    <div>> USEAST CLUSTER: ONLINE</div>
                    <div>> EUWEST CLUSTER: ONLINE</div>
                    <div>> APNORT CLUSTER: DEGRADED</div>
                </div>
            </div>

            <div class="server-list custom-scroll" id="grid-list">
                </div>

            <footer class="bg-black border-t border-slate-800 flex items-center px-4 text-[10px] font-mono text-slate-500">
                <span class="mr-2 text-green-500">root@global-ops:~#</span>
                <span id="term-log">tail -f /var/log/syslog</span>
            </footer>

            <script>
                let nodes = [];
                let drMode = false;

                async function init() {
                    await loadData();
                    // Auto-refresh data every 60s (without page reload)
                    setInterval(loadData, 60000);
                    // Live Physics
                    setInterval(updatePhysics, 1000);
                }

                // [ÌïµÏã¨] Cache Busting Fetcher
                async function loadData() {
                    const statusEl = document.getElementById('sync-time');
                    statusEl.innerText = "FETCHING...";
                    
                    try {
                        // URL ÎÅùÏóê ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ(?v=...)Î•º Î∂ôÏó¨ÏÑú Ï∫êÏãú Î¨¥Ïãú
                        const res = await fetch('dashboard_data.json?v=' + Date.now());
                        if(!res.ok) throw new Error("Network error");
                        
                        const data = await res.json();
                        nodes = data.nodes;
                        
                        renderMap();
                        renderList();
                        
                        const genTime = new Date(data.generated_at);
                        const now = new Date();
                        const diff = Math.floor((now - genTime) / 1000);
                        statusEl.innerText = `UPDATED ${diff}s AGO`;
                        statusEl.classList.replace('text-red-500', 'text-green-400');
                        
                    } catch(e) {
                        console.error(e);
                        // Fallback (Îπà ÌôîÎ©¥ Î∞©ÏßÄ)
                        if(nodes.length === 0) generateFallback();
                        statusEl.innerText = "OFFLINE MODE (LOCAL DATA)";
                        statusEl.classList.replace('text-green-400', 'text-red-500');
                    }
                }

                function generateFallback() {
                    nodes = Array.from({length: 50}, (_, i) => ({
                        id: `LOCAL-${i}`, type: "FALLBACK", region: "US-EAST", status: "ACTIVE",
                        pos: { top: Math.random()*80+10+"%", left: Math.random()*80+10+"%" },
                        tech: { db: "LocalDB" }, metrics: { cpu: 50, tps: 100 }
                    }));
                    renderMap();
                    renderList();
                }

                function renderMap() {
                    const map = document.getElementById('world-map');
                    // Keep grid, remove nodes
                    const grid = map.querySelector('.map-grid');
                    map.innerHTML = ''; 
                    map.appendChild(grid); 

                    nodes.forEach((n, i) => {
                        const el = document.createElement('div');
                        el.className = `node-point ${n.status === 'CRITICAL' ? 'crit' : ''}`;
                        el.style.top = n.pos.top;
                        el.style.left = n.pos.left;
                        el.title = `${n.id} [${n.status}]`;
                        el.onclick = () => alert(`Node: ${n.id}\nDB: ${n.tech.db}\nCPU: ${n.metrics.cpu}%`);
                        map.appendChild(el);
                    });
                }

                function renderList() {
                    const list = document.getElementById('grid-list');
                    list.innerHTML = nodes.map(n => `
                        <div class="card ${n.status === 'CRITICAL' ? 'border-red-500' : ''}">
                            <div class="flex justify-between font-bold text-white mb-1">
                                <span>${n.id}</span>
                                <span class="${n.status==='CRITICAL'?'text-red-500':'text-green-500'}">‚óè</span>
                            </div>
                            <div class="text-slate-400">${n.tech.db}</div>
                            <div class="flex justify-between mt-2 text-slate-500">
                                <span>CPU: <span id="cpu-${n.id}">${n.metrics.cpu}%</span></span>
                                <span>TPS: ${n.metrics.tps}</span>
                            </div>
                        </div>
                    `).join('');
                }

                function updatePhysics() {
                    nodes.forEach(n => {
                        // Live Jitter
                        n.metrics.cpu = Math.max(0, Math.min(100, n.metrics.cpu + Math.floor(Math.random()*5-2)));
                        const el = document.getElementById(`cpu-${n.id}`);
                        if(el) el.innerText = n.metrics.cpu + "%";
                    });
                    
                    // Random Logs
                    if(Math.random() > 0.9) {
                        const logs = ["Syncing replica...", "Health check OK", "Auth token refreshed", "Packet loss detected"];
                        const logEl = document.getElementById('term-log');
                        logEl.innerText = `> ${logs[Math.floor(Math.random()*logs.length)]} [${new Date().toLocaleTimeString()}]`;
                    }
                }

                window.forceRefresh = function() {
                    loadData();
                }

                window.toggleDR = function() {
                    drMode = !drMode;
                    if(drMode) {
                        document.body.classList.add('dr-mode');
                        alert("‚ö†Ô∏è DISASTER RECOVERY PROTOCOL INITIATED ‚ö†Ô∏è\nRerouting global traffic...");
                    } else {
                        document.body.classList.remove('dr-mode');
                    }
                }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: üöÄ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with: { path: _site/ }

  deploy:
    needs: build-deploy
    permissions: { pages: write, id-token: write }
    environment: { name: github-pages, url: ${{ steps.deployment.outputs.page_url }} }
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
