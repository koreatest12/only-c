name: ğŸŒŒ Galaxy Ops:Reboot & Tokenize

on:
  schedule:
    - cron: '*/10 * * * *' # 10ë¶„ë§ˆë‹¤ ì¸í”„ë¼ ìŠ¤ëƒ…ìƒ· ê°±ì‹ 
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "galaxy-ops-token"
  cancel-in-progress: true

jobs:
  build-simulate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“¥ Checkout Repo
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] ğŸ­ ì¸í”„ë¼ ì—”ì§„ (ì„œë¹„ìŠ¤ë³„ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ë° í† í° ìƒì„±)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Provisioning Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, uuid, hashlib
        from datetime import datetime
        from faker import Faker
        fake = Faker()
        
        NODE_COUNT = 100
        
        # ì„œë¹„ìŠ¤ë³„ ì„¤ì¹˜ ë¡œê·¸ íŒ¨í„´ ì •ì˜
        SERVICES = {
            "PAYMENT": {
                "icon": "ğŸ’³", 
                "pkg": ["libssl-dev", "payment-gateway-v4", "fraud-detection-daemon"],
                "logs": ["Verifying PCI-DSS compliance...", "Mounting secure ledger volume...", "Opening port 443 for transactions..."]
            },
            "AUTH": {
                "icon": "ğŸ”", 
                "pkg": ["oauth2-proxy", "keycloak-server", "jwt-signer"],
                "logs": ["Generating RSA-4096 keys...", "Syncing LDAP users...", "Flushing expired sessions..."]
            },
            "AI-CORE": {
                "icon": "ğŸ§ ", 
                "pkg": ["nvidia-cuda-toolkit", "pytorch-lightning", "huggingface-cli"],
                "logs": ["Allocating VRAM pages...", "Loading LoRA adapters...", "Warming up Tensor Cores..."]
            },
            "DELIVERY": {
                "icon": "ğŸšš", 
                "pkg": ["geo-spatial-db", "route-optimizer", "mqtt-broker"],
                "logs": ["Calibrating GPS grid...", "Connecting to logistics fleet...", "Optimizing pathfinding graph..."]
            }
        }
        
        CLUSTERS = ["Alpha-Centauri", "Nebula-Edge", "Sirius-Main", "Orion-Backup"]

        def gen_token_batch():
            # ëŒ€ëŸ‰ í† í° ì‹œë®¬ë ˆì´ì…˜ (ìƒ˜í”Œë§)
            return [hashlib.sha256(str(uuid.uuid4()).encode()).hexdigest()[:16] for _ in range(5)]

        def gen_fleet():
            nodes = []
            
            for i in range(NODE_COUNT):
                svc_type = random.choice(list(SERVICES.keys()))
                svc_info = SERVICES[svc_type]
                cluster = random.choice(CLUSTERS)
                
                # ìŠ¤í™ ìƒì„±
                is_heavy = svc_type == "AI-CORE"
                cpu = random.randint(10, 90)
                mem = random.randint(20, 80)
                temp = random.randint(40, 85)
                
                # ëŒ€ëŸ‰ í† í° ì¹´ìš´íŠ¸ (ìˆ˜ì²œ ~ ìˆ˜ë§Œ ê°œ)
                token_count = random.randint(5000, 99999)
                
                nodes.append({
                    "id": f"{svc_type}-{cluster}-{i:03d}",
                    "type": svc_type,
                    "icon": svc_info['icon'],
                    "cluster": cluster,
                    "status": "ACTIVE",
                    "install_logs": svc_info['logs'], # ì¬ë¶€íŒ… ì‹œ ì‚¬ìš©í•  ë¡œê·¸
                    "packages": svc_info['pkg'],
                    "metrics": {
                        "cpu": cpu, "mem": mem, "temp": temp,
                        "token_count": token_count,
                        "token_samples": gen_token_batch()
                    }
                })
            
            return {
                "timestamp": str(datetime.now()),
                "summary": {"total": NODE_COUNT, "tokens_global": sum(n['metrics']['token_count'] for n in nodes)},
                "nodes": nodes
            }

        if __name__ == "__main__":
            data = gen_fleet()
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f, indent=2)
            print(f"âœ… Provisioned {NODE_COUNT} nodes with Service Packs.")
        EOF
        
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] ë°ì´í„° ì €ì¥
    # ----------------------------------------------------------------
    - name: ğŸ’¾ Commit Data
      run: |
        git config --global user.name "Ops-Master"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "ğŸŒŒ Infra Scale-up [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped"

    # ----------------------------------------------------------------
    # [Step 3] í”„ë¡ íŠ¸ì—”ë“œ (ì¬ë¶€íŒ… ì‹œë®¬ë ˆì´í„° & í† í° ìŠ¤íŠ¸ë¦¼ íƒ‘ì¬)
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Command Center
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>GALAXY OPS CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                body { background-color: #030712; color: #e5e7eb; font-family: 'Courier New', monospace; overflow: hidden; }
                
                /* Grid Layout */
                .main-layout { display: grid; grid-template-rows: 60px 1fr 30px; height: 100vh; }
                .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 8px; padding: 8px; overflow-y: auto; }
                
                /* Card Styling */
                .card { background: #111827; border: 1px solid #1f2937; padding: 12px; position: relative; transition: all 0.3s; }
                .card:hover { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); z-index: 10; transform: scale(1.01); }
                
                /* Rebooting State Style */
                .card.rebooting { background: #000; border-color: #f59e0b; color: #f59e0b; }
                .card.rebooting .normal-view { display: none; }
                .card.rebooting .boot-view { display: block; }
                
                /* Views */
                .boot-view { display: none; font-size: 10px; line-height: 1.4; height: 100%; overflow: hidden; }
                .boot-line { animation: type 0.1s; }
                
                /* Token Stream Animation */
                .token-stream { font-size: 9px; color: #10b981; opacity: 0.7; white-space: nowrap; overflow: hidden; }
                
                /* Scrollbar */
                ::-webkit-scrollbar { width: 6px; }
                ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
            </style>
        </head>
        <body class="main-layout">
            
            <header class="flex items-center justify-between px-6 bg-gray-900 border-b border-gray-800">
                <div class="flex items-center gap-4">
                    <span class="text-2xl animate-spin-slow">ğŸª</span>
                    <h1 class="text-xl font-bold tracking-[0.2em] text-white">GALAXY <span class="text-blue-500">OPS</span></h1>
                </div>
                <div class="flex gap-6 text-xs">
                    <div>GLOBAL TOKENS: <span id="gl-tokens" class="text-green-400 font-bold text-lg">0</span></div>
                    <div>ACTIVE NODES: <span id="gl-nodes" class="text-blue-400 font-bold text-lg">0</span></div>
                </div>
            </header>

            <div id="grid" class="card-grid custom-scroll">
                </div>

            <div class="bg-black border-t border-gray-800 flex items-center px-4 text-[10px] text-gray-500">
                <span class="mr-2">SYSTEM:</span>
                <span id="sys-log">Monitoring Galaxy Cluster...</span>
            </div>

            <script>
                // Fallback Data
                const FALLBACK = {
                    "nodes": Array.from({length:12}, (_,i) => ({
                        id: `FALLBACK-${i}`, type: "AUTH", icon: "ğŸ”", status: "ACTIVE", install_logs: ["Loading..."],
                        metrics: {cpu:50, mem:50, temp:40, token_count: 12345, token_samples: ["a1b2c3d4", "e5f6g7h8"]}
                    }))
                };

                let nodes = [];

                async function init() {
                    try {
                        const res = await fetch('dashboard_data.json');
                        if(!res.ok) throw new Error("Load fail");
                        const data = await res.json();
                        nodes = data.nodes;
                    } catch(e) {
                        nodes = FALLBACK.nodes;
                    }
                    
                    renderGrid();
                    updateGlobalStats();
                    setInterval(updatePhysics, 1000); // 1ì´ˆë§ˆë‹¤ ìˆ˜ì¹˜ ë³€ë™
                }

                function renderGrid() {
                    const grid = document.getElementById('grid');
                    grid.innerHTML = nodes.map((n, i) => `
                        <div class="card" id="card-${i}">
                            <div class="normal-view h-full flex flex-col justify-between">
                                <div>
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-bold text-white text-sm">${n.icon} ${n.id}</div>
                                            <div class="text-[10px] text-gray-500">${n.type} SERVER</div>
                                        </div>
                                        <div class="px-2 py-0.5 rounded bg-green-900/30 text-green-400 text-[10px] border border-green-800" id="status-${i}">
                                            ACTIVE
                                        </div>
                                    </div>
                                    
                                    <div class="bg-black/50 p-2 rounded border border-gray-800 mb-3">
                                        <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                            <span>ACTIVE TOKENS</span>
                                            <span class="text-green-400 font-mono" id="tok-cnt-${i}">${n.metrics.token_count.toLocaleString()}</span>
                                        </div>
                                        <div class="token-stream font-mono" id="tok-stream-${i}">
                                            ${n.metrics.token_samples.join(' ')}
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-3 gap-2 text-center text-[10px] mb-2">
                                        <div class="bg-gray-800/50 p-1 rounded">
                                            <div class="text-gray-500">CPU</div>
                                            <div class="text-white font-bold" id="cpu-${i}">${n.metrics.cpu}%</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-1 rounded">
                                            <div class="text-gray-500">MEM</div>
                                            <div class="text-white font-bold" id="mem-${i}">${n.metrics.mem}%</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-1 rounded">
                                            <div class="text-gray-500">TEMP</div>
                                            <div class="text-white font-bold" id="temp-${i}">${n.metrics.temp}Â°C</div>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="triggerReboot(${i})" class="w-full py-1 text-[10px] bg-red-900/20 hover:bg-red-600 border border-red-900/50 hover:text-white text-red-400 transition rounded flex items-center justify-center gap-1">
                                    <span>â†º</span> SYSTEM REBOOT
                                </button>
                            </div>

                            <div class="boot-view font-mono text-green-500 p-1" id="boot-term-${i}">
                                <div class="text-yellow-500 mb-1">> INITIATING REBOOT SEQUENCE...</div>
                            </div>
                        </div>
                    `).join('');
                }

                function updateGlobalStats() {
                    const totalTokens = nodes.reduce((acc, n) => acc + n.metrics.token_count, 0);
                    document.getElementById('gl-tokens').innerText = totalTokens.toLocaleString();
                    document.getElementById('gl-nodes').innerText = nodes.length;
                }

                // [í•µì‹¬ ê¸°ëŠ¥] ì„œë²„ ì¬ê¸°ë™ ì‹œë®¬ë ˆì´ì…˜
                window.triggerReboot = function(idx) {
                    const card = document.getElementById(`card-${idx}`);
                    const term = document.getElementById(`boot-term-${idx}`);
                    const node = nodes[idx];
                    
                    if(card.classList.contains('rebooting')) return;
                    
                    // UI ìƒíƒœ ì „í™˜
                    card.classList.add('rebooting');
                    term.innerHTML = `<div class="text-yellow-500">> SIGTERM received. Stopping services...</div>`;
                    
                    // ë¶€íŒ… ë¡œê·¸ ì‹œí€€ìŠ¤ (ì„¤ì¹˜ ê³¼ì • ì‹œë®¬ë ˆì´ì…˜)
                    const steps = [
                        ...node.install_logs, // Pythonì—ì„œ ì •ì˜í•œ ì„œë¹„ìŠ¤ë³„ ë¡œê·¸
                        "Cleaning up cache...",
                        "Verifying package integrity...",
                        "Generating new access tokens...",
                        "Starting system daemon... OK"
                    ];
                    
                    let stepIdx = 0;
                    const bootInterval = setInterval(() => {
                        if(stepIdx >= steps.length) {
                            // ë¶€íŒ… ì™„ë£Œ
                            clearInterval(bootInterval);
                            setTimeout(() => {
                                card.classList.remove('rebooting');
                                // í† í° ìˆ˜ì¹˜ ë¦¬ì…‹ íš¨ê³¼
                                node.metrics.token_count += Math.floor(Math.random() * 1000);
                                document.getElementById(`tok-cnt-${idx}`).innerText = node.metrics.token_count.toLocaleString();
                            }, 800);
                        } else {
                            // ë¡œê·¸ ì¶œë ¥
                            const line = document.createElement('div');
                            line.className = 'boot-line';
                            line.innerText = `> ${steps[stepIdx]}`;
                            term.appendChild(line);
                            term.scrollTop = term.scrollHeight; // Auto scroll
                            stepIdx++;
                        }
                    }, 800); // 0.8ì´ˆë§ˆë‹¤ ë¡œê·¸ í•œ ì¤„ ì¶œë ¥
                }

                // Physics Engine (ë¼ì´ë¸Œ ìˆ˜ì¹˜ ë³€ë™)
                function updatePhysics() {
                    nodes.forEach((n, i) => {
                        // CPU/MEM ë³€ë™
                        const jitter = Math.floor(Math.random() * 5) - 2;
                        n.metrics.cpu = Math.max(0, Math.min(100, n.metrics.cpu + jitter));
                        n.metrics.token_count += Math.floor(Math.random() * 10) - 2; // í† í° ìˆ˜ ë¯¸ì„¸ ë³€ë™
                        
                        // DOM ì—…ë°ì´íŠ¸
                        const card = document.getElementById(`card-${i}`);
                        if(!card.classList.contains('rebooting')) {
                            document.getElementById(`cpu-${i}`).innerText = n.metrics.cpu + "%";
                            document.getElementById(`tok-cnt-${i}`).innerText = n.metrics.token_count.toLocaleString();
                            
                            // í† í° ìŠ¤íŠ¸ë¦¼ ì• ë‹ˆë©”ì´ì…˜ (ëœë¤ í•´ì‹œ êµì²´)
                            if(Math.random() > 0.7) {
                                const newHash = Math.random().toString(36).substring(2, 10);
                                document.getElementById(`tok-stream-${i}`).innerText = newHash + " " + n.metrics.token_samples.slice(0,4).join(' ');
                            }
                        }
                    });
                    updateGlobalStats();
                }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: ğŸš€ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

  deploy:
    needs: build-simulate-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
