name: ğŸš€ Ops Control Center (Full-Screen Fix)

on:
  schedule:
    - cron: '0 */4 * * *' # 4ì‹œê°„ë§ˆë‹¤ ë°ì´í„° ê°±ì‹ 
  push:
    branches: [ "main" ]
  workflow_dispatch:

# [ê¶Œí•œ ì„¤ì •] ë°ì´í„° ì»¤ë°‹ ë° ë°°í¬ ê¶Œí•œ
permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "ops-full-fix"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ë°ì´í„° ìƒì„± ë° ì›¹ ì‚¬ì´íŠ¸ ë¹Œë“œ (ë‹¨ì¼ Jobìœ¼ë¡œ í†µí•©í•˜ì—¬ ì†ë„ í–¥ìƒ)
  # ==============================================================================
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout Repo
      uses: actions/checkout@v4

    # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
    - name: ğŸ“¦ Install Deps
      run: pip install faker

    # 4. ğŸ­ ë°ì´í„° ìƒì„± ì—”ì§„ ì‹¤í–‰ (JSON íŒŒì¼ ìƒì„±)
    - name: ğŸ­ Run Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, os
        from datetime import datetime
        from faker import Faker
        
        fake = Faker()
        DATA_FILE = "dashboard_data.json"
        
        # ì„œë¹„ìŠ¤ ì •ì˜
        SERVICES = [
            {"type": "PAYMENT", "icon": "ğŸ’³", "err": "Gateway Timeout"},
            {"type": "AUTH",    "icon": "ğŸ”", "err": "Token Expired"},
            {"type": "ORDER",   "icon": "ğŸ›’", "err": "DB Deadlock"},
            {"type": "AI-MODEL","icon": "ğŸ§ ", "err": "GPU OOM"},
            {"type": "DELIVERY","icon": "ğŸšš", "err": "Route Fail"}
        ]
        REGIONS = ["US-East", "KR-Seoul", "EU-West", "JP-Tokyo"]

        def generate_data():
            services = []
            active_cnt = 0
            crit_cnt = 0
            
            for i in range(50): # 50ê°œ ì„œë¹„ìŠ¤ ìƒì„±
                svc_def = random.choice(SERVICES)
                region = random.choice(REGIONS)
                
                # ìƒíƒœ ëœë¤ ê²°ì • (20% í™•ë¥ ë¡œ ì—ëŸ¬)
                is_error = random.random() < 0.2
                status = "CRITICAL" if is_error else "ACTIVE"
                if is_error: crit_cnt += 1
                else: active_cnt += 1
                
                cpu = random.randint(80, 99) if is_error else random.randint(10, 60)
                mem = random.randint(80, 99) if is_error else random.randint(20, 70)
                
                logs = []
                # ë¡œê·¸ ìƒì„±
                for _ in range(3):
                    logs.append({
                        "ts": datetime.now().strftime("%H:%M:%S"),
                        "level": "INFO",
                        "msg": "Health check passed."
                    })
                if is_error:
                    logs.append({
                        "ts": datetime.now().strftime("%H:%M:%S"),
                        "level": "ERROR",
                        "msg": f"{svc_def['err']} detected!"
                    })
                
                services.append({
                    "id": f"{svc_def['type']}-{region}-{random.randint(100,999)}",
                    "type": svc_def['type'],
                    "icon": svc_def['icon'],
                    "region": region,
                    "status": status,
                    "metrics": {"cpu": cpu, "mem": mem},
                    "logs": sorted(logs, key=lambda x: x['ts'], reverse=True)
                })
            
            data = {
                "generated_at": str(datetime.now()),
                "summary": {"active": active_cnt, "critical": crit_cnt},
                "services": services
            }
            return data

        if __name__ == "__main__":
            data = generate_data()
            with open(DATA_FILE, "w") as f:
                json.dump(data, f, indent=2)
            print("âœ… Data Generated Successfully.")
        EOF
        
        python db_engine.py

    # 5. ë°ì´í„° íŒŒì¼ ì»¤ë°‹ (GitHub Pagesê°€ ì½ì„ ìˆ˜ ìˆë„ë¡)
    - name: ğŸ’¾ Commit Data
      run: |
        git config --global user.name "Ops-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
        git commit -m "ğŸ“ˆ Auto-update: Dashboard Data" || echo "No changes to commit"
        git push origin main || echo "Push failed (might be concurrent update), skipping..."

    # 6. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (í™”ë©´ êµ¬ì„± ì½”ë“œ)
    - name: ğŸ¨ Build Frontend
      shell: bash
      run: |
        mkdir -p _site
        
        # JSON ë°ì´í„° ë³µì‚¬ (ë§¤ìš° ì¤‘ìš”: ì‚¬ì´íŠ¸ ë£¨íŠ¸ë¡œ ë³µì‚¬)
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>OPS CONTROL CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                body { background-color: #0f172a; color: #94a3b8; font-family: monospace; overflow: hidden; }
                .grid-layout { display: grid; grid-template-columns: 2fr 1fr; height: 100vh; }
                .border-r { border-right: 1px solid #1e293b; }
                .header-panel { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #1e293b; background: #0f172a; }
                .scroll-area { overflow-y: auto; height: calc(100vh - 60px); }
                
                /* Custom Scrollbar */
                ::-webkit-scrollbar { width: 8px; }
                ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
                
                /* Status Colors */
                .st-ACTIVE { color: #4ade80; }
                .st-CRITICAL { color: #f87171; font-weight: bold; animation: blink 1s infinite; }
                @keyframes blink { 50% { opacity: 0.5; } }
                
                tr:hover { background-color: #1e293b; cursor: pointer; }
                .selected-row { background-color: #1e293b; border-left: 2px solid #3b82f6; }
            </style>
        </head>
        <body>
            <div class="header-panel">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ­</span>
                    <h1 class="text-xl font-bold text-white tracking-widest">OPS CONTROL <span class="text-blue-500">CENTER</span></h1>
                </div>
                <div class="flex gap-4 text-xs">
                    <span class="border border-red-900 bg-red-900/20 text-red-400 px-3 py-1 rounded">CRITICAL: <span id="cnt-crit">0</span></span>
                    <span class="border border-green-900 bg-green-900/20 text-green-400 px-3 py-1 rounded">ACTIVE: <span id="cnt-active">0</span></span>
                </div>
            </div>

            <div class="grid-layout">
                
                <div class="border-r flex flex-col">
                    <div class="p-2 bg-slate-800 text-xs font-bold text-slate-400 border-b border-slate-700">SERVICE FLEET</div>
                    <div class="scroll-area">
                        <table class="w-full text-left text-sm">
                            <thead class="text-slate-500 bg-[#0f172a] sticky top-0 border-b border-slate-700">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">REGION</th>
                                    <th class="p-3">STATUS</th>
                                    <th class="p-3 text-right">CPU</th>
                                    <th class="p-3 text-center">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="svc-table" class="divide-y divide-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex flex-col bg-slate-900/50">
                    <div class="p-2 bg-slate-800 text-xs font-bold text-slate-400 border-b border-slate-700">ğŸš¨ EVENT SITUATION ROOM</div>
                    <div id="event-room" class="scroll-area p-4 space-y-2">
                        <div class="text-center text-slate-600 mt-20 italic">Select a service to view live logs...</div>
                    </div>
                </div>
            </div>

            <script>
                // [í•µì‹¬] ì•ˆì „ì¥ì¹˜ ë°ì´í„° (íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
                const FALLBACK_DATA = {
                    "summary": {"active": 5, "critical": 1},
                    "services": [
                        {"id": "DEMO-WEB-001", "region": "KR-Seoul", "status": "ACTIVE", "metrics": {"cpu": 45}, "logs": [{"ts":"NOW", "level":"INFO", "msg":"Demo Mode Active"}]},
                        {"id": "DEMO-DB-002", "region": "US-East", "status": "CRITICAL", "metrics": {"cpu": 99}, "logs": [{"ts":"NOW", "level":"ERROR", "msg":"Connection Failed"}]},
                        {"id": "DEMO-API-003", "region": "EU-West", "status": "ACTIVE", "metrics": {"cpu": 12}, "logs": [{"ts":"NOW", "level":"INFO", "msg":"Healthy"}]}
                    ]
                };

                let globalServices = [];

                async function init() {
                    try {
                        // 1. ì‹¤ì œ ë°ì´í„° íŒŒì¼ ë¡œë“œ ì‹œë„
                        const res = await fetch('dashboard_data.json');
                        if (!res.ok) throw new Error("File not found");
                        const data = await res.json();
                        render(data);
                    } catch (e) {
                        console.warn("âš ï¸ Data fetch failed, using FALLBACK data to prevent empty screen.", e);
                        // 2. ì‹¤íŒ¨ ì‹œ í´ë°± ë°ì´í„° ì‚¬ìš© (ë¹ˆ í™”ë©´ ë°©ì§€)
                        render(FALLBACK_DATA);
                    }
                }

                function render(data) {
                    globalServices = data.services;
                    
                    // ìƒë‹¨ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                    document.getElementById('cnt-active').innerText = data.summary.active;
                    document.getElementById('cnt-crit').innerText = data.summary.critical;

                    const tbody = document.getElementById('svc-table');
                    tbody.innerHTML = '';

                    data.services.forEach((svc, idx) => {
                        const statusColor = svc.status === 'CRITICAL' ? 'st-CRITICAL' : 'st-ACTIVE';
                        const cpuColor = svc.metrics.cpu > 80 ? 'bg-red-500' : 'bg-green-500';
                        
                        tbody.innerHTML += `
                        <tr onclick="showLogs(${idx}, this)" class="group transition">
                            <td class="p-3 text-white font-mono font-bold">${svc.id}</td>
                            <td class="p-3 text-xs text-slate-400">${svc.region}</td>
                            <td class="p-3 text-xs ${statusColor}">${svc.status}</td>
                            <td class="p-3 text-right">
                                <div class="w-full bg-slate-700 h-1.5 rounded-full mt-1">
                                    <div class="${cpuColor} h-1.5 rounded-full" style="width: ${svc.metrics.cpu}%"></div>
                                </div>
                                <span class="text-[9px]">${svc.metrics.cpu}%</span>
                            </td>
                            <td class="p-3 text-center">
                                <button class="text-[10px] border border-slate-600 px-2 py-0.5 rounded hover:bg-slate-700 hover:text-white">REBOOT</button>
                            </td>
                        </tr>`;
                    });
                }

                window.showLogs = function(idx, rowElem) {
                    // ì„ íƒ íš¨ê³¼
                    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
                    rowElem.classList.add('selected-row');

                    const svc = globalServices[idx];
                    const board = document.getElementById('event-room');
                    
                    let logHtml = `<div class="mb-4 pb-2 border-b border-slate-700">
                        <h2 class="text-white font-bold text-lg">${svc.id}</h2>
                        <span class="text-xs text-slate-400">Region: ${svc.region} | Status: ${svc.status}</span>
                    </div>`;

                    svc.logs.forEach(log => {
                        const color = log.level === 'ERROR' ? 'text-red-400 border-l-2 border-red-500 pl-2' : 'text-green-400 border-l-2 border-green-500 pl-2';
                        logHtml += `
                        <div class="mb-2 font-mono text-xs ${color} bg-slate-800/30 p-1 rounded">
                            <span class="opacity-50">[${log.ts}]</span> <span class="font-bold">${log.level}</span>: ${log.msg}
                        </div>`;
                    });
                    
                    board.innerHTML = logHtml;
                }

                init();
            </script>
        </body>
        </html>
        EOF

    # 7. GitHub Pages ë°°í¬
    - name: ğŸš€ Deploy to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

  deploy:
    needs: build-and-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
