name: ü™ê Galaxy Ops:Omni-Command (Shell & Security)

on:
  schedule:
    - cron: '*/5 * * * *' # 5Î∂ÑÎßàÎã§ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "galaxy-ops-omni"
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Setup Python
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }

    - name: üì¶ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] üè≠ Ïò¥Îãà Îç∞Ïù¥ÌÑ∞ ÏóîÏßÑ (Î≥¥Ïïà, ÎπÑÏö©, Ïâò Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±)
    # ----------------------------------------------------------------
    - name: üè≠ Run Omni Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, datetime, uuid
        from faker import Faker
        fake = Faker()
        
        NODE_COUNT = 80
        
        REGIONS = {
            "US-EAST": {"lat": 38, "lon": 25, "c": "USE"},
            "EU-CENT": {"lat": 35, "lon": 52, "c": "EUC"},
            "AP-SEOUL": {"lat": 40, "lon": 82, "c": "APS"},
            "SA-BRAZ": {"lat": 75, "lon": 30, "c": "SAB"}
        }
        
        THREAT_ORIGINS = [
            {"lat": 35, "lon": 20}, # Unknown Proxy
            {"lat": 45, "lon": 90}, # Botnet A
            {"lat": 60, "lon": 40}, # Botnet B
            {"lat": 80, "lon": 10}  # Dark Web Node
        ]
        
        ATTACK_TYPES = ["DDoS Volumetric", "SQL Injection", "XSS Attempt", "Brute Force SSH", "Ransomware Scan"]

        def gen_finops():
            return {
                "budget": 50000,
                "current_spend": round(random.uniform(20000, 35000), 2),
                "burn_rate_per_sec": round(random.uniform(0.05, 0.25), 4),
                "forecast": "OVER_BUDGET" if random.random() > 0.7 else "OPTIMAL"
            }

        def gen_threats():
            threats = []
            for _ in range(20):
                target = random.choice(list(REGIONS.values()))
                origin = random.choice(THREAT_ORIGINS)
                threats.append({
                    "id": str(uuid.uuid4())[:8],
                    "type": random.choice(ATTACK_TYPES),
                    "src_coords": {"top": f"{origin['lat']}%", "left": f"{origin['lon']}%"},
                    "dst_coords": {"top": f"{target['lat']}%", "left": f"{target['lon']}%"},
                    "severity": random.choice(["LOW", "MEDIUM", "HIGH", "CRITICAL"])
                })
            return threats

        def gen_nodes():
            nodes = []
            for i in range(NODE_COUNT):
                r_key = random.choice(list(REGIONS.keys()))
                reg = REGIONS[r_key]
                
                # Í∞ÄÏÉÅ ÌååÏùºÏãúÏä§ÌÖú Î∞è Ïâò ÌôòÍ≤Ω Îç∞Ïù¥ÌÑ∞
                files = ["config.yaml", "app.py", "error.log", "id_rsa.pub"]
                
                nodes.append({
                    "id": f"{reg['c']}-{i:03d}",
                    "region": r_key,
                    "role": random.choice(["WEB", "WAS", "DB", "CACHE"]),
                    "ip": fake.ipv4_private(),
                    "status": "ACTIVE" if random.random() > 0.1 else "CRITICAL",
                    "pos": {
                        "top": f"{reg['lat'] + random.randint(-5,5)}%", 
                        "left": f"{reg['lon'] + random.randint(-5,5)}%"
                    },
                    "metrics": {
                        "cpu": random.randint(5, 95),
                        "mem": random.randint(10, 90)
                    },
                    "shell_env": {
                        "user": "devops",
                        "files": files,
                        "uptime": f"{random.randint(1, 100)} days"
                    }
                })
            return nodes

        if __name__ == "__main__":
            data = {
                "generated_at": datetime.datetime.now().isoformat(),
                "finops": gen_finops(),
                "threats": gen_threats(),
                "nodes": gen_nodes()
            }
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f, indent=2)
            print("‚úÖ Omni Data Generated.")
        EOF
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] Îç∞Ïù¥ÌÑ∞ Ïª§Î∞ã
    # ----------------------------------------------------------------
    - name: üíæ Commit Data
      run: |
        git config --global user.name "Shell-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "ü™ê Omni-Ops Update [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped"

    # ----------------------------------------------------------------
    # [Step 3] ÌîÑÎ°†Ìä∏ÏóîÎìú (Shell, Canvas Map, FinOps)
    # ----------------------------------------------------------------
    - name: üé® Build Omni Interface
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
            <title>GALAXY OMNI-COMMAND</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
                
                body { background-color: #050505; color: #a3a3a3; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
                
                /* Layout */
                .main-layout { display: grid; grid-template-rows: 50px 1fr 250px 25px; height: 100vh; }
                .middle-section { display: grid; grid-template-columns: 1fr 300px; overflow: hidden; }
                
                /* Header FinOps */
                .ticker { font-variant-numeric: tabular-nums; letter-spacing: 1px; }
                
                /* Map & Canvas */
                .map-wrapper { position: relative; background: radial-gradient(circle at 50% 50%, #171717 0%, #000 90%); overflow: hidden; border-right: 1px solid #333; }
                #threat-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
                .node-dot { position: absolute; width: 6px; height: 6px; background: #3b82f6; border-radius: 50%; box-shadow: 0 0 8px #3b82f6; transition: all 0.5s; cursor: pointer; }
                .node-dot:hover { transform: scale(2); background: #fff; z-index: 50; }
                .node-dot.crit { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
                
                /* Right Panel (Threats) */
                .threat-panel { background: #0a0a0a; border-left: 1px solid #333; display: flex; flex-direction: column; }
                .log-item { font-size: 10px; padding: 4px 8px; border-bottom: 1px solid #1a1a1a; }
                .log-item.high { border-left: 2px solid #ef4444; color: #fca5a5; }
                
                /* Terminal / Shell Area */
                .terminal-container { background: #0c0c0c; border-top: 1px solid #333; padding: 10px; font-size: 12px; display: flex; flex-direction: column; overflow: hidden; }
                .term-output { flex: 1; overflow-y: auto; color: #d4d4d4; margin-bottom: 5px; white-space: pre-wrap; }
                .term-input-line { display: flex; color: #22c55e; font-weight: bold; align-items: center; }
                .term-input { background: transparent; border: none; color: #fff; flex: 1; outline: none; margin-left: 8px; font-family: inherit; font-weight: normal; }
                
                /* Scrollbar */
                ::-webkit-scrollbar { width: 6px; }
                ::-webkit-scrollbar-thumb { background: #333; }
            </style>
        </head>
        <body class="main-layout">
            
            <header class="flex justify-between items-center px-4 bg-black border-b border-[#333]">
                <div class="flex items-center gap-4">
                    <span class="text-2xl animate-pulse">ü™ê</span>
                    <h1 class="text-lg font-bold text-white tracking-widest">OMNI <span class="text-blue-500">COMMAND</span></h1>
                    <div class="px-2 py-0.5 rounded border border-red-900 bg-red-900/20 text-red-500 text-xs font-bold" id="defcon-badge">DEFCON 4</div>
                </div>
                
                <div class="flex items-center gap-6 text-xs">
                    <div class="text-right">
                        <div class="text-gray-500">CURRENT SPEND</div>
                        <div class="text-yellow-400 font-bold text-lg ticker">$<span id="fin-spend">0.00</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-gray-500">BURN RATE</div>
                        <div class="text-gray-300 font-bold ticker">+$<span id="fin-rate">0.0000</span>/s</div>
                    </div>
                </div>
            </header>

            <section class="middle-section">
                <div class="map-wrapper" id="map-root">
                    <canvas id="threat-canvas"></canvas>
                    <div class="absolute top-4 left-4 text-[10px] text-gray-500">
                        > THREAT_VISUALIZER_V8.0<br>
                        > INTERCEPTING PACKETS...
                    </div>
                    </div>

                <div class="threat-panel">
                    <div class="p-2 bg-[#111] text-[10px] font-bold text-gray-400 border-b border-[#333] flex justify-between">
                        <span>üõ°Ô∏è WAF EVENT LOGS</span>
                        <span id="threat-count" class="text-red-500">0 DETECTED</span>
                    </div>
                    <div id="waf-logs" class="flex-1 overflow-y-auto custom-scroll"></div>
                </div>
            </section>

            <section class="terminal-container" onclick="document.getElementById('cmd').focus()">
                <div class="term-output" id="term-out">
                    <div class="text-blue-400">Welcome to Galaxy Omni-Shell v8.0.2 LTS</div>
                    <div class="text-gray-500">Type 'help' for available commands. Try 'connect [ID]' to SSH into a node.</div>
                    <br>
                </div>
                <div class="term-input-line">
                    <span id="prompt-user">devops@galaxy-ops:~$</span>
                    <input type="text" id="cmd" class="term-input" autocomplete="off" spellcheck="false">
                </div>
            </section>

            <footer class="bg-black text-[10px] text-gray-600 flex items-center px-4">
                <span class="mr-4">CONNECTED: TLS v1.3</span>
                <span>LATENCY: 24ms</span>
            </footer>

            <script>
                // Data State
                let globalData = { nodes: [], threats: [], finops: {} };
                let sshSession = null; // Current SSH context
                
                // --- INIT ---
                async function init() {
                    await loadData();
                    setInterval(loadData, 60000); // Data Refresh
                    
                    // Start Animation Loops
                    requestAnimationFrame(animateThreats);
                    setInterval(updateFinOps, 1000);
                    setInterval(autoLog, 2000);

                    // Setup Shell
                    document.getElementById('cmd').addEventListener('keydown', handleShellInput);
                }

                async function loadData() {
                    try {
                        const res = await fetch('dashboard_data.json?v=' + Date.now());
                        const data = await res.json();
                        globalData = data;
                        renderMap();
                        renderThreatLogs();
                        
                        // Set Initial FinOps
                        document.getElementById('fin-spend').innerText = data.finops.current_spend.toFixed(2);
                        document.getElementById('fin-rate').innerText = data.finops.burn_rate_per_sec;
                    } catch(e) {
                        console.log("Offline Mode");
                    }
                }

                // --- MAP & VISUALS ---
                function renderMap() {
                    const map = document.getElementById('map-root');
                    // Remove old dots only (keep canvas)
                    document.querySelectorAll('.node-dot').forEach(e => e.remove());
                    
                    globalData.nodes.forEach(n => {
                        const el = document.createElement('div');
                        el.className = `node-dot ${n.status==='CRITICAL'?'crit':''}`;
                        el.style.top = n.pos.top;
                        el.style.left = n.pos.left;
                        el.title = `${n.id} (${n.ip})`;
                        el.onclick = () => {
                            document.getElementById('cmd').value = `connect ${n.id}`;
                            document.getElementById('cmd').focus();
                        };
                        map.appendChild(el);
                    });
                }

                const canvas = document.getElementById('threat-canvas');
                const ctx = canvas.getContext('2d');
                let threatsAnim = [];

                function animateThreats() {
                    // Resize
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Add new threats randomly
                    if(Math.random() > 0.95 && globalData.threats.length > 0) {
                        const t = globalData.threats[Math.floor(Math.random() * globalData.threats.length)];
                        threatsAnim.push({
                            x: parseFloat(t.src_coords.left) / 100 * canvas.width,
                            y: parseFloat(t.src_coords.top) / 100 * canvas.height,
                            tx: parseFloat(t.dst_coords.left) / 100 * canvas.width,
                            ty: parseFloat(t.dst_coords.top) / 100 * canvas.height,
                            progress: 0,
                            speed: Math.random() * 0.02 + 0.01,
                            color: t.severity === 'CRITICAL' ? '#ef4444' : '#f59e0b'
                        });
                    }

                    // Draw lines
                    threatsAnim.forEach((t, i) => {
                        t.progress += t.speed;
                        
                        const curX = t.x + (t.tx - t.x) * t.progress;
                        const curY = t.y + (t.ty - t.y) * t.progress;
                        
                        // Trail
                        ctx.beginPath();
                        ctx.moveTo(t.x, t.y);
                        ctx.lineTo(curX, curY);
                        ctx.strokeStyle = `rgba(${t.color === '#ef4444' ? '239,68,68' : '245,158,11'}, ${1-t.progress})`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // Head
                        ctx.beginPath();
                        ctx.arc(curX, curY, 2, 0, Math.PI*2);
                        ctx.fillStyle = '#fff';
                        ctx.fill();

                        if(t.progress >= 1) threatsAnim.splice(i, 1);
                    });

                    requestAnimationFrame(animateThreats);
                }

                // --- FINOPS ENGINE ---
                function updateFinOps() {
                    if(!globalData.finops) return;
                    
                    let spend = parseFloat(document.getElementById('fin-spend').innerText);
                    let rate = globalData.finops.burn_rate_per_sec;
                    
                    // Increment
                    spend += rate;
                    document.getElementById('fin-spend').innerText = spend.toFixed(2);
                }

                // --- SHELL / TERMINAL LOGIC (THE BRAIN) ---
                function handleShellInput(e) {
                    if(e.key === 'Enter') {
                        const input = e.target.value.trim();
                        const out = document.getElementById('term-out');
                        const prompt = document.getElementById('prompt-user').innerText;
                        
                        // Echo input
                        out.innerHTML += `<div><span class="text-green-500">${prompt}</span> ${input}</div>`;
                        
                        // Process Command
                        processCommand(input, out);
                        
                        // Scroll & Clear
                        e.target.value = '';
                        out.scrollTop = out.scrollHeight;
                    }
                }

                function processCommand(cmd, out) {
                    const args = cmd.split(' ');
                    const main = args[0].toLowerCase();
                    
                    if(sshSession) {
                        // SSH Context Commands
                        if(main === 'exit') {
                            sshSession = null;
                            document.getElementById('prompt-user').innerText = "devops@galaxy-ops:~$";
                            out.innerHTML += `<div class="text-gray-400">Connection closed.</div>`;
                            return;
                        }
                        if(main === 'ls') {
                            out.innerHTML += `<div class="text-blue-300">${sshSession.shell_env.files.join('  ')}</div>`;
                            return;
                        }
                        if(main === 'whoami') {
                            out.innerHTML += `<div>${sshSession.shell_env.user}</div>`;
                            return;
                        }
                        if(main === 'top') {
                            out.innerHTML += `
                            <div>Tasks: 12 total, 1 running, 11 sleeping</div>
                            <div>%Cpu(s): ${sshSession.metrics.cpu}.0 us,  2.1 sy,  0.0 ni</div>
                            <div>MiB Mem : ${sshSession.metrics.mem * 64} total,  ${sshSession.metrics.mem * 32} free</div>
                            `;
                            return;
                        }
                    } 
                    
                    // Global Context Commands
                    if(main === 'help') {
                        out.innerHTML += `
                        <div class="text-gray-400">Available Commands:</div>
                        <div>  help          Show this help</div>
                        <div>  status        Global system status</div>
                        <div>  list          List all active nodes</div>
                        <div>  cost          Show detailed FinOps report</div>
                        <div>  connect [ID]  SSH into a specific server</div>
                        <div>  clear         Clear terminal</div>
                        `;
                    } else if (main === 'clear') {
                        out.innerHTML = '';
                    } else if (main === 'status') {
                        const crit = globalData.nodes.filter(n => n.status === 'CRITICAL').length;
                        out.innerHTML += `<div>System Status: ${crit > 0 ? 'DEGRADED' : 'OPERATIONAL'} | Active Nodes: ${globalData.nodes.length}</div>`;
                    } else if (main === 'list') {
                        const list = globalData.nodes.map(n => `${n.id} [${n.ip}]`).join('\n');
                        out.innerHTML += `<div class="text-gray-500">${list}</div>`;
                    } else if (main === 'cost') {
                         out.innerHTML += `<div>Budget: $${globalData.finops.budget} | Forecast: ${globalData.finops.forecast}</div>`;
                    } else if (main === 'connect') {
                        const targetId = args[1];
                        const node = globalData.nodes.find(n => n.id === targetId);
                        if(node) {
                            sshSession = node;
                            out.innerHTML += `<div class="text-gray-400">Authenticating to ${node.ip}...</div>`;
                            setTimeout(() => {
                                out.innerHTML += `<div>Welcome to Ubuntu 22.04.2 LTS (${node.id})</div>`;
                                document.getElementById('prompt-user').innerText = `${node.shell_env.user}@${node.id}:~$`;
                                out.scrollTop = out.scrollHeight;
                            }, 500);
                        } else {
                            out.innerHTML += `<div class="text-red-400">Error: Node '${targetId}' not found. Try 'list'.</div>`;
                        }
                    } else if (cmd === '') {
                        // do nothing
                    } else {
                        out.innerHTML += `<div class="text-red-400">Command not found: ${main}</div>`;
                    }
                }

                function renderThreatLogs() {
                    const el = document.getElementById('waf-logs');
                    el.innerHTML = '';
                    globalData.threats.forEach(t => {
                        const div = document.createElement('div');
                        div.className = `log-item ${t.severity === 'CRITICAL' ? 'high' : ''}`;
                        div.innerHTML = `<span class="text-gray-500">[BLOCK]</span> ${t.type} from unknown <span class="text-gray-600">(${t.id})</span>`;
                        el.appendChild(div);
                    });
                    document.getElementById('threat-count').innerText = globalData.threats.length + " BLOCKED";
                }

                function autoLog() {
                    // Random logs in the WAF panel to make it feel alive
                    const el = document.getElementById('waf-logs');
                    if(Math.random() > 0.7) {
                        const attacks = ["SQLi", "XSS", "Path Traversal"];
                        const div = document.createElement('div');
                        div.className = 'log-item';
                        div.innerHTML = `<span class="text-blue-400">[INFO]</span> Rate limit triggered for IP 10.23.${Math.floor(Math.random()*255)}.x`;
                        el.prepend(div);
                        if(el.children.length > 20) el.lastChild.remove();
                    }
                }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: üöÄ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with: { path: _site/ }

  deploy:
    needs: build-deploy
    permissions: { pages: write, id-token: write }
    environment: { name: github-pages, url: ${{ steps.deployment.outputs.page_url }} }
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
