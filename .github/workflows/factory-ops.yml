name: Factory Ops Universal (All Artifacts)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  factory-ops-universal:
    runs-on: ubuntu-latest
    
    steps:
    # ------------------------------------------------------------------
    # [1ë‹¨ê³„] ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
    # ------------------------------------------------------------------
    - name: ðŸ§¹ Free Disk Space
      run: |
        echo "::group::Disk Cleanup"
        echo "START_DISK=$(df -h / | awk 'NR==2 {print $4}')" >> $GITHUB_ENV
        
        # ë¶ˆí•„ìš”í•œ ëŒ€í˜• ë„êµ¬ ì‚­ì œ
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker system prune -af
        
        echo "CLEANED_DISK=$(df -h / | awk 'NR==2 {print $4}')" >> $GITHUB_ENV
        # ì•„í‹°íŒ©íŠ¸ ìˆ˜ì§‘ìš© í´ë” ìƒì„±
        mkdir -p _dist_artifacts
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # [2ë‹¨ê³„] í™˜ê²½ ì„¤ì •
    # ------------------------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Tools
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    # ------------------------------------------------------------------
    # [3ë‹¨ê³„] ðŸ­ ë§ŒëŠ¥ ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ìƒì„± (í•µì‹¬ ìˆ˜ì •)
    # ------------------------------------------------------------------
    - name: ðŸ­ Build & Harvest All Artifacts
      id: build_process
      run: |
        # ë¦¬í¬íŠ¸ í—¤ë” ìƒì„±
        echo "Service|Status|Duration|Artifact" > build_results.txt
        GLOBAL_EXIT_CODE=0
        
        echo "ðŸš€ Starting Universal Build Process..."

        # _dist_artifacts í´ë”ì™€ ìˆ¨ê¹€ í´ë”ë¥¼ ì œì™¸í•˜ê³  ìˆœíšŒ
        find . -maxdepth 1 -type d -not -path '*/.*' -not -path '.' -not -name '_dist_artifacts' | while read service_dir; do
          SERVICE_NAME=$(basename "$service_dir")
          START_TIME=$(date +%s)
          BUILD_STATUS="SUCCESS"
          ARTIFACT_MSG="-"
          
          echo "::group::ðŸ”¨ Processing: $SERVICE_NAME"
          cd "$service_dir"
          
          # --- [A] ìžë™ ê°ì§€ ë° ë¹Œë“œ (ìˆœì„œ ì¤‘ìš”) ---
          
          # 1. Java (Maven)
          if [ -f "pom.xml" ]; then
            echo "Detected: Java (Maven)"
            mvn clean package -DskipTests || BUILD_STATUS="FAILED"
            
          # 2. Java (Gradle)
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "Detected: Java (Gradle)"
            chmod +x gradlew || true
            ./gradlew clean build -x test || BUILD_STATUS="FAILED"
            
          # 3. C# (.NET)
          elif [ -f *.csproj ] || ls *.csproj 1> /dev/null 2>&1; then
            echo "Detected: C# (.NET)"
            dotnet restore && dotnet build -c Release || BUILD_STATUS="FAILED"
            
          # 4. C++ (Make/CMake/G++) - cpp_core ëŒ€ì‘
          elif [ -f "CMakeLists.txt" ]; then
            echo "Detected: C++ (CMake)"
            cmake . && make || BUILD_STATUS="FAILED"
          elif ls *.cpp 1> /dev/null 2>&1; then
            echo "Detected: C++ (Direct Compile)"
            # ë‹¨ìˆœ ì»´íŒŒì¼: ëª¨ë“  cpp íŒŒì¼ì„ í•˜ë‚˜ì˜ ì‹¤í–‰íŒŒì¼(ì„œë¹„ìŠ¤ëª…)ë¡œ ì»´íŒŒì¼
            g++ -o "$SERVICE_NAME.bin" *.cpp || BUILD_STATUS="FAILED"
            
          # 5. Makefile í”„ë¡œì íŠ¸
          elif [ -f "Makefile" ]; then
            echo "Detected: Makefile"
            make || BUILD_STATUS="FAILED"
            
          # 6. ìŠ¤í¬ë¦½íŠ¸/ì„¤ì • í”„ë¡œì íŠ¸ (ops_scripts, data_center ë“±)
          elif ls *.sh 1> /dev/null 2>&1 || ls *.py 1> /dev/null 2>&1 || ls *.yaml 1> /dev/null 2>&1; then
             echo "Detected: Scripts/Config (No Compile Needed)"
             # ë¹Œë“œ ê³¼ì • ì—†ìŒ, ë°”ë¡œ ì„±ê³µ ì²˜ë¦¬í•˜ì—¬ íŒŒì¼ë§Œ ë³µì‚¬
             BUILD_STATUS="SUCCESS" 
             
          else
            echo "âš ï¸ Unknown project type. Treating as raw assets."
            BUILD_STATUS="SUCCESS"
          fi
          
          # --- [B] ê²°ê³¼ë¬¼ ìˆ˜ì§‘ (Harvesting) ---
          # ë¹Œë“œê°€ ì„±ê³µí–ˆë‹¤ë©´ ê²°ê³¼ë¬¼ì„ _dist_artifactsë¡œ ë³µì‚¬
          if [ "$BUILD_STATUS" == "SUCCESS" ]; then
            mkdir -p "../_dist_artifacts/$SERVICE_NAME"
            
            # 1. Java (.jar, .war)
            find target build/libs -name "*.jar" -o -name "*.war" 2>/dev/null | xargs -I {} cp {} "../_dist_artifacts/$SERVICE_NAME/"
            
            # 2. .NET (.dll, .exe, .json)
            find bin/Release -name "*.dll" -o -name "*.exe" -o -name "*.runtimeconfig.json" 2>/dev/null | grep -v "ref/" | xargs -I {} cp {} "../_dist_artifacts/$SERVICE_NAME/"
            
            # 3. C++ Binary & Executables (í™•ìž¥ìžê°€ ì—†ê±°ë‚˜ .bin, .out)
            # í˜„ìž¬ í´ë”ì—ì„œ ì‹¤í–‰ ê¶Œí•œì´ ìžˆëŠ” íŒŒì¼ì´ë‚˜ .bin íŒŒì¼ì„ ì°¾ìŒ
            find . -maxdepth 1 -type f -executable -not -name "*.sh" -not -name "*.py" 2>/dev/null | xargs -I {} cp {} "../_dist_artifacts/$SERVICE_NAME/"
            find . -maxdepth 1 -name "*.bin" 2>/dev/null | xargs -I {} cp {} "../_dist_artifacts/$SERVICE_NAME/"

            # 4. Scripts & Configs (ops_scripts ë“± ì»´íŒŒì¼ ì•ˆëœ í´ë”ìš©)
            # í´ë” ë‚´ì˜ í•µì‹¬ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬
            find . -maxdepth 1 -name "*.sh" -o -name "*.py" -o -name "*.yaml" -o -name "*.json" -o -name "*.xml" 2>/dev/null | xargs -I {} cp {} "../_dist_artifacts/$SERVICE_NAME/"
            
            # ìˆ˜ì§‘ëœ íŒŒì¼ ê°œìˆ˜ í™•ì¸
            COUNT=$(ls "../_dist_artifacts/$SERVICE_NAME/" | wc -l)
            if [ "$COUNT" -gt 0 ]; then
               ARTIFACT_MSG="ðŸ“¦ $COUNT files"
            else
               # íŒŒì¼ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê°•ì œë¡œ í´ë” ë‚´ìš©ë¬¼ ì „ì²´ ì••ì¶• (ìµœí›„ì˜ ìˆ˜ë‹¨)
               echo "âš ï¸ No binaries found, archiving sources..."
               tar -czf "../_dist_artifacts/$SERVICE_NAME/source_bundle.tar.gz" .
               ARTIFACT_MSG="ðŸ“¦ Source Bundle"
            fi
          else
            ARTIFACT_MSG="âŒ Failed"
          fi

          # --- [C] ì •ë¦¬ (Clean) ---
          # ì›ë³¸ ë¹Œë“œ ë¶€ì‚°ë¬¼ ì‚­ì œ (ê³µê°„ í™•ë³´)
          rm -rf target build bin obj *.o *.bin
          
          cd ..
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          if [ "$BUILD_STATUS" == "SUCCESS" ]; then ICON="âœ…"; else ICON="âŒ"; fi
          echo "$SERVICE_NAME|$BUILD_STATUS|${DURATION}s|$ARTIFACT_MSG" >> build_results.txt
          
          echo "::endgroup::"
          if [ "$BUILD_STATUS" == "FAILED" ]; then GLOBAL_EXIT_CODE=1; fi
        done
        
        if [ $GLOBAL_EXIT_CODE -ne 0 ]; then echo "BUILD_HAS_FAILURES=true" >> $GITHUB_ENV; fi

    # ------------------------------------------------------------------
    # [4ë‹¨ê³„] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë””ë²„ê¹… í¬í•¨)
    # ------------------------------------------------------------------
    - name: ðŸ“‚ Check Artifacts Before Upload
      run: |
        echo "::group::Inspect Artifacts"
        echo "Checking _dist_artifacts content:"
        # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ìž¬í•˜ëŠ”ì§€ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ í™•ì¸
        ls -R _dist_artifacts
        echo "::endgroup::"

    - name: ðŸ“¤ Upload All Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: factory-ops-release-package
        path: _dist_artifacts/
        if-no-files-found: warn
        retention-days: 5

    # ------------------------------------------------------------------
    # [5ë‹¨ê³„] ëŒ€ì‹œë³´ë“œ ìƒì„±
    # ------------------------------------------------------------------
    - name: ðŸ“ˆ Generate Dashboard
      if: always()
      run: |
        echo "# ðŸ­ Factory Ops Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“… Run ID: $GITHUB_RUN_ID" >> $GITHUB_STEP_SUMMARY
        
        # ì‹œìŠ¤í…œ í†µê³„
        CURRENT_DISK=$(df -h / | awk 'NR==2 {print $4}')
        echo "## ðŸ–¥ï¸ Disk Status: Start($START_DISK) -> Cleaned($CLEANED_DISK) -> End($CURRENT_DISK)" >> $GITHUB_STEP_SUMMARY
        
        # ê²°ê³¼ í…Œì´ë¸”
        echo "## ðŸ—ï¸ Build & Artifact Report" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status | Time | Artifacts |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
        
        tail -n +2 build_results.txt | while IFS='|' read -r service status duration artifact; do
          if [ "$status" == "SUCCESS" ]; then ICON="âœ…"; else ICON="âŒ"; fi
          echo "| **$service** | $ICON $status | $duration | $artifact |" >> $GITHUB_STEP_SUMMARY
        done

    - name: Final Failure Check
      if: env.BUILD_HAS_FAILURES == 'true'
      run: exit 1
