name: ğŸ›¡ï¸ Ops Control Center (Hardened Security)

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

# [ë³´ì•ˆ í•µì‹¬ 1] ìµœìƒìœ„ ê¶Œí•œì„ 'ì½ê¸° ì „ìš©'ìœ¼ë¡œ ì ê¸ˆ (Default Deny)
permissions: read-all

concurrency:
  group: "ops-control-secure"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ë°ì´í„° ìƒì‚°, ë³´ì•ˆ ê²€ì‚¬, ì €ì¥
  # ==============================================================================
  secure-ops-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # ì´ Jobì—ë§Œ ì“°ê¸° ê¶Œí•œ ë¶€ì—¬ (ìµœì†Œ ê¶Œí•œ ì›ì¹™)
    permissions:
      contents: write 

    steps:
    # [ë³´ì•ˆ í•µì‹¬ 2] Action ë²„ì „ì„ SHA í•´ì‹œë¡œ ê³ ì • (ë³€ì¡° ë°©ì§€)
    # actions/checkout@v4 -> b4ffde65f46336ab88eb53be808477a3936bae11
    - name: ğŸ“¥ Checkout Repo (Secure Pinning)
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
      with:
        python-version: '3.10'

    # [ë³´ì•ˆ í•µì‹¬ 3] ë³´ì•ˆ ìŠ¤ìºë„ˆ(Bandit) ì„¤ì¹˜
    - name: ğŸ“¦ Install Deps & Security Tools
      run: |
        pip install --no-cache-dir flask flask-cors gunicorn faker pandas requests jinja2 psutil pymongo redis bandit
        # pip ìºì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ì˜¤ì—¼ëœ ìºì‹œ ê³µê²© ë°©ì§€

    # ----------------------------------------------------------------
    # [Step 3] ğŸ­ Secure Data Engine (secrets ëª¨ë“ˆ ì ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Secure Data Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > db_engine.py
        import os, shutil, json, uuid, sqlite3, secrets
        from datetime import datetime, date
        from decimal import Decimal
        from faker import Faker
        
        # [Security] ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ ìƒì„±ê¸° ì‚¬ìš©
        secure_rng = secrets.SystemRandom()
        fake = Faker()
        OUTPUT_DIR = "_data_warehouse"
        
        def json_serial(obj):
            if isinstance(obj, (datetime, date)):
                return obj.isoformat()
            if isinstance(obj, Decimal):
                return float(obj)
            raise TypeError (f"Type {type(obj)} not serializable")

        def gen_rdb():
            path = "data/rdb/finance"
            os.makedirs(path, exist_ok=True)
            conn = sqlite3.connect(f"{path}/ledger.db")
            c = conn.cursor()
            c.execute('''CREATE TABLE txs (id text, date text, amount real, user text)''')
            # prepared statement ì‚¬ìš© (SQL Injection ë°©ì§€ íŒ¨í„´ ì¤€ìˆ˜)
            for _ in range(100):
                c.execute("INSERT INTO txs VALUES (?,?,?,?)",
                           (str(uuid.uuid4()), str(datetime.now()), secure_rng.uniform(10,9999), fake.name()))
            conn.commit()
            conn.close()
            return {"type": "RDB", "count": 100, "status": "Online"}

        def gen_nosql():
            path = "data/nosql/users"
            os.makedirs(path, exist_ok=True)
            docs = []
            for _ in range(100):
                profile = fake.profile()
                doc = {
                    "_id": str(uuid.uuid4()),
                    "profile": profile, 
                    "history": [fake.url() for _ in range(3)]
                }
                docs.append(doc)
            
            with open(f"{path}/collection.json", "w") as f: 
                 json.dump(docs, f, default=json_serial)
            return {"type": "NoSQL", "count": 100, "status": "Active"}

        def gen_others():
            return [{"type": "Graph", "count": 50, "status": "Mapped"}, 
                     {"type": "TSDB", "count": 500, "status": "Collecting"}]

        def gen_services_with_events():
            services = []
            regions = ["KR-Seoul", "US-East", "EU-West"]
            domains = ["Payment", "Auth", "Order", "Delivery"]
            errors = ["Connection Timeout", "Heap OOM", "Disk Full"]

            for r in regions:
                for d in domains:
                    # secrets ëª¨ë“ˆì„ ì‚¬ìš©í•œ ì•ˆì „í•œ í™•ë¥  ê³„ì‚°
                    is_down = secure_rng.random() < 0.2
                    status = "CRITICAL" if is_down else "ACTIVE"
                    svc_id = f"{d}-{r}-{secure_rng.randint(100,999)}"
                    
                    events = []
                    for _ in range(3):
                        events.append({"ts": str(fake.date_time_this_month()), "level": "INFO", "msg": "Health check ok"})
                    
                    if is_down:
                        events.append({"ts": str(datetime.now()), "level": "ERROR", "msg": secure_rng.choice(errors)})
                    
                    services.append({
                        "id": svc_id, "region": r, "domain": d, "status": status, 
                        "events": sorted(events, key=lambda x: x['ts'], reverse=True)
                    })
            return services

        if __name__ == "__main__":
            print("ğŸš€ Generating Secure Data...")
            try:
                db_stats = [gen_rdb(), gen_nosql()] + gen_others()
                services = gen_services_with_events()
                
                if os.path.exists("data"):
                    shutil.make_archive(f"{OUTPUT_DIR}/db_backup", 'zip', "data")
                    shutil.rmtree("data")
                
                data = {
                    "generated_at": str(datetime.now()),
                    "databases": db_stats,
                    "services": services
                }
                
                with open("dashboard_data.json", "w") as f:
                    json.dump(data, f, default=json_serial)
                print("âœ… Engine Finished Successfully.")
            except Exception as e:
                print(f"âš ï¸ Failure: {e}")
        EOF

    # [ë³´ì•ˆ í•µì‹¬ 4] ì •ì  ì½”ë“œ ë¶„ì„ (SAST) ì‹¤í–‰
    # ìƒì„±ëœ íŒŒì´ì¬ ì½”ë“œê°€ ë³´ì•ˆìƒ ì•ˆì „í•œì§€ ê²€ì‚¬í•©ë‹ˆë‹¤. (B101ì€ assertë¬¸ ë¬´ì‹œ)
    - name: ğŸ•µï¸ Run Security Audit (Bandit)
      run: |
        echo "ğŸ›¡ï¸ Running Security Scan on Engine..."
        bandit -r db_engine.py -s B101
        python db_engine.py

    # ----------------------------------------------------------------
    # ğŸ’¾ ë°ì´í„° ì˜êµ¬ ì €ì¥ (Commit & Push)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ Commit & Push Data
      run: |
        git config --global user.name "Security-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add dashboard_data.json
        git commit -m "ğŸ”’ Secure Auto-update: [$(date)]" || exit 0
        git push

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Control Center UI
      shell: bash
      run: |
        mkdir -p _web_portal/static
        mkdir -p _web_portal/templates
        
        # HTML ìƒì„± (ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•˜ì§€ ì•Šê³  ë³´ì•ˆìƒ ì•ˆì „í•˜ê²Œ ìƒì„±)
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>SECURE OPS CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; overflow: hidden; }
                .scroll-y { overflow-y: auto; height: 100%; }
                .status-active { color: #4ade80; }
                .status-critical { color: #f87171; font-weight: bold; animation: pulse 2s infinite; }
                @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
                .log-ERROR { color: #fca5a5; border-left: 2px solid #ef4444; padding-left: 8px; }
                .log-INFO { color: #86efac; border-left: 2px solid #22c55e; padding-left: 8px; }
                .btn-retry { background: #1e293b; border: 1px solid #475569; padding: 4px 10px; cursor: pointer; border-radius: 4px; font-size: 0.75rem; }
                .btn-retry:hover { background: #334155; color: white; }
            </style>
        </head>
        <body class="flex flex-col h-screen">
            <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between">
                <h1 class="text-xl font-bold text-white tracking-widest">ğŸ›¡ï¸ SECURE OPS <span class="text-blue-400">CENTER</span></h1>
                <div class="text-xs flex gap-4">
                    <span class="text-red-400 border border-red-900 px-2 py-1 rounded bg-red-900/20">CRITICAL: <span id="cnt-crit">0</span></span>
                    <span class="text-green-400 border border-green-900 px-2 py-1 rounded bg-green-900/20">ACTIVE: <span id="cnt-active">0</span></span>
                </div>
            </header>
            <main class="flex-1 flex overflow-hidden">
                <div class="w-2/3 border-r border-slate-700 flex flex-col">
                    <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700">SECURE FLEET</div>
                    <div class="flex-1 scroll-y p-4">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="text-slate-500 border-b border-slate-700 sticky top-0 bg-[#0f172a]">
                                <tr><th class="p-2">ID</th><th class="p-2">REGION</th><th class="p-2">STATUS</th><th class="p-2 text-center">ACTION</th></tr>
                            </thead>
                            <tbody id="svc-table" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
                <div class="w-1/3 flex flex-col bg-slate-900/50">
                    <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700">ğŸ”’ AUDIT LOGS</div>
                    <div class="flex-1 scroll-y p-4 space-y-3" id="event-board">
                        <div class="text-center text-slate-600 mt-10">Select a service...</div>
                    </div>
                </div>
            </main>
            <script>
                // XSS ë°©ì§€ë¥¼ ìœ„í•œ ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ (innerHTML ì‚¬ìš© ì‹œ ì£¼ì˜ í•„ìš”í•˜ë‚˜ ë°ëª¨ íŠ¹ì„±ìƒ ìœ ì§€)
                let globalData = [];
                async function loadData() {
                    const res = await fetch('/api/stats').catch(()=>fetch('dashboard_data.json'));
                    const data = await res.json();
                    globalData = data.services || [];
                    render();
                }
                function render() {
                    const tbody = document.getElementById('svc-table');
                    tbody.innerHTML = '';
                    let crit = 0; let active = 0;
                    globalData.forEach((svc, idx) => {
                        if(svc.status === 'CRITICAL') crit++; else active++;
                        const statusClass = svc.status === 'CRITICAL' ? 'status-critical' : 'status-active';
                        const btn = svc.status === 'CRITICAL' 
                             ? `<button class="btn-retry text-red-300" onclick="reboot('${svc.id}', ${idx}, event)">ğŸ›¡ï¸ SECURE REBOOT</button>` 
                             : `<span class="text-slate-600 text-xs">NO ACTION NEEDED</span>`;
                        
                        // IDê°’ ì‚´ê·  ì²˜ë¦¬ (Sanitization) ìƒëµë¨ (ë°ëª¨ ëª©ì )
                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-800 transition cursor-pointer" onclick="showEvents(${idx})">
                            <td class="p-3 font-bold text-slate-300">${svc.id}</td>
                            <td class="p-3 text-xs text-slate-400">${svc.region}</td>
                            <td class="p-3 ${statusClass}">${svc.status}</td>
                            <td class="p-3 text-center">${btn}</td>
                        </tr>`;
                    });
                    document.getElementById('cnt-crit').innerText = crit;
                    document.getElementById('cnt-active').innerText = active;
                }
                function showEvents(idx) {
                    const svc = globalData[idx];
                    const board = document.getElementById('event-board');
                    board.innerHTML = `<div class="mb-4 text-xs text-slate-500 border-b border-slate-700 pb-2">LOGS: <span class="text-white font-bold">${svc.id}</span></div>`;
                    svc.events.forEach(e => {
                        board.innerHTML += `
                        <div class="text-xs mb-2 log-${e.level}">
                            <div class="opacity-50 text-[10px]">${e.ts}</div>
                            <div class="font-bold">[${e.level}] ${e.msg}</div>
                        </div>`;
                    });
                }
                async function reboot(id, idx, e) {
                    e.stopPropagation();
                    const row = document.getElementById('svc-table').children[idx];
                    row.children[3].innerHTML = `<span class="text-yellow-500 text-xs">âš™ï¸ VERIFYING...</span>`;
                    try {
                        await fetch('/api/retry/' + id, {method: 'POST'});
                        loadData();
                    } catch(err) {
                        console.log("Simulating Reboot...");
                        setTimeout(() => {
                            globalData[idx].status = "ACTIVE";
                            globalData[idx].events.unshift({ts: new Date().toISOString(), level: "INFO", msg: "Action Verified by SecOps"});
                            render();
                            showEvents(idx);
                        }, 1500);
                    }
                }
                loadData();
            </script>
        </body>
        </html>
        EOF

    - name: âš™ï¸ Build Server API
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory, request, abort
        import json, re
        app = Flask(__name__)
        DATA_FILE = '../dashboard_data.json'

        @app.route('/')
        def home(): return render_template('index.html')

        @app.route('/api/stats')
        def stats():
            try: return jsonify(json.load(open(DATA_FILE)))
            except: return jsonify({"services": []})

        # [ë³´ì•ˆ í•µì‹¬ 5] ì…ë ¥ ê°’ ê²€ì¦ (Input Validation)
        @app.route('/api/retry/<id>', methods=['POST'])
        def retry(id):
            # ID í¬ë§· ê²€ì¦ (Alphanumeric ë° í•˜ì´í”ˆë§Œ í—ˆìš©)
            if not re.match(r'^[a-zA-Z0-9-]+$', id):
                abort(400, "Invalid ID Format")
                
            try:
                with open(DATA_FILE, 'r') as f: data = json.load(f)
                found = False
                for s in data['services']:
                    if s['id'] == id:
                        s['status'] = 'ACTIVE'
                        s['events'].insert(0, {"ts": "NOW", "level": "INFO", "msg": "Rebooted via Secure API"})
                        found = True
                
                if found:
                    with open(DATA_FILE, 'w') as f: json.dump(data, f)
                    return jsonify({"status": "ok"})
                else:
                    abort(404)
            except Exception: 
                return jsonify({"error": "Server Error"}), 500

        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        cat <<'EOF' > _web_portal/gunicorn_config.py
        bind = "0.0.0.0:5000"
        workers = 1
        loglevel = "error"
        accesslog = "/dev/null"
        errorlog = "/dev/null"
        EOF

    - name: ğŸ§ª Test & Build
      run: |
        cd _web_portal
        gunicorn -c gunicorn_config.py app:app > /dev/null 2>&1 &
        PID=$!
        sleep 5
        curl -4 -s http://127.0.0.1:5000/api/stats > /dev/null
        kill -TERM $PID
        wait $PID 2>/dev/null || true
        
        mkdir -p ../_site
        cp templates/index.html ../_site/index.html
        cp ../dashboard_data.json ../_site/dashboard_data.json

    - name: ğŸ“¤ Upload Artifacts (Secure Pinning)
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
      with:
        name: ops-control-package
        path: |
          _web_portal/
          _data_warehouse/
          dashboard_data.json

    - name: ğŸ“¤ Upload Pages (Secure Pinning)
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] ë°°í¬ (ê¶Œí•œ ë¶„ë¦¬)
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: secure-ops-engine
    # ë°°í¬ì— í•„ìš”í•œ ê¶Œí•œë§Œ í• ë‹¹ (Id-Tokenì€ OIDC ì¸ì¦ìš©)
    permissions:
      pages: write
      id-token: write
    
    steps:
      - name: ğŸš€ Deploy (Secure Pinning)
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
