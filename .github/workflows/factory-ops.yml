name: ğŸ‘ï¸ Ops Control Center (Full Process Visibility)

on:
  schedule:
    - cron: '0 */6 * * *' # 6ì‹œê°„ë§ˆë‹¤ ê°±ì‹ 
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions: read-all

concurrency:
  group: "ops-control-visual"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ë° ì‹œê°í™” ë°ì´í„° ìƒì„±
  # ==============================================================================
  process-visualizer:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: write

    steps:
    # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout Repo
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

    # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
      with:
        python-version: '3.10'

    # 3. í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
    - name: ğŸ“¦ Install Tools
      run: pip install --no-cache-dir flask flask-cors gunicorn faker pandas requests bandit

    # 4. ğŸ­ ë°ì´í„° ì—”ì§„ (íŒŒì´í”„ë¼ì¸ ì¶”ì  ë°ì´í„° ì¶”ê°€)
    - name: ğŸ­ Run Process Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import os, json, uuid, secrets, time
        from datetime import datetime, date, timedelta
        from decimal import Decimal
        from faker import Faker
        
        secure_rng = secrets.SystemRandom()
        fake = Faker()
        DATA_FILE = "dashboard_data.json"
        
        def json_serial(obj):
            if isinstance(obj, (datetime, date)):
                return obj.isoformat()
            if isinstance(obj, Decimal):
                return float(obj)
            raise TypeError (f"Type {type(obj)} not serializable")

        def load_existing_data():
            if os.path.exists(DATA_FILE):
                try:
                    with open(DATA_FILE, 'r') as f: return json.load(f)
                except: return None
            return None

        # [NEW] íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë³„ ìƒíƒœ ìƒì„±
        def gen_pipeline_steps():
            now = datetime.now()
            return [
                {"step": "DATA GEN", "status": "SUCCESS", "time": (now - timedelta(seconds=45)).strftime("%H:%M:%S")},
                {"step": "SECURITY SCAN", "status": "PASSED", "time": (now - timedelta(seconds=30)).strftime("%H:%M:%S")},
                {"step": "UNIT TEST", "status": "PASSED", "time": (now - timedelta(seconds=15)).strftime("%H:%M:%S")},
                {"step": "DEPLOYMENT", "status": "PENDING", "time": "IN PROGRESS"} 
            ]

        def gen_services():
            services = []
            regions = ["KR-Seoul", "US-East", "EU-West"]
            domains = ["Payment", "Auth", "Order", "Delivery"]
            critical_count = 0
            active_count = 0
            
            for r in regions:
                for d in domains:
                    is_down = secure_rng.random() < 0.15
                    status = "CRITICAL" if is_down else "ACTIVE"
                    if is_down: critical_count += 1
                    else: active_count += 1
                    
                    svc_id = f"{d}-{r}-{secure_rng.randint(100,999)}"
                    events = []
                    if is_down:
                        events.append({"ts": str(datetime.now()), "level": "ERROR", "msg": "Latency > 2000ms"})
                    else:
                        events.append({"ts": str(datetime.now()), "level": "INFO", "msg": "Health check ok"})
                    
                    services.append({
                        "id": svc_id, "region": r, "domain": d, "status": status, 
                        "events": events
                    })
            return services, active_count, critical_count

        if __name__ == "__main__":
            print("ğŸš€ Starting Process Engine...")
            old_data = load_existing_data()
            if old_data is None: old_data = {"history": []}
            
            services, active, critical = gen_services()
            pipeline = gen_pipeline_steps() # íŒŒì´í”„ë¼ì¸ ë°ì´í„° ìƒì„±
            
            # íˆìŠ¤í† ë¦¬ ê¸°ë¡
            history = old_data.get("history", [])
            history.append({
                "ts": datetime.now().strftime("%H:%M"),
                "active": active,
                "critical": critical
            })
            if len(history) > 20: history = history[-20:]
            
            final_data = {
                "generated_at": str(datetime.now()),
                "pipeline": pipeline, # ì‹œê°í™”ìš© íŒŒì´í”„ë¼ì¸ ë°ì´í„° í¬í•¨
                "history": history,
                "services": services
            }
            
            with open(DATA_FILE, "w") as f:
                json.dump(final_data, f, default=json_serial, indent=2)
            print("âœ… Process Completed.")
        EOF
        
        python db_engine.py

    # 5. ë³´ì•ˆ ê°ì‚¬ (SAST)
    - name: ğŸ•µï¸ Run Security Audit
      run: bandit -r db_engine.py -s B101,B311 || true

    # 6. ë°ì´í„° ì €ì¥ (ê°•ì œ ì¶”ê°€ ë° Rebase)
    - name: ğŸ’¾ Commit & Push Data
      run: |
        git config --global user.name "Process-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        if git diff --staged --quiet; then
          echo "No changes."
        else
          git commit -m "UPDATE: System Process Log [$(date)]"
          git pull --rebase --autostash
          git push
        fi

    # 7. UI ë¹Œë“œ (íŒŒì´í”„ë¼ì¸ ì‹œê°í™” í¬í•¨)
    - name: ğŸ¨ Build Visual Dashboard
      shell: bash
      run: |
        mkdir -p _web_portal/templates
        
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>OPS PROCESS VISUALIZER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                body { background-color: #0b1121; color: #e2e8f0; font-family: 'Courier New', monospace; overflow: hidden; }
                .scroll-y { overflow-y: auto; height: 100%; }
                
                /* Status Colors */
                .st-active { color: #4ade80; text-shadow: 0 0 5px #4ade80; }
                .st-critical { color: #f87171; text-shadow: 0 0 5px #f87171; animation: blink 1s infinite; }
                @keyframes blink { 50% { opacity: 0.5; } }
                
                /* Process Step Bar */
                .step-box { border: 1px solid #334155; padding: 10px; flex: 1; text-align: center; background: #0f172a; }
                .step-success { border-bottom: 3px solid #4ade80; color: #4ade80; }
                .step-pending { border-bottom: 3px solid #fbbf24; color: #fbbf24; }
                
                /* Scrollbar */
                ::-webkit-scrollbar { width: 6px; }
                ::-webkit-scrollbar-thumb { background: #334155; }
            </style>
        </head>
        <body class="flex flex-col h-screen">
            <div id="pipeline-container" class="flex justify-between gap-2 p-2 bg-slate-900 border-b border-slate-700 h-24">
                </div>

            <div class="flex flex-1 overflow-hidden">
                <div class="w-3/4 flex flex-col border-r border-slate-700">
                    <header class="p-4 flex justify-between items-center bg-slate-800/50">
                        <h1 class="text-2xl font-bold tracking-widest">SYSTEM <span class="text-blue-500">VISUALIZER</span></h1>
                        <div class="text-xs text-slate-400">LAST UPDATE: <span id="last-update" class="text-white">...</span></div>
                    </header>
                    
                    <div class="h-1/3 p-4 border-b border-slate-700">
                        <canvas id="trendChart"></canvas>
                    </div>
                    
                    <div class="flex-1 scroll-y p-4">
                        <table class="w-full text-left text-sm">
                            <thead class="text-slate-500 sticky top-0 bg-[#0b1121] border-b border-slate-700">
                                <tr><th class="p-3">SERVICE ID</th><th class="p-3">REGION</th><th class="p-3">PROCESS STATE</th></tr>
                            </thead>
                            <tbody id="svc-table" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>

                <div class="w-1/4 flex flex-col bg-slate-900">
                    <div class="p-3 bg-slate-800 font-bold text-xs text-slate-400 border-b border-slate-700">ğŸ–¥ï¸ SYSTEM BOOT LOGS</div>
                    <div class="flex-1 scroll-y p-3 font-mono text-[10px] space-y-1" id="boot-logs">
                        <div class="text-slate-500">Waiting for data stream...</div>
                    </div>
                    
                    <div class="p-3 bg-slate-800 font-bold text-xs text-slate-400 border-y border-slate-700">ğŸš¨ ERROR ALERTS</div>
                    <div class="h-1/3 scroll-y p-3 space-y-2" id="error-logs"></div>
                </div>
            </div>

            <script>
                async function loadData() {
                    const res = await fetch('/api/stats').catch(()=>fetch('dashboard_data.json'));
                    const data = await res.json();
                    
                    document.getElementById('last-update').innerText = data.generated_at;
                    
                    renderPipeline(data.pipeline);
                    renderTable(data.services);
                    renderChart(data.history);
                    renderLogs(data.services, data.pipeline);
                }

                // 1. Render Pipeline Steps (Top Bar)
                function renderPipeline(steps) {
                    const container = document.getElementById('pipeline-container');
                    container.innerHTML = '';
                    if(!steps) return;
                    
                    steps.forEach(s => {
                        const style = s.status === 'SUCCESS' || s.status === 'PASSED' ? 'step-success' : 'step-pending';
                        const icon = s.status === 'SUCCESS' || s.status === 'PASSED' ? 'âœ”' : 'âš¡';
                        container.innerHTML += `
                        <div class="step-box ${style} flex flex-col justify-center">
                            <div class="text-xs opacity-70">${s.step}</div>
                            <div class="text-lg font-bold">${icon} ${s.status}</div>
                            <div class="text-[10px] opacity-50">${s.time}</div>
                        </div>`;
                    });
                }

                // 2. Render Service Table
                function renderTable(services) {
                    const tbody = document.getElementById('svc-table');
                    tbody.innerHTML = '';
                    services.forEach(svc => {
                        const color = svc.status === 'CRITICAL' ? 'st-critical' : 'st-active';
                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-800/50 transition">
                            <td class="p-2 text-slate-300 font-bold">${svc.id}</td>
                            <td class="p-2 text-xs text-slate-500">${svc.region}</td>
                            <td class="p-2 ${color} text-xs">[ ${svc.status} ]</td>
                        </tr>`;
                    });
                }

                // 3. Render Logs (Boot & Error)
                function renderLogs(services, pipeline) {
                    const bootBox = document.getElementById('boot-logs');
                    const errBox = document.getElementById('error-logs');
                    
                    // Boot Logs (Simulated from pipeline data)
                    bootBox.innerHTML = '';
                    if(pipeline) {
                        pipeline.forEach(p => {
                            bootBox.innerHTML += `<div class="text-green-400"> > [${p.time}] PROCESS: ${p.step} initialized... OK</div>`;
                        });
                    }
                    bootBox.innerHTML += `<div class="text-blue-400"> > [NOW] Dashboard rendering complete.</div>`;
                    
                    // Error Logs
                    errBox.innerHTML = '';
                    const errs = services.filter(s => s.status === 'CRITICAL');
                    if(errs.length === 0) errBox.innerHTML = '<div class="text-center text-slate-600 mt-4">No Active Alerts</div>';
                    
                    errs.forEach(s => {
                        errBox.innerHTML += `
                        <div class="bg-red-900/10 border-l-2 border-red-500 p-2 text-[10px] text-red-200">
                            <div class="font-bold">${s.id}</div>
                            <div>${s.events[0].msg}</div>
                        </div>`;
                    });
                }

                // 4. Render Chart
                function renderChart(history) {
                    if(!history) return;
                    const ctx = document.getElementById('trendChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.ts),
                            datasets: [{
                                label: 'System Load',
                                data: history.map(h => h.active),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { grid: { color: '#1e293b' }, ticks: { color: '#64748b' } }
                            }
                        }
                    });
                }
                
                loadData();
            </script>
        </body>
        </html>
        EOF

    # 8. ë¹Œë“œ ë° ë°°í¬ ì¤€ë¹„
    - name: ğŸ§ª Build & Publish
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        @app.route('/')
        def home(): return render_template('index.html')
        @app.route('/api/stats')
        def stats(): return jsonify(json.load(open('../dashboard_data.json')))
        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        mkdir -p _site
        cp _web_portal/templates/index.html _site/index.html
        cp dashboard_data.json _site/dashboard_data.json

    - name: ğŸ“¤ Upload Pages
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] ë°°í¬
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: process-visualizer
    permissions:
      pages: write
      id-token: write
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
