name: üåå Galaxy Ops:DB, Backup & Snapshot

on:
  schedule:
    - cron: '*/15 * * * *' # 15Î∂ÑÎßàÎã§ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "galaxy-ops-full"
  cancel-in-progress: true

jobs:
  build-simulate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üì• Checkout Repo
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] üè≠ Ïù∏ÌîÑÎùº & DB Îç∞Ïù¥ÌÑ∞ ÏóîÏßÑ
    # ----------------------------------------------------------------
    - name: üè≠ Run Full-Stack Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, uuid, datetime
        from faker import Faker
        fake = Faker()
        
        NODE_COUNT = 60 # ÌôîÎ©¥ Î∞ÄÎèÑÎ•º ÏúÑÌï¥ ÏµúÏ†ÅÌôî
        
        # ÏÑúÎπÑÏä§Î≥Ñ DB Í∏∞Ïà† Ïä§ÌÉù Ï†ïÏùò
        TECH_STACK = {
            "PAYMENT": { "db": "PostgreSQL 16", "store": "NVMe Block", "backup_type": "WAL Archive" },
            "AUTH":    { "db": "Redis Cluster", "store": "In-Memory", "backup_type": "RDB Snapshot" },
            "AI-CORE": { "db": "Milvus Vector", "store": "Object Store", "backup_type": "Embedding Dump" },
            "DELIVERY":{ "db": "MongoDB 7.0",   "store": "SSD Raid-0", "backup_type": "Oplog Slice" }
        }
        
        CLUSTERS = ["Alpha", "Beta", "Gamma", "Delta"]

        def gen_backups():
            # Í≥ºÍ±∞ Î∞±ÏóÖ Í∏∞Î°ù ÏÉùÏÑ±
            backups = []
            for i in range(random.randint(2, 5)):
                dt = fake.date_time_this_month()
                size = random.randint(50, 5000)
                backups.append({
                    "id": f"bk-{fake.hex_color()[1:]}-{i}",
                    "date": dt.strftime("%Y-%m-%d %H:%M"),
                    "size": f"{size}GB",
                    "status": "SUCCESS"
                })
            return sorted(backups, key=lambda x: x['date'], reverse=True)

        def gen_snapshots():
            # Ïä§ÎÉÖÏÉ∑ Í∏∞Î°ù ÏÉùÏÑ±
            snaps = []
            for i in range(random.randint(1, 3)):
                dt = fake.date_time_this_week()
                snaps.append({
                    "id": f"snap-{random.randint(1000,9999)}",
                    "date": dt.strftime("%H:%M:%S"),
                    "desc": random.choice(["Pre-deploy", "Hourly", "Manual"]),
                    "size": f"{random.randint(1, 100)}GB"
                })
            return snaps

        def gen_nodes():
            nodes = []
            for i in range(NODE_COUNT):
                svc_type = random.choice(list(TECH_STACK.keys()))
                tech = TECH_STACK[svc_type]
                cluster = random.choice(CLUSTERS)
                
                # DB Metrics
                db_size = random.randint(100, 9000) # GB
                db_used = random.randint(10, db_size - 50)
                connections = random.randint(50, 5000)
                
                nodes.append({
                    "id": f"{svc_type}-{cluster}-{i:03d}",
                    "type": svc_type,
                    "cluster": cluster,
                    "status": "ACTIVE",
                    "tech": tech,
                    "metrics": {
                        "cpu": random.randint(10, 80),
                        "mem": random.randint(20, 70),
                        "temp": random.randint(40, 75),
                        "db_total": db_size,
                        "db_used": db_used,
                        "conn": connections,
                        "tps": random.randint(100, 20000)
                    },
                    "backups": gen_backups(),
                    "snapshots": gen_snapshots()
                })
            
            return {"timestamp": str(datetime.datetime.now()), "nodes": nodes}

        if __name__ == "__main__":
            data = gen_nodes()
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f, indent=2)
            print(f"‚úÖ Generated Full-Stack Data for {NODE_COUNT} nodes.")
        EOF
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] Îç∞Ïù¥ÌÑ∞ Ïª§Î∞ã
    # ----------------------------------------------------------------
    - name: üíæ Commit Data
      run: |
        git config --global user.name "DBA-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "üóÑÔ∏è DB & Backup State Update [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped"

    # ----------------------------------------------------------------
    # [Step 3] ÌîÑÎ°†Ìä∏ÏóîÎìú (Î™®Îã¨, ÌÉ≠, Í∏∞Îä• ÏãúÎÆ¨Î†àÏù¥ÏÖò ÌÉëÏû¨)
    # ----------------------------------------------------------------
    - name: üé® Build Deep Ops UI
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>GALAXY DEEP OPS</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <style>
                body { background-color: #020617; color: #cbd5e1; font-family: 'Courier New', monospace; overflow: hidden; }
                
                /* Layout */
                .layout { display: grid; grid-template-rows: 60px 1fr 30px; height: 100vh; }
                .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px; padding: 10px; overflow-y: auto; }
                
                /* Card */
                .card { background: #0f172a; border: 1px solid #1e293b; padding: 10px; cursor: pointer; transition: all 0.2s; position: relative; }
                .card:hover { border-color: #3b82f6; background: #1e293b; transform: translateY(-2px); }
                .card.active .status-dot { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
                
                /* Modal */
                .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; backdrop-filter: blur(4px); }
                .modal-content { 
                    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    width: 80%; height: 80%; background: #0f172a; border: 1px solid #3b82f6; 
                    display: grid; grid-template-rows: 50px 1fr; 
                    box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
                }
                
                /* Tabs */
                .tab-bar { display: flex; border-bottom: 1px solid #334155; background: #1e293b; }
                .tab-btn { padding: 0 20px; height: 100%; display: flex; align-items: center; cursor: pointer; border-right: 1px solid #334155; color: #94a3b8; }
                .tab-btn:hover { background: #334155; color: white; }
                .tab-btn.active { background: #0f172a; color: #3b82f6; border-bottom: 2px solid #3b82f6; }
                
                .tab-content { display: none; padding: 20px; overflow-y: auto; height: 100%; }
                .tab-content.active { display: block; }
                
                /* Visuals */
                .bar-bg { width: 100%; background: #334155; height: 6px; border-radius: 3px; overflow: hidden; }
                .bar-fill { height: 100%; transition: width 0.5s; }
                .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block; margin-right: 5px; }

                /* Animations */
                .spin-slow { animation: spin 3s linear infinite; }
                @keyframes spin { 100% { transform: rotate(360deg); } }
                .blink { animation: blink 1s infinite; }
                @keyframes blink { 50% { opacity: 0.5; } }
            </style>
        </head>
        <body class="layout">
            
            <header class="flex justify-between items-center px-6 border-b border-slate-800 bg-slate-950">
                <div class="flex items-center gap-3">
                    <i class="fas fa-server text-blue-500 text-xl"></i>
                    <h1 class="text-xl font-bold text-white tracking-widest">GALAXY <span class="text-blue-500">DEEP OPS</span></h1>
                </div>
                <div class="text-xs text-slate-500">
                    <span class="mr-4"><i class="fas fa-database text-green-500"></i> DB LINKED: <span class="text-white" id="stat-db">--</span></span>
                    <span><i class="fas fa-shield-alt text-yellow-500"></i> SECURITY LEVEL: <span class="text-white">MAX</span></span>
                </div>
            </header>

            <div id="grid-container" class="grid-view custom-scroll"></div>

            <footer class="flex items-center px-4 bg-slate-950 border-t border-slate-800 text-[10px] text-slate-500">
                <span>> SYSTEM READY. CLICK ANY NODE FOR DETAILS.</span>
            </footer>

            <div id="detail-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="tab-bar">
                        <div class="px-4 flex items-center font-bold text-white border-right border-slate-700 w-64 bg-slate-900">
                            <i class="fas fa-terminal mr-2 text-blue-400"></i> <span id="modal-title">NODE-ID</span>
                        </div>
                        <div class="tab-btn active" onclick="switchTab('overview')">OVERVIEW</div>
                        <div class="tab-btn" onclick="switchTab('database')">DATABASE</div>
                        <div class="tab-btn" onclick="switchTab('backup')">BACKUPS</div>
                        <div class="tab-btn" onclick="switchTab('snapshot')">SNAPSHOTS</div>
                        <div class="flex-1"></div>
                        <div class="tab-btn text-red-400 hover:bg-red-900/50" onclick="closeModal()">CLOSE [X]</div>
                    </div>

                    <div id="tab-overview" class="tab-content active">
                        <div class="grid grid-cols-2 gap-4 h-full">
                            <div class="border border-slate-700 p-4 bg-slate-900/50">
                                <h3 class="text-blue-400 font-bold mb-4 border-b border-slate-700 pb-2">SYSTEM METRICS</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between text-xs mb-1"><span>CPU LOAD</span><span id="ov-cpu">0%</span></div>
                                        <div class="bar-bg"><div id="bar-ov-cpu" class="bar-fill bg-blue-500" style="width:0%"></div></div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-xs mb-1"><span>MEMORY</span><span id="ov-mem">0%</span></div>
                                        <div class="bar-bg"><div id="bar-ov-mem" class="bar-fill bg-purple-500" style="width:0%"></div></div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-xs mb-1"><span>THERMAL</span><span id="ov-temp">0¬∞C</span></div>
                                        <div class="bar-bg"><div id="bar-ov-temp" class="bar-fill bg-red-500" style="width:0%"></div></div>
                                    </div>
                                </div>
                                <div class="mt-8">
                                    <button class="w-full py-2 bg-red-900/20 border border-red-800 text-red-400 hover:bg-red-800 hover:text-white transition text-xs font-bold" onclick="simulateAction('REBOOT')">
                                        <i class="fas fa-power-off mr-2"></i> EMERGENCY REBOOT
                                    </button>
                                </div>
                            </div>
                            <div class="border border-slate-700 p-4 bg-black font-mono text-xs overflow-y-auto text-green-400" id="ov-log">
                                > Connection established.<br>
                                > Monitoring daemon active.<br>
                                > Waiting for user input...
                            </div>
                        </div>
                    </div>

                    <div id="tab-database" class="tab-content">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-white" id="db-engine">PostgreSQL</h2>
                                <div class="text-sm text-slate-400">Storage Engine: <span id="db-store" class="text-blue-300">NVMe</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-green-400" id="db-tps">0</div>
                                <div class="text-xs text-slate-500">TRANSACTIONS / SEC</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-slate-800 p-3 rounded text-center">
                                <div class="text-xs text-slate-400">TOTAL STORAGE</div>
                                <div class="text-xl font-bold text-white" id="db-total">0 GB</div>
                            </div>
                            <div class="bg-slate-800 p-3 rounded text-center">
                                <div class="text-xs text-slate-400">USED SPACE</div>
                                <div class="text-xl font-bold text-yellow-400" id="db-used">0 GB</div>
                            </div>
                            <div class="bg-slate-800 p-3 rounded text-center">
                                <div class="text-xs text-slate-400">ACTIVE CONNECTIONS</div>
                                <div class="text-xl font-bold text-blue-400" id="db-conn">0</div>
                            </div>
                        </div>

                        <div class="border border-slate-700 p-4 bg-black/50">
                            <div class="flex justify-between mb-2 text-xs font-bold text-slate-400">
                                <span>STORAGE UTILIZATION</span>
                                <span id="db-util-text">0%</span>
                            </div>
                            <div class="h-4 w-full bg-slate-700 rounded overflow-hidden">
                                <div id="db-util-bar" class="h-full bg-gradient-to-r from-blue-500 to-red-500 transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                             <button class="px-4 py-2 bg-blue-900/30 border border-blue-700 text-blue-300 text-xs hover:bg-blue-800" onclick="simulateAction('VACUUM')">RUN VACUUM</button>
                             <button class="px-4 py-2 bg-blue-900/30 border border-blue-700 text-blue-300 text-xs hover:bg-blue-800" onclick="simulateAction('REINDEX')">REINDEX</button>
                        </div>
                    </div>

                    <div id="tab-backup" class="tab-content">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-white">BACKUP HISTORY</h3>
                            <button class="px-3 py-1 bg-green-900/30 border border-green-700 text-green-400 text-xs hover:bg-green-800" onclick="runBackup()">
                                <i class="fas fa-save mr-1"></i> RUN INCREMENTAL BACKUP
                            </button>
                        </div>
                        <div id="backup-progress" class="hidden mb-4">
                            <div class="text-xs text-green-400 mb-1">Backing up... <span id="bk-pct">0%</span></div>
                            <div class="bar-bg"><div id="bk-bar" class="bar-fill bg-green-500" style="width:0%"></div></div>
                        </div>
                        <table class="w-full text-left text-xs text-slate-300 border border-slate-700">
                            <thead class="bg-slate-800 font-bold">
                                <tr><th class="p-2">BACKUP ID</th><th class="p-2">DATE</th><th class="p-2">SIZE</th><th class="p-2">STATUS</th></tr>
                            </thead>
                            <tbody id="backup-list" class="divide-y divide-slate-800 bg-slate-900"></tbody>
                        </table>
                    </div>

                    <div id="tab-snapshot" class="tab-content">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-white">SYSTEM SNAPSHOTS</h3>
                            <button class="px-3 py-1 bg-purple-900/30 border border-purple-700 text-purple-400 text-xs hover:bg-purple-800" onclick="takeSnapshot()">
                                <i class="fas fa-camera mr-1"></i> TAKE SNAPSHOT
                            </button>
                        </div>
                        <div id="snap-flash" class="hidden fixed inset-0 bg-white/20 z-50"></div>
                        <table class="w-full text-left text-xs text-slate-300 border border-slate-700">
                            <thead class="bg-slate-800 font-bold">
                                <tr><th class="p-2">SNAPSHOT ID</th><th class="p-2">TIME</th><th class="p-2">DESC</th><th class="p-2">SIZE</th><th class="p-2">ACTION</th></tr>
                            </thead>
                            <tbody id="snap-list" class="divide-y divide-slate-800 bg-slate-900"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <script>
                // Data Storage
                let nodes = [];
                let currentNodeIdx = null;

                // Fallback Data
                const FALLBACK = { "nodes": [] };

                async function init() {
                    try {
                        const res = await fetch('dashboard_data.json');
                        if(!res.ok) throw new Error("Load fail");
                        const data = await res.json();
                        nodes = data.nodes;
                    } catch(e) {
                        nodes = FALLBACK.nodes;
                    }
                    renderGrid();
                    document.getElementById('stat-db').innerText = nodes.length;
                    
                    // Live Update (Physics)
                    setInterval(() => {
                        nodes.forEach(n => {
                            n.metrics.cpu = clamp(n.metrics.cpu + (Math.random()*4-2), 0, 100);
                            n.metrics.tps = Math.max(0, Math.floor(n.metrics.tps + (Math.random()*100-50)));
                        });
                        // Update Modal if open
                        if(currentNodeIdx !== null) updateModalMetrics(currentNodeIdx);
                    }, 1000);
                }

                function renderGrid() {
                    const grid = document.getElementById('grid-container');
                    grid.innerHTML = nodes.map((n, i) => `
                        <div class="card active" onclick="openModal(${i})">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-xs text-white">${n.id}</div>
                                <div class="status-dot"></div>
                            </div>
                            <div class="text-[10px] text-slate-400 mb-2">${n.tech.db}</div>
                            <div class="grid grid-cols-2 gap-2 text-[9px] text-slate-500">
                                <div><i class="fas fa-hdd"></i> ${n.metrics.db_used}GB</div>
                                <div><i class="fas fa-bolt"></i> ${n.metrics.tps} TPS</div>
                            </div>
                        </div>
                    `).join('');
                }

                // --- MODAL LOGIC ---
                window.openModal = function(idx) {
                    currentNodeIdx = idx;
                    const n = nodes[idx];
                    
                    document.getElementById('detail-modal').style.display = 'block';
                    document.getElementById('modal-title').innerText = n.id;
                    
                    // Init Tabs
                    switchTab('overview');
                    
                    // Populate Static Data
                    // DB Tab
                    document.getElementById('db-engine').innerText = n.tech.db;
                    document.getElementById('db-store').innerText = n.tech.store;
                    document.getElementById('db-total').innerText = n.metrics.db_total + " GB";
                    
                    // Lists
                    renderBackups(n.backups);
                    renderSnapshots(n.snapshots);
                    
                    updateModalMetrics(idx);
                }

                window.closeModal = function() {
                    document.getElementById('detail-modal').style.display = 'none';
                    currentNodeIdx = null;
                }

                window.switchTab = function(tabName) {
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                    
                    document.getElementById('tab-' + tabName).classList.add('active');
                    // Find button (simple approximate match)
                    event.target.classList.add('active');
                }

                function updateModalMetrics(idx) {
                    const n = nodes[idx];
                    
                    // Overview Tab
                    document.getElementById('ov-cpu').innerText = Math.floor(n.metrics.cpu) + "%";
                    document.getElementById('bar-ov-cpu').style.width = n.metrics.cpu + "%";
                    
                    document.getElementById('ov-mem').innerText = n.metrics.mem + "%";
                    document.getElementById('bar-ov-mem').style.width = n.metrics.mem + "%";
                    
                    document.getElementById('ov-temp').innerText = n.metrics.temp + "¬∞C";
                    document.getElementById('bar-ov-temp').style.width = (n.metrics.temp / 100 * 100) + "%";

                    // Database Tab
                    document.getElementById('db-tps').innerText = n.metrics.tps.toLocaleString();
                    document.getElementById('db-used').innerText = n.metrics.db_used + " GB";
                    document.getElementById('db-conn').innerText = n.metrics.conn;
                    
                    const util = (n.metrics.db_used / n.metrics.db_total) * 100;
                    document.getElementById('db-util-bar').style.width = util + "%";
                    document.getElementById('db-util-text').innerText = util.toFixed(1) + "%";
                }

                // --- ACTIONS ---
                window.simulateAction = function(action) {
                    const log = document.getElementById('ov-log');
                    log.innerHTML += `> Command: ${action} initiated...<br>`;
                    log.scrollTop = log.scrollHeight;
                    setTimeout(() => {
                        log.innerHTML += `> ${action} completed successfully.<br>`;
                        log.scrollTop = log.scrollHeight;
                    }, 1500);
                }

                // Backup Logic
                function renderBackups(list) {
                    const tbody = document.getElementById('backup-list');
                    tbody.innerHTML = list.map(b => `
                        <tr class="hover:bg-slate-800">
                            <td class="p-2 font-mono text-blue-300">${b.id}</td>
                            <td class="p-2">${b.date}</td>
                            <td class="p-2">${b.size}</td>
                            <td class="p-2 text-green-400">${b.status}</td>
                        </tr>
                    `).join('');
                }

                window.runBackup = function() {
                    const progDiv = document.getElementById('backup-progress');
                    const bar = document.getElementById('bk-bar');
                    const txt = document.getElementById('bk-pct');
                    
                    progDiv.classList.remove('hidden');
                    let width = 0;
                    const intv = setInterval(() => {
                        width += Math.random() * 5;
                        if(width >= 100) {
                            width = 100;
                            clearInterval(intv);
                            setTimeout(() => progDiv.classList.add('hidden'), 500);
                            
                            // Add dummy backup row
                            const n = nodes[currentNodeIdx];
                            n.backups.unshift({
                                id: "bk-new-" + Math.floor(Math.random()*1000),
                                date: "Just now",
                                size: (n.metrics.db_used * 0.1).toFixed(1) + "GB (Inc)",
                                status: "SUCCESS"
                            });
                            renderBackups(n.backups);
                        }
                        bar.style.width = width + "%";
                        txt.innerText = Math.floor(width) + "%";
                    }, 100);
                }

                // Snapshot Logic
                function renderSnapshots(list) {
                    const tbody = document.getElementById('snap-list');
                    tbody.innerHTML = list.map(s => `
                        <tr class="hover:bg-slate-800">
                            <td class="p-2 font-mono text-purple-300">${s.id}</td>
                            <td class="p-2">${s.date}</td>
                            <td class="p-2">${s.desc}</td>
                            <td class="p-2">${s.size}</td>
                            <td class="p-2"><button class="text-red-400 hover:text-white" onclick="alert('Simulated Delete')">[DEL]</button></td>
                        </tr>
                    `).join('');
                }

                window.takeSnapshot = function() {
                    // Flash effect
                    const flash = document.getElementById('snap-flash');
                    flash.classList.remove('hidden');
                    setTimeout(() => flash.classList.add('hidden'), 100);
                    
                    const n = nodes[currentNodeIdx];
                    n.snapshots.unshift({
                        id: "snap-" + Math.floor(Math.random()*9999),
                        date: new Date().toLocaleTimeString(),
                        desc: "Manual User Snap",
                        size: "0.5GB"
                    });
                    renderSnapshots(n.snapshots);
                }

                function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: üöÄ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

  deploy:
    needs: build-simulate-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
