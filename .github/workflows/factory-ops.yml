name: Factory Ops Dashboard & Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  factory-ops-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    # ------------------------------------------------------------------
    # [1ë‹¨ê³„] ì´ˆê¸° ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
    # ------------------------------------------------------------------
    - name: ğŸ§¹ Free Disk Space (Safe Mode)
      run: |
        echo "::group::Initializing Disk Cleanup"
        # ì´ˆê¸° ìš©ëŸ‰ ì¸¡ì •
        echo "START_DISK=$(df -h / | awk 'NR==2 {print $4}')" >> $GITHUB_ENV
        
        sudo rm -rf /usr/local/lib/android # Android SDK (10GB+)
        sudo rm -rf /opt/ghc               # Haskell
        sudo rm -rf /usr/share/swift       # Swift
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker system prune -af
        sudo apt-get clean
        
        # í™•ë³´ í›„ ìš©ëŸ‰ ì¸¡ì •
        echo "CLEANED_DISK=$(df -h / | awk 'NR==2 {print $4}')" >> $GITHUB_ENV
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # [2ë‹¨ê³„] í™˜ê²½ ì„¤ì • (Code Checkout & Setup)
    # ------------------------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Tools (Java & .NET)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    # ------------------------------------------------------------------
    # [3ë‹¨ê³„] ğŸ¶ Watchdog ì‹¤í–‰ (ì‹œìŠ¤í…œ ê°ì‹œ)
    # ------------------------------------------------------------------
    - name: ğŸ¶ Start Watchdog
      run: |
        cat << 'EOF' > watchdog.sh
        #!/bin/bash
        while true; do
          DISK_AVAIL=$(df -k . | awk 'NR==2 {print $4}')
          if [ "$DISK_AVAIL" -lt 500000 ]; then
             echo "ğŸš¨ [WATCHDOG] Low Disk Space: ${DISK_AVAIL} KB" >> watchdog_alerts.log
          fi
          sleep 10
        done
        EOF
        chmod +x watchdog.sh
        ./watchdog.sh &

    # ------------------------------------------------------------------
    # [4ë‹¨ê³„] ëŒ€ëŸ‰ ì„œë¹„ìŠ¤ ë¹Œë“œ ë° ë°ì´í„° ìˆ˜ì§‘ (í•µì‹¬)
    # ------------------------------------------------------------------
    - name: ğŸ­ Run Services & Collect Metrics
      id: build_process
      run: |
        # ë¦¬í¬íŠ¸ ë°ì´í„° íŒŒì¼ ì´ˆê¸°í™” (CSV í˜•ì‹: ì„œë¹„ìŠ¤ëª…,ìƒíƒœ,ì‹œê°„,ì•„ì´ì½˜)
        echo "Service|Status|Duration|Icon" > build_results.txt
        
        echo "ğŸš€ Starting Bulk Processing..."
        
        # ì „ì²´ ì‹¤íŒ¨ ì—¬ë¶€ í”Œë˜ê·¸
        GLOBAL_EXIT_CODE=0

        # ë£¨íŠ¸ ê²½ë¡œì˜ í´ë” ìˆœíšŒ
        find . -maxdepth 1 -type d -not -path '*/.*' -not -path '.' | while read service_dir; do
          SERVICE_NAME=$(basename "$service_dir")
          START_TIME=$(date +%s)
          BUILD_STATUS="SUCCESS"
          ICON="âœ…"
          
          echo "::group::ğŸ”¨ Building: $SERVICE_NAME"
          cd "$service_dir"
          
          # --- ë¹Œë“œ ë¡œì§ ì‹¤í–‰ (ì—ëŸ¬ ë°œìƒ ì‹œ ë©ˆì¶”ì§€ ì•Šê³  ìº¡ì²˜) ---
          if [ -f "pom.xml" ]; then
            mvn clean package -DskipTests || { BUILD_STATUS="FAILED"; ICON="âŒ"; }
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            chmod +x gradlew || true
            ./gradlew clean build -x test || { BUILD_STATUS="FAILED"; ICON="âŒ"; }
          elif [ -f *.csproj ] || ls *.csproj 1> /dev/null 2>&1; then
            dotnet restore && dotnet build --no-restore || { BUILD_STATUS="FAILED"; ICON="âŒ"; }
          elif [ -f "Makefile" ]; then
            make || { BUILD_STATUS="FAILED"; ICON="âŒ"; }
          elif [ -f "run.sh" ]; then
            chmod +x run.sh
            ./run.sh || { BUILD_STATUS="FAILED"; ICON="âŒ"; }
          else
            echo "âš ï¸ No build file found."
            BUILD_STATUS="SKIPPED"
            ICON="âš ï¸"
          fi
          
          # --- ë¹Œë“œ ì¢…ë£Œ í›„ ì •ë¦¬ ë° ê¸°ë¡ ---
          cd ..
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          # ê²°ê³¼ íŒŒì¼ì— ê¸°ë¡
          echo "$SERVICE_NAME|$BUILD_STATUS|${DURATION}s|$ICON" >> build_results.txt
          
          # ì„ì‹œ íŒŒì¼ ì¦‰ì‹œ ì‚­ì œ (ê³µê°„ í™•ë³´)
          rm -rf "$service_dir/target" "$service_dir/build" "$service_dir/bin" "$service_dir/obj"
          
          echo "::endgroup::"
          
          # ì‹¤íŒ¨ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ìµœì¢…ì ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬ìš© í”Œë˜ê·¸ ì„¤ì •
          if [ "$BUILD_STATUS" == "FAILED" ]; then
            GLOBAL_EXIT_CODE=1
          fi
        done
        
        # ë£¨í”„ ë‚´ë¶€ ë³€ìˆ˜ ì „ë‹¬ì„ ìœ„í•´ ì„ì‹œ íŒŒì¼ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ ë‚´ë³´ëƒ„
        if [ $GLOBAL_EXIT_CODE -ne 0 ]; then
          echo "BUILD_HAS_FAILURES=true" >> $GITHUB_ENV
        else
          echo "BUILD_HAS_FAILURES=false" >> $GITHUB_ENV
        fi

    # ------------------------------------------------------------------
    # [5ë‹¨ê³„] ğŸ“Š GitHub ëŒ€ì‹œë³´ë“œ ìƒì„± (Job Summary)
    # ------------------------------------------------------------------
    - name: ğŸ“ˆ Generate Dashboard
      if: always() # ë¹Œë“œ ì‹¤íŒ¨í•˜ë”ë¼ë„ ëŒ€ì‹œë³´ë“œëŠ” ì¶œë ¥
      run: |
        # 1. í—¤ë” ì‘ì„±
        echo "# ğŸ­ Factory Ops Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“… Date: $(date)" >> $GITHUB_STEP_SUMMARY
        
        # 2. ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½
        echo "## ğŸ–¥ï¸ System Health" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ’¿ Initial Disk | **$START_DISK** |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§¹ After Cleanup | **$CLEANED_DISK** |" >> $GITHUB_STEP_SUMMARY
        CURRENT_DISK=$(df -h / | awk 'NR==2 {print $4}')
        echo "| ğŸ Final Disk | **$CURRENT_DISK** |" >> $GITHUB_STEP_SUMMARY
        
        # Watchdog ê²½ê³  í™•ì¸
        if [ -f watchdog_alerts.log ]; then
           ALERT_COUNT=$(wc -l < watchdog_alerts.log)
           echo "| ğŸ¶ Watchdog Alerts | ğŸ”´ **$ALERT_COUNT Warnings** (Check logs) |" >> $GITHUB_STEP_SUMMARY
        else
           echo "| ğŸ¶ Watchdog Alerts | ğŸŸ¢ System Stable |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # 3. ì„œë¹„ìŠ¤ ë¹Œë“œ ê²°ê³¼ í…Œì´ë¸” ì‘ì„±
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ—ï¸ Build Results" >> $GITHUB_STEP_SUMMARY
        echo "| Service Name | Status | Duration | Result |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: | :---: | :---: |" >> $GITHUB_STEP_SUMMARY
        
        # ê²°ê³¼ íŒŒì¼ ì½ì–´ì„œ í…Œì´ë¸” í–‰ ìƒì„±
        # ì²« ì¤„(í—¤ë”) ê±´ë„ˆë›°ê³  ì²˜ë¦¬
        tail -n +2 build_results.txt | while IFS='|' read -r service status duration icon; do
          echo "| **$service** | $status | $duration | $icon |" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> *Generated by Factory Ops Automation*" >> $GITHUB_STEP_SUMMARY

    # ------------------------------------------------------------------
    # [6ë‹¨ê³„] ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬ (ë¹Œë“œ ì‹¤íŒ¨ê°€ ìˆì—ˆë‹¤ë©´ ì›Œí¬í”Œë¡œìš°ë¥¼ Redë¡œ í‘œì‹œ)
    # ------------------------------------------------------------------
    - name: Check Final Status
      if: env.BUILD_HAS_FAILURES == 'true'
      run: |
        echo "â›” Some services failed to build. Check the Dashboard above."
        exit 1
