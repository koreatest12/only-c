name: Factory Ops with Capacity Check

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  factory-ops-build:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------------
    # [1ë‹¨ê³„] ì‹œìŠ¤í…œ ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ (í•µì‹¬: .NETì€ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ë§Œ ì‚­ì œ)
    # ------------------------------------------------------------------
    - name: ðŸ§¹ Free Disk Space (Optimized for .NET/C)
      run: |
        echo "::group::Initialize Disk Cleanup"
        echo "ðŸ“‰ [ì´ˆê¸° ìƒíƒœ] ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ì¸:"
        df -h
        
        echo "ðŸ—‘ï¸ ë¶ˆí•„ìš”í•œ ëŒ€í˜• íŒ¨í‚¤ì§€ ì‚­ì œ ì¤‘..."
        # 1. Android SDK ì‚­ì œ (ê°€ìž¥ í¼, C# ì„œë²„ ê°œë°œì— ë¶ˆí•„ìš”)
        sudo rm -rf /usr/local/lib/android
        
        # 2. Swift, Haskell, CodeQL ì‚­ì œ
        sudo rm -rf /usr/share/swift
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        
        # 3. Docker ì´ë¯¸ì§€ ì •ë¦¬ (ìºì‹œëœ ë ˆì´ì–´ ì „ì²´ ì‚­ì œ)
        sudo docker system prune -af
        
        # 4. Apt ìºì‹œ ì •ë¦¬
        sudo apt-get clean
        
        # âš ï¸ ì¤‘ìš”: /usr/share/dotnet í´ë”ëŠ” ì ˆëŒ€ ì‚­ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (í”„ë¡œì íŠ¸ ë¹Œë“œ í•„ìˆ˜ ìš”ì†Œ)
        
        echo "ðŸ“ˆ [ì •ë¦¬ í›„] ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ì¸:"
        df -h
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # [2ë‹¨ê³„] ì½”ë“œ ì²´í¬ì•„ì›ƒ
    # ------------------------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    # ------------------------------------------------------------------
    # [3ë‹¨ê³„] ë ˆí¬ì§€í† ë¦¬ ë‚´ ì„œë¹„ìŠ¤ë³„ ìš©ëŸ‰ ì²´í¬ (ìš”ì²­í•˜ì‹  ê¸°ëŠ¥)
    # ------------------------------------------------------------------
    - name: ðŸ” Check Service Capacity (Folder Size Analysis)
      run: |
        echo "::group::Service Capacity Report"
        echo "ðŸ“‚ í˜„ìž¬ ë ˆí¬ì§€í† ë¦¬ ë‚´ í´ë”ë³„ ìš©ëŸ‰ ë¶„ì„ (ìƒìœ„ 15ê°œ):"
        
        # í˜„ìž¬ ë””ë ‰í† ë¦¬ ë‚´ì˜ í´ë” ìš©ëŸ‰ì„ í° ìˆœì„œëŒ€ë¡œ ì¶œë ¥
        du -h --max-depth=2 . | sort -hr | head -n 15
        
        echo "------------------------------------------------"
        echo "ðŸ’¾ ì „ì²´ í”„ë¡œì íŠ¸ í¬ê¸°:"
        du -sh .
        echo "::endgroup::"

    # ------------------------------------------------------------------
    # [4ë‹¨ê³„] Factory Ops ì‹¤í–‰
    # ------------------------------------------------------------------
    - name: Run Factory Ops
      run: |
        echo "ðŸš€ Running Factory Ops..."
        
        # C# í”„ë¡œì íŠ¸ì¸ ê²½ìš° ì˜ì¡´ì„± ë³µì› ì‹œ ê³µê°„ ë¶€ì¡±ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ 
        # nuget ìºì‹œë¥¼ ì •ë¦¬í•˜ê±°ë‚˜ ìµœì†Œí™”í•˜ëŠ” ì˜µì…˜ì„ ê³ ë ¤í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
        # ì˜ˆ: dotnet restore --disable-parallel
        
        # ì—¬ê¸°ì— ì‹¤ì œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”.
        # ì˜ˆ: ./build.sh ë˜ëŠ” dotnet run --project ...
        echo "Factory Ops Logic execution placeholder"

    # ------------------------------------------------------------------
    # [5ë‹¨ê³„] ë¹Œë“œ í›„ ì •ë¦¬ (ì„ íƒ ì‚¬í•­)
    # ------------------------------------------------------------------
    - name: ðŸ§¹ Post-Build Cleanup
      if: always() # ì‹¤íŒ¨í•˜ë”ë¼ë„ ì‹¤í–‰
      run: |
        echo "::group::Post-Build Cleanup"
        echo "Cleaning up bin/obj folders to save space for artifacts..."
        # ëª¨ë“  bin, obj í´ë” ì°¾ì•„ì„œ ì‚­ì œ (ê³µê°„ í™•ë³´ìš©)
        find . -iname "bin" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -iname "obj" -type d -exec rm -rf {} + 2>/dev/null || true
        
        echo "Final Disk Space:"
        df -h
        echo "::endgroup::"
