name: â™¾ï¸ Massive Ops Control (Big Data Edition)

on:
  schedule:
    - cron: '0 */4 * * *' # 4ì‹œê°„ë§ˆë‹¤ ëŒ€ëŸ‰ ë°ì´í„° ê°±ì‹ 
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions: read-all

concurrency:
  group: "ops-control-massive"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ëŒ€ê·œëª¨ ë°ì´í„° ìƒì‚° ë° ì‹œê°í™” íŒŒì´í”„ë¼ì¸
  # ==============================================================================
  massive-data-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: write

    steps:
    # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout Repo
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

    # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
      with:
        python-version: '3.10'

    # 3. í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
    - name: ğŸ“¦ Install Tools
      run: pip install --no-cache-dir flask flask-cors gunicorn faker pandas requests bandit

    # 4. ğŸ­ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì—”ì§„ (Big Data Engine)
    - name: ğŸ­ Run Massive Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import os, json, uuid, secrets, random
        from datetime import datetime, timedelta
        from decimal import Decimal
        from faker import Faker
        
        secure_rng = secrets.SystemRandom()
        fake = Faker()
        DATA_FILE = "dashboard_data.json"
        
        # ì„¤ì •: ìƒì„±í•  ì„œë²„ì˜ ìˆ˜ (ëŒ€ëŸ‰ ìƒì„±)
        SERVER_COUNT = 500  
        
        def json_serial(obj):
            if isinstance(obj, (datetime, date)): return obj.isoformat()
            if isinstance(obj, Decimal): return float(obj)
            raise TypeError (f"Type {type(obj)} not serializable")

        def load_existing_data():
            if os.path.exists(DATA_FILE):
                try:
                    with open(DATA_FILE, 'r') as f: return json.load(f)
                except: return None
            return None

        # íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ ì‹œê°í™” ë°ì´í„°
        def gen_pipeline_steps():
            now = datetime.now()
            return [
                {"step": "DATA MINING", "status": "SUCCESS", "time": (now - timedelta(seconds=60)).strftime("%H:%M:%S")},
                {"step": "ETL PROCESS", "status": "SUCCESS", "time": (now - timedelta(seconds=45)).strftime("%H:%M:%S")},
                {"step": "SECURITY AUDIT", "status": "PASSED", "time": (now - timedelta(seconds=20)).strftime("%H:%M:%S")},
                {"step": "VISUALIZATION", "status": "RENDERING", "time": "LIVE"} 
            ]

        # ëŒ€ëŸ‰ ì„œë¹„ìŠ¤ ìƒì„± ë¡œì§
        def gen_massive_services():
            services = []
            regions = ["KR-Seoul", "US-East", "US-West", "EU-Frankfurt", "EU-London", "AP-Tokyo", "AP-Singapore"]
            clusters = ["Alpha", "Beta", "Gamma", "Delta", "Omega"]
            
            critical_cnt = 0
            warning_cnt = 0
            active_cnt = 0
            
            print(f"Generating {SERVER_COUNT} service nodes...")
            
            for i in range(SERVER_COUNT):
                r = secure_rng.choice(regions)
                c = secure_rng.choice(clusters)
                
                # ëœë¤ ë©”íŠ¸ë¦­ ìƒì„±
                cpu = secure_rng.randint(5, 99)
                mem = secure_rng.randint(10, 95)
                latency = secure_rng.randint(10, 500)
                
                # ìƒíƒœ ê²°ì • ë¡œì§
                status = "ACTIVE"
                if cpu > 90 or mem > 90: 
                    status = "CRITICAL"
                    critical_cnt += 1
                elif cpu > 70 or latency > 300:
                    status = "WARNING"
                    warning_cnt += 1
                else:
                    active_cnt += 1
                
                svc_id = f"{c}-{r}-{i:04d}"
                
                services.append({
                    "id": svc_id,
                    "region": r,
                    "cluster": c,
                    "status": status,
                    "metrics": {
                        "cpu": cpu,
                        "mem": mem,
                        "lat": latency,
                        "net_in": f"{secure_rng.randint(10, 900)}Mbps",
                        "net_out": f"{secure_rng.randint(10, 900)}Mbps"
                    },
                    "last_log": f"Daemon process pid:{secure_rng.randint(1000,9999)} state changed."
                })
                
            return services, {"active": active_cnt, "warning": warning_cnt, "critical": critical_cnt}

        if __name__ == "__main__":
            print("ğŸš€ Starting Massive Data Engine...")
            old_data = load_existing_data()
            if old_data is None: old_data = {"history": []}
            
            services, stats = gen_massive_services()
            pipeline = gen_pipeline_steps()
            
            # íˆìŠ¤í† ë¦¬ ê¸°ë¡ (ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ìš©)
            history = old_data.get("history", [])
            history.append({
                "ts": datetime.now().strftime("%H:%M"),
                "stats": stats
            })
            if len(history) > 30: history = history[-30:] # ìµœê·¼ 30ê°œ í¬ì¸íŠ¸ ìœ ì§€
            
            final_data = {
                "generated_at": str(datetime.now()),
                "pipeline": pipeline,
                "summary": stats,
                "history": history,
                "services": services
            }
            
            with open(DATA_FILE, "w") as f:
                json.dump(final_data, f, default=json_serial, indent=None) # ëŒ€ìš©ëŸ‰ì´ë¯€ë¡œ indent ì œê±°í•˜ì—¬ ìš©ëŸ‰ ì ˆì•½
            print("âœ… Massive Data Generation Completed.")
        EOF
        
        python db_engine.py

    # 5. ë³´ì•ˆ ê°ì‚¬ (SAST)
    - name: ğŸ•µï¸ Run Security Audit
      run: bandit -r db_engine.py -s B101,B311 || true

    # 6. ë°ì´í„° ì €ì¥ (ì¶©ëŒ ë°©ì§€ ë° ëŒ€ëŸ‰ íŒŒì¼ ì²˜ë¦¬)
    - name: ğŸ’¾ Commit & Push Data
      run: |
        git config --global user.name "BigData-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        if git diff --staged --quiet; then
          echo "No changes."
        else
          git commit -m "ğŸ“Š Big Data Update: 500+ Nodes [$(date)]"
          git pull --rebase --autostash
          git push
        fi

    # 7. UI ë¹Œë“œ (ê³ ë°€ë„ ëŒ€ì‹œë³´ë“œ)
    - name: ğŸ¨ Build High-Density Dashboard
      shell: bash
      run: |
        mkdir -p _web_portal/templates
        
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>MASSIVE OPS CONTROL</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                /* Cyberpunk / High-Density Style */
                body { background-color: #050505; color: #a3a3a3; font-family: 'Consolas', 'Monaco', monospace; overflow: hidden; font-size: 11px; }
                
                /* Grid Layout */
                .dashboard-grid { display: grid; grid-template-rows: 40px 120px 1fr 150px; height: 100vh; gap: 2px; }
                
                /* Colors */
                .bg-panel { background: #0a0a0a; border: 1px solid #1f1f1f; }
                .text-crit { color: #ff4444; text-shadow: 0 0 3px #ff0000; }
                .text-warn { color: #ffbb33; }
                .text-good { color: #00cc66; }
                .border-crit { border-color: #ff4444; }
                
                /* Custom Scroll */
                ::-webkit-scrollbar { width: 6px; height: 6px; }
                ::-webkit-scrollbar-thumb { background: #333; }
                ::-webkit-scrollbar-track { background: #000; }
                
                /* Table Styling */
                table { border-collapse: collapse; width: 100%; }
                th { position: sticky; top: 0; background: #111; z-index: 10; padding: 4px; text-align: left; border-bottom: 1px solid #333; color: #666; }
                td { padding: 2px 4px; border-bottom: 1px solid #111; white-space: nowrap; }
                tr:hover { background: #1a1a1a; cursor: crosshair; }
                
                /* Progress Bars */
                .bar-bg { background: #222; height: 4px; width: 100%; display: inline-block; }
                .bar-fill { height: 100%; }
            </style>
        </head>
        <body class="dashboard-grid">
            
            <header class="bg-panel flex items-center justify-between px-4">
                <div class="flex items-center gap-4">
                    <h1 class="text-lg font-bold text-white tracking-widest">â™¾ï¸ MASSIVE <span class="text-blue-600">DATA OPS</span></h1>
                    <span class="text-[10px] bg-blue-900/30 text-blue-400 px-2 border border-blue-900">NODE COUNT: <span id="total-nodes">0</span></span>
                </div>
                <div class="flex gap-2" id="pipeline-steps"></div>
            </header>

            <section class="grid grid-cols-4 gap-1 px-1">
                <div class="bg-panel p-2 flex flex-col justify-center items-center">
                    <div class="text-2xl font-bold text-white" id="val-active">0</div>
                    <div class="text-[10px] text-green-500">ACTIVE NODES</div>
                </div>
                <div class="bg-panel p-2 flex flex-col justify-center items-center">
                    <div class="text-2xl font-bold text-warn" id="val-warn">0</div>
                    <div class="text-[10px] text-yellow-500">WARNING NODES</div>
                </div>
                <div class="bg-panel p-2 flex flex-col justify-center items-center border border-red-900/30">
                    <div class="text-2xl font-bold text-crit" id="val-crit">0</div>
                    <div class="text-[10px] text-red-500">CRITICAL NODES</div>
                </div>
                <div class="bg-panel p-1 relative">
                    <canvas id="mainChart"></canvas>
                </div>
            </section>

            <section class="bg-panel overflow-auto mx-1 relative">
                <table class="w-full">
                    <thead>
                        <tr>
                            <th style="width:120px">ID</th>
                            <th style="width:80px">REGION</th>
                            <th style="width:60px">STATUS</th>
                            <th style="width:100px">CPU LOAD</th>
                            <th style="width:100px">MEMORY</th>
                            <th style="width:80px">LATENCY</th>
                            <th>NET I/O</th>
                            <th class="text-right">LAST LOG MESSAGE</th>
                        </tr>
                    </thead>
                    <tbody id="grid-body" class="font-mono"></tbody>
                </table>
            </section>

            <footer class="bg-panel mx-1 mb-1 p-2 flex flex-col">
                <div class="text-[10px] font-bold text-slate-500 border-b border-slate-800 mb-1">ğŸ“¢ SYSTEM BROADCAST STREAM</div>
                <div class="flex-1 overflow-y-auto space-y-1" id="log-stream"></div>
            </footer>

            <script>
                async function init() {
                    const res = await fetch('/api/stats').catch(()=>fetch('dashboard_data.json'));
                    const data = await res.json();
                    
                    renderHeader(data);
                    renderSummary(data.summary);
                    renderGrid(data.services);
                    renderChart(data.history);
                    startLogStream(data.services);
                }

                function renderHeader(data) {
                    document.getElementById('total-nodes').innerText = data.services.length;
                    const p = document.getElementById('pipeline-steps');
                    p.innerHTML = '';
                    data.pipeline.forEach(step => {
                        const color = step.status === 'SUCCESS' || step.status === 'PASSED' ? 'text-green-400' : 'text-blue-400';
                        p.innerHTML += `<div class="bg-[#111] px-2 py-1 border border-[#222]">
                            <span class="text-white font-bold">${step.step}</span>: <span class="${color}">${step.status}</span>
                        </div>`;
                    });
                }

                function renderSummary(s) {
                    document.getElementById('val-active').innerText = s.active;
                    document.getElementById('val-warn').innerText = s.warning;
                    document.getElementById('val-crit').innerText = s.critical;
                }

                function renderGrid(services) {
                    const tbody = document.getElementById('grid-body');
                    // ëŒ€ëŸ‰ ë°ì´í„° ë Œë”ë§ ì„±ëŠ¥ì„ ìœ„í•´ HTML ë¬¸ìì—´ í•œ ë²ˆì— êµ¬ì„±
                    let html = '';
                    services.forEach(svc => {
                        let stClass = 'text-good';
                        if(svc.status === 'CRITICAL') stClass = 'text-crit font-bold';
                        if(svc.status === 'WARNING') stClass = 'text-warn';
                        
                        // CPU Bar Color
                        let cpuColor = '#00cc66';
                        if(svc.metrics.cpu > 70) cpuColor = '#ffbb33';
                        if(svc.metrics.cpu > 90) cpuColor = '#ff4444';

                        html += `
                        <tr>
                            <td class="text-white">${svc.id}</td>
                            <td>${svc.region}</td>
                            <td class="${stClass}">${svc.status}</td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <span class="w-6 text-right">${svc.metrics.cpu}%</span>
                                    <div class="bar-bg"><div class="bar-fill" style="width:${svc.metrics.cpu}%; background:${cpuColor}"></div></div>
                                </div>
                            </td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <span class="w-6 text-right">${svc.metrics.mem}%</span>
                                    <div class="bar-bg"><div class="bar-fill" style="width:${svc.metrics.mem}%; background:#3b82f6"></div></div>
                                </div>
                            </td>
                            <td>${svc.metrics.lat}ms</td>
                            <td class="text-[9px] text-slate-500">â¬‡${svc.metrics.net_in} â¬†${svc.metrics.net_out}</td>
                            <td class="text-right text-slate-600 italic">${svc.last_log}</td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                }

                function renderChart(history) {
                    if(!history) return;
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.ts),
                            datasets: [
                                { label: 'Active', data: history.map(h => h.stats.active), borderColor: '#00cc66', pointRadius: 0, tension: 0.2 },
                                { label: 'Warning', data: history.map(h => h.stats.warning), borderColor: '#ffbb33', pointRadius: 0, tension: 0.2 },
                                { label: 'Critical', data: history.map(h => h.stats.critical), borderColor: '#ff4444', pointRadius: 0, tension: 0.2 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { display: false }
                            },
                            animation: false
                        }
                    });
                }

                function startLogStream(services) {
                    const stream = document.getElementById('log-stream');
                    // Simulate live streaming logs from the static data
                    setInterval(() => {
                        const randomSvc = services[Math.floor(Math.random() * services.length)];
                        const time = new Date().toISOString().split('T')[1].split('.')[0];
                        const logColor = randomSvc.status === 'CRITICAL' ? 'text-red-400' : 'text-slate-400';
                        
                        const logLine = document.createElement('div');
                        logLine.className = `font-mono ${logColor}`;
                        logLine.innerHTML = `<span class="opacity-50">[${time}]</span> ${randomSvc.id} :: ${randomSvc.metrics.cpu}% Load - ${randomSvc.last_log}`;
                        
                        stream.prepend(logLine);
                        if(stream.children.length > 50) stream.lastChild.remove();
                    }, 800);
                }

                init();
            </script>
        </body>
        </html>
        EOF

    # 8. ë°°í¬ìš© ë¹Œë“œ
    - name: ğŸ§ª Build & Publish
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        @app.route('/')
        def home(): return render_template('index.html')
        @app.route('/api/stats')
        def stats(): return jsonify(json.load(open('../dashboard_data.json')))
        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        mkdir -p _site
        cp _web_portal/templates/index.html _site/index.html
        cp dashboard_data.json _site/dashboard_data.json

    - name: ğŸ“¤ Upload Pages
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] ë°°í¬
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: massive-data-ops
    permissions:
      pages: write
      id-token: write
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
