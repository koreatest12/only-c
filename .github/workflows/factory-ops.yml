name: ğŸ›¡ï¸ Ops Control Center (Visualized & Persistent)

on:
  schedule:
    - cron: '0 */6 * * *' # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  push:
    branches: [ "main" ]
  workflow_dispatch:

# [ë³´ì•ˆ] ìµœìƒìœ„ ê¶Œí•œ ì ê¸ˆ
permissions: read-all

concurrency:
  group: "ops-control-secure"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ë°ì´í„° ì—”ì§„ ì‹¤í–‰, ë³´ì•ˆ ê°ì‚¬, ì‹œê°í™” ë°ì´í„° êµ¬ì¶•
  # ==============================================================================
  secure-ops-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: write # ì»¤ë°‹ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìˆ˜

    steps:
    # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ (ë³´ì•ˆ íƒœê·¸ ê³ ì •)
    - name: ğŸ“¥ Checkout Repo
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

    # 2. íŒŒì´ì¬ ì„¤ì •
    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
      with:
        python-version: '3.10'

    # 3. ì˜ì¡´ì„± ì„¤ì¹˜ (ë³´ì•ˆ íˆ´ + ë°ì´í„° ë¶„ì„ íˆ´)
    - name: ğŸ“¦ Install Deps
      run: |
        pip install --no-cache-dir flask flask-cors gunicorn faker pandas requests jinja2 bandit
    
    # 4. ğŸ­ ê³ ê¸‰ ë°ì´í„° ì—”ì§„ (íˆìŠ¤í† ë¦¬ ëˆ„ì  ê¸°ëŠ¥ ì¶”ê°€)
    - name: ğŸ­ Run Smart Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import os, json, uuid, secrets
        from datetime import datetime, date
        from decimal import Decimal
        from faker import Faker
        
        secure_rng = secrets.SystemRandom()
        fake = Faker()
        DATA_FILE = "dashboard_data.json"
        
        # JSON ì§ë ¬í™”
        def json_serial(obj):
            if isinstance(obj, (datetime, date)):
                return obj.isoformat()
            if isinstance(obj, Decimal):
                return float(obj)
            raise TypeError (f"Type {type(obj)} not serializable")

        # ê¸°ì¡´ ë°ì´í„° ë¡œë“œ (íˆìŠ¤í† ë¦¬ ìœ ì§€ë¥¼ ìœ„í•´)
        def load_existing_data():
            if os.path.exists(DATA_FILE):
                try:
                    with open(DATA_FILE, 'r') as f:
                        return json.load(f)
                except:
                    return None
            return None

        # ì„œë¹„ìŠ¤ ìƒì„± ë¡œì§
        def gen_services():
            services = []
            regions = ["KR-Seoul", "US-East", "EU-West"]
            domains = ["Payment", "Auth", "Order", "Delivery"]
            
            critical_count = 0
            active_count = 0

            for r in regions:
                for d in domains:
                    is_down = secure_rng.random() < 0.15 # 15% í™•ë¥ ë¡œ ì¥ì• 
                    status = "CRITICAL" if is_down else "ACTIVE"
                    if is_down: critical_count += 1
                    else: active_count += 1
                    
                    svc_id = f"{d}-{r}-{secure_rng.randint(100,999)}"
                    events = []
                    
                    # ë¡œê·¸ ìƒì„±
                    if is_down:
                        events.append({"ts": str(datetime.now()), "level": "ERROR", "msg": "Connection Timeout"})
                    else:
                        events.append({"ts": str(datetime.now()), "level": "INFO", "msg": "Health check ok"})
                    
                    services.append({
                        "id": svc_id, "region": r, "domain": d, "status": status, 
                        "events": events
                    })
            
            return services, active_count, critical_count

        if __name__ == "__main__":
            print("ğŸš€ Generating Smart Data...")
            
            # 1. ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            old_data = load_existing_data()
            if old_data is None:
                old_data = {"history": [], "services": []}
            
            # 2. ìƒˆë¡œìš´ ìƒíƒœ ìƒì„±
            services, active, critical = gen_services()
            
            # 3. íˆìŠ¤í† ë¦¬ ê¸°ë¡ (ìµœê·¼ 20ê°œ í¬ì¸íŠ¸ë§Œ ìœ ì§€)
            new_history_point = {
                "ts": datetime.now().strftime("%H:%M"),
                "active": active,
                "critical": critical
            }
            
            history = old_data.get("history", [])
            history.append(new_history_point)
            if len(history) > 20: 
                history = history[-20:] # ê¼¬ë¦¬ ìë¥´ê¸°
            
            final_data = {
                "generated_at": str(datetime.now()),
                "history": history,
                "services": services
            }
            
            with open(DATA_FILE, "w") as f:
                json.dump(final_data, f, default=json_serial, indent=2)
            
            print("âœ… Data Updated with History.")
        EOF
        
        # ì—”ì§„ ì‹¤í–‰
        python db_engine.py

    # 5. ë³´ì•ˆ ê°ì‚¬ (SAST)
    - name: ğŸ•µï¸ Run Security Audit
      run: bandit -r db_engine.py -s B101,B311 || true

    # ----------------------------------------------------------------
    # [FIXED & IMPROVED] ğŸ’¾ ë°ì´í„° ì˜êµ¬ ì €ì¥ (ê°•ì œ ì¶”ê°€ ë° ì¶©ëŒ ë°©ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ Commit & Push Data
      run: |
        git config --global user.name "Security-Bot"
        git config --global user.email "bot@noreply.github.com"
        
        # [í•µì‹¬ ìˆ˜ì • 1] .gitignore ë¬´ì‹œí•˜ê³  ê°•ì œë¡œ íŒŒì¼ ìŠ¤í…Œì´ì§• (-f ì˜µì…˜)
        git add -f dashboard_data.json
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "ğŸ“Š Auto-update: Ops Data & History [$(date)]"
          
          # [í•µì‹¬ ìˆ˜ì • 2] ë¦¬ëª¨íŠ¸ ë³€ê²½ì‚¬í•­ì„ ë¨¼ì € ë‹¹ê²¨ì™€ì„œ ì¶©ëŒ ë°©ì§€ (Rebase)
          git pull --rebase --autostash
          git push
        fi

    # ----------------------------------------------------------------
    # [Step 6] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ (Chart.js ì‹œê°í™” ì¶”ê°€)
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Dashboard UI
      shell: bash
      run: |
        mkdir -p _web_portal/static
        mkdir -p _web_portal/templates
        
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>SECURE OPS DASHBOARD</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; overflow: hidden; }
                .scroll-y { overflow-y: auto; height: 100%; }
                .status-critical { color: #f87171; font-weight: bold; }
                .status-active { color: #4ade80; }
                /* Custom Scrollbar */
                ::-webkit-scrollbar { width: 8px; }
                ::-webkit-scrollbar-track { background: #1e293b; }
                ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
            </style>
        </head>
        <body class="flex flex-col h-screen">
            <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold tracking-widest text-white">ğŸ›¡ï¸ OPS <span class="text-blue-500">DASHBOARD</span></h1>
                    <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400">LIVE MODE</span>
                </div>
                <div class="text-xs text-slate-500">Secure Connection: TLS 1.3</div>
            </header>

            <main class="flex-1 flex overflow-hidden">
                <div class="w-1/2 border-r border-slate-700 flex flex-col">
                    <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700 flex justify-between">
                        <span>SERVICE FLEET STATUS</span>
                        <button onclick="loadData()" class="hover:text-white">â†» REFRESH</button>
                    </div>
                    <div class="flex-1 scroll-y p-4">
                        <table class="w-full text-left text-sm">
                            <thead class="text-slate-500 border-b border-slate-700 sticky top-0 bg-[#0f172a]">
                                <tr><th class="p-2">ID</th><th class="p-2">REGION</th><th class="p-2">STATUS</th></tr>
                            </thead>
                            <tbody id="svc-table" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>

                <div class="w-1/2 flex flex-col bg-slate-900/50">
                    <div class="h-1/2 border-b border-slate-700 flex flex-col">
                        <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700">ğŸ“ˆ SYSTEM TRENDS (Active vs Critical)</div>
                        <div class="flex-1 p-4 relative">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="h-1/2 flex flex-col">
                         <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700">ğŸš¨ LIVE INCIDENT LOGS</div>
                         <div class="flex-1 scroll-y p-4 space-y-2" id="log-board"></div>
                    </div>
                </div>
            </main>

            <script>
                let chartInstance = null;

                async function loadData() {
                    const res = await fetch('/api/stats').catch(()=>fetch('dashboard_data.json'));
                    const data = await res.json();
                    renderTable(data.services);
                    renderChart(data.history);
                    renderLogs(data.services);
                }

                function renderTable(services) {
                    const tbody = document.getElementById('svc-table');
                    tbody.innerHTML = '';
                    services.forEach(svc => {
                        const color = svc.status === 'CRITICAL' ? 'status-critical' : 'status-active';
                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-800 transition">
                            <td class="p-2 font-mono text-slate-300">${svc.id}</td>
                            <td class="p-2 text-xs text-slate-500">${svc.region}</td>
                            <td class="p-2 ${color} text-xs">${svc.status}</td>
                        </tr>`;
                    });
                }

                function renderLogs(services) {
                    const board = document.getElementById('log-board');
                    board.innerHTML = '';
                    const criticals = services.filter(s => s.status === 'CRITICAL');
                    
                    if(criticals.length === 0) {
                        board.innerHTML = '<div class="text-center text-green-500 text-sm mt-10">âœ… All Systems Operational</div>';
                        return;
                    }

                    criticals.forEach(svc => {
                        svc.events.forEach(e => {
                            if(e.level === 'ERROR') {
                                board.innerHTML += `
                                <div class="bg-red-900/20 border-l-2 border-red-500 p-2 text-xs text-red-200">
                                    <span class="opacity-50">[${e.ts.split(' ')[1]}]</span> 
                                    <span class="font-bold">${svc.id}</span>: ${e.msg}
                                </div>`;
                            }
                        });
                    });
                }

                function renderChart(history) {
                    if(!history || history.length === 0) return;
                    
                    const ctx = document.getElementById('trendChart').getContext('2d');
                    const labels = history.map(h => h.ts);
                    const activeData = history.map(h => h.active);
                    const critData = history.map(h => h.critical);

                    if(chartInstance) chartInstance.destroy();

                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Active', data: activeData, borderColor: '#4ade80', tension: 0.4 },
                                { label: 'Critical', data: critData, borderColor: '#f87171', tension: 0.4 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, labels: { color: '#94a3b8' } } },
                            scales: {
                                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                            }
                        }
                    });
                }
                
                loadData();
            </script>
        </body>
        </html>
        EOF

    # 7. ì„œë²„ ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    - name: ğŸ§ª Build & Test
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        @app.route('/')
        def home(): return render_template('index.html')
        @app.route('/api/stats')
        def stats(): return jsonify(json.load(open('../dashboard_data.json')))
        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        # Static Build
        mkdir -p _site
        cp _web_portal/templates/index.html _site/index.html
        cp dashboard_data.json _site/dashboard_data.json

    - name: ğŸ“¤ Upload Pages
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] ë°°í¬ (Pages)
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: secure-ops-engine
    permissions:
      pages: write
      id-token: write
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
