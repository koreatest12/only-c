name: üåå Hyper-Scale GPU Control Center (Fixed & Enhanced)

on:
  schedule:
    - cron: '*/5 * * * *' # 5Î∂ÑÎßàÎã§ Ïã§Ìñâ (GitHub ÌóàÏö© ÏµúÎåÄ ÎπàÎèÑ)
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "gpu-ops-hyper"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] Build, Simulate & Deploy (All-in-One for Speed)
  # ==============================================================================
  build-simulate-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üì• Checkout Repo
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] üè≠ Í≥†ÎèÑÌôîÎêú GPU Îç∞Ïù¥ÌÑ∞ ÏóîÏßÑ (ÏóêÎü¨ ÏàòÏ†ïÎê®)
    # ----------------------------------------------------------------
    - name: üè≠ Run Physics-Based Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, uuid
        from datetime import datetime
        from faker import Faker
        fake = Faker()
        
        # [ÏÑ§Ï†ï] Ï¥àÎåÄÌòï ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò (300Í∞ú ÎÖ∏Îìú)
        NODE_COUNT = 300
        
        # GPU Ïä§Ìéô Ï†ïÏùò (TDPÎäî Watt Îã®ÏúÑ)
        GPU_SPECS = [
            {"model": "NVIDIA H100 SXM", "vram": 80, "tdp": 700, "arch": "Hopper"},
            {"model": "NVIDIA A100 80G", "vram": 80, "tdp": 400, "arch": "Ampere"},
            {"model": "NVIDIA L40S",     "vram": 48, "tdp": 350, "arch": "Ada"},
            {"model": "RTX 6000 Ada",    "vram": 48, "tdp": 300, "arch": "Ada"},
            {"model": "RTX 4090",        "vram": 24, "tdp": 450, "arch": "Ada"},
            {"model": "Tesla T4",        "vram": 16, "tdp": 70,  "arch": "Turing"} 
        ]
        
        CLUSTERS = ["US-East-HPC", "KR-Seoul-AI", "EU-Frankfurt-LLM", "JP-Tokyo-Edge"]
        WORKLOADS = ["Training (LLM)", "Fine-tuning", "Inference", "Data Preprocessing", "Idle"]

        def gen_fleet():
            nodes = []
            stats = {"total": NODE_COUNT, "active": 0, "training": 0, "error": 0}
            
            for i in range(NODE_COUNT):
                spec = random.choice(GPU_SPECS)
                cluster = random.choice(CLUSTERS)
                workload = random.choice(WORKLOADS)
                
                # [Î°úÏßÅ] ÏõåÌÅ¨Î°úÎìúÏóê Îî∞Î•∏ Î∂ÄÌïò ÏãúÎÆ¨Î†àÏù¥ÏÖò
                if workload == "Idle":
                    util = random.randint(0, 10)
                    mem_used = random.uniform(0.5, 2.0)
                    temp = random.randint(30, 45)
                    # [FIX] ÏóêÎü¨ Î∞úÏÉù ÏõêÏù∏Ïù¥ÏóàÎçò ÌïòÎìúÏΩîÎî© Ï†úÍ±∞ -> Ïä§Ìéô Í∏∞Î∞ò Í≥ÑÏÇ∞
                    power_min = int(spec['tdp'] * 0.1) # ÏïÑÏù¥Îì§ Ïãú 10% Ï†ÑÎ†•
                    power_max = int(spec['tdp'] * 0.3)
                elif "Training" in workload:
                    util = random.randint(90, 100)
                    mem_used = spec['vram'] * random.uniform(0.8, 0.98)
                    temp = random.randint(75, 88)
                    power_min = int(spec['tdp'] * 0.8)
                    power_max = spec['tdp']
                    stats["training"] += 1
                else: # Inference / Others
                    util = random.randint(40, 80)
                    mem_used = spec['vram'] * random.uniform(0.3, 0.7)
                    temp = random.randint(50, 70)
                    power_min = int(spec['tdp'] * 0.4)
                    power_max = int(spec['tdp'] * 0.7)

                # [FIX] ÏïàÏ†ÑÌïú ÎûúÎç§ Î≤îÏúÑ ÏÑ§Ï†ï (minÏù¥ maxÎ≥¥Îã§ ÌÅ¥ Ïàò ÏóÜÏùå)
                if power_min >= power_max: power_max = power_min + 5
                power = random.randint(power_min, power_max)

                # ÏÉÅÌÉú Í≤∞Ï†ï (Í≥ºÏó¥ ÏãúÎÆ¨Î†àÏù¥ÏÖò)
                status = "ACTIVE"
                if temp > 85:
                    status = "WARNING"
                if temp > 90 or random.random() < 0.02: # 2% ÌôïÎ•†Î°ú ÎûúÎç§ Í≥†Ïû•
                    status = "CRITICAL"
                    workload = "ERROR_STATE"
                    stats["error"] += 1
                else:
                    stats["active"] += 1

                nodes.append({
                    "id": f"{spec['arch']}-{cluster}-{i:04d}",
                    "model": spec['model'],
                    "cluster": cluster,
                    "status": status,
                    "workload": workload,
                    "metrics": {
                        "util": util,
                        "temp": temp,
                        "power": power,
                        "fan": min(100, int((temp / 90) * 100)), # Ïò®ÎèÑ ÎπÑÎ°Ä Ìå¨ ÏÜçÎèÑ
                        "vram_total": spec['vram'],
                        "vram_used": round(mem_used, 1)
                    }
                })
            
            return {
                "timestamp": str(datetime.now()),
                "summary": stats,
                "nodes": nodes
            }

        if __name__ == "__main__":
            try:
                data = gen_fleet()
                with open("dashboard_data.json", "w") as f:
                    json.dump(data, f, indent=2)
                print(f"‚úÖ Physics Engine: Generated {NODE_COUNT} nodes without error.")
            except Exception as e:
                print(f"‚ùå Critical Error: {e}")
                exit(1)
        EOF
        
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] Îç∞Ïù¥ÌÑ∞ Ïª§Î∞ã (ÌûàÏä§ÌÜ†Î¶¨ Î≥¥Ï°¥)
    # ----------------------------------------------------------------
    - name: üíæ Commit Data
      run: |
        git config --global user.name "H100-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "üåå GPU Matrix Update [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped (concurrency)"

    # ----------------------------------------------------------------
    # [Step 3] ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú (999% Live Jitter Engine)
    # ----------------------------------------------------------------
    - name: üé® Build Dashboard
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>GPU HIVE MIND</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
            <style>
                :root { --neon-green: #00ff41; --neon-red: #ff003c; --bg-dark: #050505; }
                body { background-color: var(--bg-dark); color: #e0e0e0; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
                
                /* Layout */
                .main-layout { display: grid; grid-template-rows: 60px 80px 1fr 30px; height: 100vh; }
                .gpu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1px; background: #222; overflow-y: scroll; }
                
                /* Card Design */
                .card { background: #0a0a0a; border: 1px solid #222; padding: 10px; font-size: 10px; position: relative; transition: background 0.2s; }
                .card:hover { background: #111; z-index: 10; border-color: #555; }
                .card.crit { border: 1px solid var(--neon-red); box-shadow: inset 0 0 10px rgba(255,0,60,0.2); }
                
                /* Visuals */
                .bar-track { background: #1a1a1a; height: 4px; width: 100%; margin-top: 2px; }
                .bar-fill { height: 100%; transition: width 0.2s ease-out; }
                .led { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
                .led-on { background: var(--neon-green); box-shadow: 0 0 5px var(--neon-green); }
                .led-off { background: #333; }
                .led-err { background: var(--neon-red); box-shadow: 0 0 5px var(--neon-red); animation: blink 0.5s infinite; }
                
                @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
                
                /* Scrollbar */
                ::-webkit-scrollbar { width: 6px; }
                ::-webkit-scrollbar-thumb { background: #333; }
            </style>
        </head>
        <body class="main-layout">
            
            <header class="flex items-center justify-between px-6 border-b border-[#333] bg-[#080808]">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <h1 class="text-lg font-bold tracking-widest text-white">NVIDIA <span class="text-green-500">HIVE MIND</span></h1>
                </div>
                <div class="text-[10px] text-gray-500">
                    SYNC RATE: <span class="text-green-400">10ms</span> | PROTOCOL: <span class="text-blue-400">WebSocket (Sim)</span>
                </div>
            </header>

            <div class="grid grid-cols-5 gap-0 divide-x divide-[#333] bg-[#0a0a0a] border-b border-[#333]">
                <div class="p-3 text-center">
                    <div class="text-[9px] text-gray-500">TOTAL NODES</div>
                    <div class="text-xl font-bold text-white" id="val-total">---</div>
                </div>
                <div class="p-3 text-center">
                    <div class="text-[9px] text-gray-500">ACTIVE WORKERS</div>
                    <div class="text-xl font-bold text-green-400" id="val-active">---</div>
                </div>
                <div class="p-3 text-center">
                    <div class="text-[9px] text-gray-500">TRAINING JOBS</div>
                    <div class="text-xl font-bold text-blue-400" id="val-training">---</div>
                </div>
                <div class="p-3 text-center">
                    <div class="text-[9px] text-gray-500">CRITICAL ALERTS</div>
                    <div class="text-xl font-bold text-red-500" id="val-error">---</div>
                </div>
                <div class="p-3 text-center">
                    <div class="text-[9px] text-gray-500">TOTAL POWER (kW)</div>
                    <div class="text-xl font-bold text-yellow-500" id="val-power">---</div>
                </div>
            </div>

            <div id="grid-container" class="gpu-grid">
                </div>

            <div class="bg-black border-t border-[#333] flex items-center px-4 text-[10px] font-mono">
                <span class="text-green-600 mr-2">root@h100-cluster:~#</span>
                <span id="console-log" class="text-gray-400">tail -f /var/log/gpu_telemetry.log</span>
            </div>

            <script>
                // Fallback Data (Îπà ÌôîÎ©¥ Î∞©ÏßÄ)
                const FALLBACK = {
                    "summary": {"total": 4, "active": 4, "training": 2, "error": 0},
                    "nodes": Array.from({length: 20}, (_, i) => ({
                        id: `DEMO-NODE-${i}`, model: "NVIDIA H100", status: "ACTIVE", workload: "Initializing...",
                        metrics: { util: 50, temp: 40, power: 100, fan: 30, vram_total: 80, vram_used: 10 }
                    }))
                };

                let nodes = [];

                async function init() {
                    try {
                        const res = await fetch('dashboard_data.json');
                        if(!res.ok) throw new Error("404");
                        const data = await res.json();
                        nodes = data.nodes;
                    } catch(e) {
                        nodes = FALLBACK.nodes;
                    }
                    renderOnce();
                    startPhysicsEngine();
                }

                function renderOnce() {
                    const container = document.getElementById('grid-container');
                    container.innerHTML = nodes.map((n, i) => createCardHTML(n, i)).join('');
                    updateStats();
                }

                function createCardHTML(n, i) {
                    const ledClass = n.status === 'CRITICAL' ? 'led-err' : 'led-on';
                    const borderClass = n.status === 'CRITICAL' ? 'crit' : '';
                    
                    return `
                    <div class="card ${borderClass}" id="card-${i}">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-bold text-white truncate w-24">${n.id}</div>
                            <div class="text-[9px] bg-[#222] px-1 rounded text-gray-400">${n.model}</div>
                        </div>
                        
                        <div class="flex items-center gap-2 mb-2">
                            <div class="led ${ledClass}" id="led-${i}"></div>
                            <div class="text-[9px] truncate text-gray-300 w-full" id="work-${i}">${n.workload}</div>
                        </div>

                        <div class="space-y-1">
                            <div class="flex justify-between"><span>UTIL</span><span id="txt-util-${i}">${n.metrics.util}%</span></div>
                            <div class="bar-track"><div class="bar-fill bg-blue-500" style="width: ${n.metrics.util}%" id="bar-util-${i}"></div></div>
                            
                            <div class="flex justify-between mt-1"><span>VRAM</span><span class="text-gray-500" id="txt-vram-${i}">${n.metrics.vram_used}/${n.metrics.vram_total}G</span></div>
                            <div class="bar-track"><div class="bar-fill bg-purple-500" style="width: ${(n.metrics.vram_used/n.metrics.vram_total)*100}%" id="bar-vram-${i}"></div></div>

                            <div class="flex justify-between mt-1"><span>TEMP</span><span id="txt-temp-${i}">${n.metrics.temp}¬∞C</span></div>
                            <div class="bar-track"><div class="bar-fill bg-green-500" style="width: ${(n.metrics.temp/100)*100}%" id="bar-temp-${i}"></div></div>
                            
                            <div class="flex justify-between mt-1 text-gray-600">
                                <span>FAN</span>
                                <span id="txt-fan-${i}">${n.metrics.fan}%</span>
                            </div>
                        </div>
                    </div>`;
                }

                function updateStats() {
                    const total = nodes.length;
                    const err = nodes.filter(n => n.status === 'CRITICAL').length;
                    const active = total - err;
                    const training = nodes.filter(n => n.workload.includes('Training')).length;
                    const power = nodes.reduce((a, b) => a + b.metrics.power, 0) / 1000;

                    document.getElementById('val-total').innerText = total;
                    document.getElementById('val-active').innerText = active;
                    document.getElementById('val-error').innerText = err;
                    document.getElementById('val-training').innerText = training;
                    document.getElementById('val-power').innerText = power.toFixed(1);
                }

                // [ÌïµÏã¨] 999% Live Physics Engine (Client-Side Simulation)
                function startPhysicsEngine() {
                    setInterval(() => {
                        nodes.forEach((n, i) => {
                            // 1. Physics: ÏõåÌÅ¨Î°úÎìúÏóê Îî∞Î•∏ Î≥ÄÎèôÏÑ± Î∂ÄÏó¨
                            let jitter = Math.random() > 0.5 ? 1 : -1;
                            
                            // Training Ï§ëÏù¥Î©¥ Ïò®ÎèÑÍ∞Ä ÏÑúÏÑúÌûà Ïò§Î¶Ñ
                            if (n.workload.includes('Training')) {
                                if (Math.random() > 0.7) n.metrics.temp += 1;
                                if (n.metrics.util < 99) n.metrics.util += 1;
                            } else {
                                // IdleÏù¥Î©¥ Ïò®ÎèÑÍ∞Ä ÏÑúÏÑúÌûà ÏãùÏùå
                                if (Math.random() > 0.6 && n.metrics.temp > 30) n.metrics.temp -= 1;
                            }
                            
                            // Random Noise (ÏûêÏó∞Ïä§Îü¨Ïö¥ Îñ®Î¶º)
                            n.metrics.util = clamp(n.metrics.util + jitter, 0, 100);
                            n.metrics.temp = clamp(n.metrics.temp + (Math.random() > 0.8 ? jitter : 0), 20, 95);
                            
                            // Critical Check
                            if (n.metrics.temp > 90) {
                                n.status = "CRITICAL";
                                updateLed(i, 'err');
                            } else {
                                n.status = "ACTIVE";
                                updateLed(i, 'on');
                            }

                            // Update DOM (Efficiently)
                            document.getElementById(`txt-util-${i}`).innerText = n.metrics.util + "%";
                            document.getElementById(`bar-util-${i}`).style.width = n.metrics.util + "%";
                            
                            document.getElementById(`txt-temp-${i}`).innerText = n.metrics.temp + "¬∞C";
                            const tempBar = document.getElementById(`bar-temp-${i}`);
                            tempBar.style.width = (n.metrics.temp / 100 * 100) + "%";
                            tempBar.className = `bar-fill ${n.metrics.temp > 80 ? 'bg-red-500' : 'bg-green-500'}`;
                            
                            document.getElementById(`txt-fan-${i}`).innerText = Math.floor(n.metrics.temp * 1.1) + "%";
                        });
                        
                        updateStats();

                        // Random Console Log
                        if(Math.random() > 0.9) {
                            const logs = [
                                "[KERNEL] NVLink connection unstable on GPU-04",
                                "[CUDA] Out of Memory retry... success",
                                "[COOLING] Fan curve adjusted (+10%)",
                                "[JOB] Checkpoint saved: model_v3.pt"
                            ];
                            const logLine = document.getElementById('console-log');
                            logLine.innerText = logs[Math.floor(Math.random() * logs.length)] + " [" + new Date().toISOString().split('T')[1] + "]";
                            logLine.classList.add('text-white');
                            setTimeout(() => logLine.classList.remove('text-white'), 200);
                        }

                    }, 800); // 0.8Ï¥àÎßàÎã§ Í∞±Ïã† (Îπ†Î•∏ Î∞òÏùë ÏÜçÎèÑ)
                }

                function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
                function updateLed(i, status) {
                    const led = document.getElementById(`led-${i}`);
                    const card = document.getElementById(`card-${i}`);
                    if(status === 'err') {
                        led.className = 'led led-err';
                        card.classList.add('crit');
                    } else {
                        led.className = 'led led-on';
                        card.classList.remove('crit');
                    }
                }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: üöÄ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] Deploy (Correct Syntax)
  # ==============================================================================
  deploy:
    needs: build-simulate-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
