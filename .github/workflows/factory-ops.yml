name: ğŸš€ GPU AI Data Center (Hyper-Scale & Live)

on:
  schedule:
    - cron: '*/10 * * * *' # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "gpu-ops-live"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ë°ì´í„° ìƒì„± ë° ì›¹ í˜ì´ì§€ ë¹Œë“œ
  # ==============================================================================
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] ëŒ€ëŸ‰ GPU ë°ì´í„° ìƒì„± ì—”ì§„ (Python)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run GPU Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, uuid
        from datetime import datetime
        from faker import Faker
        fake = Faker()
        
        # ì„¤ì •: ëŒ€ëŸ‰ ë…¸ë“œ ìƒì„± (200ê°œ ì´ìƒ)
        NODE_COUNT = 200
        GPU_MODELS = [
            {"name": "NVIDIA H100", "vram": 80, "tdp": 700},
            {"name": "NVIDIA A100", "vram": 40, "tdp": 400},
            {"name": "RTX 4090",    "vram": 24, "tdp": 450},
            {"name": "Tesla T4",    "vram": 16, "tdp": 70}
        ]
        CLUSTERS = ["US-AI-Lab", "KR-Busan-Edge", "EU-Research", "SG-FinTech"]

        def gen_gpu_fleet():
            nodes = []
            active = 0
            critical = 0
            
            for i in range(NODE_COUNT):
                model = random.choice(GPU_MODELS)
                cluster = random.choice(CLUSTERS)
                
                # ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜
                is_overheat = random.random() < 0.15 # 15% ê³¼ì—´
                status = "CRITICAL" if is_overheat else "ACTIVE"
                if is_overheat: critical += 1
                else: active += 1
                
                # ì˜¨ë„ ë° ë¡œë“œ ê³„ì‚°
                temp = random.randint(90, 105) if is_overheat else random.randint(40, 75)
                util = random.randint(90, 100) if is_overheat else random.randint(10, 85)
                fan = 100 if is_overheat else random.randint(30, 70)
                
                nodes.append({
                    "id": f"GPU-{cluster}-{i:04d}",
                    "model": model['name'],
                    "cluster": cluster,
                    "status": status,
                    "metrics": {
                        "temp": temp,        # ì˜¨ë„ (C)
                        "util": util,        # ì‚¬ìš©ë¥  (%)
                        "vram_used": round(random.uniform(2, model['vram']), 1),
                        "vram_total": model['vram'],
                        "fan": fan,          # íŒ¬ ì†ë„ (%)
                        "power": random.randint(100, model['tdp']) # ì „ë ¥ (W)
                    }
                })
            
            return {
                "updated_at": str(datetime.now()),
                "summary": {"total": NODE_COUNT, "active": active, "critical": critical},
                "nodes": nodes
            }

        if __name__ == "__main__":
            data = gen_gpu_fleet()
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f, indent=2)
            print(f"âœ… Generated {NODE_COUNT} GPU Nodes.")
        EOF
        
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] ë°ì´í„° ì»¤ë°‹ (ì €ì¥ì†Œ ë°˜ì˜)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ Commit & Push
      run: |
        git config --global user.name "GPU-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "ğŸ”¥ GPU Status Update [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped"

    # ----------------------------------------------------------------
    # [Step 3] í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (Live Simulation Engine íƒ‘ì¬)
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build UI with Live Engine
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>GPU CONTROL TOWER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                body { background-color: #050505; color: #a1a1aa; font-family: 'Courier New', monospace; overflow: hidden; }
                
                /* Layout */
                .layout { display: grid; grid-template-rows: 50px 100px 1fr 30px; height: 100vh; }
                
                /* Grid Table */
                .gpu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 4px; padding: 4px; overflow-y: auto; }
                
                /* Card Style */
                .gpu-card { background: #0f0f0f; border: 1px solid #27272a; padding: 10px; font-size: 11px; position: relative; }
                .gpu-card.critical { border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.2); }
                .gpu-card:hover { background: #18181b; }
                
                /* Visual Bars */
                .bar-bg { width: 100%; background: #27272a; height: 4px; margin-top: 2px; }
                .bar-fill { height: 100%; transition: width 0.5s; }
                
                /* Animations */
                .blink { animation: blinker 1s linear infinite; }
                @keyframes blinker { 50% { opacity: 0; } }
            </style>
        </head>
        <body class="layout">
            
            <header class="flex items-center justify-between px-4 border-b border-zinc-800 bg-black">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ”¥</span>
                    <h1 class="text-lg font-bold text-white tracking-[0.2em]">NVIDIA <span class="text-green-500">GPU OPS</span></h1>
                </div>
                <div class="text-xs text-zinc-500">
                    LIVE CONNECTION: <span class="text-green-500 font-bold">ESTABLISHED (99.9%)</span>
                </div>
            </header>

            <div class="grid grid-cols-4 gap-4 p-4 border-b border-zinc-800 bg-[#0a0a0a]">
                <div class="p-2 border border-zinc-800 bg-black text-center">
                    <div class="text-[10px] text-zinc-500">TOTAL NODES</div>
                    <div id="stat-total" class="text-2xl text-white font-bold">0</div>
                </div>
                <div class="p-2 border border-zinc-800 bg-black text-center">
                    <div class="text-[10px] text-zinc-500">ACTIVE</div>
                    <div id="stat-active" class="text-2xl text-green-500 font-bold">0</div>
                </div>
                <div class="p-2 border border-zinc-800 bg-black text-center">
                    <div class="text-[10px] text-zinc-500">CRITICAL / OVERHEAT</div>
                    <div id="stat-crit" class="text-2xl text-red-500 font-bold blink">0</div>
                </div>
                <div class="p-2 border border-zinc-800 bg-black text-center">
                    <div class="text-[10px] text-zinc-500">TOTAL POWER (kW)</div>
                    <div id="stat-power" class="text-2xl text-yellow-500 font-bold">0</div>
                </div>
            </div>

            <div id="gpu-container" class="gpu-grid custom-scroll">
                </div>

            <div class="bg-black border-t border-zinc-800 flex items-center px-4 text-[10px] text-green-700 font-mono">
                <span class="mr-2"> > SYSTEM_DAEMON:</span>
                <span id="log-line">Initializing monitoring sequence...</span>
            </div>

            <script>
                // [ì•ˆì „ì¥ì¹˜] ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•  ë”ë¯¸ ë°ì´í„°
                const FALLBACK = {
                    "summary": {"total": 4, "active": 3, "critical": 1},
                    "nodes": [
                        {"id": "GPU-FALLBACK-01", "model": "NVIDIA H100", "status": "ACTIVE", "metrics": {"temp": 65, "util": 80, "vram_used": 40, "vram_total": 80}},
                        {"id": "GPU-FALLBACK-02", "model": "NVIDIA A100", "status": "CRITICAL", "metrics": {"temp": 98, "util": 99, "vram_used": 39, "vram_total": 40}},
                        {"id": "GPU-FALLBACK-03", "model": "RTX 4090", "status": "ACTIVE", "metrics": {"temp": 55, "util": 10, "vram_used": 12, "vram_total": 24}},
                        {"id": "GPU-FALLBACK-04", "model": "NVIDIA H100", "status": "ACTIVE", "metrics": {"temp": 70, "util": 92, "vram_used": 75, "vram_total": 80}}
                    ]
                };

                let gpuNodes = [];

                async function init() {
                    try {
                        const res = await fetch('dashboard_data.json');
                        if(!res.ok) throw new Error("Load fail");
                        const data = await res.json();
                        gpuNodes = data.nodes;
                    } catch(e) {
                        gpuNodes = FALLBACK.nodes;
                    }
                    
                    renderInitial();
                    startLiveUpdate(); // 999% Update Logic Start
                }

                function renderInitial() {
                    const container = document.getElementById('gpu-container');
                    container.innerHTML = '';

                    gpuNodes.forEach((node, idx) => {
                        // ì¹´ë“œ HTML ìƒì„±
                        const div = document.createElement('div');
                        div.id = `card-${idx}`;
                        div.className = `gpu-card ${node.status === 'CRITICAL' ? 'critical' : ''}`;
                        div.innerHTML = getCardHTML(node);
                        container.appendChild(div);
                    });
                    updateStats();
                }

                function getCardHTML(node) {
                    // Color Logic
                    const tempColor = node.metrics.temp > 85 ? '#ef4444' : (node.metrics.temp > 70 ? '#eab308' : '#22c55e');
                    const utilColor = node.metrics.util > 90 ? '#ef4444' : '#3b82f6';
                    
                    return `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-white">${node.id}</span>
                            <span class="text-[9px] border px-1 border-zinc-700 rounded">${node.model}</span>
                        </div>
                        <div class="flex justify-between text-zinc-500 mb-2">
                            <span>${node.cluster}</span>
                            <span class="${node.status==='CRITICAL'?'text-red-500 font-bold':''}">${node.status}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <div class="flex justify-between"><span>TEMP</span> <span class="text-white" id="val-temp">${node.metrics.temp}Â°C</span></div>
                                <div class="bar-bg"><div class="bar-fill" style="width:${node.metrics.temp/1.1}%; background:${tempColor}"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between"><span>UTIL</span> <span class="text-white" id="val-util">${node.metrics.util}%</span></div>
                                <div class="bar-bg"><div class="bar-fill" style="width:${node.metrics.util}%; background:${utilColor}"></div></div>
                            </div>
                            <div class="col-span-2 mt-1">
                                <div class="flex justify-between"><span>VRAM (${node.metrics.vram_total}GB)</span> <span class="text-zinc-400">${node.metrics.vram_used}GB</span></div>
                                <div class="bar-bg"><div class="bar-fill" style="width:${(node.metrics.vram_used/node.metrics.vram_total)*100}%; background:#a855f7"></div></div>
                            </div>
                        </div>
                    `;
                }

                function updateStats() {
                    const total = gpuNodes.length;
                    const crit = gpuNodes.filter(n => n.status === 'CRITICAL').length;
                    const active = total - crit;
                    const power = gpuNodes.reduce((acc, curr) => acc + (curr.metrics.power || 0), 0) / 1000;

                    document.getElementById('stat-total').innerText = total;
                    document.getElementById('stat-active').innerText = active;
                    document.getElementById('stat-crit').innerText = crit;
                    document.getElementById('stat-power').innerText = power.toFixed(1);
                }

                // [í•µì‹¬] Live Simulation Engine (999% Update Feel)
                function startLiveUpdate() {
                    setInterval(() => {
                        // 1. Random Jitter (ë°ì´í„° ë¯¸ì„¸ ë³€ë™ ì‹œë®¬ë ˆì´ì…˜)
                        gpuNodes.forEach((node, idx) => {
                            // ë³€ë™í­ ì„¤ì • (-2 ~ +2)
                            const jitter = Math.floor(Math.random() * 5) - 2;
                            
                            // ì˜¨ë„ ì—…ë°ì´íŠ¸
                            node.metrics.temp += jitter;
                            if(node.metrics.temp < 30) node.metrics.temp = 30;
                            if(node.metrics.temp > 110) node.metrics.temp = 110;
                            
                            // ë¡œë“œ ì—…ë°ì´íŠ¸
                            node.metrics.util += jitter;
                            if(node.metrics.util < 0) node.metrics.util = 0;
                            if(node.metrics.util > 100) node.metrics.util = 100;

                            // ìƒíƒœ ìë™ ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜
                            if(node.metrics.temp > 90) node.status = "CRITICAL";
                            else node.status = "ACTIVE";

                            // DOM ì—…ë°ì´íŠ¸
                            const card = document.getElementById(`card-${idx}`);
                            if(card) {
                                card.innerHTML = getCardHTML(node);
                                if(node.status === 'CRITICAL') card.classList.add('critical');
                                else card.classList.remove('critical');
                            }
                        });
                        
                        // 2. í†µê³„ ê°±ì‹ 
                        updateStats();

                        // 3. ë¡œê·¸ ê°±ì‹ 
                        const logMsg = [
                            "Adjusting fan speeds for cluster KR-Busan...",
                            "Syncing tensor cores...",
                            "Optimizing power delivery...",
                            "Collecting telemetry data..."
                        ];
                        document.getElementById('log-line').innerText = logMsg[Math.floor(Math.random()*logMsg.length)] + " [" + new Date().toLocaleTimeString() + "]";

                    }, 1000); // 1ì´ˆë§ˆë‹¤ í™”ë©´ ê°±ì‹  (Real-time ëŠë‚Œ)
                }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: ğŸš€ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] ë°°í¬ (ìˆ˜ì •ëœ êµ¬ë¬¸)
  # ==============================================================================
  deploy:
    needs: build-and-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
