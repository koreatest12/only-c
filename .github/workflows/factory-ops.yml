name: üåå Galaxy Ops:Final Frontier (v10.0)

on:
  schedule:
    - cron: '*/5 * * * *' # 5Î∂ÑÎßàÎã§ Í∞±Ïã†
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "galaxy-ops-final-v10"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ÎåÄÍ∑úÎ™® Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Î∞è ÌôÄÎ°úÍ∑∏ÎûòÌîΩ UI ÎπåÎìú
  # ==============================================================================
  build-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Setup Python
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }

    - name: üì¶ Install Deps
      run: pip install faker

    # ----------------------------------------------------------------
    # [Step 1] üè≠ ÌñâÏÑ±Í∏â Îç∞Ïù¥ÌÑ∞ ÏóîÏßÑ (Planetary Data Engine)
    # ----------------------------------------------------------------
    - name: üè≠ Run Planetary Data Engine
      shell: bash
      run: |
        cat <<'EOF' > db_engine.py
        import json, random, datetime, uuid
        from faker import Faker
        fake = Faker()
        
        # ÏÑ§Ï†ï: 120Í∞ú Ïù¥ÏÉÅÏùò ÎÖ∏Îìú, 5Í∞ú ÌñâÏÑ± ÏÑπÌÑ∞
        SECTORS = [
            {"name": "EARTH-CORE", "code": "TER", "color": "blue"},
            {"name": "LUNAR-BASE", "code": "LUN", "color": "gray"},
            {"name": "MARS-COLONY", "code": "MRS", "color": "red"},
            {"name": "TITAN-OUTPOST", "code": "TTN", "color": "yellow"},
            {"name": "ORBITAL-STATION", "code": "ORB", "color": "cyan"}
        ]
        
        SERVICES = ["Life-Support", "Quantum-Net", "Fusion-Reactor", "Defense-Grid", "AI-Cortex"]

        def gen_radar_blips():
            # Î†àÏù¥ÎçîÏóê Ïû°ÌûàÎäî ÎØ∏ÌôïÏù∏ Î¨ºÏ≤¥
            blips = []
            for _ in range(5):
                blips.append({
                    "angle": random.randint(0, 360),
                    "dist": random.randint(10, 90),
                    "type": random.choice(["FRIENDLY", "HOSTILE", "UNKNOWN"])
                })
            return blips

        def gen_system_logs():
            logs = []
            for _ in range(20):
                logs.append(f"[{datetime.datetime.now().strftime('%H:%M:%S')}] {fake.uri_path()} process_id={random.randint(1000,9999)} status=SYNC")
            return logs

        def gen_nodes():
            nodes = []
            for sector in SECTORS:
                # ÏÑπÌÑ∞Îãπ 20~30Í∞ú ÎÖ∏Îìú ÏÉùÏÑ±
                count = random.randint(20, 30)
                for i in range(count):
                    svc = random.choice(SERVICES)
                    is_crit = random.random() < 0.05
                    
                    nodes.append({
                        "id": f"{sector['code']}-{svc[:3].upper()}-{i:03d}",
                        "sector": sector['name'],
                        "color": sector['color'],
                        "service": svc,
                        "status": "CRITICAL" if is_crit else "ACTIVE",
                        "metrics": {
                            "integrity": random.randint(50, 100) if is_crit else random.randint(90, 100),
                            "energy": random.randint(100, 5000),
                            "temp": random.randint(100, 900)
                        },
                        "fw_version": f"v{random.randint(10,12)}.{random.randint(0,9)}"
                    })
            return nodes

        if __name__ == "__main__":
            data = {
                "generated_at": datetime.datetime.now().isoformat(),
                "radar": gen_radar_blips(),
                "logs": gen_system_logs(),
                "nodes": gen_nodes(),
                "global_integrity": random.randint(92, 99)
            }
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f, indent=2)
            print("‚úÖ Planetary Data Generated.")
        EOF
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 2] Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    # ----------------------------------------------------------------
    - name: üíæ Commit Data
      run: |
        git config --global user.name "Commander-Bot"
        git config --global user.email "bot@noreply.github.com"
        git add -f dashboard_data.json
        git commit -m "üöÄ Galaxy Status Update [$(date)]" || echo "No changes"
        git push origin main || echo "Push skipped"

    # ----------------------------------------------------------------
    # [Step 3] ÌîÑÎ°†Ìä∏ÏóîÎìú (Holographic HUD & Radar)
    # ----------------------------------------------------------------
    - name: üé® Build Holographic Interface
      shell: bash
      run: |
        mkdir -p _site
        cp dashboard_data.json _site/dashboard_data.json
        
        cat <<'EOF' > _site/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
            <title>GALAXY FINAL FRONTIER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
                
                body { 
                    background-color: #000; 
                    color: #0ff; 
                    font-family: 'Share Tech Mono', monospace; 
                    overflow: hidden; 
                    background-image: 
                        linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
                    background-size: 30px 30px;
                }
                
                /* Layout: Sci-Fi HUD Grid */
                .hud-layout {
                    display: grid;
                    grid-template-columns: 300px 1fr 300px;
                    grid-template-rows: 60px 1fr 200px;
                    height: 100vh;
                    gap: 10px;
                    padding: 10px;
                }
                
                /* Panels */
                .panel {
                    border: 1px solid rgba(0, 255, 255, 0.3);
                    background: rgba(0, 10, 20, 0.8);
                    box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
                    position: relative;
                    overflow: hidden;
                }
                .panel::before {
                    content: ''; position: absolute; top: 0; left: 0; width: 10px; height: 10px;
                    border-top: 2px solid #0ff; border-left: 2px solid #0ff;
                }
                .panel::after {
                    content: ''; position: absolute; bottom: 0; right: 0; width: 10px; height: 10px;
                    border-bottom: 2px solid #0ff; border-right: 2px solid #0ff;
                }
                .panel-header {
                    background: rgba(0, 255, 255, 0.1);
                    padding: 5px 10px;
                    font-weight: bold;
                    letter-spacing: 2px;
                    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
                    display: flex; justify-content: space-between;
                }

                /* Radar Animation */
                .radar-scope {
                    width: 200px; height: 200px;
                    border: 2px solid rgba(0, 255, 255, 0.5);
                    border-radius: 50%;
                    position: relative;
                    margin: 20px auto;
                    background: radial-gradient(circle, rgba(0,255,255,0.1) 0%, transparent 70%);
                }
                .radar-sweep {
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    border-radius: 50%;
                    background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 255, 0.4) 360deg);
                    animation: radar-spin 2s linear infinite;
                    clip-path: polygon(50% 50%, 100% 0, 100% 0, 50% 0);
                }
                .blip {
                    position: absolute; width: 6px; height: 6px; border-radius: 50%;
                    background: #f00; box-shadow: 0 0 5px #f00;
                    animation: blink 1s infinite;
                }
                
                /* Main Grid */
                .sector-grid {
                    display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                    gap: 5px; padding: 10px; overflow-y: auto;
                }
                .node-card {
                    border: 1px solid #033; background: #011; padding: 5px; font-size: 10px; cursor: pointer;
                    transition: all 0.2s;
                }
                .node-card:hover { border-color: #0ff; background: #022; transform: scale(1.05); z-index: 10; }
                .node-card.crit { border-color: #f00; background: #200; animation: flash 1s infinite; }
                
                /* Log Stream */
                .log-stream {
                    font-size: 11px; line-height: 1.4; color: #0f0;
                    text-shadow: 0 0 2px #0f0;
                    overflow-y: hidden;
                }
                
                /* Keyframes */
                @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                @keyframes blink { 50% { opacity: 0; } }
                @keyframes flash { 0%, 100% { border-color: #f00; } 50% { border-color: #fff; } }
                
                /* Scrollbar */
                ::-webkit-scrollbar { width: 5px; }
                ::-webkit-scrollbar-thumb { background: #0ff; }
            </style>
        </head>
        <body class="hud-layout">
            
            <header class="col-span-3 panel flex items-center justify-between px-6 bg-black">
                <div class="flex items-center gap-4">
                    <i class="fas fa-satellite-dish text-3xl text-cyan-400 animate-pulse"></i>
                    <div>
                        <h1 class="text-2xl font-bold tracking-[0.3em]">GALAXY <span class="text-white">OPS</span></h1>
                        <div class="text-xs text-cyan-600">SECTOR CONTROL // V10.0 FINAL</div>
                    </div>
                </div>
                <div class="flex gap-8 text-xl font-bold">
                    <div class="text-center">
                        <div class="text-[10px] text-gray-500">INTEGRITY</div>
                        <div id="integrity-val" class="text-green-400">98%</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] text-gray-500">ACTIVE NODES</div>
                        <div id="active-val">--</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] text-gray-500">THREAT LEVEL</div>
                        <div class="text-red-500 animate-pulse">ELEVATED</div>
                    </div>
                </div>
                <button onclick="window.location.reload()" class="border border-cyan-500 px-4 py-2 hover:bg-cyan-900 transition text-xs">
                    SYSTEM REFRESH
                </button>
            </header>

            <aside class="panel flex flex-col">
                <div class="panel-header"><span>SECTOR RADAR</span> <span>LIVE</span></div>
                <div class="flex-1 flex flex-col items-center justify-center relative">
                    <div class="radar-scope" id="radar">
                        <div class="radar-sweep"></div>
                        </div>
                    <div class="text-xs text-center mt-2">
                        SCANNING SECTOR 4...<br>
                        <span class="text-red-500" id="radar-count">0 CONTACTS</span>
                    </div>
                </div>
                <div class="h-1/3 border-t border-cyan-900 p-2 overflow-y-auto">
                    <div class="text-[10px] font-bold mb-1">> ALERT QUEUE</div>
                    <div id="alert-box" class="space-y-1 text-[10px] text-red-400"></div>
                </div>
            </aside>

            <main class="panel flex flex-col">
                <div class="panel-header">
                    <span>SERVICE FLEET</span>
                    <div class="flex gap-2 text-[10px]">
                        <span class="text-blue-400">‚ñ† EARTH</span>
                        <span class="text-gray-400">‚ñ† MOON</span>
                        <span class="text-red-400">‚ñ† MARS</span>
                    </div>
                </div>
                <div id="node-grid" class="sector-grid custom-scroll flex-1">
                    </div>
            </main>

            <aside class="panel flex flex-col">
                <div class="panel-header"><span>COMMAND</span></div>
                <div class="p-4 space-y-4">
                    <button onclick="deployEffect()" class="w-full border border-green-500 text-green-500 py-3 hover:bg-green-900/50 transition font-bold">
                        <i class="fas fa-upload mr-2"></i> DEPLOY FIRMWARE
                    </button>
                    <button onclick="purgeEffect()" class="w-full border border-yellow-500 text-yellow-500 py-3 hover:bg-yellow-900/50 transition font-bold">
                        <i class="fas fa-broom mr-2"></i> PURGE CACHE
                    </button>
                    <button onclick="emergencyEffect()" class="w-full border border-red-500 text-red-500 py-3 hover:bg-red-900/50 transition font-bold animate-pulse">
                        <i class="fas fa-radiation-alt mr-2"></i> EMERGENCY SHUTDOWN
                    </button>
                </div>
                <div class="flex-1 border-t border-cyan-900 p-2">
                    <div class="text-[10px] text-cyan-600 mb-1">> SYSTEM STATUS</div>
                    <div class="h-full bg-black border border-cyan-900 p-1 relative overflow-hidden">
                        <div class="absolute bottom-0 w-full h-1 bg-green-500" id="cpu-bar" style="height: 40%"></div>
                    </div>
                </div>
            </aside>

            <footer class="col-span-3 panel flex flex-col">
                <div class="panel-header"><span>GLOBAL EVENT STREAM</span> <span>ENCRYPTED</span></div>
                <div id="log-stream" class="log-stream p-2 flex-1"></div>
            </footer>

            <script>
                let globalData = {};

                async function init() {
                    try {
                        const res = await fetch('dashboard_data.json?v=' + Date.now());
                        globalData = await res.json();
                        
                        renderRadar();
                        renderNodes();
                        renderLogs();
                        
                        document.getElementById('integrity-val').innerText = globalData.global_integrity + "%";
                        document.getElementById('active-val').innerText = globalData.nodes.length;
                        
                        // Physics Loop
                        setInterval(visualPhysics, 100);
                        setInterval(addRandomLog, 500);
                        
                    } catch(e) { console.error("Offline"); }
                }

                function renderRadar() {
                    const radar = document.getElementById('radar');
                    // Clear old blips (keep sweep)
                    const oldBlips = radar.querySelectorAll('.blip');
                    oldBlips.forEach(b => b.remove());
                    
                    globalData.radar.forEach(b => {
                        const blip = document.createElement('div');
                        blip.className = 'blip';
                        // Convert Polar to Cartesian for CSS
                        const r = b.dist; 
                        const theta = b.angle * (Math.PI / 180);
                        const x = 100 + r * Math.cos(theta);
                        const y = 100 + r * Math.sin(theta);
                        
                        blip.style.left = x + 'px';
                        blip.style.top = y + 'px';
                        if(b.type === 'HOSTILE') blip.style.backgroundColor = '#f00';
                        else if(b.type === 'FRIENDLY') blip.style.backgroundColor = '#0f0';
                        
                        radar.appendChild(blip);
                    });
                    document.getElementById('radar-count').innerText = globalData.radar.length + " CONTACTS";
                }

                function renderNodes() {
                    const grid = document.getElementById('node-grid');
                    grid.innerHTML = globalData.nodes.map((n, i) => `
                        <div class="node-card ${n.status==='CRITICAL'?'crit':''}" id="node-${i}">
                            <div class="flex justify-between text-[9px] mb-1">
                                <span class="font-bold text-${getColor(n.color)}-400">${n.sector}</span>
                                <span>${n.fw_version}</span>
                            </div>
                            <div class="text-white font-bold truncate">${n.id}</div>
                            <div class="flex justify-between mt-1 text-gray-400">
                                <span>NRG: ${n.metrics.energy}</span>
                                <span>TMP: ${n.metrics.temp}</span>
                            </div>
                            <div class="w-full bg-gray-800 h-1 mt-1">
                                <div class="h-full ${n.status==='CRITICAL'?'bg-red-500':'bg-cyan-500'}" style="width:${n.metrics.integrity}%"></div>
                            </div>
                        </div>
                    `).join('');
                }
                
                function getColor(c) {
                    // Tailwind mapping
                    if(c==='blue') return 'blue';
                    if(c==='red') return 'red';
                    if(c==='yellow') return 'yellow';
                    return 'gray';
                }

                function renderLogs() {
                    const div = document.getElementById('log-stream');
                    globalData.logs.forEach(l => {
                        div.innerHTML += `<div>${l}</div>`;
                    });
                }
                
                function addRandomLog() {
                    const div = document.getElementById('log-stream');
                    const lines = [
                        "Decrypting incoming transmission...",
                        "Packets dropped on sector 7",
                        "AI Cortex rerouting power...",
                        "Handshake successful [Titan-Outpost]",
                        "Scanning for unauthorized access..."
                    ];
                    const line = document.createElement('div');
                    line.innerText = `> ${lines[Math.floor(Math.random()*lines.length)]}`;
                    div.prepend(line);
                    if(div.children.length > 15) div.lastChild.remove();
                }

                function visualPhysics() {
                    // Randomly fluctuate CPU bar
                    const h = Math.random() * 100;
                    document.getElementById('cpu-bar').style.height = h + "%";
                }

                // --- EFFECTS ---
                window.deployEffect = function() {
                    alert("INITIATING GLOBAL FIRMWARE UPDATE...\nThis will affect all 5 sectors.");
                }
                window.purgeEffect = function() {
                    alert("PURGING CACHE...\nTemp files deleted.");
                }
                window.emergencyEffect = function() {
                    document.body.style.filter = "sepia(1) hue-rotate(-50deg) saturate(5)";
                    setTimeout(() => { document.body.style.filter = "none"; }, 2000);
                }

                init();
            </script>
        </body>
        </html>
        EOF

    - name: üöÄ Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with: { path: _site/ }

  # ==============================================================================
  # [Job 2] Î∞∞Ìè¨ (Íµ¨Î¨∏ ÏóêÎü¨ ÏôÑÎ≤Ω ÏàòÏ†ï)
  # ==============================================================================
  deploy:
    needs: build-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
