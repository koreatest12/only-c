name: ğŸš€ 2026 Ultimate Hyper-Speed System (Parallel Unlocked)

on:
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "main", "master" ]
  
  # [NEW] ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ê¸°ëŠ¥ ì¶”ê°€ (ì¬ì‚¬ìš©ì„± ê·¹ëŒ€í™”)
  workflow_call:
    inputs:
      data_count:
        description: 'Callerë¡œë¶€í„° ì „ë‹¬ë°›ì„ ë°ì´í„° ìˆ˜'
        required: false
        default: '500000'
        type: string

  workflow_dispatch:
    inputs:
      data_count:
        description: 'ìƒì„±í•  ë°ì´í„° í–‰ ìˆ˜ (ê¸°ë³¸: 1,000,000)'
        required: true
        default: '1000000'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHONIOENCODING: "utf-8"
  # ì…ë ¥ê°’ ìš°ì„ ìˆœìœ„ ì²˜ë¦¬ (Dispatch > Call > Default)
  DATA_COUNT: ${{ inputs.data_count || '1000000' }}

permissions:
  contents: write
  packages: write
  actions: write

# [CRITICAL] ë™ì‹œì„± ì œí•œ(Concurrency) ì œê±°
# ê¸°ì¡´ì˜ concurrency: group: ... êµ¬ë¬¸ì„ ì‚­ì œí•˜ì—¬
# ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì‹œì— í­ë°œì ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ í—ˆìš©í•¨.

jobs:
  # ==================================================================================
  # JOB 1: ì´ˆê³ ì† ë³‘ë ¬ ë¹Œë“œ & ë°ì´í„° ìƒì„± (ì¶©ëŒ ë°©ì§€ ì•„í‚¤í…ì²˜ ì ìš©)
  # ==================================================================================
  managed-build:
    name: âš¡ Hyper-Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4

    # [Isolation] ì‹¤í–‰ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ ë™ì  ìƒì„± (ì¤‘ë³µ ì‹¤í–‰ ì‹œ ì¶©ëŒ ë°©ì§€)
    - name: âš™ï¸ Set Dynamic Environment
      run: |
        RUN_ID="${{ github.run_id }}"
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          echo "ARTIFACT_NAME=Binary-Linux-${RUN_ID}" >> $GITHUB_ENV
          echo "OS_TYPE=Linux" >> $GITHUB_ENV
        else
          echo "ARTIFACT_NAME=Binary-Windows-${RUN_ID}" >> $GITHUB_ENV
          echo "OS_TYPE=Windows" >> $GITHUB_ENV
        fi
        echo "âœ… Dynamic Isolation ID: $RUN_ID"

    # 1. [Speed] ì»´íŒŒì¼ëŸ¬ ìºì‹œ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
    - name: ğŸ› ï¸ Setup Optimization Tools
      run: |
        echo "::: Initializing High-Performance Env for $OS_TYPE :::"
        if [[ "$OS_TYPE" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck tree g++ ccache
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
        else
          choco install cppcheck -y --no-progress
        fi

    # 2. [Speed] Python í™˜ê²½
    - name: ğŸ Setup Python 3.12 with Cache
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Pillow qrcode pandas matplotlib

    # 3. [Speed] Ccache ìºì‹œ ë³µêµ¬
    - name: âš¡ Restore Compiler Cache
      if: runner.os == 'Linux'
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        # OSì™€ í•¨ê»˜ Run IDê°€ ì•„ë‹Œ ë¸Œëœì¹˜ ë“±ì„ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ìºì‹œ íš¨ìœ¨ ê·¹ëŒ€í™”
        key: ${{ runner.os }}-ccache-${{ github.ref_name }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    # ----------------------------------------------------------------
    # 4. [Core] Upgrade Manager: ëŒ€ëŸ‰ ì²˜ë¦¬ ë° I/O ìµœì í™” ì—”ì§„
    # ----------------------------------------------------------------
    - name: ğŸ“ Generate Optimized Upgrade Manager
      run: |
        cat <<'EOF' > upgrade_manager.py
        import os
        import sys
        
        SYSTEM_VERSION = "2026.3.0 (Parallel Edition)"
        GCC_FLAGS = "-O3 -Wall -Wextra -std=c++20 -pthread -march=native"

        def log(msg):
            try: print(f"[âš™ï¸ MANAGER] {msg}")
            except: pass

        def generate_cpp_source():
            log(f"Generating Optimized C++20 Source (v{SYSTEM_VERSION})...")
            
            content = """
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <future>
        #include <random>
        #include <iomanip>
        
        namespace fs = std::filesystem;
        
        long long get_target_count() {
            const char* env_p = std::getenv("DATA_COUNT");
            if(env_p) return std::stoll(env_p);
            return 100000;
        }

        void optimizeIO() {
            std::ios_base::sync_with_stdio(false);
            std::cin.tie(NULL);
        }

        // --- Optimized Data Managers (Buffer Tuning) ---
        class VirtualAccountManager {
        public:
            static void generate(long long count) {
                std::ofstream file("output/data/va_dump.csv");
                char buffer[1024 * 1024]; // 1MB Buffer
                file.rdbuf()->pubsetbuf(buffer, sizeof(buffer));
                
                file << "Bank,Account,Holder,Balance,Status,RiskScore\\n";
                for(long long i=0; i<count; ++i) {
                    file << (i%2==0 ? "KB-2026" : "WOORI-2026") << ","
                         << "562-" << std::setw(8) << std::setfill('0') << i << ","
                         << "User_" << i << ","
                         << (i * 1500) << ","
                         << (i%10==0 ? "Inactive" : "Active") << ","
                         << (i%100) 
                         << "\\n";
                }
                std::cout << "âœ… Accounts Generated: " << count << std::endl;
            }
        };

        class VirtualCardManager {
        public:
            static void generate(long long count) {
                std::ofstream file("output/data/card_dump.csv");
                char buffer[1024 * 1024];
                file.rdbuf()->pubsetbuf(buffer, sizeof(buffer));

                file << "CardNum,CVC,Expiry,Type,Limit\\n";
                for(long long i=0; i<count; ++i) {
                    file << "4222-" << (2026 + i%5) << "-" << std::setw(4) << std::setfill('0') << i%10000 << "-XXXX,"
                         << (i%999) << ",12/30,"
                         << (i%3==0 ? "VISA" : (i%3==1 ? "MASTER" : "AMEX")) << ","
                         << (5000 + (i%10)*1000)
                         << "\\n";
                }
                std::cout << "âœ… Cards Generated: " << count << std::endl;
            }
        };

        int main(int argc, char* argv[]) {
            optimizeIO();
            fs::create_directories("output/data");
            
            long long target = get_target_count();
            std::cout << "ğŸš€ Starting Parallel Engine v{SYSTEM_VERSION} (Target: " << target << ")..." << std::endl;
            
            // Async Execution
            auto f1 = std::async(std::launch::async, VirtualAccountManager::generate, target);
            auto f2 = std::async(std::launch::async, VirtualCardManager::generate, target);
            
            f1.get(); f2.get();
            
            std::cout << "âœ¨ Data Generation Completed." << std::endl;
            return 0;
        }
            """
            final_content = content.replace("{SYSTEM_VERSION}", SYSTEM_VERSION)
            with open("enterprise_main.cpp", "w", encoding="utf-8") as f:
                f.write(final_content.strip())

        def generate_build_files():
            log("Generating Build Systems...")
            makefile_content = f"""
        CXX = ccache g++
        CXXFLAGS = {GCC_FLAGS}
        TARGET = server_app_core
        SRCS = enterprise_main.cpp
        all: $(TARGET)
        $(TARGET): $(SRCS)
        \t$(CXX) $(CXXFLAGS) $(SRCS) -o $(TARGET)
        clean:
        \trm -f $(TARGET)
            """
            with open("Makefile", "w", encoding="utf-8") as f: f.write(makefile_content.strip())

            cmake = """
        cmake_minimum_required(VERSION 3.15)
        project(MassiveServer2026)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(enterprise_main enterprise_main.cpp)
        if(UNIX)
            add_compile_options(-O3 -Wall -Wextra -pthread -march=native)
        endif()
        """
            with open("CMakeLists.txt", "w", encoding="utf-8") as f: f.write(cmake.strip())

        if __name__ == "__main__":
            generate_cpp_source()
            generate_build_files()
            log("âœ… Optimization Applied.")
        EOF

    - name: ğŸ”„ Execute Upgrade Manager
      run: python upgrade_manager.py

    # 5. ë¹Œë“œ ë° ì‹¤í–‰
    - name: ğŸ’¥ Build & Run (Parallel Safe)
      run: |
        mkdir -p output_data/data
        
        if [[ "$OS_TYPE" == "Linux" ]]; then
          make -j$(nproc) all
          chmod +x server_app_core
          cp server_app_core final_binary
          ./server_app_core
        else
          mkdir -p build
          cd build
          cmake ..
          cmake --build . --config Release --parallel
          cd ..
          cp build/Release/enterprise_main.exe final_binary.exe
          ./build/Release/enterprise_main.exe
        fi
        
        if [ -d "output" ]; then cp -r output/* output_data/; fi

    # 6. ë¦¬í¬íŠ¸ ìƒì„±
    - name: ğŸ“Š Generate Report
      run: |
        cat <<'EOF' > gen_report.py
        import os
        with open("output_data/report.html", "w") as f: f.write("<h1>Done</h1>")
        EOF
        python gen_report.py

    # 7. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ê²©ë¦¬ëœ ì´ë¦„ ì‚¬ìš©)
    - name: ğŸ Finalize
      run: |
        if [[ "$OS_TYPE" == "Linux" ]]; then sha256sum final_binary > checksum.sha256; else sha256sum final_binary.exe > checksum.sha256; fi

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}  # Run IDê°€ í¬í•¨ëœ ê³ ìœ  ì´ë¦„
        path: |
          final_binary*
          checksum.sha256
          output_data/

  # ==================================================================================
  # JOB 2: Docker ë¹Œë“œ (ë³‘ë ¬ ì‹¤í–‰ ì‹œ íƒœê·¸ ì¶©ëŒ ë°©ì§€)
  # ==================================================================================
  docker-publish:
    name: ğŸ³ Dockerize
    needs: managed-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      # [Isolation] Linux ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ (ë™ì  ì´ë¦„ ëŒ€ì‘)
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Linux-${{ github.run_id }} # ì •í™•íˆ ë‚´ Run IDì˜ ì•„í‹°íŒ©íŠ¸ë§Œ ê°€ì ¸ì˜´

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Docker Context
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:24.04
          WORKDIR /app
          COPY final_binary /app/server_app
          COPY output_data /app/data
          RUN chmod +x /app/server_app
          CMD ["./server_app"]
          EOF

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # [Concurrency] ì—¬ëŸ¬ workflowê°€ ë™ì‹œì— ëŒì•„ë„ ê°ìì˜ Run Numberë¡œ íƒœê¹…í•˜ì—¬ ì¶©ëŒ ì—†ìŒ
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.run_number }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================================================================================
  # JOB 3: í†µí•© ë¦´ë¦¬ì¦ˆ (ë³‘ë ¬ ì•ˆì „ ëª¨ë“œ)
  # ==================================================================================
  release-manager:
    name: ğŸ“¦ Managed Release V3
    needs: [managed-build, docker-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ë‚´ Run IDì— í•´ë‹¹í•˜ëŠ” Windows/Linux íŒŒì¼ë§Œ ë‹¤ìš´ë¡œë“œ
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Linux-${{ github.run_id }}
          path: linux_pkg
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Windows-${{ github.run_id }}
          path: windows_pkg

      - name: ğŸ“¦ Create Release Package
        run: |
          mkdir release_assets
          cp windows_pkg/final_binary.exe release_assets/server_app_2026.exe
          cp linux_pkg/final_binary release_assets/server_app_linux_2026
          cp -r linux_pkg/output_data release_assets/dataset_2026
          cd release_assets
          zip -r ../parallel_system_v${{ github.run_number }}.zip .

      # ë¦´ë¦¬ì¦ˆ ìƒì„± (Main ë¸Œëœì¹˜ì¼ ë•Œë§Œ, íƒœê·¸ ì¶©ëŒ ë°©ì§€)
      - uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v2026.3.0.${{ github.run_number }}
          name: ğŸš€ Parallel System v${{ github.run_number }} (Unlocked)
          body: |
            ## ğŸš€ 2026 Parallel Execution Update
            
            This release enables **Concurrent Workflow Execution**.
            
            ### ğŸ”“ Unlocked Features
            - **Non-Blocking:** Multiple workflows can run simultaneously without waiting.
            - **Workflow Call:** Can be triggered by other pipelines as a submodule.
            - **Isolated Artifacts:** Uses `${{ github.run_id }}` to prevent file collisions.
            
            ğŸ‘‰ **Managed by 2026 Ultimate Pipeline**
          files: parallel_system_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
