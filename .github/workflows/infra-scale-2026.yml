name: ğŸ§¨ Force Account & Mass Directory Loader

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ìƒì„±í•  í”„ë¡œì íŠ¸/í´ë” ìˆ˜ëŸ‰'
        required: true
        default: '50'
        type: string
      data_type:
        description: 'ì ì¬í•  ë°ì´í„° ìœ í˜•'
        required: true
        default: 'mixed'
        type: choice
        options:
          - mixed
          - log_files
          - transaction_data

jobs:
  force-dir-and-load:
    name: âš¡ Mass Directory & Data Load (x${{ inputs.quantity }})
    runs-on: ubuntu-latest
    
    # ê°€ìƒ AWS í™˜ê²½(LocalStack) êµ¬ë™
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,iam,sts
          DEFAULT_REGION: ap-northeast-2
          DEBUG: 1

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. [í•µì‹¬] ë””ë ‰í† ë¦¬ ë° ë°ì´í„° ëŒ€ëŸ‰ ìƒì„± ê³µì¥ ê°€ë™
      # -----------------------------------------------------------
      - name: ğŸ­ Generate Mass Directories & Data
        run: |
          QTY=${{ inputs.quantity }}
          BASE_DIR="mass_archive/2026"
          
          echo "::: [System] ë””ë ‰í† ë¦¬ ëŒ€ëŸ‰ ìƒì„± ë° ë°ì´í„° ì ì¬ ì‹œì‘ (ìˆ˜ëŸ‰: $QTY) :::"
          
          # íŠ¸ë¦¬ êµ¬ì¡° ì‹œê°í™” ë„êµ¬ ì„¤ì¹˜
          sudo apt-get install -y tree

          # ë°˜ë³µë¬¸ìœ¼ë¡œ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± ë° ë°ì´í„° ì ì¬
          for i in $(seq 1 $QTY); do
            # 1) ë³µì¡í•œ ë””ë ‰í† ë¦¬ ê³„ì¸µ êµ¬ì¡° ìƒì„± (ë…„/ì›”/ê·¸ë£¹/ìœ ì €)
            TARGET_DIR="$BASE_DIR/01/group_$(($i % 5 + 1))/user_$i"
            mkdir -p "$TARGET_DIR/logs"
            mkdir -p "$TARGET_DIR/data"
            mkdir -p "$TARGET_DIR/backup"
            
            # 2) ë°ì´í„° ì ì¬ (íŒŒì¼ ìƒì„±)
            # - ì„¤ì • íŒŒì¼ ì ì¬
            echo "user_id=$i, access_level=admin" > "$TARGET_DIR/config.ini"
            
            # - ë¡œê·¸ ë°ì´í„° ì ì¬
            echo "[INFO] $(date) - User $i logged in" > "$TARGET_DIR/logs/access.log"
            echo "[WARN] Connection latency detected" >> "$TARGET_DIR/logs/error.log"
            
            # - ëŒ€ìš©ëŸ‰ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜ (CSV)
            echo "id,timestamp,value" > "$TARGET_DIR/data/transactions.csv"
            for k in {1..10}; do
              echo "$k,$(date +%s),$RANDOM" >> "$TARGET_DIR/data/transactions.csv"
            done
          done
          
          echo "âœ… ë¡œì»¬ ë°ì´í„° ì ì¬ ì™„ë£Œ."
          echo "::: ìƒì„±ëœ ë””ë ‰í† ë¦¬ êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 3ë ˆë²¨) :::"
          tree -L 4 mass_archive | head -n 30

      # -----------------------------------------------------------
      # 2. ê³„ì • ì •ë³´ ê°•ì œ ìƒì„± (ë¬´ì¡°ê±´ í†µê³¼)
      # -----------------------------------------------------------
      - name: ğŸ”‘ Force Credentials
        run: |
          echo "AWS_ACCESS_KEY_ID=test" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=test" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=ap-northeast-2" >> $GITHUB_ENV

      # -----------------------------------------------------------
      # 3. ê°€ìƒ ìŠ¤í† ë¦¬ì§€(S3) ìƒì„± ë° ëŒ€ëŸ‰ ë°ì´í„° ì—…ë¡œë“œ (ì ì¬)
      # -----------------------------------------------------------
      - name: â˜ï¸ Create Bucket & Sync Data
        run: |
          ENDPOINT="http://localhost:4566"
          BUCKET_NAME="mass-data-storage-2026"
          
          echo "::: 1. S3 ë²„í‚· ìƒì„± ($BUCKET_NAME) :::"
          aws --endpoint-url=$ENDPOINT s3 mb s3://$BUCKET_NAME
          
          echo "::: 2. ëŒ€ëŸ‰ ë””ë ‰í† ë¦¬/íŒŒì¼ í´ë¼ìš°ë“œ ì ì¬ (Sync) :::"
          # ë¡œì»¬ì˜ mass_archive í´ë”ë¥¼ í†µì§¸ë¡œ S3ë¡œ ì—…ë¡œë“œ
          aws --endpoint-url=$ENDPOINT s3 sync mass_archive s3://$BUCKET_NAME
          
          echo "::: 3. ì ì¬ ê²°ê³¼ ê²€ì¦ (íŒŒì¼ ëª©ë¡ ì¡°íšŒ) :::"
          COUNT=$(aws --endpoint-url=$ENDPOINT s3 ls s3://$BUCKET_NAME --recursive | wc -l)
          echo "âœ… ì´ $COUNT ê°œì˜ íŒŒì¼ì´ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ì— ì •ìƒ ì ì¬ë˜ì—ˆìŠµë‹ˆë‹¤."

      # -----------------------------------------------------------
      # 4. ê²°ê³¼ë¬¼(ë””ë ‰í† ë¦¬ ì „ì²´) ì••ì¶• ë° ë‹¤ìš´ë¡œë“œ ì œê³µ
      # -----------------------------------------------------------
      - name: ğŸ“¦ Archive Directory Structure
        uses: actions/upload-artifact@v4
        with:
          name: Mass-Directories-and-Data
          path: mass_archive/
