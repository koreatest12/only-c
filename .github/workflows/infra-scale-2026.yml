name: ğŸ—ï¸ 2026 Mass Infra Scaling (Fixed OIDC & Mass Info)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'í™œë™í™œë™'
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - expand_db_storage
          - add_disk
          - expand_disk
      resource_identifier:
        description: 'ì°¸ê°€ì ID ë˜ëŠ” ì´ë¦„ (ì˜ˆ: db-main-01, vol-data-02)'
        required: true
        type: string
      target_size_gb:
        description: 'ëª©í‘œ í™”ë¶„ (GB ë‹¨ìœ„)'
        required: true
        default: '50'
        type: string
      quantity:
        description: 'ìƒì„± ìˆ˜ëŸ‰ (ëŒ€ëŸ‰ ì‘ì—… ì‹œ ì •ë³´)'
        required: true
        default: '1'
        type: string

permissions:
  contents: read
  id-token: write # [í•„ìˆ˜] OIDC ì¸ì¦ í† í° ë°œê¸‰ ê¶Œí•œ

jobs:
  mass-scaling:
    name: âš™ï¸ Mass Action (${{ inputs.action_type }} x ${{ inputs.quantity }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      # [ìˆ˜ì •ë¨] Terraformìœ¼ë¡œ ìƒì„±í•œ Role ARNì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦
      - name: ğŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # ìœ„ Terraform ì½”ë“œì—ì„œ ìƒì„±ëœ Roleì˜ ARNì„ ì •í™•íˆ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
          # ì˜ˆ: arn:aws:iam::123456789012:role/GitHubAction-Infra-Role
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubAction-Infra-Role
          aws-region: ap-northeast-2

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: ğŸ” Plan Mass Changes
        run: |
          echo "::: ëŒ€ëŸ‰ ì •ë³´ ë° ìš©ëŸ‰ ì„¤ì • í™•ì¸ :::"
          echo "í™˜ê²½: ${{ inputs.environment }}"
          echo "í™œë™: ${{ inputs.action_type }}"
          echo "ëŒ€ìƒ: ${{ inputs.resource_identifier }}"
          echo "ìš©ëŸ‰: ${{ inputs.target_size_gb }} GB"
          echo "ìˆ˜ëŸ‰: ${{ inputs.quantity }} ê°œ"
          
          # ëŒ€ëŸ‰(Mass) ì •ë³´ ë°˜ì˜
          if [ "${{ inputs.action_type }}" == "create_db" ]; then
            terraform plan -var="create_db=true" \
                           -var="db_name_prefix=${{ inputs.resource_identifier }}" \
                           -var="db_storage_size=${{ inputs.target_size_gb }}" \
                           -var="instance_count=${{ inputs.quantity }}" \
                           -out=tfplan

          elif [ "${{ inputs.action_type }}" == "add_disk" ]; then
            terraform plan -var="add_new_disk=true" \
                           -var="disk_name_prefix=${{ inputs.resource_identifier }}" \
                           -var="disk_size=${{ inputs.target_size_gb }}" \
                           -var="disk_count=${{ inputs.quantity }}" \
                           -out=tfplan

          else
            # ê¸°ì¡´ ì¦ì„¤ ë¡œì§ (ë‹¨ì¼ ëŒ€ìƒ)
            terraform plan -var="resize_target=${{ inputs.resource_identifier }}" \
                           -var="new_size=${{ inputs.target_size_gb }}" \
                           -out=tfplan
          fi
        working-directory: ./terraform

      - name: ğŸš€ Apply Changes
        if: inputs.environment == 'prod'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
