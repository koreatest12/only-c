name: ğŸ—ï¸ 2026 Mass Scale (Download from URL)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'í™œë™í™œë™'
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - add_disk
      config_url:
        description: 'ê³µì‹ ì •ë³´ ë‹¤ìš´ë¡œë“œ ì£¼ì†Œ (URL)' # [í•µì‹¬] ëŒ€ëŸ‰ ì •ë³´ê°€ ë‹´ê¸´ JSON íŒŒì¼ ì£¼ì†Œ
        required: true
        default: 'https://api.koreatest12.com/infra/2026-plan.json'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  download-and-deploy:
    name: ğŸ“¥ Download & Apply
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: ğŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubAction-Infra-Role
          aws-region: ap-northeast-2

      # [NEW] ê³µì‹ ì£¼ì†Œì—ì„œ ëŒ€ëŸ‰ ì •ë³´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: ğŸ“¥ Download Mass Config Info
        run: |
          echo "::: ê³µì‹ ì£¼ì†Œì—ì„œ ì •ë³´ ë‹¤ìš´ë¡œë“œ ì¤‘... :::"
          echo "Target URL: ${{ inputs.config_url }}"
          
          # ì¸ì¦ í† í°ì´ í•„ìš”í•œ ê²½ìš° í—¤ë”(-H) ì¶”ê°€ ê°€ëŠ¥. ì—¬ê¸°ì„œëŠ” ê³µê°œ URL ê°€ì •.
          # ì‹¤ì œ ë³´ì•ˆì´ í•„ìš”í•˜ë©´: curl -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" ...
          curl -L -o terraform/mass_config.json "${{ inputs.config_url }}"
          
          echo "::: ë‹¤ìš´ë¡œë“œ ì™„ë£Œ. ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° :::"
          cat terraform/mass_config.json
        shell: bash

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: ğŸ” Plan (Based on Downloaded File)
        run: |
          echo "::: ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„íš ìˆ˜ë¦½ :::"
          
          # Terraform ë³€ìˆ˜ë¡œ íŒŒì¼ ê²½ë¡œë¥¼ ì „ë‹¬í•˜ê±°ë‚˜, Terraform ì½”ë“œ ë‚´ì—ì„œ íŒŒì¼ ì´ë¦„ ê³ ì • ì‚¬ìš©
          terraform plan -var="action_type=${{ inputs.action_type }}" -out=tfplan
        working-directory: ./terraform

      - name: ğŸš€ Apply Changes
        if: inputs.environment == 'prod'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
