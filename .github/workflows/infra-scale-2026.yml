name: ğŸ—ï¸ 2026 Mass Infra Scaling (Keyless OIDC)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'í™œë™í™œë™'
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - expand_db_storage
          - add_disk
          - expand_disk
      resource_identifier:
        description: 'ì°¸ê°€ì ID ë˜ëŠ” ì´ë¦„ (ì˜ˆ: db-main-01, vol-data-02)'
        required: true
        type: string
      target_size_gb:
        description: 'ëª©í‘œ í™”ë¶„ (GB ë‹¨ìœ„) ë˜ëŠ” ìƒì„± ìˆ˜ëŸ‰' # ëŒ€ëŸ‰ ìƒì„±ì„ ìœ„í•´ ì„¤ëª… ë³´ê°•
        required: true
        type: string

# [ì¤‘ìš”] í‚¤ ì—†ëŠ” ì¸ì¦(OIDC)ì„ ìœ„í•´ í•„ìˆ˜ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  id-token: write

jobs:
  infra-scaling:
    name: âš™ï¸ Run (${{ inputs.action_type }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      # [ë³€ê²½] í‚¤ ì…ë ¥ ì—†ì´ IAM Roleì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦
      - name: ğŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # ì•„ë˜ì— ìƒì„±í•œ AWS IAM Roleì˜ ARNì„ ì…ë ¥í•˜ì„¸ìš”
          role-to-assume: arn:aws:iam::123456789012:role/GitHubAction-Infra-Role
          aws-region: ap-northeast-2

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: ğŸ” Plan Infrastructure Changes (Massive)
        run: |
          echo "::: ëŒ€ëŸ‰ ìƒì„± ë° ì¦ì„¤ ì‹¤í–‰ ì •ë³´ :::"
          echo "í™˜ê²½: ${{ inputs.environment }}"
          echo "í™œë™: ${{ inputs.action_type }}"
          echo "ëŒ€ìƒ: ${{ inputs.resource_identifier }}"
          echo "ì…ë ¥ê°’(ìˆ˜ëŸ‰/í¬ê¸°): ${{ inputs.target_size_gb }}"
          
          # action_typeì— ë”°ë¼ ëŒ€ëŸ‰ ìƒì„±(count) ë³€ìˆ˜ ì²˜ë¦¬
          if [ "${{ inputs.action_type }}" == "create_db" ]; then
            # target_size_gbë¥¼ 'ìƒì„± ê°œìˆ˜'ë¡œ í™œìš©í•˜ëŠ” ì˜ˆì‹œ
            terraform plan -var="create_db=true" \
                           -var="db_name_prefix=${{ inputs.resource_identifier }}" \
                           -var="instance_count=${{ inputs.target_size_gb }}" \
                           -out=tfplan
                           
          elif [ "${{ inputs.action_type }}" == "add_disk" ]; then
            # ë””ìŠ¤í¬ ì¶”ê°€ ë¡œì§
            terraform plan -var="add_new_disk=true" \
                           -var="disk_size=${{ inputs.target_size_gb }}" \
                           -out=tfplan

          else
            # ê¸°ì¡´ ì¦ì„¤ ë¡œì§ ìœ ì§€
            terraform plan -var="resize_target=${{ inputs.resource_identifier }}" \
                           -var="new_size=${{ inputs.target_size_gb }}" \
                           -out=tfplan
          fi
        working-directory: ./terraform

      - name: ğŸš€ Apply Changes
        if: inputs.environment == 'prod'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
