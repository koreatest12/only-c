name: ğŸš€ 2026 Next-Gen Enterprise Platform (Permission Fixed)

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ìƒì„± ë¦¬ì†ŒìŠ¤ ìˆ˜ëŸ‰ (User/Bucket/Table)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'ê´€ë¦¬ì ë° ê³ ì‚¬ì–‘ ë¦¬ì†ŒìŠ¤ ë¹„ìœ¨ (%)'
        required: true
        default: '20'
        type: string
  push:
    branches: ["main"]
  schedule:
    - cron: '0 */4 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================================================================================
  # JOB 1: ì°¨ì„¸ëŒ€ í”Œë«í¼ êµ¬ì¶• (Build Next-Gen Platform)
  # ==================================================================================
  build-platform:
    name: âš¡ Phase 1 - Build Cloud Platform
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          # [Fix] DynamoDB ë“± ëª¨ë“  ì„œë¹„ìŠ¤ ëª…ì‹œì  í™œì„±í™”
          SERVICES: iam,sts,s3,dynamodb,sns,sqs,cloudwatch
          DEFAULT_REGION: ap-northeast-2
          DEBUG: 1

    steps:
      - name: ğŸ“‚ Checkout Source
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 1. [Permission & Setup] ê¶Œí•œ ì„¤ì • ë° í™˜ê²½ ëŒ€ëŸ‰ êµ¬ì¶•
      # ------------------------------------------------------------------------
      - name: ğŸ›¡ï¸ Setup Permissions & Env
        run: |
          echo "::: [System] ì‹œìŠ¤í…œ ê¶Œí•œ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ëŒ€ëŸ‰ ì„¤ì • :::"
          
          # 1. ì›¹ ì„œë²„ ë””ë ‰í† ë¦¬ ê¶Œí•œ ë¯¸ë¦¬ í™•ë³´ (í•µì‹¬ ìˆ˜ì • ì‚¬í•­)
          # /var/www/html ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³ , í˜„ì¬ ìœ ì €($USER)ì—ê²Œ ì†Œìœ ê¶Œì„ ë„˜ê¹ë‹ˆë‹¤.
          # ì´ì œ sudo ì—†ì´ë„ ììœ ë¡­ê²Œ index.htmlì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          sudo mkdir -p /var/www/html
          sudo chown -R $USER:$USER /var/www/html
          sudo chmod -R 755 /var/www/html
          echo "âœ… Web Root Permissions Granted to $USER"
          
          # 2. Terraform ì„¤ì¹˜ (ì´ì¤‘ ì²´í¬)
          if ! command -v terraform &> /dev/null; then
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install terraform
          fi
          
          # 3. ë³´ì•ˆ ë„êµ¬(TFLint) ë° Python ë„êµ¬ ì„¤ì¹˜
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib
          sudo apt-get install -y nginx apache2-utils
          
          echo "âœ… All System Dependencies Installed."

      # ------------------------------------------------------------------------
      # 2. [Data Gen] ë©€í‹° ì„œë¹„ìŠ¤ ë°ì´í„° ìƒì„±
      # ------------------------------------------------------------------------
      - name: ğŸ¢ Generate Multi-Service Data
        run: |
          INPUT_QTY="${{ inputs.quantity }}"
          QTY="${INPUT_QTY:-1000}"
          RATIO="${{ inputs.expert_ratio || 20 }}"
          
          mkdir -p terraform_infra admin_dashboard logs
          JSON_FILE="terraform_infra/resources.json"
          COST_LOG="admin_dashboard/cost_estimation.csv"
          
          echo "::: [Gen] $QTY ê°œì˜ ë©€í‹° ë¦¬ì†ŒìŠ¤ ë°ì´í„° ìƒì„± :::"
          echo "[" > $JSON_FILE
          echo "Resource_ID,Type,Owner,Region,Est_Cost_Monthly" > $COST_LOG
          
          DEPTS=("DevOps" "DataTeam" "Backend" "Frontend" "Security")
          
          for i in $(seq 1 $QTY); do
            SUFFIX=$(date +%s%N | cut -b10-13)
            USER="usr_$(printf "%04d" $i)_$SUFFIX"
            BUCKET="bkt-$(printf "%04d" $i)-$SUFFIX"
            TABLE="tbl_$(printf "%04d" $i)_$SUFFIX"
            
            if [ $((RANDOM%100)) -lt $RATIO ]; then 
               TIER="High"; COST="15.50"
            else 
               TIER="Standard"; COST="2.30" 
            fi
            
            DEPT=${DEPTS[$RANDOM % ${#DEPTS[@]}]}
            
            echo "IAM-$i,IAM_User,$USER,ap-northeast-2,0.00" >> $COST_LOG
            echo "S3-$i,S3_Bucket,$BUCKET,ap-northeast-2,$COST" >> $COST_LOG
            
            echo "  { \"username\": \"$USER\", \"bucket\": \"$BUCKET\", \"table\": \"$TABLE\", \"dept\": \"$DEPT\", \"tier\": \"$TIER\" }," >> $JSON_FILE
          done
          
          echo "  { \"username\": \"dummy\", \"bucket\": \"dummy\", \"table\": \"dummy\", \"dept\": \"sys\", \"tier\": \"low\" } ]" >> $JSON_FILE
          echo "âœ… ë°ì´í„° ìƒì„± ì™„ë£Œ."

      # ------------------------------------------------------------------------
      # 3. [IaC] ì¸í”„ë¼ ì½”ë“œ ìƒì„± ë° ë³´ì•ˆ ê²€ì‚¬
      # ------------------------------------------------------------------------
      - name: ğŸ› ï¸ Generate & Audit IaC Code
        run: |
          cat <<EOF > terraform_infra/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            endpoints {
              iam      = "http://localhost:4566"
              s3       = "http://localhost:4566"
              dynamodb = "http://localhost:4566"
              sns      = "http://localhost:4566"
            }
            skip_credentials_validation = true
            skip_requesting_account_id = true
            s3_use_path_style = true
          }
          
          locals { resources = jsondecode(file("\${path.module}/resources.json")) }
          
          resource "aws_iam_user" "users" {
            for_each = { for r in local.resources : r.username => r }
            name = each.value.username
            tags = { Dept = each.value.dept }
          }
          
          resource "aws_s3_bucket" "buckets" {
            for_each = { for r in local.resources : r.bucket => r }
            bucket = each.value.bucket
          }
          
          resource "aws_dynamodb_table" "tables" {
            for_each = { for r in local.resources : r.table => r }
            name           = each.value.table
            billing_mode   = "PAY_PER_REQUEST"
            hash_key       = "PK"
            attribute { name = "PK"; type = "S" }
          }
          EOF
          
          cd terraform_infra
          terraform init
          tflint --init && tflint || echo "Lint warning ignored"
          terraform validate
          echo "âœ… Code Security Check Passed."

      # ------------------------------------------------------------------------
      # 4. [Deploy] ì¸í”„ë¼ ëŒ€ëŸ‰ ë°°í¬
      # ------------------------------------------------------------------------
      - name: ğŸš€ Deploy Cloud Platform
        run: |
          cd terraform_infra
          echo "::: [Deploy] IAM + S3 + DynamoDB ëŒ€ëŸ‰ ë°°í¬ :::"
          terraform apply -auto-approve -parallelism=100
          echo "âœ… í´ë¼ìš°ë“œ í”Œë«í¼ êµ¬ì¶• ì™„ë£Œ."

      # ------------------------------------------------------------------------
      # 5. [FinOps & Chaos] ì›¹ ì„œë²„ ì„¤ì • ë° ì¥ì•  í…ŒìŠ¤íŠ¸ (ê¶Œí•œ ë¬¸ì œ í•´ê²°ë¨)
      # ------------------------------------------------------------------------
      - name: ğŸ’° FinOps & Chaos Simulation
        run: |
          # 1. Nginx ì„¤ì • (sudo ì‚¬ìš©)
          echo "events { worker_connections 2048; } http { server { listen 80; root /var/www/html; } }" > nginx_temp.conf
          sudo mv nginx_temp.conf /etc/nginx/nginx.conf
          
          # [Fix] /var/www/html ì†Œìœ ê¶Œì´ ì´ë¯¸ runnerì—ê²Œ ìˆìœ¼ë¯€ë¡œ sudo ì—†ì´ íŒŒì¼ ìƒì„± ê°€ëŠ¥
          echo "System Initializing..." > /var/www/html/index.html
          sudo service nginx restart
          
          # 2. Chaos: LocalStack ì¬ì‹œì‘ (ì¥ì•  ì‹œë®¬ë ˆì´ì…˜)
          echo "::: [Chaos] DB Connection Failure Simulation :::"
          START=$(date +%s%3N)
          docker stop $(docker ps -q --filter ancestor=localstack/localstack)
          sleep 3
          docker start $(docker ps -a -q --filter ancestor=localstack/localstack)
          
          # 3. Auto-Healing: DynamoDB í™œì„±í™” ëŒ€ê¸° (ì‹œê°„ ì œí•œ ì—°ì¥)
          echo "Waiting for DynamoDB recovery..."
          timeout 90s bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"dynamodb\": \"available\""; do echo "Healing..."; sleep 2; done'
          
          END=$(date +%s%3N)
          echo "Full_Recovery_Time: $((END-START)) ms" > admin_dashboard/recovery_metrics.txt
          
          # 4. ë¶€í•˜ í…ŒìŠ¤íŠ¸
          ab -n 2000 -c 200 http://localhost/ > admin_dashboard/load_test.txt
          echo "âœ… FinOps ë° ì•ˆì •ì„± ê²€ì¦ ì™„ë£Œ."

      # ------------------------------------------------------------------------
      # 6. [Dashboard] ëŒ€ì‹œë³´ë“œ ìƒì„±
      # ------------------------------------------------------------------------
      - name: ğŸ–¥ï¸ Build Next-Gen Dashboard
        run: |
          cat <<EOF > build_web.py
          import pandas as pd
          import datetime, re

          try:
              df_cost = pd.read_csv('admin_dashboard/cost_estimation.csv')
              total_resources = len(df_cost)
              total_cost = df_cost['Est_Cost_Monthly'].sum()
          except: 
              total_resources=0; total_cost=0.0

          try:
              with open('admin_dashboard/load_test.txt') as f:
                  rps = re.search(r'Requests per second:\s+([\d.]+)', f.read()).group(1)
          except: rps="0"
          
          try:
              with open('admin_dashboard/recovery_metrics.txt') as f:
                  rec_time = f.read().split(': ')[1].strip()
          except: rec_time="N/A"

          md = f"""---
          layout: default
          title: 2026 Cloud Platform
          ---
          
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
          
          <div class="container-fluid mt-4 text-white">
              <div class="p-5 bg-dark border border-primary rounded-3 mb-4">
                  <h1 class="display-4 fw-bold text-primary">â˜ï¸ Next-Gen Enterprise Platform</h1>
                  <p class="fs-4">Integrated Management System</p>
                  <span class="badge bg-success">SECURE & COMPLIANT</span>
              </div>

              <div class="row text-center mb-4">
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h5>Resources</h5><h1>{total_resources}</h1></div></div>
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h5>Monthly Cost</h5><h1 class="text-warning">${total_cost:,.2f}</h1></div></div>
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h5>Throughput</h5><h1 class="text-info">{rps}</h1></div></div>
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h5>Recovery</h5><h1 class="text-danger">{rec_time}</h1></div></div>
              </div>
          </div>
          """
          
          with open('admin_dashboard/index.html', 'w') as f: f.write(md)
          with open('admin_dashboard/_config.yml', 'w') as f: f.write("title: 2026 Cloud Platform\ntheme: jekyll-theme-tactile\n")
          EOF
          python build_web.py

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-content
          path: admin_dashboard/

  # ==================================================================================
  # JOB 2: Jekyll ë¹Œë“œ
  # ==================================================================================
  build-pages:
    name: ğŸ—ï¸ Phase 2 - Build Site
    runs-on: ubuntu-latest
    needs: build-platform
    steps:
      - name: ğŸ“¥ Download
        uses: actions/download-artifact@v4
        with:
          name: website-content
          path: .
      - name: âš™ï¸ Setup Pages
        uses: actions/configure-pages@v5
      - name: ğŸ”¨ Build Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
      - name: ğŸ“¦ Upload Pages
        uses: actions/upload-pages-artifact@v3

  # ==================================================================================
  # JOB 3: ë°°í¬
  # ==================================================================================
  deploy-pages:
    name: ğŸš€ Phase 3 - Deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-pages
    steps:
      - name: ğŸŒ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
