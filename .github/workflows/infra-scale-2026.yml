name: ğŸ§¨ 2026 Enterprise Migration & Admin Dashboard System (Final Complete)

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ê´€ë¦¬ ëŒ€ìƒ ê³„ì • ìˆ˜ëŸ‰ (ëª…)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'ì „ë¬¸ê°€(ê´€ë¦¬ì) ë¹„ìœ¨ (%)'
        required: true
        default: '20'
        type: string

  schedule:
    - cron: '*/20 * * * *'

jobs:
  enterprise-control-system:
    name: âš¡ System Migration & Dashboard Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts,s3
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: ğŸ“‚ Checkout System Code
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 0. [NEW] ë°ì´í„° ë¶„ì„ ì„œë²„ í™˜ê²½ ë° ëª¨ë“ˆ ëŒ€ëŸ‰ ì„¤ì¹˜
      # -----------------------------------------------------------
      - name: âš™ï¸ Setup Analytics Server Environment
        run: |
          echo "::: [System] í™ˆí˜ì´ì§€ êµ¬ì¶•ì„ ìœ„í•œ ë°ì´í„° ë¶„ì„ ëª¨ë“ˆ ëŒ€ëŸ‰ ì„¤ì¹˜ ì‹œì‘ :::"
          
          # Pip ì—…ê·¸ë ˆì´ë“œ
          python -m pip install --upgrade pip
          
          # í•µì‹¬ ë°ì´í„° ë¶„ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (Pandas, Numpy ë“±)
          # ëª¨ë“ˆì´ ì—†ì–´ì„œ ë°œìƒí•œ ì—ëŸ¬ë¥¼ í•´ê²°í•˜ëŠ” í•µì‹¬ ë‹¨ê³„ì…ë‹ˆë‹¤.
          pip install pandas numpy
          
          echo "âœ… Python Data Science Environment Ready."
          python --version
          pip list | grep pandas

      # -----------------------------------------------------------
      # 1. [Legacy Gen] ì˜¨í”„ë ˆë¯¸ìŠ¤ ë°ì´í„° ìƒì„± (ë””ë ‰í† ë¦¬ êµ¬ì¡°í™”)
      # -----------------------------------------------------------
      - name: ğŸ¢ Generate Legacy Data Hierarchy
        run: |
          INPUT_QTY="${{ inputs.quantity }}"
          QTY="${INPUT_QTY:-500}"
          RATIO="${{ inputs.expert_ratio || 20 }}"
          
          BASE_DIR="legacy_on_premise_server"
          DEPTS=("DevOps_Team" "Security_Ops" "HR_Admin" "Sales_Global" "Finance_Audit" "R_and_D_Core")
          
          echo "::: [Phase 1] ë ˆê±°ì‹œ ë°ì´í„° ìƒì„± (ì´ $QTY ëª…) :::"
          
          for DEPT in "${DEPTS[@]}"; do
            mkdir -p "$BASE_DIR/$DEPT/user_data"
          done
          
          for i in $(seq 1 $QTY); do
            DEPT=${DEPTS[$RANDOM % ${#DEPTS[@]}]}
            FILE="$BASE_DIR/$DEPT/user_data/personnel_record.csv"
            
            if [ ! -f "$FILE" ]; then echo "Emp_ID,Username,Dept,Role,Email,Risk,Region" > "$FILE"; fi
            
            if [ $(( RANDOM % 100 )) -lt $RATIO ]; then ROLE="Expert-Admin"; RISK="High"; else ROLE="Standard-User"; RISK="Low"; fi
            
            SUFFIX=$(date +%s%N | cut -b10-13)
            USERNAME="user_$(printf "%04d" $i)_$SUFFIX"
            EMP_ID="EMP-$(printf "%05d" $i)"
            EMAIL="$USERNAME@legacy.local"
            REGIONS=("ap-northeast-2" "us-east-1" "eu-central-1")
            REGION=${REGIONS[$RANDOM % ${#REGIONS[@]}]}
            
            echo "$EMP_ID,$USERNAME,$DEPT,$ROLE,$EMAIL,$RISK,$REGION" >> "$FILE"
          done
          echo "âœ… ì˜¨í”„ë ˆë¯¸ìŠ¤ ë°ì´í„° ìƒì„± ì™„ë£Œ."

      # -----------------------------------------------------------
      # 2. [Migration] ë°ì´í„° ì´ê´€ ë° í†µí•©
      # -----------------------------------------------------------
      - name: ğŸšš Execute ETL & Migration
        run: |
          SOURCE="legacy_on_premise_server"
          TARGET="cloud_staging"
          mkdir -p $TARGET terraform_iam admin_dashboard
          
          JSON_FILE="terraform_iam/users.json"
          MIG_LOG="admin_dashboard/migration_history.log"
          FULL_CSV="admin_dashboard/full_database.csv"
          
          echo "[" > $JSON_FILE
          echo "Emp_ID,Username,Dept,Role,Email,Risk,Region,Status" > $FULL_CSV
          
          find $SOURCE -name "*.csv" | while read CSV; do
            tail -n +2 "$CSV" | while IFS=, read -r EMP USER DEPT ROLE MAIL RISK REGION; do
              # Log
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] MIGRATION SUCCESS: $EMP ($USER) -> Cloud($REGION)" >> $MIG_LOG
              # CSV Aggregate
              echo "$EMP,$USER,$DEPT,$ROLE,$MAIL,$RISK,$REGION,Active" >> $FULL_CSV
              
              # Terraform JSON
              cat <<EOF_JSON >> $JSON_FILE
                {
                  "username": "$USER",
                  "group": "$(if [ "$ROLE" == "Expert-Admin" ]; then echo "Expert-Admins"; else echo "Standard-Users"; fi)",
                  "tags": { "Dept": "$DEPT", "EmpID": "$EMP", "Region": "$REGION" }
                },
          EOF_JSON
            done
          done
          sed -i '$ s/,$//' $JSON_FILE
          echo "]" >> $JSON_FILE
          echo "âœ… ë°ì´í„° ì´ê´€ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 3. [Terraform] ì¸í”„ë¼ ë°°í¬ (ë¬¸ë²• ìˆ˜ì • ì™„ë£Œ)
      # -----------------------------------------------------------
      - name: ğŸ› ï¸ Provision Infrastructure
        run: |
          # Multi-line ë¬¸ë²• ì ìš©ìœ¼ë¡œ ì—ëŸ¬ í•´ê²°
          cat <<EOF > terraform_iam/main.tf
          terraform {
            required_providers {
              aws = {
                source  = "hashicorp/aws"
                version = "~> 5.0"
              }
            }
          }

          provider "aws" {
            region                      = "ap-northeast-2"
            access_key                  = "test"
            secret_key                  = "test"
            skip_credentials_validation = true
            skip_requesting_account_id  = true
            endpoints {
              iam = "http://localhost:4566"
            }
          }

          locals {
            users = jsondecode(file("\${path.module}/users.json"))
          }

          resource "aws_iam_user" "u" {
            for_each = { for u in local.users : u.username => u }
            name     = each.value.username
            tags     = each.value.tags
          }
          EOF
          
      - name: ğŸ—ï¸ Terraform Apply
        uses: hashicorp/setup-terraform@v3
        with: { terraform_wrapper: false }
        
      - name: ğŸš€ Deploy
        run: |
          cd terraform_iam
          terraform init
          terraform apply -auto-approve -parallelism=100

      # -----------------------------------------------------------
      # 4. [Chaos] ì¬í•´ ë³µêµ¬ í…ŒìŠ¤íŠ¸
      # -----------------------------------------------------------
      - name: ğŸ›‘ Chaos Test (Stop/Start)
        run: |
          echo "::: ì‹œìŠ¤í…œ ê°•ì œ ì¤‘ë‹¨ ì‹œë®¬ë ˆì´ì…˜ :::"
          docker stop $(docker ps -q --filter ancestor=localstack/localstack)
          sleep 5
          
          echo "::: ì‹œìŠ¤í…œ ë³µêµ¬ ë° ì¬ê°€ë™ :::"
          docker start $(docker ps -a -q --filter ancestor=localstack/localstack)
          timeout 60s bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"iam\": \"available\""; do sleep 2; done'
          
          echo "::: ì¸í”„ë¼ ìƒíƒœ ë™ê¸°í™” (Healing) :::"
          cd terraform_iam
          terraform apply -auto-approve -parallelism=100
          echo "System Recovered at $(date)" > ../admin_dashboard/system_health.txt

      # -----------------------------------------------------------
      # 5. [Web] í†µí•© ê´€ì œ í™ˆí˜ì´ì§€ êµ¬ì¶• (Pandas ì‚¬ìš©)
      # -----------------------------------------------------------
      - name: ğŸ–¥ï¸ Build Admin Dashboard (HTML/JS)
        run: |
          # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ì •ì  HTML ëŒ€ì‹œë³´ë“œ ìƒì„±
          cat <<EOF > build_dashboard.py
          import pandas as pd
          import datetime

          # ë°ì´í„° ë¡œë“œ (Pandas ëª¨ë“ˆ ì‚¬ìš©)
          try:
              df = pd.read_csv('admin_dashboard/full_database.csv')
              total_users = len(df)
              expert_count = len(df[df['Role'] == 'Expert-Admin'])
              depts = df['Dept'].value_counts().to_dict()
              regions = df['Region'].value_counts().to_dict()
          except Exception as e:
              print(f"Error loading data: {e}")
              total_users = 0
              expert_count = 0
              depts = {}
              regions = {}

          # HTML í…œí”Œë¦¿ ìƒì„± (Bootstrap + Chart.js)
          html_content = f"""
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <title>2026 Enterprise IAM Control Center</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body {{ background-color: #1a1a2e; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }}
                  .card {{ background-color: #16213e; border: 1px solid #0f3460; }}
                  .card-title {{ color: #00d4ff; }}
                  .table {{ color: #e0e0e0; }}
                  .status-ok {{ color: #00ff88; font-weight: bold; }}
              </style>
          </head>
          <body>
              <div class="container-fluid p-4">
                  <header class="d-flex justify-content-between align-items-center mb-4">
                      <h1>ğŸš€ 2026 Enterprise Cloud Control Center</h1>
                      <div class="text-end">
                          <p class="mb-0">Last Updated: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
                          <p class="status-ok mb-0">â— System Operational (Recovered)</p>
                      </div>
                  </header>

                  <div class="row mb-4">
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h3>Total Accounts</h3>
                              <div class="display-4">{total_users}</div>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h3>Experts (Admins)</h3>
                              <div class="display-4 text-warning">{expert_count}</div>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h3>Migration Status</h3>
                              <div class="display-4 text-success">100%</div>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h3>Active Regions</h3>
                              <div class="display-4">{len(regions)}</div>
                          </div>
                      </div>
                  </div>

                  <div class="row mb-4">
                      <div class="col-md-6">
                          <div class="card p-3">
                              <h5 class="card-title">Department Distribution</h5>
                              <canvas id="deptChart"></canvas>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card p-3">
                              <h5 class="card-title">Regional Traffic</h5>
                              <canvas id="regionChart"></canvas>
                          </div>
                      </div>
                  </div>

                  <div class="card p-3">
                      <h5 class="card-title mb-3">User Database (Top 50 Preview)</h5>
                      <div class="table-responsive">
                          <table class="table table-hover table-dark table-sm">
                              <thead>
                                  <tr><th>Emp ID</th><th>Username</th><th>Dept</th><th>Role</th><th>Region</th><th>Risk</th></tr>
                              </thead>
                              <tbody>
          """

          # í…Œì´ë¸” ë°ì´í„° ì£¼ì…
          if 'df' in locals():
              for index, row in df.head(50).iterrows():
                  html_content += f"<tr><td>{row['Emp_ID']}</td><td>{row['Username']}</td><td>{row['Dept']}</td><td>{row['Role']}</td><td>{row['Region']}</td><td>{row['Risk']}</td></tr>"

          html_content += """
                              </tbody>
                          </table>
                      </div>
                      <p class="text-muted text-center">Download full CSV for complete list.</p>
                  </div>
              </div>

              <script>
                  new Chart(document.getElementById('deptChart'), {
                      type: 'doughnut',
                      data: {
                          labels: """ + str(list(depts.keys())) + """,
                          datasets: [{
                              data: """ + str(list(depts.values())) + """,
                              backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0', '#9966ff']
                          }]
                      }
                  });
                  new Chart(document.getElementById('regionChart'), {
                      type: 'bar',
                      data: {
                          labels: """ + str(list(regions.keys())) + """,
                          datasets: [{
                              label: 'Users per Region',
                              data: """ + str(list(regions.values())) + """,
                              backgroundColor: '#36a2eb'
                          }]
                      }
                  });
              </script>
          </body>
          </html>
          """

          with open("admin_dashboard/index.html", "w") as f:
              f.write(html_content)
          EOF
          
          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python build_dashboard.py
          echo "âœ… ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í™ˆí˜ì´ì§€ ìƒì„± ì™„ë£Œ."

      # -----------------------------------------------------------
      # 6. [Artifact] ìµœì¢… ê²°ê³¼ë¬¼ íŒ¨í‚¤ì§•
      # -----------------------------------------------------------
      - name: ğŸ“¦ Publish Admin Portal
        uses: actions/upload-artifact@v4
        with:
          name: 2026_Admin_Dashboard_System
          path: |
            admin_dashboard/index.html
            admin_dashboard/full_database.csv
            admin_dashboard/migration_history.log
            admin_dashboard/system_health.txt
            legacy_on_premise_server/
