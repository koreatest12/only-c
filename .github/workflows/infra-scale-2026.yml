name: ğŸ—ï¸ 2026 Final Mass Scale (Fix & Generate All)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'í™œë™í™œë™ (ì‘ì—… ìœ í˜•)'
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - add_disk
          - generate_mass_files # [NEW] íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± ì „ìš© ëª¨ë“œ
      resource_identifier:
        description: 'ì°¸ê°€ì ID (ì˜ˆ: only-c-main)'
        required: true
        default: 'only-c-main'
        type: string
      quantity:
        description: 'ëŒ€ëŸ‰ ìƒì„± ìˆ˜ëŸ‰ (íŒŒì¼/DB ê°œìˆ˜)'
        required: true
        default: '50' # ê¸°ë³¸ 50ê°œ ëŒ€ëŸ‰ ìƒì„±
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  mass-execution:
    name: âš¡ Mass Run (x${{ inputs.quantity }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # [1] ëŒ€ëŸ‰ ì •ë³´/íŒŒì¼/ì†ŒìŠ¤/í…Œë¼í¼ ìë™ ìƒì„± (AWS ì ‘ì† ì „ ì‹¤í–‰)
      # ----------------------------------------------------------------
      - name: ğŸ­ Generate Mass Assets (Files, Sources, TF)
        run: |
          echo "::: [System] ëŒ€ëŸ‰ ìì‚° ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (ìˆ˜ëŸ‰: ${{ inputs.quantity }}) :::"
          
          # 1. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          mkdir -p generated_assets/src
          mkdir -p generated_assets/config
          mkdir -p generated_assets/logs
          mkdir -p terraform_generated

          # 2. ì†ŒìŠ¤ ì½”ë“œ ëŒ€ëŸ‰ ìƒì„± (ì˜ˆ: Python íŒŒì¼ 50ê°œ)
          echo "-> ì†ŒìŠ¤ ì½”ë“œ ìƒì„± ì¤‘..."
          for i in $(seq 1 ${{ inputs.quantity }}); do
            filename="generated_assets/src/module_$i.py"
            echo "def process_$i(): print('Processing item $i')" > "$filename"
            echo "config_id=$i" > "generated_assets/config/setting_$i.ini"
          done
          
          # 3. í…Œë¼í¼ ì½”ë“œ ëŒ€ëŸ‰ ìƒì„± (main.tf ìë™ ì‘ì„±)
          echo "-> í…Œë¼í¼ ì½”ë“œ ë™ì  ìƒì„± ì¤‘..."
          cat <<EOF > terraform_generated/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }
          provider "aws" { region = "ap-northeast-2" }
          
          resource "aws_db_instance" "mass_db" {
            count = ${{ inputs.quantity }}
            identifier = "${{ inputs.resource_identifier }}-\${count.index + 1}"
            allocated_storage = 20
            instance_class    = "db.t3.micro"
            engine            = "mysql"
            username          = "admin"
            password          = "PassWord1234!"
            skip_final_snapshot = true
          }
          EOF
          
          echo "âœ… ëŒ€ëŸ‰ ìƒì„± ì™„ë£Œ: ì†ŒìŠ¤ íŒŒì¼, ì„¤ì • íŒŒì¼, í…Œë¼í¼ ì½”ë“œ ì¤€ë¹„ë¨."
          ls -R generated_assets/

      # ----------------------------------------------------------------
      # [2] AWS ì¸ì¦ (ì—ëŸ¬ ìˆ˜ì • ë° ì˜ˆì™¸ ì²˜ë¦¬ ì ìš©)
      # ----------------------------------------------------------------
      - name: ğŸ” Configure AWS Credentials (OIDC/Key)
        id: auth
        continue-on-error: true # ì¸ì¦ ì‹¤íŒ¨í•´ë„ íŒŒì¼ ìƒì„± ê²°ê³¼ëŠ” ìœ ì§€
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # [ìˆ˜ì •] http-proxies ì œê±°ë¨
          # [ìˆ˜ì •] ARNì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© (ë¬¸ë²• ì—ëŸ¬ ë°©ì§€)
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID || '000000000000' }}:role/GitHubAction-Infra-Role
          aws-region: ap-northeast-2
          role-duration-seconds: 1200

      # ----------------------------------------------------------------
      # [3] í…Œë¼í¼ ì‹¤í–‰ (ì¸ì¦ ì„±ê³µ ì‹œì—ë§Œ ì‹¤ì œ í´ë¼ìš°ë“œ ë°˜ì˜)
      # ----------------------------------------------------------------
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ—ï¸ Terraform Init & Plan
        run: |
          cd terraform_generated
          
          # ì¸ì¦ ì„±ê³µ ì—¬ë¶€ í™•ì¸
          if [ "${{ steps.auth.outcome }}" == "failure" ]; then
            echo "âš ï¸ AWS ì¸ì¦ ì‹¤íŒ¨ (Invalid ARN or No Secret). ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            terraform init -backend=false
            terraform validate
            echo "âœ… ë¡œì»¬ ì½”ë“œ ìœ íš¨ì„± ê²€ì‚¬ ì™„ë£Œ (Cloud ë°°í¬ëŠ” ê±´ë„ˆëœ€)"
            exit 0
          fi
          
          # ì¸ì¦ ì„±ê³µ ì‹œ ì‹¤ì œ ì‹¤í–‰
          terraform init
          terraform plan -out=tfplan
          
      - name: ğŸš€ Apply Changes (Prod Only)
        if: inputs.environment == 'prod' && steps.auth.outcome == 'success'
        run: |
          cd terraform_generated
          terraform apply -auto-approve tfplan
