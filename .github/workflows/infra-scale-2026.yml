name: ğŸš€ 2026 Ultimate Stable System (Segfault-Proof)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      data_count:
        description: 'ë°ì´í„° ìƒì„± ê·œëª¨ (ê¸°ë³¸: 500ë§Œ)'
        required: true
        default: '5000000'
        type: string

env:
  # ë°ì´í„° ì–‘ì´ ë§ì•„ë„ ì£½ì§€ ì•Šë„ë¡ ì•ˆì „í•œ ê¸°ë³¸ê°’ ì„¤ì •
  DATA_COUNT: ${{ inputs.data_count || '5000000' }}

jobs:
  # ==================================================================================
  # JOB 1: Windows ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ (ë°ì´í„° ìƒì„± X, ì˜¤ì§ ë¹Œë“œë§Œ ìˆ˜í–‰í•˜ì—¬ ì¶©ëŒ ë°©ì§€)
  # ==================================================================================
  build-windows:
    name: ğŸªŸ Build Windows Binary
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“ Generate Source (Windows Safe)
        run: |
          # Windowsìš© ê°„ë‹¨í•œ ì†ŒìŠ¤ ìƒì„± (ë°ì´í„° ìƒì„± ë¡œì§ì€ ë™ì¼í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ë¹Œë“œë§Œ í•¨)
          @"
          #include <iostream>
          int main() { std::cout << ""Use Linux Artifact for Data Generation"" << std::endl; return 0; }
          "@ | Out-File -FilePath enterprise_main.cpp -Encoding UTF8

          @"
          cmake_minimum_required(VERSION 3.15)
          project(MassiveServer2026)
          add_executable(enterprise_main enterprise_main.cpp)
          "@ | Out-File -FilePath CMakeLists.txt -Encoding UTF8

      - name: ğŸ’¥ Build EXE
        run: |
          mkdir build
          cd build
          cmake ..
          cmake --build . --config Release
          
      - uses: actions/upload-artifact@v4
        with:
          name: Binary-Windows
          path: build/Release/enterprise_main.exe

  # ==================================================================================
  # JOB 2: Linux ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± (Swap + Ulimit + Manual Buffer ì ìš©)
  # ==================================================================================
  generate-data-linux:
    name: ğŸ§ Massive Data Gen (Linux Optimized)
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6ì‹œê°„ ì œí•œ
    steps:
      - uses: actions/checkout@v4

      # [CRITICAL] 1. ë””ìŠ¤í¬ ë° ë©”ëª¨ë¦¬ í™•ë³´ (Segfault ë°©ì§€ì˜ í•µì‹¬)
      - name: â˜¢ï¸ Initialize System Resources
        run: |
          echo "::: Removing Unused Software :::"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          
          echo "::: Creating 8GB Swap File :::"
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          echo "::: Increasing Stack Size :::"
          ulimit -s unlimited
          
          free -h
          df -h

      # [CRITICAL] 2. ê°ì‹œì ì‹¤í–‰ (ë¡œê·¸ ëŠê¹€ ë°©ì§€)
      - name: ğŸ‘ï¸ Start Watchdog
        run: |
          cat <<'EOF' > watchdog.sh
          #!/bin/bash
          while true; do
            echo "[WATCHDOG] RAM: $(free -h | grep Mem | awk '{print $3}') used | DISK: $(df -h / | tail -1 | awk '{print $4}') free"
            sleep 60
          done
          EOF
          chmod +x watchdog.sh
          ./watchdog.sh &

      # [CRITICAL] 3. C++ ì—”ì§„ (Segfault ì›ì¸ ì œê±°: Manual Buffer + Mutex)
      - name: ğŸ“ Generate Anti-Crash Engine
        run: |
          cat <<'EOF' > upgrade_manager.py
          import os
          
          SYSTEM_VERSION = "2026.6.0 (Stable Core)"
          # -O3 ìµœì í™” + pthread í•„ìˆ˜
          GCC_FLAGS = "-O3 -Wall -Wextra -std=c++20 -pthread -march=native"
          
          def generate_cpp_source():
              print(f"Generating Safer C++ Source v{SYSTEM_VERSION}...")
              content = """
          #include <iostream>
          #include <fstream>
          #include <vector>
          #include <string>
          #include <thread>
          #include <mutex>
          #include <iomanip>
          #include <sstream>
          #include <atomic>
          
          // [SAFETY] ì „ì—­ ë®¤í…ìŠ¤ë¡œ ì¶œë ¥ ì¶©ëŒ ë°©ì§€
          std::mutex print_mtx;
          
          long long get_target_count() {
              const char* env_p = std::getenv("DATA_COUNT");
              if(env_p) return std::stoll(env_p);
              return 1000000;
          }

          // [CORE] ìˆ˜ë™ ë²„í¼ë§ í´ë˜ìŠ¤ (std::ofstream ë‚´ë¶€ ë²„í¼ ì˜ì¡´ ì œê±°)
          class SafeWriter {
              std::ofstream file;
              std::vector<char> buffer;
              size_t cursor = 0;
              const size_t CAPACITY = 4 * 1024 * 1024; // 4MB Buffer
              
          public:
              SafeWriter(const std::string& filename) {
                  file.open(filename);
                  buffer.resize(CAPACITY);
              }
              
              ~SafeWriter() {
                  flush();
                  if(file.is_open()) file.close();
              }
              
              // ë°ì´í„°ë¥¼ ë²„í¼ì— ìŒ“ê³  ê½‰ ì°¨ë©´ ì“´ë‹¤ (Segfault ë°©ì§€)
              void write(const std::string& data) {
                  if (cursor + data.size() > CAPACITY) {
                      flush();
                  }
                  // ë‚¨ì€ ê³µê°„ë³´ë‹¤ ë°ì´í„°ê°€ í¬ë©´ ë°”ë¡œ ì”€ (ì´ˆëŒ€í˜• ë°ì´í„° ëŒ€ì‘)
                  if (data.size() > CAPACITY) {
                      file.write(data.c_str(), data.size());
                  } else {
                      std::copy(data.begin(), data.end(), buffer.begin() + cursor);
                      cursor += data.size();
                  }
              }
              
              void flush() {
                  if (cursor > 0) {
                      file.write(buffer.data(), cursor);
                      cursor = 0;
                  }
              }
          };

          void generate_accounts(long long count) {
              try {
                  SafeWriter writer("output/data/va_dump.csv");
                  writer.write("Bank,Account,Holder,Balance,Status\\n");
                  
                  std::stringstream ss;
                  for(long long i=0; i<count; ++i) {
                      ss.str(""); ss.clear();
                      ss << (i%2==0 ? "KB" : "WOORI") << ","
                         << "User_" << i << ","
                         << (i * 1000) << ","
                         << (i%10==0 ? "Inactive" : "Active") << "\\n";
                      writer.write(ss.str());
                      
                      if(i % 200000 == 0) {
                          std::lock_guard<std::mutex> lock(print_mtx);
                          std::cout << "[ACC] Processed " << i << "..." << std::endl;
                      }
                  }
              } catch (const std::exception& e) {
                  std::lock_guard<std::mutex> lock(print_mtx);
                  std::cerr << "!!! ACC ERROR: " << e.what() << std::endl;
              }
          }

          void generate_cards(long long count) {
              try {
                  SafeWriter writer("output/data/card_dump.csv");
                  writer.write("CardNum,CVC,Expiry,Type\\n");
                  
                  std::stringstream ss;
                  for(long long i=0; i<count; ++i) {
                      ss.str(""); ss.clear();
                      ss << "4222-" << i << ","
                         << (i%999) << ",12/30,"
                         << (i%2==0 ? "VISA" : "MASTER") << "\\n";
                      writer.write(ss.str());

                      if(i % 200000 == 0) {
                          std::lock_guard<std::mutex> lock(print_mtx);
                          std::cout << "[CARD] Processed " << i << "..." << std::endl;
                      }
                  }
              } catch (const std::exception& e) {
                  std::lock_guard<std::mutex> lock(print_mtx);
                  std::cerr << "!!! CARD ERROR: " << e.what() << std::endl;
              }
          }

          int main() {
              // í´ë” ìƒì„± (C++17)
              std::string cmd = "mkdir -p output/data";
              system(cmd.c_str());

              long long target = get_target_count();
              std::cout << "ğŸš€ Engine Start (Target: " << target << ")" << std::endl;

              // [SAFETY] std::thread ì‚¬ìš© (asyncë³´ë‹¤ ëª…ì‹œì  ì œì–´ ê°€ëŠ¥)
              std::thread t1(generate_accounts, target);
              std::thread t2(generate_cards, target);

              t1.join();
              t2.join();

              std::cout << "âœ¨ Done." << std::endl;
              return 0;
          }
              """
              final_content = content.replace("{SYSTEM_VERSION}", SYSTEM_VERSION)
              with open("enterprise_main.cpp", "w", encoding="utf-8") as f:
                  f.write(final_content.strip())
          
          def generate_makefile():
              makefile = f"""
          CXX = g++
          CXXFLAGS = {GCC_FLAGS}
          TARGET = server_app_core
          SRCS = enterprise_main.cpp
          
          all: $(TARGET)
          $(TARGET): $(SRCS)
          \t$(CXX) $(CXXFLAGS) $(SRCS) -o $(TARGET)
              """
              with open("Makefile", "w", encoding="utf-8") as f: f.write(makefile.strip())
              
          if __name__ == "__main__":
              generate_cpp_source()
              generate_makefile()
          EOF

      - name: ğŸ”„ Compile & Run
        run: |
          python upgrade_manager.py
          make
          chmod +x server_app_core
          
          echo "::: Starting Execution :::"
          ./server_app_core

      # [COMPRESSION] ëŒ€ëŸ‰ ë°ì´í„° ì••ì¶• (Pigz ë³‘ë ¬ ì••ì¶•)
      - name: ğŸ“¦ Compress Output
        run: |
          echo "::: Compressing Data :::"
          sudo apt-get install -y pigz
          tar -cf - output/ | pigz -p $(nproc) > dataset_linux.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: Binary-Linux
          path: server_app_core

      - uses: actions/upload-artifact@v4
        with:
          name: Generated-Data
          path: dataset_linux.tar.gz

  # ==================================================================================
  # JOB 3: ë¦´ë¦¬ì¦ˆ (Windows EXE + Linux Data í†µí•©)
  # ==================================================================================
  release-manager:
    name: ğŸ“¦ Final Release
    needs: [build-windows, generate-data-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Windows
          path: bin_win
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Linux
          path: bin_linux
      - uses: actions/download-artifact@v4
        with:
          name: Generated-Data
          path: data_pkg

      - name: ğŸ“¦ Package Everything
        run: |
          mkdir release_pkg
          cp bin_win/enterprise_main.exe release_pkg/
          cp bin_linux/server_app_core release_pkg/
          cp data_pkg/dataset_linux.tar.gz release_pkg/
          
          cd release_pkg
          ls -lh

      - uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v2026.6.0.${{ github.run_number }}
          name: ğŸš€ Stable Release v${{ github.run_number }}
          body: |
            ## ğŸš€ Segfault-Proof Release
            
            This release fixes memory crash issues by isolating build and data generation environments.
            
            ### ğŸ“¦ Files
            - `dataset_linux.tar.gz`: Massive dataset generated on Linux (Safe).
            - `enterprise_main.exe`: Windows Binary.
            - `server_app_core`: Linux Binary.
          files: release_pkg/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
