name: üöÄ 2026 Ultimate Enterprise NOC System (Massive Data V3)

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ÏÉùÏÑ± Î¶¨ÏÜåÏä§ ÏàòÎüâ (User/Bucket/Table)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'Í¥ÄÎ¶¨Ïûê(High Tier) ÎπÑÏú® (%)'
        required: true
        default: '20'
        type: string
  push:
    branches: ["main"]
  schedule:
    - cron: '0 */4 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================================================================================
  # JOB 1: Ï∞®ÏÑ∏ÎåÄ ÌîåÎû´Ìèº Íµ¨Ï∂ï Î∞è ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±/Ïù¥Í¥Ä
  # ==================================================================================
  build-platform:
    name: ‚ö° Phase 1 - Build & Monitor
    runs-on: ubuntu-latest
    timeout-minutes: 120  # ÎåÄÎüâ Ï≤òÎ¶¨Î•º ÏúÑÌï¥ ÏãúÍ∞Ñ Ïó∞Ïû•

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts,s3,dynamodb,sns,sqs,cloudwatch
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: üìÇ Checkout Source
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 1. [Setup] ÏãúÏä§ÌÖú Í∂åÌïú Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï
      # ------------------------------------------------------------------------
      - name: üõ°Ô∏è Setup Permissions & Env
        run: |
          echo "::: [System] ÏãúÏä§ÌÖú Í∂åÌïú Î∞è ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÎåÄÎüâ ÏÑ§Ï†ï :::"
          
          # Ïõπ Î£®Ìä∏ Í∂åÌïú ÌôïÎ≥¥
          sudo mkdir -p /var/www/html
          sudo chown -R $USER:$USER /var/www/html
          sudo chmod -R 755 /var/www/html
          
          # Terraform ÏÑ§Ïπò
          if ! command -v terraform &> /dev/null; then
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install terraform
          fi
          
          # Python Î∞è Î∂ÑÏÑù ÎèÑÍµ¨ ÏÑ§Ïπò
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib faker
          sudo apt-get install -y nginx apache2-utils
          
          echo "‚úÖ All Dependencies Ready."

      # ------------------------------------------------------------------------
      # 2. [Data Gen] Python Í∏∞Î∞ò Í≥†ÏÜç ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Í≥ÑÏ†ï/ÌÖåÏù¥Î∏î/Í∂åÌïú)
      # ------------------------------------------------------------------------
      - name: üè¢ Generate Massive Enterprise Data
        id: data-gen
        run: |
          mkdir -p terraform_infra admin_dashboard logs
          
          # Python Ïä§ÌÅ¨Î¶ΩÌä∏Î°ú ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Î°úÏßÅ ÏûëÏÑ±
          cat <<EOF > generate_data.py
          import json
          import random
          import uuid
          import datetime
          import os

          QTY = int("${{ inputs.quantity }}")
          RATIO = int("${{ inputs.expert_ratio }}")
          
          departments = ["DevOps", "DataScience", "Backend", "Frontend", "SecOps", "HR", "Finance"]
          resources = []
          cost_data = "Service,Resource,Region,Cost\n"
          event_log = f"[{datetime.datetime.now()}] SYSTEM_BOOT: Mass Data Generation Started\n"

          print(f"::: Generating {QTY} resources sets...")

          for i in range(1, QTY + 1):
              is_expert = random.randint(0, 100) < RATIO
              uid = str(uuid.uuid4())[:8]
              
              # 1. User Account Info
              username = f"usr_{i:04d}_{uid}"
              access_key = f"AKIA{uuid.uuid4().hex[:16].upper()}"
              dept = random.choice(departments)
              
              # 2. Storage & Database Info
              bucket = f"bkt-{i:04d}-{dept.lower()}-{uid}"
              table = f"tbl_{i:04d}_{dept.lower()}"
              
              # 3. Attributes & Cost
              tier = "High" if is_expert else "Standard"
              s3_cost = 15.50 if is_expert else 2.30
              ddb_cost = 25.00 if is_expert else 5.00
              
              # 4. Table Schema Configuration (Migration Info)
              pk = "UserId"
              sk = "Timestamp"
              gsi_name = f"GSI_{dept}_Index"

              resource = {
                  "username": username,
                  "access_key": access_key,
                  "bucket": bucket,
                  "table": table,
                  "dept": dept,
                  "tier": tier,
                  "pk": pk,
                  "sk": sk,
                  "gsi": gsi_name
              }
              resources.append(resource)

              # Cost Log Append
              cost_data += f"IAM,{username},ap-northeast-2,0.00\n"
              cost_data += f"S3,{bucket},ap-northeast-2,{s3_cost}\n"
              cost_data += f"DynamoDB,{table},ap-northeast-2,{ddb_cost}\n"

              if is_expert:
                  event_log += f"[{datetime.datetime.now()}] AUDIT_WARN: High privilege account {username} created.\n"

          # Finalize Files
          with open("terraform_infra/resources.json", "w") as f:
              json.dump(resources, f, indent=2)
          
          with open("admin_dashboard/cost_breakdown.csv", "w") as f:
              f.write(cost_data)

          event_log += f"[{datetime.datetime.now()}] DATA_GEN: Completed generating {QTY} complex datasets.\n"
          with open("admin_dashboard/system_events.log", "w") as f:
              f.write(event_log)
          
          print("‚úÖ Data Generation Complete.")
          EOF
          
          # Ïã§Ìñâ
          python generate_data.py

      # ------------------------------------------------------------------------
      # 3. [IaC] ÎåÄÎüâ Î¶¨ÏÜåÏä§ Terraform ÏΩîÎìú ÏÉùÏÑ± (GSI Ìè¨Ìï®)
      # ------------------------------------------------------------------------
      - name: üõ†Ô∏è Generate & Audit IaC Code
        run: |
          cat <<EOF > terraform_infra/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            endpoints {
              iam      = "http://localhost:4566"
              s3       = "http://localhost:4566"
              dynamodb = "http://localhost:4566"
            }
            skip_credentials_validation = true
            skip_requesting_account_id  = true
            s3_use_path_style           = true
          }
          
          locals { resources = jsondecode(file("\${path.module}/resources.json")) }
          
          # 1. IAM User Mass Creation
          resource "aws_iam_user" "users" {
            for_each = { for r in local.resources : r.username => r }
            name     = each.value.username
            tags     = { Dept = each.value.dept, Generated = "True" }
          }
          
          # 2. S3 Bucket Mass Creation
          resource "aws_s3_bucket" "buckets" {
            for_each = { for r in local.resources : r.bucket => r }
            bucket   = each.value.bucket
            tags     = { Tier = each.value.tier }
          }
          
          # 3. DynamoDB Table Mass Creation with GSI
          resource "aws_dynamodb_table" "tables" {
            for_each     = { for r in local.resources : r.table => r }
            name         = each.value.table
            billing_mode = "PAY_PER_REQUEST"
            hash_key     = each.value.pk
            range_key    = each.value.sk
            
            attribute {
              name = each.value.pk
              type = "S"
            }
            attribute {
              name = each.value.sk
              type = "S"
            }
            
            # Global Secondary Index for Mass Migration Simulation
            global_secondary_index {
              name               = each.value.gsi
              hash_key           = each.value.sk
              projection_type    = "ALL"
            }
            
            tags = { Owner = each.value.username }
          }
          EOF
          
          cd terraform_infra
          terraform init
          terraform validate
          echo "‚úÖ IaC Configuration for Massive Migration Validated."

      # ------------------------------------------------------------------------
      # 4. [Deploy] Ïù∏ÌîÑÎùº ÎåÄÎüâ Î∞∞Ìè¨ (Î≥ëÎ†¨ Ï≤òÎ¶¨ ÏµúÏ†ÅÌôî)
      # ------------------------------------------------------------------------
      - name: üöÄ Deploy Cloud Platform
        run: |
          cd terraform_infra
          # Î≥ëÎ†¨ Ï≤òÎ¶¨(parallelism)Î•º ÎÜíÏó¨ ÎåÄÎüâ Î∞∞Ìè¨ ÏÜçÎèÑ Ìñ•ÏÉÅ
          terraform apply -auto-approve -parallelism=50
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] DEPLOY_SUCCESS: Massive Infrastructure provisioned to LocalStack" >> ../admin_dashboard/system_events.log

      # ------------------------------------------------------------------------
      # 5. [Simulation] ÏãúÏä§ÌÖú ÏãúÎÆ¨Î†àÏù¥ÏÖò Î∞è Î©îÌä∏Î¶≠ ÏàòÏßë
      # ------------------------------------------------------------------------
      - name: üî¨ Comprehensive System Simulation
        run: |
          EVENT_LOG="admin_dashboard/system_events.log"
          
          # 1. Nginx Setup
          echo "events { worker_connections 2048; } http { server { listen 80; root /var/www/html; } }" > nginx_temp.conf
          sudo mv nginx_temp.conf /etc/nginx/nginx.conf
          echo "Dashboard Loading..." > /var/www/html/index.html
          sudo service nginx restart
          
          # 2. Chaos Test
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] CHAOS_TEST: Simulating partial outage" >> $EVENT_LOG
          START=$(date +%s%3N)
          # Localstack ÏùºÏãú Ï†ïÏßÄ/Ïû¨Í∞úÎ°ú Ïû•Ïï† ÏãúÎÆ¨Î†àÏù¥ÏÖò
          docker pause $(docker ps -q --filter ancestor=localstack/localstack)
          sleep 2
          docker unpause $(docker ps -q --filter ancestor=localstack/localstack)
          END=$(date +%s%3N)
          echo "Full_Recovery_Time: $((END-START)) ms" > admin_dashboard/recovery_metrics.txt
          
          # 3. Load Test
          ab -n 1500 -c 100 http://localhost/ > admin_dashboard/load_test.txt
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] PERF_TEST: Load testing completed" >> $EVENT_LOG
          
          # 4. Service Health Snapshot
          cat <<EOF > admin_dashboard/service_health.json
          { "IAM": "Healthy", "S3": "Healthy", "DynamoDB": "Migrated", "Nginx": "Active", "Billing": "Active" }
          EOF

      # ------------------------------------------------------------------------
      # 6. [Dashboard] NOC ÎåÄÏãúÎ≥¥Îìú Íµ¨Ï∂ï (Í≥ÑÏ†ï Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î Ìè¨Ìï®)
      # ------------------------------------------------------------------------
      - name: üñ•Ô∏è Build NOC Dashboard V3
        run: |
          cat <<EOF > build_dashboard.py
          import pandas as pd
          import json, re, datetime, os

          # 1. Load Data
          try:
              df_cost = pd.read_csv('admin_dashboard/cost_breakdown.csv')
              total_cost = df_cost['Cost'].sum()
              cost_by_service = df_cost.groupby('Service')['Cost'].sum().to_dict()
          except: total_cost=0; cost_by_service={}

          try:
              with open('terraform_infra/resources.json') as f:
                  resources = json.load(f)
          except: resources = []

          try:
              with open('admin_dashboard/load_test.txt') as f:
                  log = f.read()
                  rps = re.search(r'Requests per second:\s+([\d.]+)', log).group(1)
          except: rps="N/A"

          try:
              with open('admin_dashboard/recovery_metrics.txt') as f:
                  rec_time = f.read().split(': ')[1].strip()
          except: rec_time="N/A"
          
          try:
              with open('admin_dashboard/system_events.log') as f:
                  events = f.readlines()[-15:] # Last 15 events
          except: events = []

          # 2. HTML Template
          html = f"""
          <!DOCTYPE html>
          <html lang="en" data-bs-theme="dark">
          <head>
              <meta charset="UTF-8">
              <title>2026 Enterprise NOC - Migration Status</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body {{ background-color: #050505; color: #e0e0e0; font-family: 'Consolas', sans-serif; }}
                  .card {{ background-color: #1a1a1a; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }}
                  .text-neon {{ color: #00ff41; text-shadow: 0 0 5px #00ff41; }}
                  .text-warn {{ color: #ffeb3b; }}
                  .status-dot {{ height: 10px; width: 10px; background-color: #00ff41; border-radius: 50%; display: inline-block; margin-right: 5px; }}
                  .console {{ background: #000; color: #0f0; padding: 10px; height: 250px; overflow-y: auto; font-size: 0.8rem; border: 1px solid #333; }}
                  .table-custom {{ font-size: 0.85rem; }}
                  .scrollable-table {{ max_height: 400px; overflow-y: auto; }}
              </style>
          </head>
          <body>
              <div class="container-fluid p-4">
                  <header class="d-flex justify-content-between mb-4 border-bottom border-secondary pb-2">
                      <div>
                          <h2 class="text-neon">üöÄ 2026 Enterprise NOC</h2>
                          <small class="text-muted">Massive Data Migration & Monitoring V3</small>
                      </div>
                      <div class="text-end">
                          <h4 class="text-white"><span class="status-dot"></span>OPERATIONAL</h4>
                          <small>{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</small>
                      </div>
                  </header>

                  <div class="row text-center mb-3">
                      <div class="col-md-3"><div class="card p-3"><h6 class="text-muted">Est. Monthly Cost</h6><h3 class="text-warn">${total_cost:,.2f}</h3></div></div>
                      <div class="col-md-3"><div class="card p-3"><h6 class="text-muted">Total Resources</h6><h3 class="text-info">{len(resources)} Sets</h3></div></div>
                      <div class="col-md-3"><div class="card p-3"><h6 class="text-muted">Throughput (RPS)</h6><h3 class="text-white">{rps}</h3></div></div>
                      <div class="col-md-3"><div class="card p-3"><h6 class="text-muted">Recovery Time</h6><h3 class="text-success">{rec_time}</h3></div></div>
                  </div>

                  <div class="row">
                      <div class="col-md-4">
                          <div class="card p-3">
                              <h5>üí∞ Cost Distribution</h5>
                              <canvas id="costChart"></canvas>
                          </div>
                          <div class="card p-3">
                              <h5>üìú Live System Logs</h5>
                              <div class="console">
          """
          for line in events:
              html += f"<div>> {line.strip()}</div>"
          
          html += """
                              </div>
                          </div>
                      </div>

                      <div class="col-md-8">
                          <div class="card p-3">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                  <h5>üóÑÔ∏è Migrated Account & Table Configuration (Top 500 View)</h5>
                                  <span class="badge bg-primary">Total: """ + str(len(resources)) + """</span>
                              </div>
                              <div class="scrollable-table">
                                  <table class="table table-dark table-striped table-hover table-custom">
                                      <thead>
                                          <tr>
                                              <th>User</th>
                                              <th>Access Key</th>
                                              <th>Dept</th>
                                              <th>DynamoDB Table</th>
                                              <th>Primary Key</th>
                                              <th>GSI (Migrated)</th>
                                          </tr>
                                      </thead>
                                      <tbody>
          """
          # Show up to 500 rows to prevent browser crash, but data is generated
          for r in resources[:500]: 
              html += f"<tr><td>{r['username']}</td><td><code>{r['access_key']}</code></td><td>{r['dept']}</td><td>{r['table']}</td><td>{r['pk']}</td><td>{r['gsi']}</td></tr>"

          html += f"""
                                      </tbody>
                                  </table>
                              </div>
                              <small class="text-muted mt-2">* Displaying top 500 records only for performance. Full logs available in artifacts.</small>
                          </div>
                      </div>
                  </div>
              </div>

              <script>
                  const ctxCost = document.getElementById('costChart').getContext('2d');
                  new Chart(ctxCost, {{
                      type: 'doughnut',
                      data: {{
                          labels: {list(cost_by_service.keys())},
                          datasets: [{{
                              data: {list(cost_by_service.values())},
                              backgroundColor: ['#00ff41', '#00b8ff', '#ffeb3b', '#ff3d00'],
                              borderWidth: 0
                          }}]
                      }},
                      options: {{ plugins: {{ legend: {{ position: 'right', labels: {{ color: 'white' }} }} }} }}
                  }});
              </script>
          </body>
          </html>
          """
          
          with open('admin_dashboard/index.html', 'w') as f: f.write(html)
          
          # Jekyll Config
          with open('admin_dashboard/_config.yml', 'w') as f:
              f.write("title: 2026 Enterprise NOC\ntheme: jekyll-theme-hacker\n")
          EOF
          
          python build_dashboard.py

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-content
          path: admin_dashboard/

  # ==================================================================================
  # JOB 2: Jekyll ÎπåÎìú
  # ==================================================================================
  build-pages:
    name: üèóÔ∏è Phase 2 - Build Site
    runs-on: ubuntu-latest
    needs: build-platform
    steps:
      - name: üì• Download
        uses: actions/download-artifact@v4
        with:
          name: website-content
          path: .
      - name: ‚öôÔ∏è Setup Pages
        uses: actions/configure-pages@v5
      - name: üî® Build Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
      - name: üì¶ Upload Pages
        uses: actions/upload-pages-artifact@v3

  # ==================================================================================
  # JOB 3: Î∞∞Ìè¨
  # ==================================================================================
  deploy-pages:
    name: üöÄ Phase 3 - Deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-pages
    steps:
      - name: üåç Deploy
        id: deployment
        uses: actions/deploy-pages@v4
