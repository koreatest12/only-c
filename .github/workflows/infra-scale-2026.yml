name: ğŸ§¨ 2026 Expert Account & Infra Mass Generator

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ìƒì„±í•  ê³„ì • ì´ ìˆ˜ëŸ‰ (ëª…)'
        required: true
        default: '100' # ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ì‹œ 1000 ì´ìƒ ì…ë ¥ ê°€ëŠ¥
        type: string
      expert_ratio:
        description: 'ì „ë¬¸ê°€(ê´€ë¦¬ì) ë¹„ìœ¨ (%)'
        required: true
        default: '20' # ìƒìœ„ 20%ëŠ” Admin ê¶Œí•œ ë¶€ì—¬
        type: string

jobs:
  expert-account-generation:
    name: âš¡ Mass Gen Experts (x${{ inputs.quantity }})
    runs-on: ubuntu-latest
    
    # IAM ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ LocalStack (ê°€ìƒ AWS) ì„œë¹„ìŠ¤
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. [í•µì‹¬] ëŒ€ëŸ‰ ê³„ì • ë°ì´í„° ìƒì„± (CSV & JSON)
      # -----------------------------------------------------------
      - name: ğŸ‘¨â€ğŸ’» Generate Massive Expert Data
        id: gen_data
        run: |
          QTY=${{ inputs.quantity }}
          RATIO=${{ inputs.expert_ratio }}
          
          mkdir -p security_audit terraform_iam
          
          CSV_FILE="security_audit/2026_account_report.csv"
          JSON_FILE="terraform_iam/users.json"
          
          echo "::: [System] ëŒ€ëŸ‰ ê³„ì • ë°ì´í„° ìƒì„± ì‹œì‘ (ì´ $QTY ëª… / ì „ë¬¸ê°€ ë¹„ìœ¨ $RATIO%) :::"
          
          # 1. CSV í—¤ë” ì‘ì„±
          echo "Account_ID,Username,Group,Access_Key,Secret_Key,Initial_Password" > $CSV_FILE
          
          # 2. JSON ì‹œì‘ (ë°°ì—´ ì‹œì‘)
          echo "[" > $JSON_FILE
          
          # 3. ëŒ€ëŸ‰ ë£¨í”„ ì²˜ë¦¬
          for i in $(seq 1 $QTY); do
            # ì „ë¬¸ê°€ íŒë³„ ë¡œì§
            CHANCE=$(( RANDOM % 100 ))
            if [ $CHANCE -lt $RATIO ]; then
              GROUP="Expert-Admins"
              USER_PREFIX="admin_ops"
              PASS="EXP-$(openssl rand -base64 12)"
            else
              GROUP="Standard-Users"
              USER_PREFIX="user_staff"
              PASS="usr-$(openssl rand -hex 4)"
            fi
            
            USERNAME="${USER_PREFIX}_$(printf "%04d" $i)" # 4ìë¦¬ ìˆ«ìë¡œ í™•ì¥
            ACCESS_KEY="AKIA$(openssl rand -hex 8 | tr 'a-z' 'A-Z')"
            SECRET_KEY="$(openssl rand -base64 20)"
            
            # CSV ê¸°ë¡
            echo "ACC-2026-$i,$USERNAME,$GROUP,$ACCESS_KEY,$SECRET_KEY,$PASS" >> $CSV_FILE
            
            # JSON ê¸°ë¡ (Terraform ì—°ë™ìš©) - ë§ˆì§€ë§‰ ì½¤ë§ˆ ì²˜ë¦¬ëŠ” ë£¨í”„ í›„ë°˜ë¶€ì—ì„œ ì •ë¦¬í•˜ê±°ë‚˜ ë‹¨ìˆœí™”
            # ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ ë§ˆì§€ë§‰ í•­ëª© ë’¤ì—ë„ ì½¤ë§ˆê°€ ë¶™ì§€ ì•Šë„ë¡ ì¡°ê±´ ì²˜ë¦¬
            if [ "$i" -eq "$QTY" ]; then
              echo "  { \"username\": \"$USERNAME\", \"group\": \"$GROUP\" }" >> $JSON_FILE
            else
              echo "  { \"username\": \"$USERNAME\", \"group\": \"$GROUP\" }," >> $JSON_FILE
            fi
          done
          
          # JSON ì¢…ë£Œ
          echo "]" >> $JSON_FILE
          
          echo "âœ… ë°ì´í„° ìƒì„± ì™„ë£Œ."
          echo ":: Generate Report Summary ::"
          echo "Total Accounts: $QTY"
          grep -c "Expert-Admins" $CSV_FILE | awk '{print "Experts Generated: " $1}'

      # -----------------------------------------------------------
      # 2. Terraform ì½”ë“œ ìƒì„± (JSON ë°ì´í„° ì—°ë™í˜•)
      # -----------------------------------------------------------
      - name: ğŸ› ï¸ Generate Scalable Terraform Code
        run: |
          cat <<EOF > terraform_iam/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }

          provider "aws" {
            region                      = "ap-northeast-2"
            access_key                  = "test"
            secret_key                  = "test"
            skip_credentials_validation = true
            skip_requesting_account_id  = true
            endpoints {
              iam = "http://localhost:4566"
            }
          }

          # 1. JSON ë°ì´í„° ë¡œë“œ (Bashì—ì„œ ìƒì„±í•œ íŒŒì¼)
          locals {
            users_data = jsondecode(file("\${path.module}/users.json"))
          }

          # 2. IAM ê·¸ë£¹ ìƒì„± (ì „ë¬¸ê°€ / ì¼ë°˜)
          resource "aws_iam_group" "expert_group" {
            name = "Expert-Admins"
          }

          resource "aws_iam_group" "standard_group" {
            name = "Standard-Users"
          }

          # 3. IAM ì •ì±… ì—°ê²° (ì „ë¬¸ê°€ëŠ” Admin, ì¼ë°˜ì€ ReadOnly)
          resource "aws_iam_group_policy_attachment" "expert_policy" {
            group      = aws_iam_group.expert_group.name
            policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"
          }

          resource "aws_iam_group_policy_attachment" "standard_policy" {
            group      = aws_iam_group.standard_group.name
            policy_arn = "arn:aws:iam::aws:policy/ReadOnlyAccess"
          }

          # 4. [ëŒ€ëŸ‰] IAM ì‚¬ìš©ì ìƒì„± (for_each ì‚¬ìš©)
          resource "aws_iam_user" "mass_users" {
            for_each = { for user in local.users_data : user.username => user }
            name     = each.value.username
            path     = "/system/"
          }

          # 5. [ëŒ€ëŸ‰] ì‚¬ìš©ì-ê·¸ë£¹ ë©¤ë²„ì‹­ ë§¤í•‘
          resource "aws_iam_user_group_membership" "mass_membership" {
            for_each = { for user in local.users_data : user.username => user }

            user   = aws_iam_user.mass_users[each.key].name
            groups = [
              each.value.group == "Expert-Admins" ? aws_iam_group.expert_group.name : aws_iam_group.standard_group.name
            ]
          }
          EOF

      # -----------------------------------------------------------
      # 3. ê°€ìƒ ì¸í”„ë¼ ë°°í¬ (Terraform Apply)
      # -----------------------------------------------------------
      - name: ğŸ—ï¸ Terraform Init & Apply
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false # ëŒ€ëŸ‰ ì¶œë ¥ ì‹œ ë¡œê·¸ ê¹¨ì§ ë°©ì§€

      - name: ğŸš€ Deploy Massive Infra
        run: |
          cd terraform_iam
          
          echo "::: Terraform ì´ˆê¸°í™” :::"
          terraform init
          
          echo "::: Terraform ëŒ€ëŸ‰ ì ìš© (Parallelism ì¦ê°€) :::"
          # ëŒ€ëŸ‰ ë¦¬ì†ŒìŠ¤ ì²˜ë¦¬ ì†ë„ë¥¼ ìœ„í•´ ë³‘ë ¬ ì²˜ë¦¬ ìˆ˜ ì¦ê°€
          terraform apply -auto-approve -parallelism=50
          
          echo "âœ… ê°€ìƒ í´ë¼ìš°ë“œì— ëŒ€ëŸ‰ ê³„ì • ë° ê¶Œí•œ ë°°í¬ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 4. ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      # -----------------------------------------------------------
      - name: ğŸ“¦ Archive Credentials & State
        uses: actions/upload-artifact@v4
        with:
          name: 2026_Massive_Account_Export
          path: |
            security_audit/2026_account_report.csv
            terraform_iam/users.json
            terraform_iam/terraform.tfstate
