name: ğŸ—ï¸ 2026 Infra Scale (Auto-Recovery & Mass Gen)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'í™œë™í™œë™'
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - expand_db_storage
          - add_disk
      resource_identifier:
        description: 'ì°¸ê°€ì ID ë˜ëŠ” ì´ë¦„ (ì˜ˆ: db-main-01)'
        required: true
        type: string
      target_size_gb:
        description: 'ëª©í‘œ í™”ë¶„ (GB ë‹¨ìœ„)'
        required: true
        default: '50'
        type: string
      config_url:
        description: 'ê³µì‹ ì •ë³´ ë‹¤ìš´ë¡œë“œ ì£¼ì†Œ (ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)'
        required: false
        default: 'https://api.koreatest12.com/infra/emergency-plan.json'
        type: string

permissions:
  contents: read
  id-token: write # OIDC ì¸ì¦ í•„ìˆ˜ ê¶Œí•œ

jobs:
  # ------------------------------------------------------------------
  # [1ë‹¨ê³„] ì •ê·œ ì‹¤í–‰ ì‹œë„ (Standard Run)
  # ------------------------------------------------------------------
  primary-deploy:
    name: ğŸš€ Primary Deployment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      status: ${{ job.status }}
    
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS (OIDC)
        id: auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubAction-Infra-Role
          aws-region: ap-northeast-2
          # ì‹¤íŒ¨ ì‹œ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ì§€ ì•Šë„ë¡ íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„ ì„¤ì •
          role-duration-seconds: 900
          http-proxies: "" 

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ—ï¸ Terraform Init & Apply
        run: |
          terraform init
          terraform plan -var="db_name=${{ inputs.resource_identifier }}" -out=tfplan
          if [ "${{ inputs.environment }}" == "prod" ]; then
            terraform apply -auto-approve tfplan
          fi

  # ------------------------------------------------------------------
  # [2ë‹¨ê³„] ì‹¤íŒ¨ ì‹œ ë°œë™: ëŒ€ëŸ‰ ìƒì„± ë° ê°•ì œ ë³µêµ¬ (Emergency Recovery)
  # ------------------------------------------------------------------
  emergency-recovery:
    name: ğŸš‘ Mass Recovery & Generation
    needs: primary-deploy
    if: failure() # ì• ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: ğŸš¨ Failure Detected
        run: echo "1ì°¨ ì‹œë„ ì‹¤íŒ¨ ê°ì§€. ëŒ€ëŸ‰ ë³µêµ¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."

      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      # 1. ëŒ€ëŸ‰ ì •ë³´ ë‹¤ìš´ë¡œë“œ ì‹œë„
      - name: ğŸ“¥ Download Mass Config
        continue-on-error: true # ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
        run: |
          echo "::: ê¸´ê¸‰ ë³µêµ¬: ëŒ€ëŸ‰ êµ¬ì„± ì •ë³´ ë‹¤ìš´ë¡œë“œ ì¤‘ :::"
          curl -L -o mass_recovery.json "${{ inputs.config_url }}" || echo "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ìƒì„±ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤."

      # 2. ëŒ€ëŸ‰ íŒŒì¼/ì†ŒìŠ¤/í…Œë¼í¼ ì½”ë“œ ì¦‰ì„ ìƒì„± (ìŠ¤í¬ë¦½íŠ¸)
      - name: âš™ï¸ Generate Mass Sources & Terraform
        run: |
          echo "::: ëŒ€ëŸ‰ íŒŒì¼ ìƒì„± ë° í…Œë¼í¼ ì½”ë“œ ì¬ìƒì„± ì‹œì‘ :::"
          mkdir -p terraform_recovery
          
          # [ìë™ ìƒì„±] 1. ë©”ì¸ í…Œë¼í¼ íŒŒì¼ ê°•ì œ ìƒì„±
          cat <<EOF > terraform_recovery/main.tf
          provider "aws" { region = "ap-northeast-2" }
          
          variable "recovery_count" { default = 10 } # ê¸°ë³¸ 10ê°œ ëŒ€ëŸ‰ ìƒì„±
          
          resource "aws_db_instance" "emergency_db" {
            count = var.recovery_count
            identifier = "recovery-db-\${count.index}"
            allocated_storage = 50
            instance_class = "db.t3.micro"
            engine = "mysql"
            username = "admin"
            password = "RecoveryPass1234!"
            skip_final_snapshot = true
          }
          EOF
          
          # [ìë™ ìƒì„±] 2. ì†ŒìŠ¤ ì½”ë“œ ë° êµ¬ì„± íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
          for i in {1..50}; do
            echo "config_id=$i, status=active" > "terraform_recovery/config_$i.ini"
          done
          
          echo "âœ… íŒŒì¼ 50ê°œ ë° í…Œë¼í¼ ì½”ë“œ ìƒì„± ì™„ë£Œ."
          ls -R terraform_recovery/

      # 3. ìê²© ì¦ëª… ì¬ì‹œë„ (OIDC ì‹¤íŒ¨ ì‹œ Access Key ë°©ì‹ ì‹œë„ ë“±)
      - name: ğŸ” Retry Auth (Fallback)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # OIDCê°€ ì‹¤íŒ¨í–ˆìœ¼ë¯€ë¡œ, ì‹œí¬ë¦¿ í‚¤ê°€ ìˆë‹¤ë©´ í‚¤ ë°©ì‹ìœ¼ë¡œ ì‹œë„ (ì—†ìœ¼ë©´ ë‹¤ì‹œ OIDC ì¬ì‹œë„)
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
          # í‚¤ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ continue-on-error ì„¤ì •
        continue-on-error: true

      # 4. ìƒì„±ëœ ëŒ€ëŸ‰ ì •ë³´ ë°˜ì˜
      - name: ğŸš€ Apply Mass Recovery Changes
        run: |
          cd terraform_recovery
          terraform init
          
          echo "::: ëŒ€ëŸ‰ ìƒì„±ëœ ë³µêµ¬ ê³„íš ì ìš© :::"
          terraform plan -out=recovery_plan
          
          # í”„ë¡œë•ì…˜ í™˜ê²½ì´ë©´ ì¦‰ì‹œ ì ìš©, ì•„ë‹ˆë©´ ê³„íšë§Œ ì¶œë ¥
          if [ "${{ inputs.environment }}" == "prod" ]; then
            terraform apply -auto-approve recovery_plan
            echo "âœ… ëŒ€ëŸ‰ ë³µêµ¬ ë¦¬ì†ŒìŠ¤ ë°°í¬ ì™„ë£Œ."
          else
             echo "ğŸš§ ê°œë°œ í™˜ê²½: ëŒ€ëŸ‰ ìƒì„± ê³„íš(Plan) ìˆ˜ë¦½ ì™„ë£Œ."
          fi
