name: ğŸ—ï¸ 2026 Mass Infra Scaling (All Info & Capacity)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)' # [ê³ ì •]
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'í™œë™í™œë™' # [ê³ ì •]
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - expand_db_storage
          - add_disk
          - expand_disk
      resource_identifier:
        description: 'ì°¸ê°€ì ID ë˜ëŠ” ì´ë¦„ (ì˜ˆ: db-main-01, vol-data-02)' # [ê³ ì •]
        required: true
        type: string
      target_size_gb:
        description: 'ëª©í‘œ í™”ë¶„ (GB ë‹¨ìœ„)' # [ê³ ì •] - ìš©ëŸ‰ ì •ë³´
        required: true
        default: '50'
        type: string
      quantity:
        description: 'ìƒì„± ìˆ˜ëŸ‰ (ëŒ€ëŸ‰ ì‘ì—… ì‹œ ì •ë³´)' # [ì¶”ê°€] - "ì •ë³´ ìƒì„±"ì„ ìœ„í•œ ìˆ˜ëŸ‰
        required: true
        default: '1'
        type: string

# OIDC ì¸ì¦ì„ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  id-token: write

jobs:
  mass-scaling:
    name: âš™ï¸ Mass Action (${{ inputs.action_type }} x ${{ inputs.quantity }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: ğŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/GitHubAction-Infra-Role # ìƒì„±í•œ IAM Role ARN ì…ë ¥
          aws-region: ap-northeast-2

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: ğŸ” Plan Mass Changes
        run: |
          echo "::: ëŒ€ëŸ‰ ì‘ì—… ì‹¤í–‰ ê³„íš :::"
          echo "í™˜ê²½: ${{ inputs.environment }}"
          echo "í™œë™: ${{ inputs.action_type }}"
          echo "ëŒ€ìƒ ì´ë¦„(Prefix): ${{ inputs.resource_identifier }}"
          echo "ê°œë³„ ìš©ëŸ‰(í™”ë¶„): ${{ inputs.target_size_gb }} GB"
          echo "ì´ ìƒì„± ìˆ˜ëŸ‰: ${{ inputs.quantity }} ê°œ"
          
          # Terraformì— ìš©ëŸ‰(size)ê³¼ ìˆ˜ëŸ‰(count)ì„ ëª¨ë‘ ì „ë‹¬
          if [ "${{ inputs.action_type }}" == "create_db" ]; then
            terraform plan -var="create_db=true" \
                           -var="db_name_prefix=${{ inputs.resource_identifier }}" \
                           -var="db_storage_size=${{ inputs.target_size_gb }}" \
                           -var="instance_count=${{ inputs.quantity }}" \
                           -out=tfplan

          elif [ "${{ inputs.action_type }}" == "add_disk" ]; then
            terraform plan -var="add_new_disk=true" \
                           -var="disk_name_prefix=${{ inputs.resource_identifier }}" \
                           -var="disk_size=${{ inputs.target_size_gb }}" \
                           -var="disk_count=${{ inputs.quantity }}" \
                           -out=tfplan

          else
            # ì¦ì„¤(Expand) ì‘ì—…ì€ ë³´í†µ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ 1ê°œë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨ (í•„ìš”ì‹œ ë°˜ë³µë¬¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)
            terraform plan -var="resize_target=${{ inputs.resource_identifier }}" \
                           -var="new_size=${{ inputs.target_size_gb }}" \
                           -out=tfplan
          fi
        working-directory: ./terraform

      - name: ğŸš€ Apply Changes
        if: inputs.environment == 'prod'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
