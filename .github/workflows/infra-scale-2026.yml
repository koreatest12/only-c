name: üöÄ 2026 Ultimate Enterprise NOC System (Monitoring V2)

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ÏÉùÏÑ± Î¶¨ÏÜåÏä§ ÏàòÎüâ (User/Bucket/Table)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'Í¥ÄÎ¶¨Ïûê Î∞è Í≥†ÏÇ¨Ïñë Î¶¨ÏÜåÏä§ ÎπÑÏú® (%)'
        required: true
        default: '20'
        type: string
  push:
    branches: ["main"]
  schedule:
    - cron: '0 */4 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================================================================================
  # JOB 1: Ï∞®ÏÑ∏ÎåÄ ÌîåÎû´Ìèº Íµ¨Ï∂ï Î∞è Î™®ÎãàÌÑ∞ÎßÅ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
  # ==================================================================================
  build-platform:
    name: ‚ö° Phase 1 - Build & Monitor
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts,s3,dynamodb,sns,sqs,cloudwatch
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: üìÇ Checkout Source
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 1. [Setup] ÏãúÏä§ÌÖú Í∂åÌïú Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï
      # ------------------------------------------------------------------------
      - name: üõ°Ô∏è Setup Permissions & Env
        run: |
          echo "::: [System] ÏãúÏä§ÌÖú Í∂åÌïú Î∞è ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÎåÄÎüâ ÏÑ§Ï†ï :::"
          
          # Ïõπ Î£®Ìä∏ Í∂åÌïú ÌôïÎ≥¥
          sudo mkdir -p /var/www/html
          sudo chown -R $USER:$USER /var/www/html
          sudo chmod -R 755 /var/www/html
          
          # Terraform ÏÑ§Ïπò
          if ! command -v terraform &> /dev/null; then
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install terraform
          fi
          
          # Î™®ÎãàÌÑ∞ÎßÅ Î∞è Î∂ÑÏÑù ÎèÑÍµ¨ ÏÑ§Ïπò
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib
          sudo apt-get install -y nginx apache2-utils
          
          echo "‚úÖ All Dependencies Ready."

      # ------------------------------------------------------------------------
      # 2. [Data Gen] ÎåÄÎüâ Î©ÄÌã∞ ÏÑúÎπÑÏä§ Î∞è Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
      # ------------------------------------------------------------------------
      - name: üè¢ Generate Comprehensive Data
        run: |
          INPUT_QTY="${{ inputs.quantity }}"
          QTY="${INPUT_QTY:-1000}"
          RATIO="${{ inputs.expert_ratio || 20 }}"
          
          mkdir -p terraform_infra admin_dashboard logs
          JSON_FILE="terraform_infra/resources.json"
          COST_LOG="admin_dashboard/cost_breakdown.csv"
          EVENT_LOG="admin_dashboard/system_events.log"
          
          echo "::: [Gen] Î¶¨ÏÜåÏä§ Î∞è Ïù¥Î≤§Ìä∏ Î°úÍ∑∏ ÎåÄÎüâ ÏÉùÏÑ± :::"
          echo "[" > $JSON_FILE
          echo "Service,Resource,Region,Cost" > $COST_LOG
          
          # Ïù¥Î≤§Ìä∏ Î°úÍ∑∏ Ìó§Îçî
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] SYSTEM_BOOT: Initialization started" > $EVENT_LOG
          
          DEPTS=("DevOps" "Data" "Backend" "Frontend" "SecOps")
          
          for i in $(seq 1 $QTY); do
            SUFFIX=$(date +%s%N | cut -b10-13)
            USER="usr_$(printf "%04d" $i)_$SUFFIX"
            BUCKET="bkt-$(printf "%04d" $i)-$SUFFIX"
            TABLE="tbl_$(printf "%04d" $i)_$SUFFIX"
            
            if [ $((RANDOM%100)) -lt $RATIO ]; then 
               TIER="High"; COST_S3="15.50"; COST_DDB="25.00"
               echo "[$(date '+%Y-%m-%d %H:%M:%S')] AUDIT_WARN: High privilege user $USER created" >> $EVENT_LOG
            else 
               TIER="Standard"; COST_S3="2.30"; COST_DDB="5.00"
            fi
            DEPT=${DEPTS[$RANDOM % ${#DEPTS[@]}]}
            
            # ÎπÑÏö© Îç∞Ïù¥ÌÑ∞ ÏÑ∏Î∂ÑÌôî
            echo "IAM,$USER,ap-northeast-2,0.00" >> $COST_LOG
            echo "S3,$BUCKET,ap-northeast-2,$COST_S3" >> $COST_LOG
            echo "DynamoDB,$TABLE,ap-northeast-2,$COST_DDB" >> $COST_LOG
            
            echo "  { \"username\": \"$USER\", \"bucket\": \"$BUCKET\", \"table\": \"$TABLE\", \"dept\": \"$DEPT\", \"tier\": \"$TIER\" }," >> $JSON_FILE
          done
          
          # JSON ÎßàÎ¨¥Î¶¨
          echo "  { \"username\": \"dummy\", \"bucket\": \"dummy\", \"table\": \"dummy\", \"dept\": \"sys\", \"tier\": \"low\" } ]" >> $JSON_FILE
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] DATA_GEN: Generated $QTY resource sets" >> $EVENT_LOG

      # ------------------------------------------------------------------------
      # 3. [IaC] Ïù∏ÌîÑÎùº ÏΩîÎìú ÏÉùÏÑ± (Î¨∏Î≤ï Ïò§Î•ò ÏàòÏ†ïÎê®)
      # ------------------------------------------------------------------------
      - name: üõ†Ô∏è Generate & Audit IaC Code
        run: |
          cat <<EOF > terraform_infra/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            endpoints {
              iam      = "http://localhost:4566"
              s3       = "http://localhost:4566"
              dynamodb = "http://localhost:4566"
              sns      = "http://localhost:4566"
            }
            skip_credentials_validation = true
            skip_requesting_account_id  = true
            s3_use_path_style           = true
          }
          
          locals { resources = jsondecode(file("\${path.module}/resources.json")) }
          
          resource "aws_iam_user" "users" {
            for_each = { for r in local.resources : r.username => r }
            name     = each.value.username
            tags     = { Dept = each.value.dept }
          }
          
          resource "aws_s3_bucket" "buckets" {
            for_each = { for r in local.resources : r.bucket => r }
            bucket   = each.value.bucket
            tags     = { Tier = each.value.tier }
          }
          
          resource "aws_dynamodb_table" "tables" {
            for_each     = { for r in local.resources : r.table => r }
            name         = each.value.table
            billing_mode = "PAY_PER_REQUEST"
            hash_key     = "PK"
            
            # [FIXED] Multi-line block definition for HCL compliance
            attribute {
              name = "PK"
              type = "S"
            }
            
            tags = { Owner = each.value.username }
          }
          EOF
          
          cd terraform_infra
          terraform init
          tflint --init && tflint || echo "Lint warnings found"
          terraform validate
          echo "‚úÖ IaC Validated."

      # ------------------------------------------------------------------------
      # 4. [Deploy] Ïù∏ÌîÑÎùº ÎåÄÎüâ Î∞∞Ìè¨
      # ------------------------------------------------------------------------
      - name: üöÄ Deploy Cloud Platform
        run: |
          cd terraform_infra
          terraform apply -auto-approve -parallelism=100
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] DEPLOY_SUCCESS: Infrastructure provisioned" >> ../admin_dashboard/system_events.log

      # ------------------------------------------------------------------------
      # 5. [Simulation] Ïõπ, Ïû•Ïï†, ÏÑ±Îä•, ÏÉÅÌÉú Ï≤¥ÌÅ¨
      # ------------------------------------------------------------------------
      - name: üî¨ Comprehensive System Simulation
        run: |
          EVENT_LOG="admin_dashboard/system_events.log"
          
          # 1. Nginx Íµ¨Îèô
          echo "events { worker_connections 2048; } http { server { listen 80; root /var/www/html; } }" > nginx_temp.conf
          sudo mv nginx_temp.conf /etc/nginx/nginx.conf
          echo "Dashboard Loading..." > /var/www/html/index.html
          sudo service nginx restart
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] WEB_SRV: Nginx started on port 80" >> $EVENT_LOG
          
          # 2. Chaos Test (DB Failure)
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] CHAOS_TEST: Simulating DynamoDB outage" >> $EVENT_LOG
          START=$(date +%s%3N)
          docker stop $(docker ps -q --filter ancestor=localstack/localstack)
          sleep 3
          docker start $(docker ps -a -q --filter ancestor=localstack/localstack)
          
          # 3. Auto-Healing
          timeout 90s bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"dynamodb\": \"available\""; do echo "Healing..."; sleep 2; done'
          END=$(date +%s%3N)
          echo "Full_Recovery_Time: $((END-START)) ms" > admin_dashboard/recovery_metrics.txt
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] RECOVERY: System healed in $((END-START))ms" >> $EVENT_LOG
          
          # 4. Load Test (Latency Ï∏°Ï†ï Í∞ïÌôî)
          ab -n 2000 -c 200 http://localhost/ > admin_dashboard/load_test.txt
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] PERF_TEST: Completed 2000 requests" >> $EVENT_LOG
          
          # 5. Service Health Snapshot ÏÉùÏÑ±
          cat <<EOF > admin_dashboard/service_health.json
          {
            "IAM": "Healthy",
            "S3": "Healthy",
            "DynamoDB": "Recovered",
            "Nginx": "Active",
            "Billing": "Active"
          }
          EOF

      # ------------------------------------------------------------------------
      # 6. [Dashboard] NOC ÎåÄÏãúÎ≥¥Îìú Íµ¨Ï∂ï (Chart.js & Live Logs)
      # ------------------------------------------------------------------------
      - name: üñ•Ô∏è Build NOC Dashboard V2
        run: |
          cat <<EOF > build_dashboard.py
          import pandas as pd
          import json, re, datetime

          # 1. Load Data
          try:
              df_cost = pd.read_csv('admin_dashboard/cost_breakdown.csv')
              total_cost = df_cost['Cost'].sum()
              cost_by_service = df_cost.groupby('Service')['Cost'].sum().to_dict()
          except: 
              total_cost=0.0; cost_by_service={}

          try:
              with open('admin_dashboard/load_test.txt') as f:
                  log = f.read()
                  rps = re.search(r'Requests per second:\s+([\d.]+)', log).group(1)
                  p95 = re.search(r'95%\s+(\d+)', log).group(1)
          except: rps="0"; p95="0"

          try:
              with open('admin_dashboard/recovery_metrics.txt') as f:
                  rec_time = f.read().split(': ')[1].strip()
          except: rec_time="N/A"

          try:
              with open('admin_dashboard/service_health.json') as f:
                  health = json.load(f)
          except: health={}

          try:
              with open('admin_dashboard/system_events.log') as f:
                  events = f.readlines()[-10:] # Last 10 events
          except: events = []

          # 2. HTML Template (Bootstrap + Dark Mode + Charts)
          html = f"""
          <!DOCTYPE html>
          <html lang="en" data-bs-theme="dark">
          <head>
              <meta charset="UTF-8">
              <title>2026 Enterprise NOC</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body {{ background-color: #0b0c10; color: #c5c6c7; font-family: 'Segoe UI', sans-serif; }}
                  .card {{ background-color: #1f2833; border: 1px solid #45a29e; margin-bottom: 20px; }}
                  .text-neon {{ color: #66fcf1; }}
                  .status-dot {{ height: 12px; width: 12px; background-color: #4CAF50; border-radius: 50%; display: inline-block; }}
                  .console {{ background: black; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; }}
              </style>
          </head>
          <body>
              <div class="container-fluid p-4">
                  <header class="d-flex justify-content-between mb-4 border-bottom border-secondary pb-3">
                      <div>
                          <h1 class="text-neon fw-bold">üöÄ 2026 Enterprise NOC</h1>
                          <small>Network Operations Center ‚Ä¢ Real-time Monitoring</small>
                      </div>
                      <div class="text-end">
                          <h4 class="text-success"><span class="status-dot"></span> SYSTEM OPERATIONAL</h4>
                          <small>{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</small>
                      </div>
                  </header>

                  <div class="row text-center">
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h6 class="text-muted">Total Monthly Cost</h6>
                              <h2 class="text-warning">${total_cost:,.2f}</h2>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h6 class="text-muted">Throughput (RPS)</h6>
                              <h2 class="text-info">{rps}</h2>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h6 class="text-muted">Latency (P95)</h6>
                              <h2 class="text-danger">{p95} ms</h2>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card p-3">
                              <h6 class="text-muted">Recovery Time</h6>
                              <h2 class="text-success">{rec_time}</h2>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-4">
                          <div class="card p-3">
                              <h5>üí∞ Cost Distribution</h5>
                              <canvas id="costChart"></canvas>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card p-3">
                              <h5>üè• Service Health Matrix</h5>
                              <table class="table table-dark table-striped mt-3">
                                  <thead><tr><th>Service</th><th>Status</th></tr></thead>
                                  <tbody>
          """
          for svc, status in health.items():
              color = "text-success" if status in ["Healthy", "Active", "Recovered"] else "text-danger"
              html += f"<tr><td>{svc}</td><td class='{color} fw-bold'>{status}</td></tr>"
          
          html += """
                                  </tbody>
                              </table>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card p-3">
                              <h5>üíª Live Event Log</h5>
                              <div class="console">
          """
          for line in events:
              html += f"<div>> {line.strip()}</div>"

          html += f"""
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <script>
                  // Cost Chart
                  const ctxCost = document.getElementById('costChart').getContext('2d');
                  new Chart(ctxCost, {{
                      type: 'doughnut',
                      data: {{
                          labels: {list(cost_by_service.keys())},
                          datasets: [{{
                              data: {list(cost_by_service.values())},
                              backgroundColor: ['#45a29e', '#66fcf1', '#c5c6c7', '#ffc107', '#dc3545'],
                              borderWidth: 0
                          }}]
                      }},
                      options: {{ plugins: {{ legend: {{ position: 'bottom', labels: {{ color: 'white' }} }} }} }}
                  }});
              </script>
          </body>
          </html>
          """

          with open('admin_dashboard/index.html', 'w') as f: f.write(html)
          
          # Jekyll Config
          with open('admin_dashboard/_config.yml', 'w') as f:
              f.write("title: 2026 Enterprise NOC\ntheme: jekyll-theme-hacker\n")
          EOF
          
          python build_dashboard.py

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-content
          path: admin_dashboard/

  # ==================================================================================
  # JOB 2: Jekyll ÎπåÎìú
  # ==================================================================================
  build-pages:
    name: üèóÔ∏è Phase 2 - Build Site
    runs-on: ubuntu-latest
    needs: build-platform
    steps:
      - name: üì• Download
        uses: actions/download-artifact@v4
        with:
          name: website-content
          path: .
      - name: ‚öôÔ∏è Setup Pages
        uses: actions/configure-pages@v5
      - name: üî® Build Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
      - name: üì¶ Upload Pages
        uses: actions/upload-pages-artifact@v3

  # ==================================================================================
  # JOB 3: Î∞∞Ìè¨
  # ==================================================================================
  deploy-pages:
    name: üöÄ Phase 3 - Deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-pages
    steps:
      - name: üåç Deploy
        id: deployment
        uses: actions/deploy-pages@v4
