name: ğŸ§¨ 2026 Expert Account & Infra Mass Generator

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ìƒì„±í•  ê³„ì • ì´ ìˆ˜ëŸ‰ (ëª…)'
        required: true
        default: '100'
        type: string
      expert_ratio:
        description: 'ì „ë¬¸ê°€(ê´€ë¦¬ì) ë¹„ìœ¨ (%)'
        required: true
        default: '20' # 100ëª… ì¤‘ 20ëª…ì€ ì „ë¬¸ê°€ ê³„ì •ìœ¼ë¡œ ìƒì„±
        type: string

jobs:
  expert-account-generation:
    name: âš¡ Gen Experts (x${{ inputs.quantity }})
    runs-on: ubuntu-latest

    # IAM(ê³„ì •ê´€ë¦¬) ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ê°€ìƒ AWS
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts,s3
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. [í•µì‹¬] ì „ë¬¸ê°€ vs ì¼ë°˜ ê³„ì • ëŒ€ëŸ‰ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
      # -----------------------------------------------------------
      - name: ğŸ‘¨â€ğŸ’» Generate Massive Expert Credentials
        run: |
          QTY=${{ inputs.quantity }}
          RATIO=${{ inputs.expert_ratio }}
          
          mkdir -p security_audit
          REPORT_FILE="security_audit/2026_account_report.csv"
          
          echo "::: [System] ì „ë¬¸ê°€ ê³„ì • í¬í•¨ ëŒ€ëŸ‰ ìƒì„± ì‹œì‘ (ì´ $QTY ëª…) :::"
          
          # CSV í—¤ë” ì‘ì„± (ì—‘ì…€ í˜¸í™˜)
          echo "Account_ID,Username,Role,Level,Access_Key,Secret_Key,Initial_Password,MFA_Token" > $REPORT_FILE
          
          for i in $(seq 1 $QTY); do
            # ì „ë¬¸ê°€ ë¹„ìœ¨ ê³„ì‚° (ëœë¤ ë˜ëŠ” ìˆœë²ˆ)
            # 1~100 ì‚¬ì´ì˜ ë‚œìˆ˜ê°€ RATIOë³´ë‹¤ ì‘ìœ¼ë©´ ì „ë¬¸ê°€ë¡œ íŒì •
            CHANCE=$(( RANDOM % 100 ))
            
            if [ $CHANCE -lt $RATIO ]; then
              # [ì „ë¬¸ê°€ ê³„ì • ìƒì„± ë¡œì§]
              ROLE="Expert_Admin"
              LEVEL="Lv.9 (Master)"
              USER_PREFIX="admin_ops"
              # ë³µì¡í•œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
              PASS="EXP-$(openssl rand -base64 12)"
            else
              # [ì¼ë°˜ ê³„ì • ìƒì„± ë¡œì§]
              ROLE="Standard_User"
              LEVEL="Lv.1 (Staff)"
              USER_PREFIX="user_staff"
              PASS="usr-$(openssl rand -hex 4)"
            fi
            
            USERNAME="${USER_PREFIX}_$(printf "%03d" $i)"
            ACCESS_KEY="AKIA$(openssl rand -hex 8 | tr 'a-z' 'A-Z')"
            SECRET_KEY="$(openssl rand -base64 20)"
            MFA_DEVICE="arn:aws:iam::2026:mfa/$USERNAME"
            
            # CSV íŒŒì¼ì— í•œ ì¤„ ì¶”ê°€ (ë°ì´í„° ì ì¬)
            echo "ACC-2026-$i,$USERNAME,$ROLE,$LEVEL,$ACCESS_KEY,$SECRET_KEY,$PASS,$MFA_DEVICE" >> $REPORT_FILE
          done
          
          echo "âœ… ì´ $QTY ëª…ì˜ ê³„ì • ì •ë³´ ìƒì„± ì™„ë£Œ."
          echo "::: ì „ë¬¸ê°€ ê³„ì • ìƒ˜í”Œ (ìƒìœ„ 5ëª…) :::"
          head -n 6 $REPORT_FILE

      # -----------------------------------------------------------
      # 2. Terraformì„ í†µí•œ IAM ë¦¬ì†ŒìŠ¤ ê³µì‹ ë°˜ì˜ (ê°€ìƒí™˜ê²½)
      # -----------------------------------------------------------
      - name: ğŸ› ï¸ Generate IAM Terraform Code
        run: |
          mkdir -p terraform_iam
          
          # CSV íŒŒì¼ì„ ì½ì–´ì„œ Terraform ë¦¬ì†ŒìŠ¤ë¡œ ë³€í™˜í•˜ëŠ” ë¡œì§ì€ ë³µì¡í•˜ë¯€ë¡œ
          # ì—¬ê¸°ì„œëŠ” ìƒì„±ëœ ìˆ˜ëŸ‰ë§Œí¼ IAM Userë¥¼ Loopë¡œ ìƒì„±í•˜ëŠ” ì½”ë“œ ì‘ì„±
          
          cat <<EOF > terraform_iam/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            skip_credentials_validation = true
            skip_requesting_account_id = true
            endpoints { iam = "http://localhost:4566" }
          }
          
          variable "total_users" { default = ${{ inputs.quantity }} }
          
          # 1. ëª¨ë“  ì‚¬ìš©ì ê³„ì • ë¦¬ì†ŒìŠ¤ ìƒì„±
          resource "aws_iam_user" "mass_users" {
            count = var.total_users
            name  = "employee-\${count.index + 1}"
            path  = "/system/"
          }
          
          # 2. ì „ë¬¸ê°€(Admin) ê·¸ë£¹ ìƒì„±
          resource "aws_iam_group" "experts" {
            name = "Expert-Admins-2026"
          }
          
          # 3. ì „ë¬¸ê°€ ê¶Œí•œ ë¶€ì—¬ (AdministratorAccess)
          resource "aws_iam_group_policy_attachment" "admin_access" {
            group      = aws_iam_group.experts.name
            policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"
          }
          EOF

      # -----------------------------------------------------------
      # 3. ê°€ìƒ ì¸í”„ë¼(IAM) ë°°í¬ ì ìš©
      # -----------------------------------------------------------
      - name: ğŸ—ï¸ Apply IAM Policies
        uses: hashicorp/setup-terraform@v3

      - name: ğŸš€ Deploy Accounts to Virtual Cloud
        run: |
          cd terraform_iam
          terraform init
          terraform apply -auto-approve
          echo "âœ… ê°€ìƒ í´ë¼ìš°ë“œì— IAM ì‚¬ìš©ì ë° ê·¸ë£¹ ì •ì±… ë°˜ì˜ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 4. [ì¤‘ìš”] ê³„ì • ì •ë³´ íŒŒì¼(ì—‘ì…€ìš©) ë‹¤ìš´ë¡œë“œ ì œê³µ
      # -----------------------------------------------------------
      - name: ğŸ“¦ Download Expert Credentials
        uses: actions/upload-artifact@v4
        with:
          name: 2026_Expert_Account_List
          path: |
            security_audit/2026_account_report.csv
            terraform_iam/terraform.tfstate
