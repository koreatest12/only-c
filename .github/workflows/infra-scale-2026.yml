name: ğŸ—ï¸ 2026 Infrastructure Scaling Manager (Only-C)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ ëŒ€ìƒ í™˜ê²½ (dev / prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action_type:
        description: 'ìˆ˜í–‰í•  ì‘ì—… ìœ í˜•'
        required: true
        type: choice
        options:
          - create_db          # DB ì‹ ê·œ ìƒì„±
          - expand_db_storage  # DB ìš©ëŸ‰ ì¦ì„¤
          - add_disk           # ë””ìŠ¤í¬ ì¶”ê°€
          - expand_disk        # ë””ìŠ¤í¬ ì¦ì„¤
      resource_identifier:
        description: 'ëŒ€ìƒ ë¦¬ì†ŒìŠ¤ ID ë˜ëŠ” ì´ë¦„ (ì˜ˆ: db-main-01, vol-data-02)'
        required: true
        type: string
      target_size_gb:
        description: 'ë³€ê²½í•  ëª©í‘œ ìš©ëŸ‰ (GB ë‹¨ìœ„)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write # í´ë¼ìš°ë“œ ì¸ì¦ì„ ìœ„í•œ ê¶Œí•œ

jobs:
  infra-scaling:
    name: âš™ï¸ Manage Infra (${{ inputs.action_type }})
    runs-on: ubuntu-latest
    env:
      TF_VAR_environment: ${{ inputs.environment }}
      TF_VAR_target_resource: ${{ inputs.resource_identifier }}
      TF_VAR_target_size: ${{ inputs.target_size_gb }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      # AWS/GCP/Azure ì¸ì¦ (ì˜ˆì‹œ: AWS)
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: ğŸ” Plan Infrastructure Changes
        id: plan
        run: |
          echo "### ğŸš€ Plan: ${{ inputs.action_type }} for ${{ inputs.resource_identifier }}"
          
          # ì…ë ¥ëœ ì‘ì—… ìœ í˜•ì— ë”°ë¼ Terraform ë³€ìˆ˜ ë™ì  í• ë‹¹
          if [ "${{ inputs.action_type }}" == "create_db" ]; then
            terraform plan -var="create_db=true" -var="db_name=${{ inputs.resource_identifier }}" -out=tfplan
          elif [ "${{ inputs.action_type }}" == "expand_db_storage" ]; then
            terraform plan -var="db_storage_size=${{ inputs.target_size_gb }}" -out=tfplan
          elif [ "${{ inputs.action_type }}" == "add_disk" ]; then
            terraform plan -var="add_new_disk=true" -var="disk_size=${{ inputs.target_size_gb }}" -out=tfplan
          elif [ "${{ inputs.action_type }}" == "expand_disk" ]; then
            terraform plan -var="resize_disk_id=${{ inputs.resource_identifier }}" -var="new_disk_size=${{ inputs.target_size_gb }}" -out=tfplan
          fi
        working-directory: ./terraform

      - name: ğŸš€ Apply Infrastructure Changes
        if: github.ref == 'refs/heads/main' && inputs.environment == 'prod' # ë©”ì¸ ë¸Œëœì¹˜ & Prod í™˜ê²½ì¼ ë•Œë§Œ ì‹¤ì œ ì ìš©
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform

      - name: ğŸ“¢ Notification
        if: always()
        run: |
          echo "ì¸í”„ë¼ ì‘ì—… ${{ inputs.action_type }} ì™„ë£Œ. ëŒ€ìƒ: ${{ inputs.resource_identifier }}, í¬ê¸°: ${{ inputs.target_size_gb }}GB"
