name: ğŸ§¨ 2026 Ultimate Enterprise System (All-in-One)

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ê´€ë¦¬ ëŒ€ìƒ ê³„ì • ìˆ˜ëŸ‰ (ëª…)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'ì „ë¬¸ê°€(ê´€ë¦¬ì) ë¹„ìœ¨ (%)'
        required: true
        default: '20'
        type: string
  push:
    branches: ["main"]
  schedule:
    - cron: '*/20 * * * *'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================================================================================
  # JOB 1: ì‹œìŠ¤í…œ êµ¬ì¶• ë° ì‹œë®¬ë ˆì´ì…˜ (System Build & Simulation)
  # ==================================================================================
  full-stack-build:
    name: âš¡ Phase 1 - Build Infra, Web, Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts,s3
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # [CRITICAL FIX] Terraform ì„¤ì¹˜ (Action ì‚¬ìš© + ìˆ˜ë™ ì„¤ì¹˜ Fallback)
      # ------------------------------------------------------------------------
      - name: ğŸ› ï¸ Setup Terraform (Dual-Check)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
          terraform_wrapper: false # ë¡œê·¸ íŒŒì‹±ì„ ìœ„í•´ Wrapper ë¹„í™œì„±í™”

      - name: âš™ï¸ Setup Environment (Python, Nginx, Utils)
        run: |
          echo "::: [System] í•„ìˆ˜ íŒ¨í‚¤ì§€ ëŒ€ëŸ‰ ì„¤ì¹˜ ë° ê²€ì¦ :::"
          
          # 1. Terraform ì„¤ì¹˜ í™•ì¸ (ì—†ìœ¼ë©´ ìˆ˜ë™ ì„¤ì¹˜ - ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
          if ! command -v terraform &> /dev/null; then
              echo "Terraform not found via Action. Installing manually..."
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install terraform
          fi
          terraform --version
          
          # 2. Python ë°ì´í„° ë¶„ì„ í™˜ê²½
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib
          
          # 3. ì›¹ ì„œë²„ ë° ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë„êµ¬
          sudo apt-get update
          sudo apt-get install -y nginx apache2-utils
          
          echo "âœ… ëª¨ë“  í™˜ê²½ ì„¤ì • ì™„ë£Œ (All Green)"

      # ------------------------------------------------------------------------
      # [Phase 1] ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± ë° ì´ê´€ (Migration ETL)
      # ------------------------------------------------------------------------
      - name: ğŸ¢ Generate & Migrate Data
        run: |
          INPUT_QTY="${{ inputs.quantity }}"
          QTY="${INPUT_QTY:-1000}"
          RATIO="${{ inputs.expert_ratio || 20 }}"
          
          mkdir -p legacy_data cloud_staging admin_dashboard terraform_iam
          JSON_FILE="terraform_iam/users.json"
          MIG_LOG="admin_dashboard/migration.log"
          DB_CSV="admin_dashboard/database.csv"
          
          echo "::: [Migration] $QTY ëª…ì˜ ë°ì´í„° ì´ê´€ ì‹œì‘ :::"
          echo "[" > $JSON_FILE
          echo "EmpID,User,Role,Dept,Region,Status" > $DB_CSV
          
          DEPTS=("DevOps" "Security" "HR" "Sales")
          REGIONS=("ap-northeast-2" "us-east-1")
          
          for i in $(seq 1 $QTY); do
            SUFFIX=$(date +%s%N | cut -b10-13)
            USER="user_$(printf "%04d" $i)_$SUFFIX"
            
            # ì „ë¬¸ê°€/ì¼ë°˜ íŒë³„
            if [ $((RANDOM%100)) -lt $RATIO ]; then ROLE="Expert-Admin"; else ROLE="Staff-User"; fi
            
            DEPT=${DEPTS[$RANDOM % ${#DEPTS[@]}]}
            REGION=${REGIONS[$RANDOM % ${#REGIONS[@]}]}
            
            # ë¡œê·¸ ë° DB ê¸°ë¡
            echo "[$(date '+%T')] MIGRATION SUCCESS: $USER -> Cloud($REGION)" >> $MIG_LOG
            echo "EMP-$i,$USER,$ROLE,$DEPT,$REGION,Active" >> $DB_CSV
            
            # Terraformìš© JSON ìƒì„±
            echo "  { \"username\": \"$USER\", \"group\": \"$ROLE\", \"tags\": {\"Dept\":\"$DEPT\"} }," >> $JSON_FILE
          done
          
          # JSON ë§ˆë¬´ë¦¬ (ë§ˆì§€ë§‰ ì½¤ë§ˆ ì²˜ë¦¬ìš© ë”ë¯¸ ë°ì´í„°)
          echo "  { \"username\": \"system_dummy\", \"group\": \"none\", \"tags\": {} } ]" >> $JSON_FILE
          echo "âœ… ë°ì´í„° ìƒì„± ë° ì´ê´€ ì™„ë£Œ."

      # ------------------------------------------------------------------------
      # [Phase 2] ì¸í”„ë¼ ë°°í¬ (Terraform Infra Provisioning)
      # ------------------------------------------------------------------------
      - name: ğŸš€ Provision Infrastructure
        run: |
          echo "::: [Infra] Terraform ì½”ë“œ ìƒì„± ë° ë°°í¬ :::"
          
          cat <<EOF > terraform_iam/main.tf
          terraform {
            required_providers {
              aws = { source = "hashicorp/aws", version = "~> 5.0" }
            }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            endpoints { iam = "http://localhost:4566" }
            skip_credentials_validation = true
            skip_requesting_account_id = true
          }
          
          locals { users = jsondecode(file("\${path.module}/users.json")) }
          
          resource "aws_iam_user" "users" {
            for_each = { for u in local.users : u.username => u }
            name = each.value.username
            tags = each.value.tags
          }
          EOF
          
          cd terraform_iam
          terraform init
          terraform apply -auto-approve -parallelism=100
          echo "âœ… ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ."

      # ------------------------------------------------------------------------
      # [Phase 3] ì›¹ ì„œë²„ êµ¬ë™ ë° ë¶€í•˜/ì¥ì•  í…ŒìŠ¤íŠ¸ (Chaos & Load Test)
      # ------------------------------------------------------------------------
      - name: ğŸ›‘ Chaos & Performance Test
        run: |
          echo "::: [Web] Nginx ì›¹ ì„œë²„ êµ¬ë™ :::"
          echo "events { worker_connections 1024; } http { server { listen 80; root /var/www/html; index index.html; } }" > nginx.conf
          sudo mv nginx.conf /etc/nginx/nginx.conf
          sudo mkdir -p /var/www/html
          sudo service nginx restart
          
          echo "::: [Chaos] ì‹œìŠ¤í…œ ì¥ì• (Down) ì‹œë®¬ë ˆì´ì…˜ :::"
          START=$(date +%s%3N)
          docker stop $(docker ps -q --filter ancestor=localstack/localstack)
          sleep 2
          docker start $(docker ps -a -q --filter ancestor=localstack/localstack)
          
          # Health Check Loop
          timeout 60s bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"iam\": \"available\""; do echo "Waiting for recovery..."; sleep 1; done'
          END=$(date +%s%3N)
          RECOVERY_TIME=$((END-START))
          echo "Recovery Time: $RECOVERY_TIME ms" > admin_dashboard/recovery.txt
          
          echo "::: [Load Test] ëŒ€ëŸ‰ íŠ¸ë˜í”½ ë¶€í•˜ í…ŒìŠ¤íŠ¸ (1,000 Req) :::"
          # ëŒ€ì‹œë³´ë“œ íŒŒì¼ì´ ì•„ì§ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œ íŒŒì¼ ìƒì„±í•˜ì—¬ í…ŒìŠ¤íŠ¸
          sudo echo "Load Test Pending" > /var/www/html/index.html
          ab -n 1000 -c 100 http://localhost/ > admin_dashboard/load_test.txt
          
          echo "âœ… ì‹œìŠ¤í…œ ì•ˆì •ì„± ê²€ì¦ ì™„ë£Œ."

      # ------------------------------------------------------------------------
      # [Phase 4] ê´€ì œ ëŒ€ì‹œë³´ë“œ(Jekyllìš©) ìƒì„±
      # ------------------------------------------------------------------------
      - name: ğŸ–¥ï¸ Build Dashboard for GitHub Pages
        run: |
          cat <<EOF > build_web.py
          import pandas as pd
          import datetime, re
          
          # ë°ì´í„° ë¡œë“œ
          try:
              df = pd.read_csv('admin_dashboard/database.csv')
              total = len(df)
              experts = len(df[df['Role'].str.contains('Expert')])
              depts = df['Dept'].value_counts().to_dict()
          except: total=0; experts=0; depts={}
          
          # ì„±ëŠ¥ ì§€í‘œ ë¡œë“œ
          try:
              with open('admin_dashboard/load_test.txt') as f:
                  log = f.read()
                  rps = re.search(r'Requests per second:\s+([\d.]+)', log).group(1)
          except: rps="0"
          
          try:
              with open('admin_dashboard/recovery.txt') as f:
                  rec_time = f.read()
          except: rec_time="N/A"
          
          # HTML ìƒì„± (Markdown + HTML í˜¼ìš© for Jekyll)
          md_content = f"""---
          layout: default
          title: 2026 Enterprise Monitor
          ---
          
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
          
          <div class="container mt-4 text-white">
              <div class="p-5 mb-4 bg-dark rounded-3 border border-secondary">
                  <div class="container-fluid py-5">
                      <h1 class="display-5 fw-bold text-info">ğŸš€ 2026 Enterprise Live Dashboard</h1>
                      <p class="col-md-8 fs-4">Real-time infrastructure monitoring system deployed via GitHub Actions.</p>
                      <p>Last Updated: {datetime.datetime.now()}</p>
                      <span class="badge bg-success">SYSTEM OPERATIONAL</span>
                  </div>
              </div>
          
              <div class="row text-center mb-4">
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h3>Total Accounts</h3><h1>{total}</h1></div></div>
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h3>Admin Users</h3><h1 class="text-warning">{experts}</h1></div></div>
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h3>Web Performance</h3><h1 class="text-success">{rps} req/s</h1></div></div>
                  <div class="col-md-3"><div class="card bg-secondary p-3"><h3>Recovery Time</h3><h1 class="text-danger">{rec_time}</h1></div></div>
              </div>

              <div class="card bg-dark text-white p-4">
                  <h3>Deparment Distribution</h3>
                  <ul>
          """
          for dept, count in depts.items():
              md_content += f"<li><strong>{dept}:</strong> {count} users</li>"
              
          md_content += """
                  </ul>
              </div>
          </div>
          """
          
          with open('admin_dashboard/index.html', 'w') as f: f.write(md_content)
          
          # Jekyll Config ìƒì„±
          with open('admin_dashboard/_config.yml', 'w') as f:
              f.write("title: 2026 Enterprise Monitor\ntheme: jekyll-theme-slate\n")
          EOF
          
          python build_web.py

      # ------------------------------------------------------------------------
      # [Phase 5] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ìŒ Jobìœ¼ë¡œ ì „ë‹¬)
      # ------------------------------------------------------------------------
      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-content
          path: admin_dashboard/

  # ==================================================================================
  # JOB 2: Jekyll ì‚¬ì´íŠ¸ ë¹Œë“œ (Build Pages)
  # ==================================================================================
  build-pages:
    name: ğŸ—ï¸ Phase 2 - Build Jekyll Site
    runs-on: ubuntu-latest
    needs: full-stack-build
    steps:
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: website-content
          path: .
      - name: âš™ï¸ Setup Pages
        uses: actions/configure-pages@v5
      - name: ğŸ”¨ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
      - name: ğŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3

  # ==================================================================================
  # JOB 3: GitHub Pages ë°°í¬ (Deploy Pages)
  # ==================================================================================
  deploy-pages:
    name: ğŸš€ Phase 3 - Deploy to Global
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-pages
    steps:
      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
