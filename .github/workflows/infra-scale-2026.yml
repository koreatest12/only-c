name: ğŸ§¨ 2026 Expert Account & Infra Mass Generator

on:
  # 1. ìˆ˜ë™ ì‹¤í–‰ (ê¸°ë³¸ 1,000ëª… ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸)
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ìƒì„±í•  ê³„ì • ì´ ìˆ˜ëŸ‰ (ëª…)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'ì „ë¬¸ê°€(ê´€ë¦¬ì) ë¹„ìœ¨ (%)'
        required: true
        default: '20'
        type: string

  # 2. ìë™ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ 20ë¶„ë§ˆë‹¤ ë°˜ë³µ ê²€ì¦)
  schedule:
    - cron: '*/20 * * * *'

jobs:
  expert-account-generation:
    name: âš¡ Mass Gen & Chaos Test
    runs-on: ubuntu-latest
    timeout-minutes: 20 # ëŒ€ëŸ‰ ë³µêµ¬ í…ŒìŠ¤íŠ¸ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ íƒ€ì„ì•„ì›ƒ ì—°ì¥
    
    # IAM ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ê°€ìƒ AWS (LocalStack)
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. [ë°ì´í„° ìƒì„±] 1,000ëª… ê·œëª¨ì˜ ê³„ì • ë°ì´í„° ìƒì„±
      # -----------------------------------------------------------
      - name: ğŸ‘¨â€ğŸ’» Generate Massive Expert Data
        id: gen_data
        run: |
          # ì…ë ¥ê°’ Fallback ì²˜ë¦¬ (ìë™ ì‹¤í–‰ ì‹œ ê¸°ë³¸ê°’ ì ìš©)
          INPUT_QTY="${{ inputs.quantity }}"
          INPUT_RATIO="${{ inputs.expert_ratio }}"
          QTY="${INPUT_QTY:-500}"      # ìë™ ì‹¤í–‰ ì‹œ 500ëª…
          RATIO="${INPUT_RATIO:-20}"
          
          mkdir -p security_audit terraform_iam
          CSV_FILE="security_audit/2026_account_report.csv"
          JSON_FILE="terraform_iam/users.json"
          
          echo "::: [Init] ëŒ€ëŸ‰ ê³„ì • ë°ì´í„° ìƒì„± (ê·œëª¨: $QTY ëª…) :::"
          
          # CSV í—¤ë” & JSON ì‹œì‘
          echo "Account_ID,Username,Group,Access_Key,Secret_Key,Initial_Password" > $CSV_FILE
          echo "[" > $JSON_FILE
          
          for i in $(seq 1 $QTY); do
            CHANCE=$(( RANDOM % 100 ))
            if [ $CHANCE -lt $RATIO ]; then
              GROUP="Expert-Admins"
              USER_PREFIX="admin_ops"
            else
              GROUP="Standard-Users"
              USER_PREFIX="user_staff"
            fi
            
            # ê³ ìœ  ì‹ë³„ì (ì¤‘ë³µ ë°©ì§€)
            SUFFIX=$(date +%s%N | cut -b10-13)
            USERNAME="${USER_PREFIX}_$(printf "%04d" $i)_$SUFFIX"
            PASS="pw-$(openssl rand -hex 4)"
            
            echo "ACC-2026-$i,$USERNAME,$GROUP,KEY,SECRET,$PASS" >> $CSV_FILE
            
            if [ "$i" -eq "$QTY" ]; then
              echo "  { \"username\": \"$USERNAME\", \"group\": \"$GROUP\" }" >> $JSON_FILE
            else
              echo "  { \"username\": \"$USERNAME\", \"group\": \"$GROUP\" }," >> $JSON_FILE
            fi
          done
          echo "]" >> $JSON_FILE
          echo "âœ… ë°ì´í„° ìƒì„± ì™„ë£Œ."

      # -----------------------------------------------------------
      # 2. [Terraform] ì½”ë“œ ìƒì„±
      # -----------------------------------------------------------
      - name: ğŸ› ï¸ Generate Scalable Terraform Code
        run: |
          cat <<EOF > terraform_iam/main.tf
          terraform {
            required_providers { aws = { source = "hashicorp/aws", version = "~> 5.0" } }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            skip_credentials_validation = true
            skip_requesting_account_id = true
            endpoints { iam = "http://localhost:4566" }
          }
          locals { users_data = jsondecode(file("\${path.module}/users.json")) }
          
          resource "aws_iam_group" "expert_group" { name = "Expert-Admins" }
          resource "aws_iam_group" "standard_group" { name = "Standard-Users" }
          
          resource "aws_iam_user" "mass_users" {
            for_each = { for user in local.users_data : user.username => user }
            name     = each.value.username
            path     = "/system/"
          }
          
          resource "aws_iam_user_group_membership" "mass_membership" {
            for_each = { for user in local.users_data : user.username => user }
            user   = aws_iam_user.mass_users[each.key].name
            groups = [ each.value.group == "Expert-Admins" ? aws_iam_group.expert_group.name : aws_iam_group.standard_group.name ]
          }
          EOF

      # -----------------------------------------------------------
      # 3. [ì´ˆê¸° ë°°í¬] 1ì°¨ ëŒ€ëŸ‰ ë°°í¬ ì‹¤í–‰
      # -----------------------------------------------------------
      - name: ğŸ—ï¸ Terraform Init & Apply (Initial)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: ğŸš€ Deploy Massive Infra (x100 Parallelism)
        run: |
          cd terraform_iam
          terraform init
          echo "::: 1ì°¨ ë°°í¬ ì‹œì‘ :::"
          terraform apply -auto-approve -parallelism=100
          echo "âœ… 1ì°¨ ë°°í¬ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 4. [í•µì‹¬ ê¸°ëŠ¥] ì»¨í…Œì´ë„ˆ ì •ì§€(Stop) -> ì¬ì‹œì‘(Start) ì‹œë®¬ë ˆì´ì…˜
      # -----------------------------------------------------------
      - name: ğŸ›‘ Simulate System Crash (Container Stop)
        run: |
          echo "::: âš ï¸ [ì¹´ì˜¤ìŠ¤ í…ŒìŠ¤íŠ¸] ì‹œìŠ¤í…œ ê°•ì œ ì •ì§€ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ :::"
          
          # LocalStack ì»¨í…Œì´ë„ˆ ID ì°¾ê¸°
          CONTAINER_ID=$(docker ps -q --filter ancestor=localstack/localstack)
          echo "Target Container ID: $CONTAINER_ID"
          
          # ì»¨í…Œì´ë„ˆ ê°•ì œ ì •ì§€
          docker stop $CONTAINER_ID
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì •ì§€ ì™„ë£Œ. ì„œë¹„ìŠ¤ ë‹¤ìš´ ìƒíƒœì…ë‹ˆë‹¤."
          echo "::: 5ì´ˆê°„ ëŒ€ê¸° (ì¥ì•  ìƒí™© ìœ ì§€) :::"
          sleep 5

      - name: â™»ï¸ System Recovery (Container Start)
        run: |
          echo "::: ğŸš‘ [ë³µêµ¬ ëª¨ë“œ] ì‹œìŠ¤í…œ ì¬ê°€ë™ ì‹œì‘ :::"
          
          # ì •ì§€ëœ ì»¨í…Œì´ë„ˆ ë‹¤ì‹œ ì‹œì‘
          # (GitHub Actions Service ì»¨í…Œì´ë„ˆëŠ” docker startë¡œ ì¬ê°œ ê°€ëŠ¥)
          CONTAINER_ID=$(docker ps -a -q --filter ancestor=localstack/localstack)
          docker start $CONTAINER_ID
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ëª…ë ¹ ì „ë‹¬ë¨. í—¬ìŠ¤ ì²´í¬ ëŒ€ê¸° ì¤‘..."
          
          # ì„œë¹„ìŠ¤ê°€ ì™„ì „íˆ ì˜¬ë¼ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸° (Health Check Loop)
          timeout 60s bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"iam\": \"available\""; do echo "Waiting for IAM service..."; sleep 2; done'
          
          echo "âœ… ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™ í™•ì¸ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 5. [ì¬ì‹¤í–‰ ë° ë³µêµ¬] ëŒ€ëŸ‰ ì¸í”„ë¼ ìê°€ ì¹˜ìœ (Self-Healing) ê²€ì¦
      # -----------------------------------------------------------
      - name: ğŸš‘ Self-Healing & Re-Execution
        run: |
          cd terraform_iam
          
          echo "::: [ì¬ì‹¤í–‰] ì‹œìŠ¤í…œ ì¬ë¶€íŒ… í›„ ì¸í”„ë¼ ìƒíƒœ ë™ê¸°í™” (Drift Detection) :::"
          # LocalStack(Community)ì€ ì¬ì‹œì‘ ì‹œ ë©”ëª¨ë¦¬ ë°ì´í„°ê°€ íœ˜ë°œë˜ë¯€ë¡œ
          # Terraformì´ ì´ë¥¼ ê°ì§€í•˜ê³  1,000ëª…ì˜ ìœ ì €ë¥¼ 'ë‹¤ì‹œ ìƒì„±'í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
          
          echo "Running Terraform Plan..."
          terraform plan -out=recovery_plan
          
          echo "::: [ëŒ€ëŸ‰ ë³µêµ¬] ì‚¬ë¼ì§„ ë¦¬ì†ŒìŠ¤ ì¦‰ì‹œ ë³µêµ¬ ìˆ˜í–‰ :::"
          terraform apply -auto-approve -parallelism=100 recovery_plan
          
          echo "âœ… ì‹œìŠ¤í…œ ì¬í•´ ë³µêµ¬(Disaster Recovery) í…ŒìŠ¤íŠ¸ ì„±ê³µ."

      # -----------------------------------------------------------
      # 6. ê²°ê³¼ë¬¼ ì €ì¥
      # -----------------------------------------------------------
      - name: ğŸ“¦ Archive Logs & Reports
        uses: actions/upload-artifact@v4
        with:
          name: 2026_Chaos_Test_Result_${{ github.run_id }}
          path: |
            security_audit/2026_account_report.csv
            terraform_iam/users.json
            terraform_iam/terraform.tfstate
