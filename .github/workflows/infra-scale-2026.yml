name: ğŸ§¨ Force Account Gen & Mass Deploy (LocalStack)

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ê°•ì œ ìƒì„±í•  ë¦¬ì†ŒìŠ¤ ìˆ˜ëŸ‰'
        required: true
        default: '50'
        type: string

jobs:
  force-generation:
    name: âš¡ Force Create Account & Resources
    runs-on: ubuntu-latest
    
    # [í•µì‹¬] ê°€ìƒì˜ AWS(LocalStack)ë¥¼ ëŸ¬ë„ˆ ë‚´ë¶€ì—ì„œ ê°•ì œ êµ¬ë™
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ec2,rds,iam,sts
          DEFAULT_REGION: ap-northeast-2
          DEBUG: 1

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. ê³„ì • ì •ë³´(ìê²© ì¦ëª…) ê°•ì œ ìƒì„± ë‹¨ê³„
      # -----------------------------------------------------------
      - name: ğŸ”‘ Force Generate Access Credentials
        id: creds
        run: |
          echo "::: [Emergency] ê³„ì • ì •ë³´ ê°•ì œ ìƒì„± ì¤‘... :::"
          
          # ëœë¤í•œ Access Key / Secret Key ìƒì„±
          GEN_ACCESS_KEY="FORCE-GEN-$(openssl rand -hex 6 | tr 'a-f' 'A-F')"
          GEN_SECRET_KEY="FORCE-SECRET-$(openssl rand -hex 16)"
          GEN_ACCOUNT_ID="000000000000" # LocalStack ê¸°ë³¸ ID
          
          echo "ACCESS_KEY=$GEN_ACCESS_KEY" >> $GITHUB_ENV
          echo "SECRET_KEY=$GEN_SECRET_KEY" >> $GITHUB_ENV
          
          # ìƒì„±ëœ ì •ë³´ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (ì‚¬ìš©ì ë‹¤ìš´ë¡œë“œìš©)
          mkdir -p generated_info
          echo "==========================================" > generated_info/account_info.txt
          echo " [ ê¸´ê¸‰ ìƒì„±ëœ ê³„ì • ì •ë³´ ë¦¬í¬íŠ¸ ] " >> generated_info/account_info.txt
          echo "==========================================" >> generated_info/account_info.txt
          echo "STATUS: SUCCESS (Forced)" >> generated_info/account_info.txt
          echo "Timestamp: $(date)" >> generated_info/account_info.txt
          echo "Access Key ID: $GEN_ACCESS_KEY" >> generated_info/account_info.txt
          echo "Secret Access Key: $GEN_SECRET_KEY" >> generated_info/account_info.txt
          echo "Region: ap-northeast-2" >> generated_info/account_info.txt
          echo "Endpoint: http://localhost:4566" >> generated_info/account_info.txt
          echo "==========================================" >> generated_info/account_info.txt
          
          echo "âœ… ê³„ì • ì •ë³´ ìƒì„± ì™„ë£Œ: $GEN_ACCESS_KEY"

      # -----------------------------------------------------------
      # 2. ê°€ìƒ í™˜ê²½ì— ë¡œê·¸ì¸ (Configure AWS CLI)
      # -----------------------------------------------------------
      - name: ğŸ”Œ Connect to Virtual Cloud
        run: |
          aws configure set aws_access_key_id ${{ env.ACCESS_KEY }}
          aws configure set aws_secret_access_key ${{ env.SECRET_KEY }}
          aws configure set region ap-northeast-2
          aws configure set output json
          
          echo "::: ê°€ìƒ í´ë¼ìš°ë“œ ì ‘ì† í…ŒìŠ¤íŠ¸ :::"
          # ì‹¤ì œ AWSê°€ ì•„ë‹Œ ë‚´ë¶€ LocalStack(localhost:4566)ìœ¼ë¡œ ì ‘ì†
          aws --endpoint-url=http://localhost:4566 sts get-caller-identity

      # -----------------------------------------------------------
      # 3. Terraform ì½”ë“œ ë™ì  ìƒì„± (ê°€ìƒí™˜ê²½ìš© Provider ì„¤ì • í¬í•¨)
      # -----------------------------------------------------------
      - name: ğŸ› ï¸ Generate Terraform Code (For Virtual Env)
        run: |
          mkdir -p terraform_force
          
          # LocalStack ì „ìš© Provider ì„¤ì •ì´ í¬í•¨ëœ main.tf ìƒì„±
          cat <<EOF > terraform_force/main.tf
          terraform {
            required_providers {
              aws = {
                source  = "hashicorp/aws"
                version = "~> 5.0"
              }
            }
          }

          provider "aws" {
            region                      = "ap-northeast-2"
            access_key                  = "${{ env.ACCESS_KEY }}"
            secret_key                  = "${{ env.SECRET_KEY }}"
            skip_credentials_validation = true
            skip_metadata_api_check     = true
            skip_requesting_account_id  = true
            
            # [ì¤‘ìš”] ëª¨ë“  ìš”ì²­ì„ ê°€ìƒ ì„œë²„(LocalStack)ë¡œ ìš°íšŒ
            endpoints {
              ec2 = "http://localhost:4566"
              rds = "http://localhost:4566"
              s3  = "http://localhost:4566"
              iam = "http://localhost:4566"
              sts = "http://localhost:4566"
            }
          }

          variable "quantity" { default = ${{ inputs.quantity }} }

          # ëŒ€ëŸ‰ DB ìƒì„±
          resource "aws_db_instance" "force_db" {
            count = var.quantity
            identifier = "force-created-db-\${count.index + 1}"
            allocated_storage = 20
            instance_class    = "db.t3.micro"
            engine            = "mysql"
            username          = "admin"
            password          = "ForcePass1234!"
            skip_final_snapshot = true
          }

          # ëŒ€ëŸ‰ ë²„í‚· ìƒì„±
          resource "aws_s3_bucket" "force_bucket" {
            count = 5
            bucket = "force-data-bucket-\${count.index + 1}"
          }
          EOF

      # -----------------------------------------------------------
      # 4. Terraform ì‹¤í–‰ (ë¬´ì¡°ê±´ ì„±ê³µí•¨)
      # -----------------------------------------------------------
      - name: ğŸ—ï¸ Terraform Apply (Force)
        uses: hashicorp/setup-terraform@v3

      - name: ğŸš€ Deploy to Virtual Cloud
        run: |
          cd terraform_force
          terraform init
          terraform apply -auto-approve
          
          echo "âœ… ëŒ€ëŸ‰ ë¦¬ì†ŒìŠ¤ ìƒì„± ì™„ë£Œ."

      # -----------------------------------------------------------
      # 5. ê²°ê³¼ë¬¼(ê³„ì •ì •ë³´ + TerraformìƒíƒœíŒŒì¼) ë‹¤ìš´ë¡œë“œ ì œê³µ
      # -----------------------------------------------------------
      - name: ğŸ“¦ Archive Account Info & State
        uses: actions/upload-artifact@v4
        with:
          name: Forced-Account-Info-and-Resources
          path: |
            generated_info/account_info.txt
            terraform_force/terraform.tfstate
