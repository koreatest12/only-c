name: ğŸ§¨ 2026 Enterprise Migration & Mass Infra Generator

on:
  workflow_dispatch:
    inputs:
      quantity:
        description: 'ì´ê´€ ë° ìƒì„±í•  ê³„ì • ìˆ˜ëŸ‰ (ëª…)'
        required: true
        default: '1000'
        type: string
      expert_ratio:
        description: 'ì „ë¬¸ê°€(ê´€ë¦¬ì) ë¹„ìœ¨ (%)'
        required: true
        default: '20'
        type: string

  schedule:
    - cron: '*/20 * * * *'

jobs:
  enterprise-migration-simulation:
    name: âš¡ Migration & Mass Gen (x${{ inputs.quantity || 500 }})
    runs-on: ubuntu-latest
    timeout-minutes: 25 # ì´ê´€ ì‘ì—… ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: iam,sts,s3
          DEFAULT_REGION: ap-northeast-2

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. [On-Premise] ë ˆê±°ì‹œ ë°ì´í„° ìƒì„± (ë¶€ì„œë³„ ë””ë ‰í† ë¦¬ êµ¬ì¡°í™”)
      # -----------------------------------------------------------
      - name: ğŸ¢ Generate Legacy Data (Directory Structured)
        id: gen_legacy
        run: |
          # ì…ë ¥ê°’ Fallback
          INPUT_QTY="${{ inputs.quantity }}"
          QTY="${INPUT_QTY:-500}"
          RATIO="${{ inputs.expert_ratio || 20 }}"
          
          # [í•µì‹¬] ë¶€ì„œë³„ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì •ì˜
          BASE_DIR="legacy_on_premise_server"
          DEPTS=("DevOps_Team" "Security_Ops" "HR_Admin" "Sales_Global" "Finance_Audit" "R_and_D_Core")
          
          echo "::: [Phase 1] ì˜¨í”„ë ˆë¯¸ìŠ¤ ë ˆê±°ì‹œ ë°ì´í„° ìƒì„± ì‹œì‘ (ì´ $QTY ëª…) :::"
          
          # ë””ë ‰í† ë¦¬ ì¼ê´„ ìƒì„±
          for DEPT in "${DEPTS[@]}"; do
            mkdir -p "$BASE_DIR/$DEPT/user_data"
            echo "Created Directory: $BASE_DIR/$DEPT/user_data"
          done
          
          # ë°ì´í„° ìƒì„± ë° ë¶„ì‚° ì €ì¥ Loop
          for i in $(seq 1 $QTY); do
            # ëœë¤ ë¶€ì„œ ì„ ì •
            DEPT=${DEPTS[$RANDOM % ${#DEPTS[@]}]}
            TARGET_FILE="$BASE_DIR/$DEPT/user_data/personnel_record.csv"
            
            # í—¤ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
            if [ ! -f "$TARGET_FILE" ]; then
              echo "Emp_ID,Username,Dept,Role,Email,Phone,Created_At" > "$TARGET_FILE"
            fi
            
            # ì „ë¬¸ê°€ ì—¬ë¶€
            CHANCE=$(( RANDOM % 100 ))
            if [ $CHANCE -lt $RATIO ]; then
              ROLE="Expert-Admin"
              PREFIX="admin"
            else
              ROLE="Standard-User"
              PREFIX="staff"
            fi
            
            SUFFIX=$(date +%s%N | cut -b10-13)
            USERNAME="${PREFIX}_$(printf "%04d" $i)_$SUFFIX"
            EMP_ID="EMP-LEGACY-$(printf "%05d" $i)"
            EMAIL="${USERNAME}@legacy-system.local"
            PHONE="010-$((RANDOM%9000+1000))-$((RANDOM%9000+1000))"
            CREATED=$(date -I)
            
            # í•´ë‹¹ ë¶€ì„œ ë””ë ‰í† ë¦¬ íŒŒì¼ì— ê¸°ë¡
            echo "$EMP_ID,$USERNAME,$DEPT,$ROLE,$EMAIL,$PHONE,$CREATED" >> "$TARGET_FILE"
          done
          
          echo "âœ… ì˜¨í”„ë ˆë¯¸ìŠ¤ ë°ì´í„° ìƒì„± ë° ë””ë ‰í† ë¦¬ ë¶„ë¥˜ ì™„ë£Œ."
          tree $BASE_DIR || echo "Tree command not found, skipping visual check."

      # -----------------------------------------------------------
      # 2. [Migration] ë°ì´í„° ì´ê´€ ë° ë³€í™˜ (ETL Process)
      # -----------------------------------------------------------
      - name: ğŸšš Data Migration (On-Prem -> Cloud Staging)
        run: |
          SOURCE_DIR="legacy_on_premise_server"
          TARGET_DIR="cloud_migration_staging"
          JSON_OUTPUT="terraform_iam/users.json"
          
          mkdir -p $TARGET_DIR
          mkdir -p terraform_iam
          
          echo "::: [Phase 2] ë°ì´í„° ì´ê´€(Migration) ë° ë³‘í•© ì‹œì‘ :::"
          
          # í†µí•© JSON ì‹œì‘
          echo "[" > $JSON_OUTPUT
          
          # ëª¨ë“  ë¶€ì„œ ë””ë ‰í† ë¦¬ ìˆœíšŒí•˜ë©° ë°ì´í„° ìˆ˜ì§‘
          find $SOURCE_DIR -name "*.csv" | while read CSV_FILE; do
            echo "Migrating: $CSV_FILE -> $TARGET_DIR..."
            
            # CSV íŒŒì‹± ë° JSON ë³€í™˜ (ì²«ì¤„ í—¤ë” ì œì™¸)
            tail -n +2 "$CSV_FILE" | while IFS=, read -r EMP_ID USER DEPT ROLE EMAIL PHONE DATE; do
              # ì´ê´€ ë¡œê·¸ ê¸°ë¡
              echo "[MIGRATED] $EMP_ID ($USER) moved to Cloud." >> "$TARGET_DIR/migration_log.txt"
              
              # Terraformìš© JSON ìƒì„±
              cat <<EOF_JSON >> $JSON_OUTPUT
                {
                  "username": "$USER",
                  "group": "$(if [ "$ROLE" == "Expert-Admin" ]; then echo "Expert-Admins"; else echo "Standard-Users"; fi)",
                  "tags": {
                    "Origin": "On-Premise-Migration",
                    "Department": "$DEPT",
                    "EmployeeID": "$EMP_ID",
                    "MigratedAt": "$(date)"
                  }
                },
          EOF_JSON
            done
          done
          
          # JSON í¬ë§· ì •ë¦¬ (ë§ˆì§€ë§‰ ì½¤ë§ˆ ì œê±° ë¡œì§ì€ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ sed ì‚¬ìš©)
          sed -i '$ s/,$//' $JSON_OUTPUT
          echo "]" >> $JSON_OUTPUT
          
          echo "âœ… ë°ì´í„° ì´ê´€ ë° í´ë¼ìš°ë“œìš© í¬ë§· ë³€í™˜ ì™„ë£Œ."
          echo "::: ì´ê´€ëœ ë°ì´í„° ìƒ˜í”Œ :::"
          head -n 5 "$TARGET_DIR/migration_log.txt"

      # -----------------------------------------------------------
      # 3. [Terraform] ì´ê´€ëœ ë°ì´í„°ë¡œ ì¸í”„ë¼ ìƒì„±
      # -----------------------------------------------------------
      - name: ğŸ› ï¸ Generate Terraform Code (Based on Migrated Data)
        run: |
          cat <<EOF > terraform_iam/main.tf
          terraform {
            required_providers { aws = { source = "hashicorp/aws", version = "~> 5.0" } }
          }
          provider "aws" {
            region = "ap-northeast-2"
            access_key = "test"
            secret_key = "test"
            skip_credentials_validation = true
            skip_requesting_account_id = true
            endpoints { iam = "http://localhost:4566" }
          }
          
          locals { users_data = jsondecode(file("\${path.module}/users.json")) }
          
          resource "aws_iam_group" "expert_group" { name = "Expert-Admins" }
          resource "aws_iam_group" "standard_group" { name = "Standard-Users" }
          
          resource "aws_iam_group_policy_attachment" "expert_policy" {
            group      = aws_iam_group.expert_group.name
            policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"
          }
          resource "aws_iam_group_policy_attachment" "standard_policy" {
            group      = aws_iam_group.standard_group.name
            policy_arn = "arn:aws:iam::aws:policy/ReadOnlyAccess"
          }
          
          resource "aws_iam_user" "mass_users" {
            for_each = { for user in local.users_data : user.username => user }
            name     = each.value.username
            path     = "/migrated-users/"
            tags     = each.value.tags
          }
          
          resource "aws_iam_user_group_membership" "mass_membership" {
            for_each = { for user in local.users_data : user.username => user }
            user   = aws_iam_user.mass_users[each.key].name
            groups = [ each.value.group == "Expert-Admins" ? aws_iam_group.expert_group.name : aws_iam_group.standard_group.name ]
          }
          EOF

      # -----------------------------------------------------------
      # 4. [Deploy] ëŒ€ëŸ‰ ë°°í¬ ì‹¤í–‰
      # -----------------------------------------------------------
      - name: ğŸ—ï¸ Terraform Init & Apply
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: ğŸš€ Deploy Migrated Infra (x100 Parallelism)
        run: |
          cd terraform_iam
          terraform init
          echo "::: [Phase 3] í´ë¼ìš°ë“œ ì¸í”„ë¼ ëŒ€ëŸ‰ ë°°í¬ :::"
          terraform apply -auto-approve -parallelism=100
          echo "âœ… ë°°í¬ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 5. [Chaos Test] ì¬í•´ ë³µêµ¬ ì‹œë®¬ë ˆì´ì…˜
      # -----------------------------------------------------------
      - name: ğŸ›‘ Simulate System Crash (Container Stop)
        run: |
          echo "::: [Phase 4] ì¬í•´ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜ (ì„œë¹„ìŠ¤ ë‹¤ìš´) :::"
          CONTAINER_ID=$(docker ps -q --filter ancestor=localstack/localstack)
          docker stop $CONTAINER_ID
          sleep 5

      - name: â™»ï¸ System Recovery (Self-Healing)
        run: |
          echo "::: [Recovery] ì„œë¹„ìŠ¤ ë³µêµ¬ ë° ë°ì´í„° ì •í•©ì„± í™•ì¸ :::"
          CONTAINER_ID=$(docker ps -a -q --filter ancestor=localstack/localstack)
          docker start $CONTAINER_ID
          timeout 60s bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"iam\": \"available\""; do echo "Waiting..."; sleep 2; done'
          
          cd terraform_iam
          terraform apply -auto-approve -parallelism=100
          echo "âœ… ëª¨ë“  ë°ì´í„° ë° ì¸í”„ë¼ ë³µêµ¬ ì™„ë£Œ."

      # -----------------------------------------------------------
      # 6. [Artifacts] ê²°ê³¼ë¬¼ ì €ì¥
      # -----------------------------------------------------------
      - name: ğŸ“¦ Archive Migration Reports
        uses: actions/upload-artifact@v4
        with:
          name: 2026_Migration_Report_${{ github.run_id }}
          path: |
            legacy_on_premise_server/
            cloud_migration_staging/migration_log.txt
            terraform_iam/users.json
            terraform_iam/terraform.tfstate
