name: ğŸ—ï¸ 2026 Infrastructure Scaling Manager (Fixed UI)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½(ê°œë°œ/í”„ë¡œë•ì…˜)' # ìš”ì²­í•˜ì‹  ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ë°˜ì˜
        required: true
        default: 'dev'
        type: choice
        options:
          - dev      # í™”ë©´ìƒ 'ê°œë°œì'ë¡œ ë²ˆì—­ë˜ì–´ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‚˜, ì‹¤ì œ ê°’ì€ devë¡œ ìœ ì§€ ê¶Œì¥
          - prod
      action_type:
        description: 'í™œë™í™œë™' # ìš”ì²­í•˜ì‹  ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ë°˜ì˜ (Activity)
        required: true
        default: 'create_db'
        type: choice
        options:
          - create_db
          - expand_db_storage
          - add_disk
          - expand_disk
      resource_identifier:
        description: 'ì°¸ê°€ì ID ë˜ëŠ” ì´ë¦„ (ì˜ˆ: db-main-01, vol-data-02)' # ìš”ì²­í•˜ì‹  ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ë°˜ì˜
        required: true
        type: string
      target_size_gb:
        description: 'ëª©í‘œ í™”ë¶„ (GB ë‹¨ìœ„)' # ìš”ì²­í•˜ì‹  ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ë°˜ì˜ (Target Size)
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  infra-scaling:
    name: âš™ï¸ Run (${{ inputs.action_type }})
    runs-on: ubuntu-latest
    env:
      TF_VAR_environment: ${{ inputs.environment }}
      TF_VAR_target_resource: ${{ inputs.resource_identifier }}
      TF_VAR_target_size: ${{ inputs.target_size_gb }}
    
    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ./terraform

      # ì‹¤ì œ ë¡œì§ ì‹¤í–‰ (ì…ë ¥ëœ ê°’ì„ Terraform ë³€ìˆ˜ë¡œ ë§¤í•‘)
      - name: ğŸ” Plan Infrastructure Changes
        run: |
          echo "::: ì‹¤í–‰ ì •ë³´ :::"
          echo "í™˜ê²½: ${{ inputs.environment }}"
          echo "í™œë™: ${{ inputs.action_type }}"
          echo "ëŒ€ìƒ(ì°¸ê°€ì): ${{ inputs.resource_identifier }}"
          echo "ëª©í‘œ ìš©ëŸ‰(í™”ë¶„): ${{ inputs.target_size_gb }} GB"
          
          if [ "${{ inputs.action_type }}" == "create_db" ]; then
            terraform plan -var="create_db=true" -var="db_name=${{ inputs.resource_identifier }}" -out=tfplan
          elif [ "${{ inputs.action_type }}" == "expand_db_storage" ]; then
            terraform plan -var="db_storage_size=${{ inputs.target_size_gb }}" -out=tfplan
          elif [ "${{ inputs.action_type }}" == "add_disk" ]; then
            terraform plan -var="add_new_disk=true" -var="disk_size=${{ inputs.target_size_gb }}" -out=tfplan
          elif [ "${{ inputs.action_type }}" == "expand_disk" ]; then
            terraform plan -var="resize_disk_id=${{ inputs.resource_identifier }}" -var="new_disk_size=${{ inputs.target_size_gb }}" -out=tfplan
          fi
        working-directory: ./terraform

      - name: ğŸš€ Apply Changes
        if: inputs.environment == 'prod'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
