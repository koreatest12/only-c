name: ğŸš€ 2026 Ultimate Hyper-Stable System

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      data_count:
        description: 'ìƒì„±í•  ë°ì´í„° í–‰ ìˆ˜ (ê¶Œì¥: 5,000,000+)'
        required: true
        default: '5000000'
        type: string

env:
  DATA_COUNT: ${{ inputs.data_count || '5000000' }}

jobs:
  # ==================================================================================
  # JOB 1: Windows ë°”ì´ë„ˆë¦¬ ë¹Œë“œ (ë¬¸ë²• ì—ëŸ¬ ìˆ˜ì •ë¨, ë°ì´í„° ìƒì„± X)
  # ==================================================================================
  build-windows-safe:
    name: ğŸªŸ Build Windows Binary (Fixed)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      # [FIX] PowerShell Here-String ë¬¸ë²• ìˆ˜ì • (ì´ì¤‘ ë”°ì˜´í‘œ ì œê±°)
      - name: ğŸ“ Generate Syntax-Correct Source
        run: |
          $code = @"
          #include <iostream>
          #include <thread>
          #include <chrono>
          
          int main() {
              // Windowsì—ì„œëŠ” ë°ì´í„° ìƒì„±ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ì¶œë ¥
              std::cout << "=============================================" << std::endl;
              std::cout << "   2026 System - Windows Client (Viewer)     " << std::endl;
              std::cout << "=============================================" << std::endl;
              std::cout << "Data generation is handled by the Linux node." << std::endl;
              std::cout << "Closing in 5 seconds..." << std::endl;
              std::this_thread::sleep_for(std::chrono::seconds(5));
              return 0;
          }
          "@
          
          # ì¸ì½”ë”© ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ UTF8ë¡œ ê°•ì œ ì €ì¥
          $code | Out-File -FilePath enterprise_main.cpp -Encoding UTF8
          
          $cmake = @"
          cmake_minimum_required(VERSION 3.15)
          project(MassiveServer2026)
          add_executable(enterprise_main enterprise_main.cpp)
          "@
          $cmake | Out-File -FilePath CMakeLists.txt -Encoding UTF8

      - name: ğŸ’¥ Build EXE
        run: |
          mkdir build
          cd build
          cmake ..
          cmake --build . --config Release
          
      - uses: actions/upload-artifact@v4
        with:
          name: Binary-Windows
          path: build/Release/enterprise_main.exe

  # ==================================================================================
  # JOB 2: Linux ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± (ì´ˆê³ ìš©ëŸ‰/ì¥ì‹œê°„ ì‹¤í–‰ ìµœì í™”)
  # ==================================================================================
  generate-data-linux-heavy:
    name: ğŸ§ Massive Data Gen (Unlimited Scale)
    runs-on: ubuntu-latest
    timeout-minutes: 350 # ì•ˆì „ì„ ìœ„í•´ 6ì‹œê°„ ë¯¸ë§Œìœ¼ë¡œ ì„¤ì •
    steps:
      - uses: actions/checkout@v4

      # [SURGERY] ë””ìŠ¤í¬/ë©”ëª¨ë¦¬/í”„ë¡œì„¸ìŠ¤ ê·¹í•œì˜ ìµœì í™”
      - name: â˜¢ï¸ Nuclear System Cleanup (Free +35GB)
        run: |
          echo "::: [INIT] Cleaning System for Massive I/O :::"
          
          # 1. ë¶ˆí•„ìš”í•œ ëŒ€í˜• íŒ¨í‚¤ì§€ ì‚­ì œ
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          
          # 2. Docker ìºì‹œ ì‚­ì œ
          docker system prune -a -f
          
          # 3. Swap ë©”ëª¨ë¦¬ 8GB í™•ë³´ (OOM Killer ë°©ì§€)
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # 4. ìŠ¤íƒ ì‚¬ì´ì¦ˆ ì œí•œ í•´ì œ
          ulimit -s unlimited
          
          echo "::: [STATUS] Resource Status :::"
          df -h
          free -h

      # [WATCHDOG] ë¡œê·¸ ì¹¨ë¬µìœ¼ë¡œ ì¸í•œ Runner ì¢…ë£Œ ë°©ì§€
      - name: ğŸ‘ï¸ Start Resource Watchdog
        run: |
          cat <<'EOF' > watchdog.sh
          #!/bin/bash
          while true; do
            # 1ë¶„ë§ˆë‹¤ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ì°ì–´ ë¡œê·¸ê°€ íë¥´ê²Œ í•¨
            echo "[WATCHDOG] Memory: $(free -h | grep Mem | awk '{print $3}') | Disk Free: $(df -h / | tail -1 | awk '{print $4}')"
            sleep 60
          done
          EOF
          chmod +x watchdog.sh
          ./watchdog.sh &

      # [CORE ENGINE] C++ ì†ŒìŠ¤ ìƒì„± (ì•ˆì •ì„± 100% ë³´ì¥í˜•)
      - name: ğŸ“ Generate Stable Engine
        run: |
          cat <<'EOF' > upgrade_manager.py
          import os
          
          # ì‹œìŠ¤í…œ ì„¤ì •
          SYSTEM_VERSION = "2026.7.0 (Architecture Fixed)"
          GCC_FLAGS = "-O3 -Wall -Wextra -std=c++20 -pthread -march=native"
          
          def generate_cpp_source():
              print(f"Generating Engine v{SYSTEM_VERSION}...")
              content = """
          #include <iostream>
          #include <fstream>
          #include <vector>
          #include <string>
          #include <thread>
          #include <mutex>
          #include <iomanip>
          #include <sstream>
          
          // [SAFETY] ìŠ¤ë ˆë“œ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ë®¤í…ìŠ¤
          std::mutex print_mtx;
          
          // [CONFIG] ë°ì´í„° ê°œìˆ˜ ë¡œë“œ
          long long get_target_count() {
              const char* env_p = std::getenv("DATA_COUNT");
              if(env_p) return std::stoll(env_p);
              return 1000000;
          }

          // [CORE] ë©”ëª¨ë¦¬ ì•ˆì „ íŒŒì¼ ë¼ì´í„° (ì§ì ‘ ë²„í¼ ê´€ë¦¬)
          class StableWriter {
              std::ofstream file;
              std::vector<char> buffer;
              size_t cursor = 0;
              const size_t CAPACITY = 8 * 1024 * 1024; // 8MB Buffer (Large)
              
          public:
              StableWriter(const std::string& filename) {
                  file.open(filename, std::ios::binary);
                  buffer.resize(CAPACITY);
              }
              
              ~StableWriter() {
                  flush();
                  if(file.is_open()) file.close();
              }
              
              void write(const std::string& data) {
                  // ë²„í¼ê°€ ê½‰ ì°¨ë©´ ë””ìŠ¤í¬ë¡œ ë‚´ë¦¼ (Segfault ë°©ì§€)
                  if (cursor + data.size() > CAPACITY) {
                      flush();
                  }
                  
                  // ë°ì´í„°ê°€ ë²„í¼ë³´ë‹¤ í¬ë©´ ì§ì ‘ ì“°ê¸°
                  if (data.size() > CAPACITY) {
                      file.write(data.c_str(), data.size());
                  } else {
                      // ë©”ëª¨ë¦¬ ë³µì‚¬
                      std::copy(data.begin(), data.end(), buffer.begin() + cursor);
                      cursor += data.size();
                  }
              }
              
              void flush() {
                  if (cursor > 0) {
                      file.write(buffer.data(), cursor);
                      cursor = 0;
                  }
              }
          };

          void task_accounts(long long count) {
              try {
                  StableWriter writer("output/data/accounts.csv");
                  writer.write("Bank,AccountID,User,Balance,Status,Hash\\n");
                  
                  std::stringstream ss;
                  for(long long i=0; i<count; ++i) {
                      ss.str(""); 
                      ss << "KR-BANK," 
                         << "ACC-" << i << ","
                         << "User_" << i << ","
                         << (i * 500) << ","
                         << (i % 2 == 0 ? "Active" : "Held") << ","
                         << "Hash_" << (i * 12345) << "\\n";
                      
                      writer.write(ss.str());
                      
                      // [ALIVE] 50ë§Œ ê±´ë§ˆë‹¤ ìƒì¡´ ì‹ ê³ 
                      if(i % 500000 == 0) {
                          std::lock_guard<std::mutex> lock(print_mtx);
                          std::cout << "::notice::[Accounts] Generated " << i << " records..." << std::endl;
                      }
                  }
                  std::cout << "âœ… Account Task Complete." << std::endl;
              } catch (const std::exception& e) {
                  std::cerr << "!!! Account Task Failed: " << e.what() << std::endl;
              }
          }

          void task_transactions(long long count) {
              try {
                  StableWriter writer("output/data/transactions.csv");
                  writer.write("TxID,Sender,Receiver,Amount,Date\\n");
                  
                  std::stringstream ss;
                  for(long long i=0; i<count; ++i) {
                      ss.str("");
                      ss << "TX-" << i << ","
                         << "User_" << i << ","
                         << "Store_" << (i % 1000) << ","
                         << (100 + i % 5000) << ","
                         << "2026-05-20\\n";
                         
                      writer.write(ss.str());

                      if(i % 500000 == 0) {
                          std::lock_guard<std::mutex> lock(print_mtx);
                          std::cout << "::notice::[Transactions] Generated " << i << " records..." << std::endl;
                      }
                  }
                  std::cout << "âœ… Transaction Task Complete." << std::endl;
              } catch (const std::exception& e) {
                  std::cerr << "!!! Transaction Task Failed: " << e.what() << std::endl;
              }
          }

          int main() {
              // í´ë” ìƒì„±
              system("mkdir -p output/data");
              
              long long target = get_target_count();
              std::cout << "ğŸš€ STARTING MASSIVE DATA GENERATION (Target: " << target << ")" << std::endl;
              
              // ìŠ¤ë ˆë“œ ë¶„ë¦¬ ì‹¤í–‰ (ì•ˆì „ì„± ìš°ì„ )
              std::thread t1(task_accounts, target);
              std::thread t2(task_transactions, target);
              
              t1.join();
              t2.join();
              
              std::cout << "âœ¨ ALL DATA GENERATED SUCCESSFULLY." << std::endl;
              return 0;
          }
              """
              with open("enterprise_main.cpp", "w", encoding="utf-8") as f:
                  f.write(content.strip())
          
          def generate_makefile():
              makefile = f"""
          CXX = g++
          CXXFLAGS = {GCC_FLAGS}
          TARGET = server_app_core
          SRCS = enterprise_main.cpp
          all: $(TARGET)
          $(TARGET): $(SRCS)
          \t$(CXX) $(CXXFLAGS) $(SRCS) -o $(TARGET)
              """
              with open("Makefile", "w", encoding="utf-8") as f: f.write(makefile.strip())
              
          if __name__ == "__main__":
              generate_cpp_source()
              generate_makefile()
          EOF

      - name: ğŸ”„ Compile & Execute
        run: |
          python upgrade_manager.py
          make
          chmod +x server_app_core
          
          echo "::: Executing Binary (Max Stability Mode) :::"
          ./server_app_core

      # [COMPRESSION] ë³‘ë ¬ ì••ì¶• (Pigz)
      - name: ğŸ“¦ Compress Data (Multi-Core)
        run: |
          echo "::: Compressing Dataset :::"
          sudo apt-get install -y pigz
          tar -cf - output/ | pigz -p $(nproc) > dataset_linux.tar.gz
          ls -lh dataset_linux.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: Binary-Linux
          path: server_app_core

      - uses: actions/upload-artifact@v4
        with:
          name: Generated-Data
          path: dataset_linux.tar.gz
          retention-days: 1 # ìš©ëŸ‰ì´ í¬ë¯€ë¡œ í•˜ë£¨ë§Œ ë³´ê´€

  # ==================================================================================
  # JOB 3: í†µí•© ë° ë°°í¬
  # ==================================================================================
  release-manager:
    name: ğŸ“¦ Managed Release V4
    needs: [build-windows-safe, generate-data-linux-heavy]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Windows
          path: pkg_win
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Linux
          path: pkg_lin
      - uses: actions/download-artifact@v4
        with:
          name: Generated-Data
          path: pkg_data

      - name: ğŸ“¦ Create Final Package
        run: |
          mkdir release_assets
          cp pkg_win/enterprise_main.exe release_assets/Viewer_Windows.exe
          cp pkg_lin/server_app_core release_assets/Generator_Linux_Core
          cp pkg_data/dataset_linux.tar.gz release_assets/
          
          cd release_assets
          ls -lh

      - uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v2026.7.0.${{ github.run_number }}
          name: ğŸš€ Hyper-Stable Release v${{ github.run_number }}
          body: |
            ## ğŸš€ Stability Update (Fixes C3688 & Segfault)
            
            This release fixes the Windows compilation syntax error and ensures massive data generation stability.
            
            ### ğŸ› ï¸ Fixes & Features
            - **Fixed:** `error C3688` (PowerShell String Escaping).
            - **Fixed:** `Segmentation fault` (Linux Heap Buffering).
            - **Scale:** Supports millions of rows with minimal RAM usage.
            
            ### ğŸ“¦ Artifacts
            - `dataset_linux.tar.gz`: The massive generated dataset.
            - `Viewer_Windows.exe`: Windows client (executable only).
            - `Generator_Linux_Core`: Linux generation engine.
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
