name: Secure Source Code Archiving (Anti-Leak)

# ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ê±°ë‚˜, íŠ¹ì • íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰ (í•„ìš”ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥)
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  encrypt-and-protect:
    name: ðŸ›¡ï¸ Encrypt Source Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. ê°•ë ¥í•œ ëžœë¤ ë¹„ë°€ë²ˆí˜¸ ìƒì„± (32ë°”ì´íŠ¸, Base64 ì¸ì½”ë”©)
      - name: Generate Strong Password
        id: keygen
        run: |
          # opensslì„ ì‚¬ìš©í•˜ì—¬ ê°•ë ¥í•œ ë‚œìˆ˜ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
          GENERATED_PASS=$(openssl rand -base64 32)
          echo "::add-mask::$GENERATED_PASS" # ë¡œê·¸ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ (ë³´ì•ˆ)
          echo "SECURE_PASS=$GENERATED_PASS" >> $GITHUB_OUTPUT

      # 3. 7-Zipì„ ì‚¬ìš©í•œ AES-256 ì•”í˜¸í™” ì••ì¶•
      - name: Archive with AES-256 Encryption
        run: |
          # .git í´ë” ì œì™¸í•˜ê³  ëª¨ë“  íŒŒì¼ì„ ì•”í˜¸í™” ì••ì¶•
          # -p: ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
          # -mhe=on: í—¤ë” ì•”í˜¸í™” (íŒŒì¼ ì´ë¦„ë„ ìˆ¨ê¹€)
          # -t7z: 7z í˜•ì‹ ì‚¬ìš© (ì••ì¶•ë¥  ë° ë³´ì•ˆ ìš°ìˆ˜)
          
          7z a -t7z -mhe=on -p"${{ steps.keygen.outputs.SECURE_PASS }}" \
          secure_source_code.7z . -xr!.git

      # 4. ì•”í˜¸í™”ëœ íŒŒì¼ ì—…ë¡œë“œ (ë¹„ë°€ë²ˆí˜¸ ì—†ì´ëŠ” ì ˆëŒ€ ì—´ ìˆ˜ ì—†ìŒ)
      - name: Upload Encrypted Artifact
        uses: actions/upload-artifact@v4
        with:
          name: secure-code-bundle
          path: secure_source_code.7z
          retention-days: 3 # ë³´ì•ˆì„ ìœ„í•´ ë³´ê´€ ê¸°ê°„ ì§§ê²Œ ì„¤ì •

      # 5. ìž‘ì—… ìš”ì•½ì— ë¹„ë°€ë²ˆí˜¸ ì¶œë ¥ (ì‹¤í–‰ìžë§Œ í™•ì¸ ê°€ëŠ¥í•˜ë„ë¡)
      - name: Display Decryption Key (Action Summary)
        if: always()
        run: |
          echo "## ðŸ” Security Archive Complete" >> $GITHUB_STEP_SUMMARY
          echo "Files have been encrypted with AES-256." >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”‘ Decryption Password" >> $GITHUB_STEP_SUMMARY
          echo "Copy the password below to extract the files:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.keygen.outputs.SECURE_PASS }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Warning**: This password is valid only for this artifact." >> $GITHUB_STEP_SUMMARY
