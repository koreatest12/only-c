name: Enterprise CI/CD & GHCR Publish System

on:
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: write
  packages: write #
  actions: write

jobs:
  # ----------------------------------------------------------------
  # JOB 1: ëŒ€ëŸ‰ ë¦¬ì†ŒìŠ¤ ìƒì„±, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ (Windows/Linux)
  # ----------------------------------------------------------------
  build-test-generate:
    name: Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake cppcheck tree

    # 1MB ì´ìƒ ëŒ€ëŸ‰ ì†ŒìŠ¤ì½”ë“œ ë° CMakeLists ë™ì  ìƒì„±
    - name: Generate Large Scale Source Code
      run: |
        echo "ğŸ“ Generating Heavy Source Code..."
        
        # CMakeLists.txt ìƒì„±
        cat <<EOF > CMakeLists.txt
        cmake_minimum_required(VERSION 3.10)
        project(EnterpriseServer)
        set(CMAKE_CXX_STANDARD 17)
        set(CMAKE_CXX_STANDARD_REQUIRED True)
        add_executable(enterprise_main enterprise_main.cpp)
        if(WIN32)
            set_target_properties(enterprise_main PROPERTIES OUTPUT_NAME "enterprise_main")
        endif()
        EOF

        # C++ ì†ŒìŠ¤ì½”ë“œ ìƒì„± (30ë§Œê±´ ë°ì´í„° ë¡œì§)
        cat <<EOF > enterprise_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        
        namespace fs = std::filesystem;
        
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        class BigDataManager {
        public:
            static void generateMassiveTransactions() {
                // 300,000ê±´ (ì•½ 15~20MB) ìƒì„±
                std::cout << "ğŸ“Š [Data Service] Generating 300,000 massive records..." << std::endl;
                fs::create_directories("output/data");
                std::ofstream file("output/data/mass_transactions_large.csv");
                file << "TxID,UserID,Amount,Type,Timestamp,Hash" << std::endl;
                for(int i=0; i < 300000; ++i) {
                    file << "TX_" << i << ",User_" << (i%1000) << "," << (i*50) 
                         << ",DEPOSIT," << getCurrentTime() << ",hash_" << i << std::endl;
                }
                file.close();
            }
            static void generateMassiveLogs() {
                // 100,000ê±´ ë¡œê·¸ ìƒì„±
                std::cout << "ğŸ“ [Log Service] Generating 100,000 logs..." << std::endl;
                fs::create_directories("output/logs");
                std::ofstream log("output/logs/audit_trace.log");
                for(int i=0; i < 100000; ++i) log << "[INFO] " << getCurrentTime() << " ProcID:" << i << " Action:OK" << std::endl;
                log.close();
            }
        };

        int main(int argc, char* argv[]) {
            if (argc > 1 && std::string(argv[1]) == "--test") return 0; // í…ŒìŠ¤íŠ¸ í†µê³¼ ì²˜ë¦¬
            std::cout << "ğŸš€ [Enterprise System] Starting Large Scale Workflow..." << std::endl;
            BigDataManager::generateMassiveTransactions();
            BigDataManager::generateMassiveLogs();
            
            // í™ë³´ ë§í¬ ì¶œë ¥
            std::cout << "ğŸ”— Follow us at: https://github.com/koreatest12/only-c" << std::endl;
            return 0;
        }
        EOF

    - name: Run Static Analysis (Cppcheck)
      if: runner.os == 'Linux'
      run: cppcheck --enable=all --inconclusive --force enterprise_main.cpp || true

    - name: Build Application
      run: |
        mkdir -p build
        cd build
        cmake ..
        cmake --build . --config Release

    - name: Run Automated Tests
      run: |
        cd build
        if [[ "$RUNNER_OS" == "Windows" ]]; then ./Release/enterprise_main.exe --test; else ./enterprise_main --test; fi

    - name: Run & Generate Resources
      run: |
        cd build
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          ./Release/enterprise_main.exe
          cp ./Release/enterprise_main.exe ../server_app.exe
        else
          ./enterprise_main
          cp ./enterprise_main ../server_app_linux
        fi
        cp -r output ../output_data

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifact-${{ matrix.os }}
        path: |
          server_app*
          output_data/
          enterprise_main.cpp

  # ----------------------------------------------------------------
  # JOB 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCR ê²Œì‹œ
  # ----------------------------------------------------------------
  docker-build-push:
    name: Dockerize & Publish to GHCR
    needs: build-test-generate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write #
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. ì´ì „ ë¹Œë“œ ê²°ê³¼ë¬¼(Linux ì‹¤í–‰ íŒŒì¼) ë‹¤ìš´ë¡œë“œ
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-ubuntu-latest

      # 2. Dockerfile ë™ì  ìƒì„± (í•„ìˆ˜ ë‹¨ê³„)
      - name: Create Dockerfile dynamically
        run: |
          echo "ğŸ³ Generating Dockerfile..."
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          WORKDIR /app
          COPY server_app_linux /app/server_app
          RUN chmod +x /app/server_app
          # ë¦¬í¬ì§€í† ë¦¬ ì—°ê²°ì„ ìœ„í•œ ë ˆì´ë¸”
          LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}
          LABEL org.opencontainers.image.description="Enterprise C++ Server with Massive Data Gen"
          CMD ["./server_app"]
          EOF

      # 3. GitHub Container Registry ë¡œê·¸ì¸
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. ë©”íƒ€ë°ì´í„° ë° íƒœê·¸ ìƒì„±
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      # 5. ë¹Œë“œ ë° í‘¸ì‹œ (GHCRë¡œ ì „ì†¡)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ----------------------------------------------------------------
  # JOB 3: ë¦´ë¦¬ì¦ˆ íŒ¨í‚¤ì§€ ìƒì„± ë° ë°°í¬
  # ----------------------------------------------------------------
  release-package:
    name: Publish Release
    needs: [build-test-generate, docker-build-push]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      - name: Prepare Release
        run: |
          mkdir release_pkg
          cp build-artifact-windows-latest/server_app.exe release_pkg/
          cp build-artifact-ubuntu-latest/server_app_linux release_pkg/
          cp -r build-artifact-ubuntu-latest/output_data release_pkg/data_samples
          cd release_pkg
          zip -r ../enterprise_full_v${{ github.run_number }}.zip .
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v5.0.${{ github.run_number }}
          name: ğŸš€ Enterprise & Docker Publish v5.0.${{ github.run_number }}
          body: |
            ## ğŸ“¦ Enterprise Build + GHCR Publish
            Docker ì´ë¯¸ì§€ê°€ **GitHub Container Registry**ì— ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ğŸ³ Docker Pull Command
            \`\`\`bash
            docker pull ghcr.io/${{ github.repository }}:latest
            \`\`\`
            
            ### ğŸ“Š Data Scale
            - Transaction CSV: 300,000 Rows (~20MB)
            - Logs: 100,000 Entries
            
            ğŸ‘‰ **https://github.com/koreatest12/only-c**
          files: enterprise_full_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
