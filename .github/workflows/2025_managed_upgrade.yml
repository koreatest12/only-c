name: 2025 Managed Upgrade System (Script Fixed)

on:
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # Windows ì½˜ì†” ì¸ì½”ë”© ì—ëŸ¬ ë°©ì§€
  PYTHONIOENCODING: "utf-8"

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  managed-build:
    name: Managed Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set Artifact Name
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          echo "ARTIFACT_NAME=Binary-Linux" >> $GITHUB_ENV
        else
          echo "ARTIFACT_NAME=Binary-Windows" >> $GITHUB_ENV
        fi

    # 1. í™˜ê²½ êµ¬ì„±
    - name: Setup System Environment
      run: |
        echo "ğŸ› ï¸ Initializing Environment..."
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck tree g++
        else
          echo "ğŸªŸ Windows: Installing Cppcheck..."
          choco install cppcheck -y --no-progress
        fi

    # 2. Python ì„¤ì •
    - name: Setup Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Pillow qrcode
        echo "âœ… Python Ready."

    # ----------------------------------------------------------------
    # [í•µì‹¬ ìˆ˜ì •] Upgrade Manager ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    # <<'EOF'ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‰˜ ë³€ìˆ˜ í™•ì¥($)ì„ ë°©ì§€í•¨ -> ì—ëŸ¬ í•´ê²°
    # ----------------------------------------------------------------
    - name: Generate Upgrade Manager Script
      run: |
        cat <<'EOF' > upgrade_manager.py
        import os
        import sys
        import platform
        
        # ë²„ì „ ë° ì»´íŒŒì¼ ì„¤ì •
        SYSTEM_VERSION = "2025.3.2"
        # ì‰˜ ë³€ìˆ˜ê°€ ì•„ë‹Œ Python ë³€ìˆ˜ë¡œ ì§ì ‘ ì •ì˜
        GCC_FLAGS = "-O3 -Wall -Wextra -std=c++20 -pthread -march=native"

        def log(msg):
            # ì´ëª¨ì§€ ì¶œë ¥ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            try:
                print(f"[âš™ï¸ MANAGER] {msg}")
            except:
                print(f"[MANAGER] {msg}")

        def generate_cpp_source():
            log(f"Generating C++20 Source Code (v{SYSTEM_VERSION})...")
            content = """
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>
        #include <iomanip>
        #include <format>
        
        namespace fs = std::filesystem;
        
        void optimizeIO() {
            std::ios_base::sync_with_stdio(false);
            std::cin.tie(NULL);
        }

        class VirtualAccountManager {
        public:
            static void generate() {
                const int COUNT = 100000;
                fs::create_directories("output/data");
                std::ofstream file("output/data/va_dump_2025.csv");
                file << "Bank,Account,Holder,Amount,Expiry" << std::endl;
                for(int i=0; i<COUNT; ++i) {
                    file << (i%2==0?"KB-2025":"SHINHAN-2025") << ",562-" 
                         << std::setw(6) << std::setfill('0') << i 
                         << ",User_" << i << "," << (i*1000) 
                         << ",2030-12-31" << std::endl;
                }
                file.close();
            }
        };

        class VirtualCardManager {
        public:
            static void generate() {
                const int COUNT = 100000;
                fs::create_directories("output/data");
                std::ofstream file("output/data/card_dump_2025.csv");
                file << "CardNum,CVC,Expiry,Type" << std::endl;
                for(int i=0; i<COUNT; ++i) {
                    file << "4222-2025-" << std::setw(4) << std::setfill('0') << i << "-XXXX," 
                         << (i%999) << ",12/30,VISA_CORP" << std::endl;
                }
                file.close();
            }
        };

        int main(int argc, char* argv[]) {
            optimizeIO();
            if (argc > 1 && std::string(argv[1]) == "--test") return 0;
            std::cout << "ğŸš€ Starting Managed System v{SYSTEM_VERSION}..." << std::endl;
            VirtualAccountManager::generate();
            VirtualCardManager::generate();
            return 0;
        }
        """
            # Python f-string í¬ë§·íŒ… ì ìš© (.format ì‚¬ìš©)
            final_content = content.replace("{SYSTEM_VERSION}", SYSTEM_VERSION)
            
            with open("enterprise_main.cpp", "w", encoding="utf-8") as f:
                f.write(final_content.strip())

        def generate_build_files():
            log("Generating CMakeLists.txt & Makefile...")
            
            # [í•µì‹¬ ìˆ˜ì •] Makefile ìƒì„± ì‹œ ë³€ìˆ˜($)ê°€ ì‰˜ì— ì˜í•´ í•´ì„ë˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬ë¨
            # Python ë‚´ì—ì„œ ë¬¸ìì—´ë¡œ ì •í™•íˆ ì²˜ë¦¬
            makefile_content = f"""
        CXX = g++
        CXXFLAGS = {GCC_FLAGS}
        TARGET = server_app_gcc
        SRCS = enterprise_main.cpp

        all: $(TARGET)

        $(TARGET): $(SRCS)
        \t$(CXX) $(CXXFLAGS) $(SRCS) -o $(TARGET)

        clean:
        \trm -f $(TARGET)
        """
            with open("Makefile", "w", encoding="utf-8") as f:
                f.write(makefile_content.strip())

            # CMakeLists.txt
            cmake = """
        cmake_minimum_required(VERSION 3.15)
        project(ManagedServer2025)
        set(CMAKE_CXX_STANDARD 20)
        set(CMAKE_CXX_STANDARD_REQUIRED True)
        add_executable(enterprise_main enterprise_main.cpp)
        if(UNIX)
            add_compile_options(-O3 -Wall -Wextra -pthread)
        endif()
        if(WIN32)
            set_target_properties(enterprise_main PROPERTIES OUTPUT_NAME "enterprise_main")
        endif()
        """
            with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                f.write(cmake.strip())

        if __name__ == "__main__":
            # Windows ì¶œë ¥ ì¸ì½”ë”© ê°•ì œ ì„¤ì • (ì•ˆì „ì¥ì¹˜)
            if sys.platform == "win32":
                try: sys.stdout.reconfigure(encoding='utf-8')
                except: pass
            
            generate_cpp_source()
            generate_build_files()
            log("âœ… Upgrade Complete. Files are ready for build.")
        EOF

    # 4. ì—…ê·¸ë ˆì´ë“œ ë§¤ë‹ˆì € ì‹¤í–‰
    - name: Execute Upgrade Manager
      run: |
        echo "ğŸ”„ Running Upgrade Manager..."
        python upgrade_manager.py
        # ìƒì„± ë‚´ìš© í™•ì¸ (ë””ë²„ê¹…)
        echo "--- Makefile Content ---"
        cat Makefile

    # 5. ì •ì  ë¶„ì„
    - name: Static Analysis
      run: |
        cppcheck --enable=all --inconclusive --force --std=c++20 enterprise_main.cpp || true

    # 6. ë¹Œë“œ ìˆ˜í–‰ (Fallback ë¡œì§ í¬í•¨)
    - name: Build System
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          echo "ğŸ”¨ Building with Make..."
          make clean
          # Makefile ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì§ì ‘ ì»´íŒŒì¼ ëª…ë ¹ ì‹¤í–‰ (2ì¤‘ ì•ˆì „ì¥ì¹˜)
          make -j$(nproc) all || g++ -O3 -Wall -Wextra -std=c++20 -pthread -march=native enterprise_main.cpp -o server_app_gcc
          chmod +x server_app_gcc
        else
          echo "ğŸ”¨ Building with CMake (Windows)..."
          mkdir -p build
          cd build
          cmake ..
          cmake --build . --config Release
        fi

    # 7. ì‹¤í–‰ ë° ë°ì´í„° ìƒì„±
    - name: Run Application
      run: |
        mkdir -p output_data
        
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          ./server_app_gcc
          cp server_app_gcc final_binary
          if [ -d "output" ]; then cp -r output/* output_data/; fi
        else
          ./build/Release/enterprise_main.exe
          cp build/Release/enterprise_main.exe final_binary.exe
          
          if [ -d "output" ]; then cp -r output/* output_data/; 
          elif [ -d "build/output" ]; then cp -r build/output/* output_data/; fi
        fi

    # 8. ì´ë¯¸ì§€ ìƒì„± (Python Asset Generator)
    - name: Generate Visual Assets
      run: |
        cat <<'EOF' > gen_assets.py
        import csv, os, qrcode, sys
        from PIL import Image, ImageDraw

        try: sys.stdout.reconfigure(encoding='utf-8')
        except: pass

        OUT_VA = "output_data/data/va_images"
        OUT_CARD = "output_data/data/card_images"
        os.makedirs(OUT_VA, exist_ok=True)
        os.makedirs(OUT_CARD, exist_ok=True)

        print("ğŸ–¼ï¸ Asset Generator Started...")

        try:
            with open("output_data/data/va_dump_2025.csv", 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                count = 0
                for row in reader:
                    if count >= 10: break
                    count += 1
                    img = Image.new('RGB', (400, 200), (240, 248, 255))
                    draw = ImageDraw.Draw(img)
                    draw.rectangle([(5,5),(395,195)], outline="navy", width=3)
                    draw.text((20,20), f"2025 SLIP", fill="navy")
                    draw.text((20,50), f"BANK: {row['Bank']}", fill="black")
                    draw.text((20,80), f"ACC: {row['Account']}", fill="black")
                    qr = qrcode.make(f"{row['Bank']}|{row['Account']}")
                    img.paste(qr.resize((90,90)), (290, 50))
                    img.save(f"{OUT_VA}/va_{count}.png")
            print("âœ… VA Images OK.")
        except Exception as e: print(f"âŒ VA Error: {e}")

        try:
            with open("output_data/data/card_dump_2025.csv", 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                count = 0
                for row in reader:
                    if count >= 10: break
                    count += 1
                    img = Image.new('RGB', (400, 250), (10, 10, 40))
                    draw = ImageDraw.Draw(img)
                    draw.text((30, 110), row['CardNum'], fill="white")
                    draw.text((320, 210), "VISA", fill="white")
                    img.save(f"{OUT_CARD}/card_{count}.png")
            print("âœ… Card Images OK.")
        except Exception as e: print(f"âŒ Card Error: {e}")
        EOF
        
        PYTHONIOENCODING=utf-8 python gen_assets.py

    # 9. ì²´í¬ì„¬ ë° ì—…ë¡œë“œ
    - name: Finalize & Upload
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sha256sum final_binary > checksum.sha256
        else
          sha256sum final_binary.exe > checksum.sha256
        fi
        
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          final_binary*
          checksum.sha256
          output_data/
          upgrade_manager.py
          enterprise_main.cpp

  # ----------------------------------------------------------------
  # JOB 2: Docker ë¹Œë“œ
  # ----------------------------------------------------------------
  docker-publish:
    name: Dockerize (Ubuntu 24.04)
    needs: managed-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Linux
      
      - name: Build Docker
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:24.04
          WORKDIR /app
          COPY final_binary /app/server_app
          COPY output_data /app/data
          RUN chmod +x /app/server_app
          LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}
          LABEL org.opencontainers.image.description="Managed Server 2025"
          CMD ["./server_app"]
          EOF

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest

  # ----------------------------------------------------------------
  # JOB 3: ë¦´ë¦¬ì¦ˆ ë°°í¬
  # ----------------------------------------------------------------
  release-manager:
    name: Managed Release
    needs: [managed-build, docker-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Linux
          path: linux_pkg
      - uses: actions/download-artifact@v4
        with:
          name: Binary-Windows
          path: windows_pkg

      - name: Package Assets
        run: |
          mkdir release_assets
          cp windows_pkg/final_binary.exe release_assets/server_app_2025.exe
          cp linux_pkg/final_binary release_assets/server_app_linux_2025
          cp linux_pkg/checksum.sha256 release_assets/checksum_linux.sha256
          cp windows_pkg/checksum.sha256 release_assets/checksum_windows.sha256
          cp -r linux_pkg/output_data release_assets/assets_2025
          cp linux_pkg/upgrade_manager.py release_assets/
          
          cd release_assets
          zip -r ../managed_system_v${{ github.run_number }}.zip .

      - uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v2025.3.2.${{ github.run_number }}
          name: ğŸš€ Managed System v${{ github.run_number }} (Script Fixed)
          body: |
            ## ğŸ› ï¸ Script Syntax Fixed
            
            `cat <<EOF` ë³€ìˆ˜ í™•ì¥ ë¬¸ì œë¡œ ì¸í•œ `command not found` ì—ëŸ¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
            ì´ì œ `upgrade_manager.py`ê°€ ì •ìƒì ìœ¼ë¡œ `Makefile`ê³¼ ì†ŒìŠ¤ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            
            ### ğŸ“œ Changes
            - **Script:** Used `cat <<'EOF'` to prevent shell variable expansion.
            - **Makefile:** Correctly generated via Python string injection.
            - **Build:** Fallback compilation logic added.
            
            ğŸ‘‰ **https://github.com/koreatest12/only-c**
          files: managed_system_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
