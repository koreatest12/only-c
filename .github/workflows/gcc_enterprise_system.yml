name: GCC Enterprise Build & GHCR Publish System

on:
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GCC_FLAGS: "-O3 -Wall -Wextra -std=c++17 -pthread"

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  # ----------------------------------------------------------------
  # JOB 1: GCC ë¹Œë“œ, ìµœì í™”, ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± (Linux & Windows)
  # ----------------------------------------------------------------
  gcc-build-generate:
    name: GCC Build & Gen on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. Linux í™˜ê²½: GCC ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
    - name: Install GCC & Tools (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake cppcheck tree g++
        g++ --version

    # 2. ëŒ€ê·œëª¨ ì—”í„°í”„ë¼ì´ì¦ˆ ì†ŒìŠ¤ì½”ë“œ ë° ë¹Œë“œ íŒŒì¼ ìƒì„±
    - name: Generate Enterprise Source & Build Files
      run: |
        echo "ğŸ“ Generating High-Performance Source Code..."
        
        # [Makefile]
        cat <<EOF > Makefile
        CXX = g++
        CXXFLAGS = $GCC_FLAGS
        TARGET = server_app_gcc
        SRCS = enterprise_main.cpp

        all: \$(TARGET)

        \$(TARGET): \$(SRCS)
        	\$(CXX) \$(CXXFLAGS) \$(SRCS) -o \$(TARGET)

        clean:
        	rm -f \$(TARGET)
        EOF

        # [CMakeLists.txt]
        cat <<EOF > CMakeLists.txt
        cmake_minimum_required(VERSION 3.10)
        project(EnterpriseServer)
        set(CMAKE_CXX_STANDARD 17)
        add_executable(enterprise_main enterprise_main.cpp)
        if(UNIX)
            add_compile_options(-O3 -Wall -Wextra -pthread)
        endif()
        if(WIN32)
            set_target_properties(enterprise_main PROPERTIES OUTPUT_NAME "enterprise_main")
        endif()
        EOF

        # [C++ Source]
        cat <<EOF > enterprise_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>
        
        namespace fs = std::filesystem;
        
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        class BigDataManager {
        public:
            static void generateMassiveTransactions() {
                const int COUNT = 300000;
                std::cout << "ğŸ“Š [Data Service] Generating " << COUNT << " records (Target > 20MB)..." << std::endl;
                fs::create_directories("output/data");
                std::ofstream file("output/data/mass_transactions.csv");
                file << "TxID,UserID,Amount,Type,Timestamp,Hash_Signature" << std::endl;
                for(int i=0; i < COUNT; ++i) {
                    file << "TX_" << i << ",User_" << (i%5000) << "," << (i*10.5) 
                         << ",DEPOSIT," << getCurrentTime() << ",sig_xc_" << i << std::endl;
                }
                file.close();
            }
            static void generateMassiveLogs() {
                const int LOG_COUNT = 100000;
                std::cout << "ğŸ“ [Log Service] Generating " << LOG_COUNT << " system logs..." << std::endl;
                fs::create_directories("output/logs");
                std::ofstream log("output/logs/audit.log");
                for(int i=0; i < LOG_COUNT; ++i) {
                    log << "[INFO] " << getCurrentTime() << " PID:" << (1000+i%100) 
                        << " Action:Access_Resource Status:Granted" << std::endl;
                }
                log.close();
            }
        };

        int main(int argc, char* argv[]) {
            if (argc > 1 && std::string(argv[1]) == "--test") return 0;
            std::cout << "ğŸš€ [GCC Enterprise Server] Starting High-Performance Workflow..." << std::endl;
            auto start = std::chrono::high_resolution_clock::now();
            
            BigDataManager::generateMassiveTransactions();
            BigDataManager::generateMassiveLogs();
            
            auto end = std::chrono::high_resolution_clock::now();
            std::chrono::duration<double> elapsed = end - start;
            std::cout << "â±ï¸ Execution Time: " << elapsed.count() << "s" << std::endl;
            std::cout << "ğŸ”— Follow us at: https://github.com/koreatest12/only-c" << std::endl;
            return 0;
        }
        EOF

    # 3. ì •ì  ë¶„ì„
    - name: GCC Static Analysis (Cppcheck)
      if: runner.os == 'Linux'
      run: cppcheck --enable=all --inconclusive --force enterprise_main.cpp || true

    # 4-A. ë¹Œë“œ (Linux: Direct GCC)
    - name: Build with Direct GCC (g++)
      if: runner.os == 'Linux'
      run: |
        echo "ğŸ”¨ Compiling with GCC (make)..."
        make all
        chmod +x server_app_gcc

    # 4-B. ë¹Œë“œ (CMake)
    - name: Build with CMake
      run: |
        echo "ğŸ”¨ Building with CMake..."
        mkdir -p build
        cd build
        cmake ..
        cmake --build . --config Release

    # 5. ì‹¤í–‰ ë° ì•„í‹°íŒ©íŠ¸ ì •ë¦¬ (ê²½ë¡œ ì—ëŸ¬ ìˆ˜ì •ë¨)
    - name: Run & Generate Artifacts (Fixed)
      run: |
        echo "â–¶ï¸ Running Application..."
        
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          # [Linux] Root ê²½ë¡œì—ì„œ ì‹¤í–‰
          ./server_app_gcc
          
          # íŒŒì¼ í™•ì¸ ë° ì´ë™ (Rootì˜ output -> output_dataë¡œ ë³€ê²½)
          if [ -d "output" ]; then
             echo "âœ… Output directory found. Moving to output_data..."
             mv output output_data
          else
             echo "âŒ Error: 'output' directory not found!"
             exit 1
          fi
          
          # ì‹¤í–‰ íŒŒì¼ ë³µì‚¬
          cp server_app_gcc final_binary
          
        else
          # [Windows] build í´ë” ë‚´ì—ì„œ ì‹¤í–‰
          cd build
          ./Release/enterprise_main.exe
          
          # íŒŒì¼ í™•ì¸ ë° ì´ë™ (build/output -> Root/output_dataë¡œ ì´ë™)
          if [ -d "output" ]; then
             echo "âœ… Output directory found (Windows). Moving to ../output_data..."
             mv output ../output_data
          else
             echo "âŒ Error: 'output' directory not found!"
             exit 1
          fi
          
          cd ..
          cp build/Release/enterprise_main.exe final_binary.exe
        fi

    # 6. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gcc-build-${{ matrix.os }}
        path: |
          final_binary*
          output_data/
          enterprise_main.cpp
          Makefile

  # ----------------------------------------------------------------
  # JOB 2: Docker ë¹Œë“œ ë° GHCR ê²Œì‹œ
  # ----------------------------------------------------------------
  docker-publish:
    name: Dockerize & Publish
    needs: gcc-build-generate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: gcc-build-Linux

      - name: Create Dockerfile
        run: |
          echo "ğŸ³ Generating Dockerfile..."
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          WORKDIR /app
          COPY final_binary /app/server_app
          RUN chmod +x /app/server_app
          LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}
          LABEL org.opencontainers.image.description="GCC Optimized Enterprise Server"
          CMD ["./server_app"]
          EOF

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ----------------------------------------------------------------
  # JOB 3: ë¦´ë¦¬ì¦ˆ ë°°í¬
  # ----------------------------------------------------------------
  release-distribute:
    name: Create Release
    needs: [gcc-build-generate, docker-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4

      - name: Package Release
        run: |
          mkdir release_dist
          cp gcc-build-Windows/final_binary.exe release_dist/server_app.exe
          cp gcc-build-Linux/final_binary release_dist/server_app_linux
          cp -r gcc-build-Linux/output_data release_dist/mass_data
          
          cd release_dist
          zip -r ../gcc_enterprise_v${{ github.run_number }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v6.1.${{ github.run_number }}
          name: ğŸš€ GCC Enterprise v6.1.${{ github.run_number }} (Fixed)
          body: |
            ## ğŸ› ï¸ GCC Build Fix
            ê²½ë¡œ ì—ëŸ¬ê°€ ìˆ˜ì •ë˜ì–´ ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ í¬í•¨ëœ ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤.
            
            ### ğŸ“Š Features
            - **Compiler:** GCC (g++) with `-O3`
            - **Data:** 300,000 Rows Massive Data Generated
            - **Docker:** GHCR Published
            
            ğŸ‘‰ **https://github.com/koreatest12/only-c**
          files: gcc_enterprise_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
