name: Generate Professional README & File Report

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì • ì—…ë°ì´íŠ¸
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Analyze Repo and Generate README
        run: |
          # ---------------------------------------------------------
          # Python ìŠ¤í¬ë¦½íŠ¸: ë¦¬í¬ì§€í† ë¦¬ ë¶„ì„ ë° README ìƒì„±
          # ---------------------------------------------------------
          cat <<EOF > readme_generator.py
          import os
          import datetime
          import math

          # 1. ì„¤ì •: ë¦¬í¬ì§€í† ë¦¬ URL ë° ì œì™¸í•  í´ë”
          REPO_URL = "https://github.com/koreatest12/only-c"
          IGNORE_DIRS = {'.git', '.github', '__pycache__', 'build', 'output', 'release_pkg'}
          IGNORE_FILES = {'readme_generator.py', '.gitignore', '.DS_Store'}

          # 2. ìœ í‹¸ë¦¬í‹°: íŒŒì¼ í¬ê¸° í¬ë§·íŒ… (Byte -> KB, MB)
          def convert_size(size_bytes):
              if size_bytes == 0:
                  return "0 B"
              size_name = ("B", "KB", "MB", "GB", "TB")
              i = int(math.floor(math.log(size_bytes, 1024)))
              p = math.pow(1024, i)
              s = round(size_bytes / p, 2)
              return f"{s} {size_name[i]}"

          # 3. ìœ í‹¸ë¦¬í‹°: íŒŒì¼ í™•ì¥ìë³„ ìë™ ì„¤ëª… ë§¤í•‘
          def get_description(filename):
              name_lower = filename.lower()
              if name_lower == 'dockerfile': return "ğŸ³ Container Definition"
              if name_lower == 'cmakelists.txt': return "ğŸ”¨ CMake Build Config"
              if name_lower == 'makefile': return "âš™ï¸ Make Build Script"
              if name_lower.endswith('.cpp'): return "âš¡ C++ Source Code"
              if name_lower.endswith('.h') or name_lower.endswith('.hpp'): return "ğŸ“š C++ Header File"
              if name_lower.endswith('.py'): return "ğŸ Python Script"
              if name_lower.endswith('.yml') or name_lower.endswith('.yaml'): return "ğŸ¤– CI/CD Workflow"
              if name_lower.endswith('.json'): return "ğŸ”§ Config/Data File"
              if name_lower.endswith('.md'): return "ğŸ“ Documentation"
              if name_lower.endswith('.csv'): return "ğŸ“Š Data Set"
              if name_lower.endswith('.exe'): return "ğŸªŸ Windows Binary"
              if name_lower == 'license': return "âš–ï¸ License File"
              return "ğŸ“„ File Resource"

          # 4. ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ êµ¬ì¡° ë¶„ì„ (í‘œ ìƒì„±)
          def generate_file_tree():
              table_rows = []
              total_size = 0
              file_count = 0

              # í˜„ì¬ ë””ë ‰í† ë¦¬ ìˆœíšŒ
              for root, dirs, files in os.walk("."):
                  # ì œì™¸í•  ë””ë ‰í† ë¦¬ í•„í„°ë§
                  dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
                  
                  for file in files:
                      if file in IGNORE_FILES or file == "README.md":
                          continue
                          
                      file_path = os.path.join(root, file)
                      try:
                          # íŒŒì¼ ì •ë³´ ì¶”ì¶œ
                          size = os.path.getsize(file_path)
                          total_size += size
                          file_count += 1
                          
                          # ìƒëŒ€ ê²½ë¡œ (./src/main.cpp -> src/main.cpp)
                          rel_path = os.path.relpath(file_path, ".")
                          
                          # ì„¤ëª… ìƒì„±
                          desc = get_description(file)
                          
                          # GitHub ë§í¬ ìƒì„±
                          link = f"[{rel_path}]({REPO_URL}/blob/main/{rel_path})"
                          
                          table_rows.append(f"| {link} | {desc} | {convert_size(size)} |")
                      except Exception as e:
                          print(f"Skipping {file}: {e}")

              # í—¤ë” ì‘ì„±
              md_table = "\n### ğŸ“‚ Repository File Structure & Capacity Report\n\n"
              md_table += f"**Total Files:** {file_count} | **Total Size:** {convert_size(total_size)}\n\n"
              md_table += "| File / Directory ğŸ“ | Description ğŸ“ | Size ğŸ’¾ |\n"
              md_table += "| :--- | :--- | :---: |\n"
              
              # í–‰ ì¶”ê°€ (ì´ë¦„ìˆœ ì •ë ¬)
              md_table += "\n".join(sorted(table_rows))
              return md_table

          # 5. ìµœì¢… Markdown ì½˜í…ì¸  ì¡°ë¦½
          current_date = datetime.datetime.now().strftime("%Y-%m-%d")
          file_report = generate_file_tree()

          markdown_content = f"""
          # ğŸš€ Welcome to My Tech Stack Journey

          ### Aspiring Systems Architect | Passionate about C++ & Docker Technology

          Welcome to my technical blog repository! ğŸŒ±
          
          This repository is a live implementation of high-performance system architecture.
          Documenting the journey of mastering **C++**, **Docker**, and **DevOps Automation**.

          ---

          ## ğŸ› ï¸ Core Technical Focus

          <div align="center">
            <img src="https://img.shields.io/badge/Modern%20C%2B%2B-17%2F20-00599C?style=for-the-badge&logo=c%2B%2B&logoColor=white" alt="C++" />
            <img src="https://img.shields.io/badge/Docker-Containerization-2496ED?style=for-the-badge&logo=docker&logoColor=white" alt="Docker" />
            <img src="https://img.shields.io/badge/Linux-Systems-FCC624?style=for-the-badge&logo=linux&logoColor=black" alt="Linux" />
          </div>

          ---

          ## ğŸ¯ Expertise & Features

          ### ğŸ³ Docker & Containerization
          - **Auto-Publish:** Docker images pushed to GHCR automatically.
          - **Optimization:** Multi-stage builds for minimal image size.

          ### âš¡ Modern C++ System
          - **Massive Data Gen:** Creating 20MB+ data for stress testing.
          - **Cross-Platform:** Builds on Windows & Linux simultaneously.
          - **GCC Optimization:** Leveraging \`-O3\` for max performance.

          ---

          {file_report}

          ---
          <p align="center">
            <em>Automatically Analyzed & Updated via GitHub Actions: {current_date}</em>
          </p>
          """

          # README.md ì €ì¥
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(markdown_content)
          
          print("âœ… Professional README with File Report generated.")
          EOF

          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python readme_generator.py

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet README.md; then
            echo "No changes to commit."
          else
            git add README.md
            git commit -m "docs: auto-update README with latest file structure [skip ci]"
            git push
            echo "ğŸ‰ README updated with new file stats."
          fi
