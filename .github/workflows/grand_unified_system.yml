name: ğŸ­ Full-Stack Mega Factory (Web & Data)

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  mega-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # ì›¹ ì„œë²„ êµ¬ë™ì„ ìœ„í•œ ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ (Redis: ì„¸ì…˜ ì €ì¥ì†Œìš©)
    services:
      redis:
        image: redis:alpine
        ports: ["6379:6379"]

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì¸í”„ë¼ í´ë¦°ì—… (Clean Room)
    # ----------------------------------------------------------------
    - name: ğŸ§¹ Infrastructure Init
      run: |
        echo "ğŸ§¹ Cleaning disk for Web Server & Database..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "âœ… Infrastructure Ready."

    # ----------------------------------------------------------------
    # [Step 2] ëŸ°íƒ€ì„ ì„¤ì • (Python, Node.js)
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Stack
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: ğŸ“¦ Install Python Libs (Flask, DB Drivers)
      run: pip install flask flask-cors faker pymssql psycopg2-binary redis requests pandas jinja2

    # ----------------------------------------------------------------
    # [Step 3] ğŸ­ ë°±ì—”ë“œ: ëŒ€ëŸ‰ ë°ì´í„° ìƒì‚° ì—”ì§„ (SQL/Log/Bin)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Backend Data Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > backend_engine.py
        import os, shutil, json, random, time, gzip
        from datetime import datetime
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        
        # ëŒ€ëŸ‰ ìƒì„±í•  ì„œë¹„ìŠ¤ ëª©ë¡
        SERVICES = ["Auth_Server", "Billing_Core", "User_Dashboard", "IoT_Gateway", "AI_Model_Server"]
        REGIONS = ["KR", "US", "EU", "JP"]

        def disk_check():
            _, _, free = shutil.disk_usage("/")
            if (free // (1024*1024)) < 1000: return False # 1GB ë¯¸ë§Œ ì¤‘ë‹¨
            return True

        def generate_data():
            print("ğŸš€ [Backend] Starting Data Production...")
            metadata_list = []
            
            for region in REGIONS:
                for svc in SERVICES:
                    if not disk_check(): break
                    
                    base_path = f"data/{region}/{svc}"
                    os.makedirs(base_path, exist_ok=True)
                    
                    # 1. SQL Dump ìƒì„±
                    with open(f"{base_path}/dump.sql", "w") as f:
                        f.write(f"-- SQL Dump for {svc}\n")
                        for _ in range(1000):
                            f.write(f"INSERT INTO logs VALUES ('{fake.uuid4()}', '{datetime.now()}', 'INFO');\n")
                            
                    # 2. Access Log ìƒì„±
                    with open(f"{base_path}/access.log", "w") as f:
                        for _ in range(2000):
                            f.write(f"{fake.ipv4()} - - [{datetime.now()}] \"GET /api/v1/data HTTP/1.1\" 200 1024\n")
                            
                    # 3. JSON Config
                    conf = {"svc": svc, "region": region, "active": True, "shards": random.randint(1,10)}
                    with open(f"{base_path}/config.json", "w") as f:
                        json.dump(conf, f)

                    # 4. ì••ì¶• ë° ì‚­ì œ (ê³µê°„ ì ˆì•½)
                    zip_name = f"{region}_{svc}"
                    shutil.make_archive(f"{OUTPUT_DIR}/{zip_name}", 'zip', base_path)
                    shutil.rmtree(base_path) # ì¦‰ì‹œ ì‚­ì œ
                    
                    metadata_list.append({"name": zip_name, "size": "Compressed", "status": "Ready"})
            
            # ëŒ€ì‹œë³´ë“œìš© ë°ì´í„° ìƒì„± (frontendê°€ ì½ì„ íŒŒì¼)
            with open("dashboard_data.json", "w") as f:
                json.dump({
                    "timestamp": str(datetime.now()),
                    "total_services": len(SERVICES) * len(REGIONS),
                    "disk_status": "Healthy",
                    "services": metadata_list
                }, f)
            
            print("âœ… [Backend] Data Generation Complete.")

        if __name__ == "__main__": generate_data()
        EOF
        
        python backend_engine.py

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ: í™ˆí˜ì´ì§€(Web Portal) ìë™ êµ¬ì¶•
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Web Portal (Dashboard)
      shell: bash
      run: |
        mkdir -p _web_portal/static/css
        mkdir -p _web_portal/static/js
        mkdir -p _web_portal/templates
        
        # 1. HTML (ëª¨ë˜ ëŒ€ì‹œë³´ë“œ UI)
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Factory Ops Control Center</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        </head>
        <body class="bg-gray-900 text-white font-sans">
            <div class="flex h-screen">
                <div class="w-64 bg-gray-800 p-5">
                    <h1 class="text-2xl font-bold text-blue-400 mb-10">ğŸ­ OPS PORTAL</h1>
                    <ul class="space-y-4">
                        <li class="p-3 bg-gray-700 rounded cursor-pointer">ğŸ“Š Dashboard</li>
                        <li class="p-3 hover:bg-gray-700 rounded cursor-pointer">ğŸ›¢ï¸ Data Lake</li>
                        <li class="p-3 hover:bg-gray-700 rounded cursor-pointer">âš™ï¸ Server Config</li>
                        <li class="p-3 hover:bg-gray-700 rounded cursor-pointer">ğŸš¨ Logs</li>
                    </ul>
                </div>
                
                <div class="flex-1 p-10 overflow-y-auto">
                    <div class="grid grid-cols-3 gap-6 mb-10">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border-l-4 border-green-500">
                            <h3 class="text-gray-400">System Status</h3>
                            <p class="text-3xl font-bold mt-2">ONLINE âœ…</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
                            <h3 class="text-gray-400">Processed Data</h3>
                            <p class="text-3xl font-bold mt-2" id="data-count">Loading...</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border-l-4 border-purple-500">
                            <h3 class="text-gray-400">Server Load</h3>
                            <p class="text-3xl font-bold mt-2">12%</p>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg mb-10">
                        <h2 class="text-xl font-bold mb-4">Real-time Traffic</h2>
                        <canvas id="trafficChart" height="100"></canvas>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h2 class="text-xl font-bold mb-4">Recent Artifacts</h2>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700 text-gray-400">
                                    <th class="p-2">Service Name</th>
                                    <th class="p-2">Region</th>
                                    <th class="p-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <script>
                // Mock Data Loading
                fetch('/api/stats')
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('data-count').innerText = data.total_services + " Sets";
                        const tbody = document.getElementById('table-body');
                        data.services.slice(0, 5).forEach(s => {
                            tbody.innerHTML += `<tr class="border-b border-gray-700"><td class="p-2">${s.name}</td><td class="p-2">Global</td><td class="p-2 text-green-400">Archived</td></tr>`;
                        });
                    })
                    .catch(e => console.log("Simulated Mode: API not reachable in static view"));

                // Chart
                const ctx = document.getElementById('trafficChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['10:00', '10:05', '10:10', '10:15', '10:20', '10:25'],
                        datasets: [{
                            label: 'Throughput (MB/s)',
                            data: [12, 19, 3, 5, 2, 3],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            </script>
        </body>
        </html>
        EOF

        # 2. CSS (ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼)
        cat <<'EOF' > _web_portal/static/css/style.css
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard-card { transition: transform 0.2s; }
        .dashboard-card:hover { transform: translateY(-5px); }
        EOF

    # ----------------------------------------------------------------
    # [Step 5] ğŸ–¥ï¸ ì„œë²„ ì¸í”„ë¼ êµ¬ì¶• (Flask Web Server)
    # ----------------------------------------------------------------
    - name: âš™ï¸ Build Web Server & Configs
      shell: bash
      run: |
        # 1. Flask ì„œë²„ ì½”ë“œ (Backend API + Frontend Serving)
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify
        import json, os

        app = Flask(__name__)

        @app.route('/')
        def home():
            return render_template('index.html')

        @app.route('/api/stats')
        def stats():
            # ë°±ì—”ë“œ ì—”ì§„ì´ ìƒì„±í•œ ë°ì´í„° ë¡œë“œ
            try:
                with open('../dashboard_data.json', 'r') as f:
                    return jsonify(json.load(f))
            except:
                return jsonify({"error": "Data not found", "services": []})

        @app.route('/health')
        def health():
            return jsonify({"status": "healthy", "server": "Flask-Production"})

        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=5000)
        EOF

        # 2. Nginx ì„¤ì • íŒŒì¼ (ìš´ì˜ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜ìš©)
        cat <<'EOF' > _web_portal/nginx.conf
        server {
            listen 80;
            server_name factory-ops.internal;

            location / {
                proxy_pass http://localhost:5000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
            
            location /static {
                alias /var/www/static;
            }
        }
        EOF
        
        # 3. Dockerfile (ì›¹ ì„œë²„ ì»¨í…Œì´ë„ˆí™” ì¤€ë¹„)
        cat <<'EOF' > _web_portal/Dockerfile
        FROM python:3.10-slim
        WORKDIR /app
        COPY . .
        RUN pip install flask flask-cors
        EXPOSE 5000
        CMD ["python", "app.py"]
        EOF

    # ----------------------------------------------------------------
    # [Step 6] ğŸ§ª ë¼ì´ë¸Œ ì„œë²„ ì‹œë®¬ë ˆì´ì…˜ (Health Check)
    # ----------------------------------------------------------------
    - name: ğŸ§ª Test Run Web Server
      run: |
        echo "ğŸŒ Starting Flask Server in Background..."
        cd _web_portal
        # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
        python app.py &
        PID=$!
        
        echo "â³ Waiting for server boot..."
        sleep 5
        
        echo "ğŸ” Testing API Endpoint..."
        curl -v http://localhost:5000/api/stats
        
        echo "ğŸ” Testing Homepage..."
        curl -I http://localhost:5000/
        
        echo "âœ… Server Test Passed."
        # ì„œë²„ ì¢…ë£Œ
        kill $PID || true

    # ----------------------------------------------------------------
    # [Step 7] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ì›¹ ì†ŒìŠ¤ + ë°ì´í„°)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload Full-Stack Package
      uses: actions/upload-artifact@v4
      with:
        name: factory-web-portal-package
        path: |
          _web_portal/
          _data_warehouse/
          dashboard_data.json
        retention-days: 1
        compression-level: 9

    # ----------------------------------------------------------------
    # [Step 8] ëŒ€ì‹œë³´ë“œ ë¦¬í¬íŠ¸
    # ----------------------------------------------------------------
    - name: ğŸ“Š Final Report
      if: always()
      run: |
        echo "# ğŸ­ Mega Factory & Web Portal Report" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Web Infrastructure Created" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Path | Status |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Frontend** | `_web_portal/templates/index.html` | âœ… Created (Tailwind/Chart.js) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Backend** | `_web_portal/app.py` | âœ… Created (Flask API) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Config** | `_web_portal/nginx.conf` | âœ… Created |" >> $GITHUB_STEP_SUMMARY
        
        DATA_COUNT=$(ls _data_warehouse/*.zip 2>/dev/null | wc -l)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ›¢ï¸ Data Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Generated Artifacts:** $DATA_COUNT ZIP files" >> $GITHUB_STEP_SUMMARY
        echo "- **API Status:** Tested & Active at \`/api/stats\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> Download the artifact to deploy your own OPS Portal." >> $GITHUB_STEP_SUMMARY
