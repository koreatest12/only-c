name: ğŸš€ TOTAL FORCE EXECUTION SYSTEM

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# [ì¤‘ìš”] ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤/ë§¥ ëª¨ë“  í™˜ê²½ì—ì„œ í•œê¸€ ë° ì´ëª¨ì§€ ê¹¨ì§ ë°©ì§€
env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8

jobs:
  full-force-build:
    name: ğŸ›¡ï¸ Execute All on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-full-pack
          - os: windows-latest
            artifact_name: windows-full-pack
          - os: macos-latest
            artifact_name: macos-full-pack

    steps:
    # ----------------------------------------------------------------
    # 1. ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # 2. ì‹œìŠ¤í…œ ì‚¬ì–‘ ë° í™˜ê²½ ì •ë³´ ì¶œë ¥ (ì „ë¬¸ê°€ê¸‰ ë¡œê¹… ì¶”ê°€)
    # ----------------------------------------------------------------
    - name: ğŸ–¥ï¸ Display System Information
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸš€ SYSTEM INFORMATION REPORT"
        echo "=========================================="
        echo "OS: ${{ matrix.os }}"
        python --version
        cmake --version
        echo "=========================================="

    # ----------------------------------------------------------------
    # 3. Python 3.10 ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # ----------------------------------------------------------------
    # 4. [ê°•ì œ ì‹¤í–‰] ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë¬´ì¡°ê±´ ì¬ìƒì„± (NO SKIP)
    #    UTF-8 ì¸ì½”ë”© ë¬¸ì œë¥¼ í•´ê²°í•œ Python ì½”ë“œë¥¼ ê°•ì œë¡œ ì”ë‹ˆë‹¤.
    # ----------------------------------------------------------------
    - name: ğŸ“ FORCE GENERATE:upgrade_manager.py
      shell: bash
      run: |
        echo "ğŸ”¥ Force creating requirements.txt..."
        echo "colorama" > requirements.txt

        echo "ğŸ”¥ Force creating upgrade_manager.py (UTF-8 Safe)..."
        # ì•„ë˜ Python ì½”ë“œëŠ” Windows í™˜ê²½ì—ì„œë„ ì•ˆì „í•˜ê²Œ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
        cat <<EOF > upgrade_manager.py
        import os
        import sys
        import platform

        # í‘œì¤€ ì¶œë ¥ ì¸ì½”ë”© ê°•ì œ ì„¤ì •
        sys.stdout.reconfigure(encoding='utf-8')

        def create_cpp_files():
            print(f"[MANAGER] ğŸš€ System: {platform.system()} detected.")
            print("[MANAGER] ğŸš€ Generating C++20 Source Code...")
            
            # C++ Main Source
            main_code = """
        #include <iostream>
        #include <vector>
        #include <string>

        int main() {
            // Windows Console Encoding Fix
            #ifdef _WIN32
            system("chcp 65001 > nul");
            #endif

            std::cout << "========================================" << std::endl;
            std::cout << "ğŸš€ FINAL BUILD SUCCESSFUL!" << std::endl;
            std::cout << "========================================" << std::endl;
            std::cout << "Target: Multi-Platform (Win/Lin/Mac)" << std::endl;
            return 0;
        }
            """
            
            # CMakeLists.txt
            cmake_code = """
        cmake_minimum_required(VERSION 3.10)
        project(ProfessionalBuild)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            # [FIX] encoding='utf-8'ì„ ì‚¬ìš©í•˜ì—¬ Windows CP1252 ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨
            try:
                print("[MANAGER] Writing main.cpp...")
                with open("main.cpp", "w", encoding="utf-8") as f:
                    f.write(main_code)
                
                print("[MANAGER] Writing CMakeLists.txt...")
                with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                    f.write(cmake_code)
                    
                print("[MANAGER] âœ… All files generated successfully without errors.")
            except Exception as e:
                print(f"[ERROR] Failed to write files: {e}")
                exit(1)

        if __name__ == "__main__":
            create_cpp_files()
        EOF

    # ----------------------------------------------------------------
    # 5. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ìƒì„±ê¸° ì‹¤í–‰ (ì¡°ê±´ ì—†ìŒ)
    # ----------------------------------------------------------------
    - name: ğŸ“¦ Install Dependencies & Run Generator
      shell: bash
      run: |
        pip install -r requirements.txt
        python upgrade_manager.py

    # ----------------------------------------------------------------
    # 6. ìƒì„±ëœ íŒŒì¼ í™•ì¸ (ë””ë²„ê¹…)
    # ----------------------------------------------------------------
    - name: ğŸ” Verify Generated Files
      shell: bash
      run: ls -R

    # ----------------------------------------------------------------
    # 7. ë¹Œë“œ í™˜ê²½ êµ¬ì„± (OSë³„ ë¶„ê¸°ì´ë‚˜ ìŠ¤í‚µì€ ì•„ë‹˜, í•„ìˆ˜ ì„¤ì¹˜)
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Linux Build Tools
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: ğŸ› ï¸ Setup Windows MSVC
      if: matrix.os == 'windows-latest'
      uses: microsoft/setup-msbuild@v1.1

    # ----------------------------------------------------------------
    # 8. CMake ë¹Œë“œ ì‹¤í–‰ (ê°•ë ¥ ëª¨ë“œ)
    # ----------------------------------------------------------------
    - name: ğŸ—ï¸ CMake Configure
      shell: bash
      run: cmake -S . -B build

    - name: ğŸ”¨ Build Project (Release)
      shell: bash
      run: cmake --build build --config Release

    # ----------------------------------------------------------------
    # 9. ë¹Œë“œ ê²°ê³¼ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (OSë³„ ê²½ë¡œ ì²˜ë¦¬)
    # ----------------------------------------------------------------
    - name: ğŸ§ª Run Application (Linux/Mac)
      if: runner.os != 'Windows'
      run: |
        chmod +x ./build/app
        ./build/app

    - name: ğŸ§ª Run Application (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: build\Release\app.exe

    # ----------------------------------------------------------------
    # 10. ëª¨ë“  ê²°ê³¼ë¬¼ ì••ì¶• ì—…ë¡œë“œ (ëŒ€ëŸ‰ ì¶”ê°€ ë°˜ì˜)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload ALL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          *.cpp
          *.txt
          *.py
          *.md
        retention-days: 1
