name: ğŸ­ Enterprise Factory (Cloud Pages)

on:
  # [íŠ¸ë¦¬ê±°] 6ì‹œê°„ë§ˆë‹¤ or Push or ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

# [ê¶Œí•œ ì„¤ì •] Pages ë°°í¬ë¥¼ ìœ„í•´ permissions í™•ì¥
permissions:
  contents: write
  pages: write      # GitHub Pages ë°°í¬ ê¶Œí•œ
  id-token: write   # OIDC í† í° ê¶Œí•œ
  packages: write

# [ë™ì‹œì„± ì œì–´]
concurrency:
  group: "pages-production"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ë°ì´í„° ìƒì‚° ë° ì›¹ì‚¬ì´íŠ¸ êµ¬ì¶• (Core Ops)
  # ==============================================================================
  factory-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì¸í”„ë¼ í´ë¦°ë£¸
    # ----------------------------------------------------------------
    - name: ğŸ§¹ Infrastructure Cleanup
      run: |
        echo "ğŸ§¹ Purging disk space..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "âœ… Disk Ready."

    # ----------------------------------------------------------------
    # [Step 2] ëŸ°íƒ€ì„ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Python 3.10
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: ğŸ“¦ Install Deps
      run: pip install flask flask-cors gunicorn faker pandas requests jinja2 psutil

    # ----------------------------------------------------------------
    # [Step 3] ë°±ì—”ë“œ ë°ì´í„° ì—”ì§„ (ëŒ€ëŸ‰ ìƒì„±)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Backend Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > backend_engine.py
        import os, shutil, json, random, uuid
        from datetime import datetime
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        SERVICES = ["Auth_Core", "Billing_Gateway", "Ops_Monitor", "AI_Inference", "DB_Shard_KR", "DB_Shard_US"]
        REGIONS = ["Global", "Asia_Seoul", "US_Virginia", "EU_London"]

        def generate():
            print("ğŸš€ Generating Enterprise Data...")
            metadata = []
            
            # ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± ë£¨í”„
            for region in REGIONS:
                for svc in SERVICES:
                    base_path = f"data/{region}/{svc}"
                    os.makedirs(base_path, exist_ok=True)
                    
                    # Log Simulation
                    with open(f"{base_path}/trace.log", "w") as f:
                        for _ in range(200): f.write(f"INFO {datetime.now()} {uuid.uuid4()} Latency={random.randint(5,100)}ms\n")

                    # Archiving
                    zip_name = f"{region}_{svc}"
                    shutil.make_archive(f"{OUTPUT_DIR}/{zip_name}", 'zip', base_path)
                    shutil.rmtree(base_path)
                    
                    metadata.append({
                        "id": str(uuid.uuid4())[:8],
                        "service": svc,
                        "region": region,
                        "status": "Healthy",
                        "throughput": f"{random.randint(100, 5000)} TPS"
                    })

            # Dashboardìš© ë°ì´í„° (ì •ì  íŒŒì¼ë¡œ ì €ì¥)
            data = {
                "system_status": "OPERATIONAL",
                "updated_at": str(datetime.now().strftime("%Y-%m-%d %H:%M:%S")),
                "total_nodes": len(SERVICES) * len(REGIONS),
                "services": metadata
            }
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f)
        
        if __name__ == "__main__": generate()
        EOF
        
        python backend_engine.py

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ ì›¹ í¬í„¸ êµ¬ì¶• (ì •ì /ë™ì  í•˜ì´ë¸Œë¦¬ë“œ ì§€ì›)
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Universal Dashboard
      shell: bash
      run: |
        mkdir -p _web_portal/static/css
        mkdir -p _web_portal/templates
        
        # HTML: GitHub Pages(ì •ì )ì™€ Flask(ë™ì ) ëª¨ë‘ì—ì„œ ì‘ë™í•˜ë„ë¡ JS ìˆ˜ì •
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>OPS COMMAND CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                body { background-color: #0b0c10; color: #c5c6c7; font-family: monospace; }
                .neon-text { color: #66fcf1; text-shadow: 0 0 5px #45a29e; }
                .card { background-color: #1f2833; border: 1px solid #45a29e; }
                .status-ok { color: #00ff00; }
                .link-box { background: #000; border: 1px dashed #66fcf1; padding: 5px; font-size: 0.8rem; cursor: pointer; }
            </style>
        </head>
        <body class="h-screen flex flex-col overflow-hidden">
            <header class="p-4 border-b border-gray-700 bg-gray-900 flex justify-between">
                <h1 class="text-2xl font-bold neon-text">ğŸ­ FACTORY OPS :: CLOUD VIEW</h1>
                <div><span class="text-green-400 animate-pulse">â— LIVE SYSTEM</span></div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto grid grid-cols-4 gap-6">
                <div class="card p-4 rounded col-span-4 bg-gray-900 border-l-4 border-green-500">
                    <h3 class="text-green-400 font-bold">ğŸŒ CONNECTION STATUS</h3>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <p class="text-xs text-gray-500">GITHUB PAGES (STATIC)</p>
                            <div class="link-box text-blue-300" onclick="window.location.reload()">Current View</div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">LAST UPDATE</p>
                            <div class="link-box text-white" id="last-update">Syncing...</div>
                        </div>
                    </div>
                </div>

                <div class="card p-4 rounded col-span-1">
                    <p class="text-xs text-gray-400">TOTAL NODES</p>
                    <p class="text-4xl font-bold text-white mt-2" id="node-count">--</p>
                </div>
                <div class="card p-4 rounded col-span-3 row-span-2">
                    <p class="text-xs text-gray-400 mb-2">SERVICE MESH TOPOLOGY</p>
                    <div class="overflow-auto max-h-64">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-800 text-cyan-400 sticky top-0">
                                <tr><th class="p-2">ID</th><th class="p-2">REGION</th><th class="p-2">SERVICE</th><th class="p-2">STATUS</th></tr>
                            </thead>
                            <tbody id="svc-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card p-4 rounded col-span-4 h-48">
                    <canvas id="mainChart"></canvas>
                </div>
            </main>

            <script>
                // ë°ì´í„° ë¡œë“œ ë¡œì§ (í•˜ì´ë¸Œë¦¬ë“œ)
                async function loadData() {
                    let data = null;
                    try {
                        // 1. Flask API ì‹œë„
                        const res = await fetch('/api/stats');
                        if(res.ok) data = await res.json();
                        else throw new Error("API failed");
                    } catch(e) {
                        console.log("Switching to Static Mode...");
                        try {
                            // 2. ì •ì  íŒŒì¼ ì‹œë„ (GitHub Pagesìš©)
                            const res = await fetch('./dashboard_data.json');
                            if(res.ok) data = await res.json();
                        } catch(e2) { console.error("Data load failed"); }
                    }

                    if(data) {
                        document.getElementById('node-count').innerText = data.total_nodes;
                        document.getElementById('last-update').innerText = data.updated_at;
                        
                        const tbody = document.getElementById('svc-table');
                        data.services.forEach(s => {
                            tbody.innerHTML += `<tr class="border-b border-gray-700">
                                <td class="p-2 text-green-400 font-mono">${s.id}</td>
                                <td class="p-2">${s.region}</td>
                                <td class="p-2 font-bold text-white">${s.service}</td>
                                <td class="p-2 status-ok">â— ${s.status}</td>
                            </tr>`;
                        });
                    }
                }
                loadData();

                // Chart
                new Chart(document.getElementById('mainChart'), {
                    type: 'bar',
                    data: {
                        labels: ['KR', 'US', 'EU', 'Global'],
                        datasets: [{ label: 'Traffic Load', data: [65, 59, 80, 81], backgroundColor: '#45a29e' }]
                    },
                    options: { maintainAspectRatio: false, scales: { y: { grid: {color:'#333'} } } }
                });
            </script>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 5] ğŸ–¥ï¸ Flask/Gunicorn ì„œë²„ ë¹Œë“œ (ë¡œì»¬ ì‹¤í–‰ìš©)
    # ----------------------------------------------------------------
    - name: âš™ï¸ Build Server App
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        @app.route('/')
        def home(): return render_template('index.html')
        @app.route('/api/stats')
        def stats():
            try: return jsonify(json.load(open('../dashboard_data.json')))
            except: return jsonify({})
        # ì •ì  íŒŒì¼ ì„œë¹™ ì§€ì› (í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ)
        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        # Gunicorn Config
        echo 'bind = "0.0.0.0:5000"' > _web_portal/gunicorn_config.py

    # ----------------------------------------------------------------
    # [Step 6] ğŸš€ ì„œë²„ í…ŒìŠ¤íŠ¸ (IPv4)
    # ----------------------------------------------------------------
    - name: ğŸ§ª Verify Server
      run: |
        cd _web_portal
        gunicorn -c gunicorn_config.py app:app &
        sleep 5
        curl -4 -v http://127.0.0.1:5000/api/stats
        pkill gunicorn || true

    # ----------------------------------------------------------------
    # [Step 7] GitHub Pagesìš© ì •ì  ì‚¬ì´íŠ¸ ì¤€ë¹„ (í•µì‹¬ ì¶”ê°€)
    # ----------------------------------------------------------------
    - name: ğŸ“„ Prepare Pages Site
      run: |
        echo "ğŸ“¦ preparing static site for GitHub Pages..."
        mkdir -p _site
        
        # 1. HTML íŒŒì¼ ë³µì‚¬ (ë£¨íŠ¸ë¡œ ì´ë™)
        cp _web_portal/templates/index.html _site/index.html
        
        # 2. ë°ì´í„° íŒŒì¼ ë³µì‚¬ (JSê°€ ì½ì„ ìˆ˜ ìˆê²Œ)
        cp dashboard_data.json _site/dashboard_data.json
        
        echo "âœ… Static site ready at ./_site"
        ls -R _site

    # ----------------------------------------------------------------
    # [Step 8] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì„œë²„ìš© & Pagesìš© ë¶„ë¦¬)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload Server Package (For Local)
      uses: actions/upload-artifact@v4
      with:
        name: full-stack-server
        path: |
          _web_portal/
          dashboard_data.json
          _data_warehouse/

    - name: ğŸ“¤ Upload Pages Artifact (For Cloud)
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site/

  # ==============================================================================
  # [Job 2] GitHub Pages ë°°í¬ (Standard Deploy)
  # ==============================================================================
  deploy-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: factory-ops # ë°ì´í„° ìƒì„±ì´ ëë‚˜ì•¼ ì‹¤í–‰
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
