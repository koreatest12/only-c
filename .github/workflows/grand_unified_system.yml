name: ğŸ’ FIXED:GRAND OPS & MASSIVE ARTIFACTS

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  grand-ops-fix:
    name: ğŸš€ Grand Ops Fix on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-grand-full-pack
          - os: windows-latest
            artifact_name: windows-grand-full-pack
          - os: macos-latest
            artifact_name: macos-grand-full-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] Java JDK 17 (ì—”í„°í”„ë¼ì´ì¦ˆ)
    # ----------------------------------------------------------------
    - name: â˜• [2] Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # ----------------------------------------------------------------
    # [Step 3] Python ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ“ [3] Init Dependencies
      shell: bash
      run: |
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt

    - name: ğŸ [4] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4-Post] Install Libs
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] ëŒ€ëŸ‰ ìƒì„±ê¸° ì‹¤í–‰ (íŒŒì¼ ìƒì„± ë³´ì¥)
    # ----------------------------------------------------------------
    - name: ğŸ­ [5] Run Massive Generator
      shell: bash
      run: |
        cat <<EOF > grand_generator.py
        import os
        import sys
        import sqlite3
        import random
        import time

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = ["Banking", "Stock", "Insurance", "PublicData"]
        
        # [ì¤‘ìš”] ë””ë ‰í† ë¦¬ ê°•ì œ ìƒì„± í•¨ìˆ˜
        def safe_makedirs(path):
            if not os.path.exists(path):
                os.makedirs(path, exist_ok=True)
                print(f"[GEN] Created Directory: {path}")

        def log(msg):
            print(f"[GRAND-GEN] {msg}")

        # 1. Java ì†ŒìŠ¤ ë° êµ¬ì¡° ëŒ€ëŸ‰ ìƒì„±
        def generate_java_structure():
            log("â˜• Generating Java Source Code...")
            safe_makedirs("src/main/java/com/enterprise")
            
            for svc in SERVICES:
                base_pkg = f"src/main/java/com/enterprise/{svc.lower()}"
                safe_makedirs(base_pkg)
                
                # Main App
                with open(f"{base_pkg}/{svc}Application.java", "w") as f:
                    f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Service Started\"); }} }}")
                
                # Components (Controller, Service, Repository) - 20ê°œì”© ìƒì„±
                for i in range(1, 21):
                    with open(f"{base_pkg}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Controller{i} {{ }}")

        # 2. SQL ë° DB ëŒ€ëŸ‰ ìƒì„±
        def generate_data_assets():
            log("ğŸ—ƒï¸ Generating Database Assets...")
            safe_makedirs("database_store")
            
            for svc in SERVICES:
                # SQL íŒŒì¼
                with open(f"database_store/{svc}_schema.sql", "w") as f:
                    f.write(f"CREATE TABLE {svc}_users (id INT, data VARCHAR(255));\n-- Mass Data for {svc}\n")
                
                # DB íŒŒì¼
                conn = sqlite3.connect(f"database_store/{svc}.db")
                cur = conn.cursor()
                cur.execute(f"CREATE TABLE {svc}_logs (id INT, msg TEXT)")
                cur.executemany(f"INSERT INTO {svc}_logs VALUES (?, ?)", [(i, f"Log {i}") for i in range(100)])
                conn.commit()
                conn.close()

        # 3. ì„œë¹„ìŠ¤ë³„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Batch/Shell)
        def generate_scripts():
            log("ğŸ“œ Generating Execution Scripts...")
            safe_makedirs("scripts")
            
            for svc in SERVICES:
                # Linux/Mac Script
                with open(f"scripts/run_{svc}.sh", "w") as f:
                    f.write(f"#!/bin/bash\necho 'Starting {svc} Service...'\njava -jar ../bin/{svc}App.jar\n")
                
                # Windows Script
                with open(f"scripts/run_{svc}.bat", "w") as f:
                    f.write(f"@echo off\necho Starting {svc} Service...\njava -jar ..\\bin\\{svc}App.jar\n")

        if __name__ == "__main__":
            generate_java_structure()
            generate_data_assets()
            generate_scripts()
            # ì»´íŒŒì¼ë  ë°”ì´ë„ˆë¦¬ í´ë” ë¯¸ë¦¬ ìƒì„±
            safe_makedirs("bin")
            log("âœ… All Generators Finished Successfully.")
        EOF
        
        # ì‹¤í–‰
        python grand_generator.py

    # ----------------------------------------------------------------
    # [Step 5] ë¹Œë“œ (Java Compile & Jar Packaging)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [6] Build All Services
      shell: bash
      run: |
        echo "ğŸ—ï¸ Compiling Java Sources..."
        # ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ í™•ë³´
        find src -name "*.java" > sources.txt
        
        # ì»´íŒŒì¼ (bin í´ë”ì— class íŒŒì¼ ìƒì„±)
        javac -d bin @sources.txt
        
        # ì„œë¹„ìŠ¤ë³„ JAR íŒ¨í‚¤ì§• ì‹œë®¬ë ˆì´ì…˜
        echo "ğŸ“¦ Packaging JARs..."
        SERVICES="Banking Stock Insurance PublicData"
        for svc in $SERVICES; do
            # ê°„ë‹¨í•œ Manifest ìƒì„±
            echo "Main-Class: com.enterprise.${svc,,}.${svc}Application" > Manifest.txt
            # Jar ìƒì„± (ì‹¤ì œ í´ë˜ìŠ¤ íŒŒì¼ í¬í•¨)
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
            echo "âœ… Created bin/${svc}App.jar"
        done

    # ----------------------------------------------------------------
    # [Step 6] ê³µì‹ ë°°í¬ ì„œë²„ ê°€ë™ ë° ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [7] Official Server & Download
      shell: bash
      run: |
        echo "ğŸš€ Starting Official Distribution Server..."
        
        # ë°°í¬í•  íŒŒì¼ë“¤ì„ release_rootë¡œ ëª¨ìŒ
        mkdir -p release_root
        cp bin/*.jar release_root/
        cp database_store/*.db release_root/
        
        # í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ í´ë” ìƒì„±
        mkdir -p download_zone
        
        # ì„œë²„ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ (Port 9000)
        cd release_root
        python3 -m http.server 9000 &
        SERVER_PID=$!
        cd ..
        
        echo "â³ Waiting for Server..."
        sleep 3
        
        # ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (Banking App)
        echo "â¬‡ï¸ Downloading BankingApp.jar from Official Server..."
        curl -f http://localhost:9000/BankingApp.jar -o download_zone/downloaded_BankingApp.jar
        
        # ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (Stock DB)
        echo "â¬‡ï¸ Downloading Stock.db from Official Server..."
        curl -f http://localhost:9000/Stock.db -o download_zone/downloaded_Stock.db
        
        # ì„œë²„ ì¢…ë£Œ
        kill $SERVER_PID || true
        
        # ë‹¤ìš´ë¡œë“œ í™•ì¸
        ls -l download_zone/

    # ----------------------------------------------------------------
    # [Step 7] CodeQL v4 ë¶„ì„
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [8] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,python"

    # ----------------------------------------------------------------
    # [Step 8] íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ìµœì¢… í™•ì¸ (ë””ë²„ê¹…)
    # ----------------------------------------------------------------
    - name: ğŸ§ [9] Verify Files Before Upload
      shell: bash
      run: |
        echo "=================================="
        echo "ğŸ“‚ FILE SYSTEM CHECK (DEBUG)"
        echo "=================================="
        echo ">>> Checking 'bin' directory:"
        ls -R bin || echo "bin missing"
        echo ">>> Checking 'database_store' directory:"
        ls -R database_store || echo "db missing"
        echo ">>> Checking 'scripts' directory:"
        ls -R scripts || echo "scripts missing"
        echo ">>> Checking 'download_zone' directory:"
        ls -R download_zone || echo "download missing"
        echo "=================================="

    # ----------------------------------------------------------------
    # [Step 9] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ê²½ë¡œ ëª…í™•í™”)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [10] Upload All Generated Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          bin/*.jar
          database_store/
          scripts/
          src/
          download_zone/
        retention-days: 1
