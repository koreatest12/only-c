name: ğŸ­ MASTER SCM:FULL SYNC & INFRASTRUCTURE

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ í˜•ìƒê´€ë¦¬ ë™ê¸°í™”
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ê¶Œí•œ: ì €ì¥ì†Œ í˜•ìƒê´€ë¦¬ë¥¼ ìœ„í•œ ì „ì²´ ì“°ê¸° ê¶Œí•œ]
permissions:
  contents: write           # ì½”ë“œ ì»¤ë°‹/í‘¸ì‹œ (í•„ìˆ˜)
  packages: write
  deployments: write
  security-events: write
  actions: write
  checks: write
  statuses: write
  issues: write
  pages: write

jobs:
  scm-factory-ops:
    name: ğŸ­ SCM Factory on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-scm-pack
          - os: windows-latest
            artifact_name: windows-scm-pack
          - os: macos-latest
            artifact_name: macos-scm-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] í˜•ìƒê´€ë¦¬ ì´ˆê¸°í™” (Full History Fetch)
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout for SCM
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ Rebase ê°€ëŠ¥
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ìƒì‚° ë„êµ¬ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [2] Setup Environment
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [3] Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4] Install Deps
      shell: bash
      run: |
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "tqdm" >> requirements.txt
        pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 3] CodeQL ë³´ì•ˆ ê°ì‹œ
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [5] CodeQL Init
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python

    # ----------------------------------------------------------------
    # [Step 4] ì´ˆëŒ€í˜• íŒ©í† ë¦¬ ê°€ë™ (ì†ŒìŠ¤ + ì¸í”„ë¼ + DB + ë¬¸ì„œ)
    # ----------------------------------------------------------------
    - name: ğŸ­ [6] Run Universal Factory
      shell: bash
      run: |
        cat <<'EOF' > factory_manager.py
        import os
        import sys
        import random
        import datetime

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys"
        ]

        def safe_makedirs(path):
            if not os.path.exists(path): os.makedirs(path, exist_ok=True)

        def log(msg): print(f"[SCM-FACTORY] {msg}")

        # 1. ì–´í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ ì½”ë“œ (Java)
        def generate_apps():
            log(f"ğŸš€ Generating Source Code for {len(SERVICES)} Services...")
            safe_makedirs("src/main/java/com/global")
            
            for svc in SERVICES:
                base = f"src/main/java/com/global/{svc.lower()}"
                safe_makedirs(base)
                
                # Main
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Active\"); }} }}")
                
                # Controllers & Logic (ëŒ€ëŸ‰ ìƒì„±)
                for i in range(1, 21):
                    with open(f"{base}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.global.{svc.lower()};\npublic class {svc}Controller{i} {{ public String status() {{ return \"OK\"; }} }}")

        # 2. ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ì½”ë“œ (IaC - Terraform, Docker, K8s)
        def generate_infrastructure():
            log("ğŸ—ï¸ Generating Infrastructure as Code (IaC)...")
            safe_makedirs("infra/terraform/modules")
            safe_makedirs("infra/k8s/deployments")
            safe_makedirs("infra/docker")
            safe_makedirs("infra/ansible")

            for svc in SERVICES:
                # Terraform
                with open(f"infra/terraform/modules/{svc}.tf", "w") as f:
                    f.write(f'resource "aws_ecr_repository" "{svc}_repo" {{ name = "{svc.lower()}_service" }}\n')
                
                # Kubernetes
                with open(f"infra/k8s/deployments/{svc}-deploy.yaml", "w") as f:
                    f.write(f"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: {svc.lower()}\nspec:\n  replicas: 3")
                
                # Dockerfile
                with open(f"infra/docker/Dockerfile.{svc}", "w") as f:
                    f.write(f"FROM openjdk:17-slim\nCOPY bin/{svc}App.jar app.jar\nCMD [\"java\", \"-jar\", \"/app.jar\"]")

        # 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë° ë§ˆì´ê·¸ë ˆì´ì…˜
        def generate_db_assets():
            log("ğŸ—ƒï¸ Generating Database Assets...")
            safe_makedirs("database/migrations")
            safe_makedirs("database/seeds")
            
            for svc in SERVICES:
                with open(f"database/migrations/V1__{svc}_init.sql", "w") as f:
                    f.write(f"CREATE TABLE {svc}_table (id INT PRIMARY KEY);")

        # 4. C++ ë³´ì•ˆ ì—”ì§„
        def generate_cpp_core():
            log("ğŸ” Generating C++ Security Core...")
            safe_makedirs("cpp_core")
            with open("cpp_core/security.cpp", "w") as f:
                f.write('#include <iostream>\nint main() { std::cout << "Security Layer Active" << std::endl; return 0; }')

        if __name__ == "__main__":
            generate_apps()
            generate_infrastructure()
            generate_db_assets()
            generate_cpp_core()
            safe_makedirs("bin")
            safe_makedirs("docs")
            log("âœ… All Assets Generated for SCM.")
        EOF
        
        python factory_manager.py

    # ----------------------------------------------------------------
    # [Step 5] ë³´ì•ˆ ì›Œí„°ë§ˆí‚¹ (SCM ì¶”ì  ëŒ€ìƒ)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [7] Apply Watermark
      shell: bash
      run: |
        cat <<'EOF' > watermark.py
        import os
        import datetime
        HEADER = f"// (C) {datetime.datetime.now().year} GLOBAL SCM. MANAGED CODE.\n"
        def inject():
            for root, dirs, files in os.walk("."):
                if any(x in root for x in [".git", "bin"]): continue
                for file in files:
                    if file.endswith(('.java', '.cpp', '.tf', '.yaml', '.sql')):
                        path = os.path.join(root, file)
                        try:
                            with open(path, 'r', encoding='utf-8') as f: content = f.read()
                            if "GLOBAL SCM" not in content:
                                with open(path, 'w', encoding='utf-8') as f:
                                    f.write(HEADER + content)
                        except: pass
        if __name__ == "__main__": inject()
        EOF
        python watermark.py

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ìƒì„±
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [8] Build & Package
      shell: bash
      run: |
        echo "â˜• Compiling Sources..."
        find src -name "*.java" > sources.txt
        javac -nowarn -d bin @sources.txt
        
        echo "ğŸš€ Compiling C++..."
        g++ -o bin/SecurityCore cpp_core/security.cpp
        
        echo "ğŸ“¦ Packaging..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax Logistics HealthCare Metaverse AI_Core IoT_Network Education_Hub Energy_Grid Defense_Sys"
        for svc in $SERVICES; do
            svc_lower=$(echo "$svc" | tr '[:upper:]' '[:lower:]')
            echo "Main-Class: com.global.${svc_lower}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
        done

    # ----------------------------------------------------------------
    # [Step 7] ëŒ€ì‹œë³´ë“œ ë¦¬í¬íŠ¸ ìƒì„±
    # ----------------------------------------------------------------
    - name: ğŸ“Š [9] Generate SCM Dashboard
      shell: bash
      run: |
        FILE_COUNT=$(find src infra database -type f | wc -l | xargs)
        DATE=$(date -u)
        
        cat <<EOF > scm_dashboard.html
        <html><body><h1>SCM Report</h1><p>$DATE</p><h2>Tracked Files: $FILE_COUNT</h2></body></html>
        EOF
        
        echo "## ğŸ­ SCM Status" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
        echo "| **Managed Files** | $FILE_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| **Infrastructure** | Terraform, K8s, Docker |" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------------------
    # [Step 8] í˜•ìƒê´€ë¦¬ ê°•ì œ ë™ê¸°í™” (SCM Sync - Critical Fix)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [10] SCM Sync (Commit & Push)
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ”„ STARTING SCM SYNCHRONIZATION..."
        echo "=========================================="
        
        git config --global user.name "SCM-Bot"
        git config --global user.email "bot@scm.com"
        
        # 1. ëª¨ë“  íŒŒì¼ ê°•ì œ ìŠ¤í…Œì´ì§• (-A: ì‹ ê·œ/ìˆ˜ì •/ì‚­ì œ ëª¨ë‘ í¬í•¨)
        # .gitignoreì— ì˜í•´ ë¬´ì‹œë˜ëŠ” íŒŒì¼ë„ ì¶”ì í•˜ê³  ì‹¶ë‹¤ë©´ -f ì‚¬ìš©, ì—¬ê¸°ì„  ì¼ë°˜ -A ì‚¬ìš©
        git add -A
        
        # 2. ê°•ì œ ìŠ¤í…Œì´ì§• (ì¤‘ìš” ìƒì„± í´ë”)
        git add -f src/ infra/ database/ cpp_core/ factory_manager.py *.html
        
        # 3. ë³€ê²½ ì‚¬í•­ í™•ì¸
        if git diff --staged --quiet; then
            echo "âœ… No changes to commit. SCM is up to date."
        else
            echo "ğŸ“ Committing changes..."
            git commit -m "ğŸ­ SCM Update: Full Stack Sync & IaC [skip ci]"
            
            # 4. [CRITICAL FIX] Rebase & Push Loop with Autostash
            # ë¡œì»¬ì˜ ë³€ê²½ì‚¬í•­(ì»¤ë°‹ë¨)ì„ ìœ ì§€í•˜ë©´ì„œ ì›ê²©ì˜ ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì˜´
            echo "ğŸ”„ Pulling and Rebase..."
            
            MAX_RETRIES=10
            for ((i=1; i<=MAX_RETRIES; i++)); do
                # --rebase --autostash: ë¡œì»¬ ë³€ê²½ì‚¬í•­ ì ì‹œ ë³´ê´€ -> pull -> rebase -> ë³´ê´€ ì ìš©
                if git pull --rebase --autostash origin main; then
                    echo "âœ… Rebase Successful."
                    
                    if git push origin main; then
                        echo "âœ… Push Successful."
                        break
                    else
                        echo "âš ï¸ Push failed (Concurrent update?), retrying ($i/$MAX_RETRIES)..."
                        sleep 5
                    fi
                else
                    echo "âš ï¸ Pull/Rebase failed, retrying ($i/$MAX_RETRIES)..."
                    # Rebase ì‹¤íŒ¨ ì‹œ Abort í›„ ì¬ì‹œë„
                    git rebase --abort || true
                    sleep 5
                fi
            done
        fi

    # ----------------------------------------------------------------
    # [Step 9] CodeQL & Artifacts
    # ----------------------------------------------------------------
    - name: ğŸ” [11] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    - name: ğŸ“¤ [12] Upload SCM Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          scm_dashboard.html
          bin/*.jar
          bin/SecurityCore*
          src/
          infra/
          database/
        retention-days: 1
