name: Grand Unified System (No Skips & Full Execution)

on:
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # GCC ë° MSVC í˜¸í™˜ì„±ì„ ê³ ë ¤í•œ ì„¤ì •
  GCC_FLAGS: "-O3 -Wall -Wextra -std=c++17 -pthread"

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  # ----------------------------------------------------------------
  # JOB 1: í†µí•© ë¹Œë“œ, ë°ì´í„° ìƒì„±, ì´ë¯¸ì§€ ìƒì„± (Windows & Linux ëª¨ë‘ ì‹¤í–‰)
  # ----------------------------------------------------------------
  unified-build:
    name: Full Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. ì•„í‹°íŒ©íŠ¸ ì´ë¦„ ê³ ì • (ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜ ë°©ì§€)
    - name: Set Artifact Name
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          echo "ARTIFACT_NAME=Binary-Linux" >> $GITHUB_ENV
        else
          echo "ARTIFACT_NAME=Binary-Windows" >> $GITHUB_ENV
        fi

    # 2. í†µí•© í™˜ê²½ ì„¤ì • (Linux & Windows ëª¨ë‘ Python/C++ ì¤€ë¹„)
    - name: Setup Full Environment
      run: |
        echo "ğŸ› ï¸ Setting up environment for ${{ matrix.os }}..."
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck tree g++
        else
          echo "ğŸªŸ Windows: Using MSVC/MinGW & Pre-installed Tools"
        fi

    # 3. Python ì„¤ì¹˜ (Windows í¬í•¨ ëª¨ë“  OSì—ì„œ ì´ë¯¸ì§€ ìƒì„± ì‹¤í–‰)
    - name: Setup Python & Libs (No Skip)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'
    - name: Install Python Dependencies
      run: |
        pip install Pillow qrcode
        echo "âœ… Python environment ready on $RUNNER_OS"

    # 4. ì†ŒìŠ¤ì½”ë“œ ìƒì„± (ê°€ìƒê³„ì¢Œ + ê°€ìƒì¹´ë“œ ëŒ€ëŸ‰ ìƒì„± ë¡œì§)
    - name: Generate Source Code
      run: |
        echo "ğŸ“ Generating Enterprise C++ Source..."
        
        # [Makefile]
        cat <<EOF > Makefile
        CXX = g++
        CXXFLAGS = $GCC_FLAGS
        TARGET = server_app_gcc
        SRCS = enterprise_main.cpp
        all: \$(TARGET)
        \$(TARGET): \$(SRCS)
        	\$(CXX) \$(CXXFLAGS) \$(SRCS) -o \$(TARGET)
        clean:
        	rm -f \$(TARGET)
        EOF

        # [CMakeLists.txt]
        cat <<EOF > CMakeLists.txt
        cmake_minimum_required(VERSION 3.10)
        project(UnifiedServer)
        set(CMAKE_CXX_STANDARD 17)
        add_executable(enterprise_main enterprise_main.cpp)
        if(UNIX)
            add_compile_options(-O3 -Wall -Wextra -pthread)
        endif()
        if(WIN32)
            set_target_properties(enterprise_main PROPERTIES OUTPUT_NAME "enterprise_main")
        endif()
        EOF

        # [C++ Source] - ê°€ìƒê³„ì¢Œ(VA) ë° ê°€ìƒì¹´ë“œ(VCC) ë¡œì§
        cat <<EOF > enterprise_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>
        #include <iomanip>
        
        namespace fs = std::filesystem;
        
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        // [ê¸°ëŠ¥ 1] ê°€ìƒê³„ì¢Œ (VA)
        class VirtualAccountManager {
        public:
            static void generateMassiveVirtualAccounts() {
                const int COUNT = 300000;
                std::cout << "ğŸ’³ [VA Service] Generating " << COUNT << " VA records..." << std::endl;
                fs::create_directories("output/data");
                std::ofstream file("output/data/va_dump.csv");
                file << "Bank,AccountNum,Holder,Amount,Status" << std::endl;
                for(int i=0; i < COUNT; ++i) {
                    file << (i%2==0 ? "KB" : "Shinhan") << ","
                         << "562-" << std::setw(6) << std::setfill('0') << i << "," 
                         << "User_" << i << "," << ((i*1000)+5000) << ",WAIT" << std::endl;
                }
                file.close();
            }
        };

        // [ê¸°ëŠ¥ 2] ê°€ìƒì¹´ë“œ (VCC) - ì‹ ê·œ ê¸°ëŠ¥
        class VirtualCardManager {
        public:
            static void generateMassiveCards() {
                const int COUNT = 200000;
                std::cout << "ğŸ’³ [Card Service] Generating " << COUNT << " Virtual Card records..." << std::endl;
                fs::create_directories("output/data");
                std::ofstream file("output/data/card_dump.csv");
                file << "CardBin,Number,CVC,Expiry,Type" << std::endl;
                for(int i=0; i < COUNT; ++i) {
                    file << "4222,"
                         << "4222-" << std::setw(4) << std::setfill('0') << (i%9999) << "-XXXX-XXXX,"
                         << (i%900)+100 << ","
                         << "12/28,"
                         << "VISA_VIRTUAL" << std::endl;
                }
                file.close();
            }
        };

        class BigDataManager {
        public:
            static void generateTransactions() {
                std::ofstream file("output/data/transactions.csv");
                file << "TxID,Time,Amount" << std::endl;
                for(int i=0; i<100000; ++i) file << i << "," << getCurrentTime() << "," << i*100 << std::endl;
                file.close();
            }
        };

        int main(int argc, char* argv[]) {
            if (argc > 1 && std::string(argv[1]) == "--test") return 0;
            std::cout << "ğŸš€ [Unified Server] Starting Full Process..." << std::endl;
            
            VirtualAccountManager::generateMassiveVirtualAccounts();
            VirtualCardManager::generateMassiveCards();
            BigDataManager::generateTransactions();
            
            return 0;
        }
        EOF

    # 5. ì •ì  ë¶„ì„ (LinuxëŠ” Cppcheck / WindowsëŠ” íŒ¨ìŠ¤í•˜ì§€ë§Œ Skip ì—†ì´ ì§„í–‰)
    - name: Static Analysis (Cross-Platform Safe)
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          cppcheck --enable=all --inconclusive --force enterprise_main.cpp || true
        else
          echo "Skipping Cppcheck on Windows (Tool not installed), proceeding..."
        fi

    # 6. ë¹Œë“œ ì‹¤í–‰
    - name: Build Application
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          echo "ğŸ”¨ Make (GCC)..."
          make all
          chmod +x server_app_gcc
        else
          echo "ğŸ”¨ CMake (Windows)..."
          mkdir -p build
          cd build
          cmake ..
          cmake --build . --config Release
        fi

    # 7. ì‹¤í–‰ ë° ë°ì´í„° ìƒì„± (ë°ì´í„° ì´ë™ ë¡œì§ ê°•í™”)
    - name: Run & Generate Data
      run: |
        echo "â–¶ï¸ Running Application..."
        mkdir -p output_data
        
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          ./server_app_gcc
          cp server_app_gcc final_binary
          if [ -d "output" ]; then cp -r output/* output_data/; rm -rf output; fi
        else
          ./build/Release/enterprise_main.exe
          cp build/Release/enterprise_main.exe final_binary.exe
          # Windows ê²½ë¡œ ìœ ì—°ì„± ëŒ€ì‘
          if [ -d "output" ]; then cp -r output/* output_data/; 
          elif [ -d "build/output" ]; then cp -r build/output/* output_data/; fi
        fi

    # 8. [ëŒ€í†µí•©] Python ì´ë¯¸ì§€ ìƒì„± (ê°€ìƒê³„ì¢Œ + ê°€ìƒì¹´ë“œ) - Windows/Linux ëª¨ë‘ ì‹¤í–‰
    - name: Generate Visual Assets (Python)
      run: |
        echo "ğŸ–¼ï¸ Generating Images on $RUNNER_OS..."
        
        cat <<EOF > gen_assets.py
        import csv, os, qrcode
        from PIL import Image, ImageDraw

        OUT_VA = "output_data/data/va_images"
        OUT_CARD = "output_data/data/card_images"
        os.makedirs(OUT_VA, exist_ok=True)
        os.makedirs(OUT_CARD, exist_ok=True)

        # 1. ê°€ìƒê³„ì¢Œ ì´ë¯¸ì§€ (ìƒ˜í”Œ 20ê°œ)
        try:
            with open("output_data/data/va_dump.csv", 'r') as f:
                reader = csv.DictReader(f)
                count = 0
                for row in reader:
                    if count >= 20: break
                    count += 1
                    
                    img = Image.new('RGB', (400, 200), (255, 255, 255))
                    draw = ImageDraw.Draw(img)
                    draw.rectangle([(5,5),(395,195)], outline="black", width=2)
                    draw.text((20,20), f"VA SLIP: {row['Bank']}", fill="blue")
                    draw.text((20,50), f"ACC: {row['AccountNum']}", fill="black")
                    draw.text((20,80), f"AMT: {row['Amount']} KRW", fill="red")
                    
                    qr = qrcode.make(f"{row['Bank']}|{row['AccountNum']}")
                    qr = qr.resize((80,80))
                    img.paste(qr, (300, 20))
                    
                    img.save(f"{OUT_VA}/va_{count}.png")
            print("âœ… VA Images Generated.")
        except Exception as e: print(f"âŒ VA Error: {e}")

        # 2. ê°€ìƒì¹´ë“œ ì´ë¯¸ì§€ (ìƒ˜í”Œ 20ê°œ) - ì‹ ê·œ ì¶”ê°€
        try:
            with open("output_data/data/card_dump.csv", 'r') as f:
                reader = csv.DictReader(f)
                count = 0
                for row in reader:
                    if count >= 20: break
                    count += 1
                    
                    # ì¹´ë“œ í”Œë ˆì´íŠ¸ (ì–´ë‘ìš´ ë°°ê²½)
                    img = Image.new('RGB', (400, 250), (30, 30, 30))
                    draw = ImageDraw.Draw(img)
                    draw.rectangle([(0,0),(400,50)], fill="gold") # ë§ˆê·¸ë„¤í‹± ë ? ì•„ë‹˜ ë””ìì¸
                    draw.text((20, 20), "VIRTUAL CARD", fill="black")
                    draw.text((30, 100), row['Number'], fill="white")
                    draw.text((30, 150), f"Valid Thru: {row['Expiry']}", fill="white")
                    draw.text((320, 200), "VISA", fill="white")
                    
                    img.save(f"{OUT_CARD}/card_{count}.png")
            print("âœ… Card Images Generated.")
        except Exception as e: print(f"âŒ Card Error: {e}")
        EOF
        
        python gen_assets.py

    # 9. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          final_binary*
          output_data/
          enterprise_main.cpp

  # ----------------------------------------------------------------
  # JOB 2: Docker ë¹Œë“œ & ê²Œì‹œ (Linux ê¸°ë°˜ ì‹¤í–‰)
  # ----------------------------------------------------------------
  docker-publish:
    name: Dockerize & Publish
    needs: unified-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Binary-Linux

      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          WORKDIR /app
          COPY final_binary /app/server_app
          COPY output_data /app/data
          RUN chmod +x /app/server_app
          LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}
          CMD ["./server_app"]
          EOF

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest

  # ----------------------------------------------------------------
  # JOB 3: ë¦´ë¦¬ì¦ˆ íŒ¨í‚¤ì§• & ì¶œì‹œ
  # ----------------------------------------------------------------
  release-all:
    name: Final Release
    needs: [unified-build, docker-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download Linux Assets
        uses: actions/download-artifact@v4
        with:
          name: Binary-Linux
          path: linux_pkg
      
      - name: Download Windows Assets
        uses: actions/download-artifact@v4
        with:
          name: Binary-Windows
          path: windows_pkg

      - name: Package Everything
        run: |
          mkdir release_assets
          # Binary Integration
          cp windows_pkg/final_binary.exe release_assets/server_app.exe
          cp linux_pkg/final_binary release_assets/server_app_linux
          
          # Data & Images Integration (Linux ê²°ê³¼ë¬¼ ê¸°ì¤€)
          cp -r linux_pkg/output_data release_assets/assets
          
          cd release_assets
          zip -r ../grand_unified_v${{ github.run_number }}.zip .

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v11.0.${{ github.run_number }}
          name: ğŸš€ Grand Unified v11.0.${{ github.run_number }} (Full Execution)
          body: |
            ## ğŸŒŸ Complete Execution Release
            
            Windowsì™€ Linux í™˜ê²½ ëª¨ë‘ì—ì„œ ë°ì´í„° ìƒì„± ë° ì´ë¯¸ì§€ ë Œë”ë§ì´ **ìŠ¤í‚µ ì—†ì´** ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ğŸ’³ New Features
            - **Virtual Cards:** `card_dump.csv` & Card Images
            - **Virtual Accounts:** `va_dump.csv` & Slip Images
            - **Cross-Platform:** Python Script Executed on Windows Runner
            
            ğŸ‘‰ **https://github.com/koreatest12/only-c**
          files: grand_unified_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
