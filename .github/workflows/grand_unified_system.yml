name: ğŸ›¡ï¸ ENTERPRISE:UPGRADE, DB, CUSTOMER & SECURITY

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# [Global Config] ì¸ì½”ë”© ë° í™˜ê²½ ì„¤ì •
env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8

# CodeQL ê¶Œí•œ ì„¤ì •
permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  enterprise-ops:
    name: ğŸš€ DevOps Pipeline on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-enterprise-pack
          - os: windows-latest
            artifact_name: windows-enterprise-pack
          - os: macos-latest
            artifact_name: macos-enterprise-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì €ì¥ì†Œ ë° ë¦¬ì†ŒìŠ¤ í™•ë³´
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] CodeQL ì´ˆê¸°í™” (ë¹Œë“œ ì „ ë³´ì•ˆ ì—”ì§„ ê°€ë™)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [2] Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp, python
        queries: security-extended, security-and-quality

    # ----------------------------------------------------------------
    # [Step 3] ì‹œìŠ¤í…œ ë° íŒ¨í‚¤ì§€ ì „ì²´ ì—…ê·¸ë ˆì´ë“œ (No Skip)
    # ----------------------------------------------------------------
    - name: ğŸ”„ [3] System & Package Auto-Upgrade
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸš€ STARTING SYSTEM UPGRADE SEQUENCE..."
        echo "=========================================="
        
        if [ "$RUNNER_OS" == "Linux" ]; then
            echo "ğŸ§ Linux: Updating APT Repositories..."
            sudo apt-get update -y
            echo "ğŸ§ Linux: Ensuring latest Build Tools..."
            sudo apt-get install -y --only-upgrade build-essential cmake
            
        elif [ "$RUNNER_OS" == "Windows" ]; then
            echo "ğŸªŸ Windows: Checking specific updates..."
            echo "âœ… Windows Update Agent is managed by GitHub Actions."
            
        elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "ğŸ macOS: Check Environment..."
            echo "âœ… macOS Environment Verified."
        fi
        echo "âœ… System Upgrade Sequence Completed."

    # ----------------------------------------------------------------
    # [Step 4] Python ì„¤ì • (ê³ ê° ë°ì´í„° ì²˜ë¦¬ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ“ [4-Pre] Force Init Requirements
      shell: bash
      run: |
        echo "colorama" > requirements.txt
        echo "pandas" >> requirements.txt
        echo "âœ… requirements.txt initialized with Data Tools."

    - name: ğŸ [4] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ”„ [4-Post] Upgrade Python Dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Python Dependencies Upgraded."

    # ----------------------------------------------------------------
    # [Step 5] í†µí•© ë§¤ë‹ˆì € ìƒì„± (ê³ ê° DB / ë³´ì•ˆ / ë¹Œë“œ í†µí•©)
    # ----------------------------------------------------------------
    - name: ğŸ“ [5] Generate Enterprise Manager (UTF-8 Safe)
      shell: bash
      run: |
        echo "ğŸ”§ Generating upgrade_manager.py with Customer Data modules..."
        cat <<EOF > upgrade_manager.py
        import os
        import sys
        import platform
        import sqlite3
        import time
        import random

        # Windows ì¸ì½”ë”© í¬ë˜ì‹œ ë°©ì§€
        sys.stdout.reconfigure(encoding='utf-8')

        def log(msg):
            print(f"[MANAGER] {msg}")

        def generate_cpp_source():
            log("Generating C++20 Source Code for Enterprise Service...")
            cpp_code = """
        #include <iostream>
        #include <vector>
        #include <string>

        struct Customer {
            int id;
            std::string tier;
        };

        int main() {
            #ifdef _WIN32
            system("chcp 65001 > nul");
            #endif
            
            std::cout << "ğŸš€ ENTERPRISE BUILD SUCCESSFUL!" << std::endl;
            std::cout << "âœ… Security Patch Applied (CodeQL Ready)." << std::endl;
            std::cout << "âœ… Customer Data Integration Module Loaded." << std::endl;
            
            // ë°ì´í„° ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜
            std::vector<Customer> batch;
            for(int i=0; i<100; ++i) {
                batch.push_back({i, "VIP"});
            }
            std::cout << "ğŸ“Š Processed " << batch.size() << " Client Records in Memory." << std::endl;

            return 0;
        }
            """
            
            cmake_code = """
        cmake_minimum_required(VERSION 3.10)
        project(EnterpriseSystem)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            try:
                with open("main.cpp", "w", encoding="utf-8") as f:
                    f.write(cpp_code)
                with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                    f.write(cmake_code)
                log("Source files generated with Customer Logic.")
            except Exception as e:
                print(f"[ERROR] {e}")

        def run_customer_db_migration():
            log("ğŸ”„ STARTING BULK CUSTOMER DATA MIGRATION...")
            db_file = "enterprise_data.db"
            try:
                conn = sqlite3.connect(db_file)
                cursor = conn.cursor()
                
                # 1. ì‹œìŠ¤í…œ ë¡œê·¸ í…Œì´ë¸”
                cursor.execute('''CREATE TABLE IF NOT EXISTS logs
                                 (id INTEGER PRIMARY KEY, msg TEXT, timestamp TEXT)''')
                
                # 2. ê³ ê° ì •ë³´ í…Œì´ë¸” (ì‹ ê·œ ì¶”ê°€)
                cursor.execute('''CREATE TABLE IF NOT EXISTS customers
                                 (id INTEGER PRIMARY KEY, name TEXT, region TEXT, tier TEXT, last_login TEXT)''')
                log("Table 'customers' schema applied.")

                # 3. ëŒ€ëŸ‰ ë°ì´í„° ì‚½ì… ì‹œë®¬ë ˆì´ì…˜ (Batch Insert)
                customers_data = []
                regions = ['KR', 'US', 'JP', 'EU']
                tiers = ['Standard', 'Gold', 'Platinum', 'Enterprise']
                
                for i in range(1, 101): # 100ëª…ì˜ ê³ ê° ë°ì´í„° ìƒì„±
                    r_region = random.choice(regions)
                    r_tier = random.choice(tiers)
                    customers_data.append((f"Client_User_{i}", r_region, r_tier, "2025-12-24"))

                cursor.executemany("INSERT INTO customers (name, region, tier, last_login) VALUES (?, ?, ?, ?)", customers_data)
                conn.commit()
                
                log(f"âœ… Bulk Insert: 100 Customer records added to '{db_file}'.")
                
                # ê²€ì¦ ì¿¼ë¦¬
                cursor.execute("SELECT COUNT(*) FROM customers")
                count = cursor.fetchone()[0]
                log(f"ğŸ“Š Total Active Customers in DB: {count}")
                
                conn.close()
            except Exception as e:
                print(f"[DB ERROR] {e}")

        def run_security_patch():
            log("ğŸ›¡ï¸ STARTING INTERNAL SECURITY AUDIT...")
            time.sleep(1) 
            log("ğŸ” Scanning Source Code Integrity...")
            
            if os.path.exists("main.cpp"):
                log("âœ… main.cpp integrity verified.")
            else:
                log("âš ï¸ main.cpp missing!")
            
            log("ğŸ› ï¸ Applying CodeQL Preparation Patch...")
            log("âœ… All Systems Secure.")

        if __name__ == "__main__":
            log(f"ğŸš€ Detected OS: {platform.system()}")
            generate_cpp_source()
            run_customer_db_migration()
            run_security_patch()
        EOF

    # ----------------------------------------------------------------
    # [Step 6] DB ì—…ë°ì´íŠ¸ & ë³´ì•ˆ íŒ¨ì¹˜ ì‹¤í–‰ (CodeQL ë¶„ì„ ëŒ€ìƒ)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [6] Execute Data & Security Automation
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸš€ EXECUTING ENTERPRISE AUTOMATION..."
        echo "=========================================="
        python upgrade_manager.py
        echo "=========================================="
        echo "âœ… Automation Finished."

    # ----------------------------------------------------------------
    # [Step 7] ë¹Œë“œ í™˜ê²½ í†µí•© ì„¤ì • (No Skip)
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [7] Universal Build Setup
      shell: bash
      run: |
        echo "ğŸ› ï¸ Configuring Environment for $RUNNER_OS..."
        if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get install -y build-essential cmake
        elif [ "$RUNNER_OS" == "Windows" ]; then
            echo "ğŸªŸ Windows MSVC/CMake Pre-loaded."
        elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "ğŸ macOS Clang/CMake Pre-loaded."
        fi

    # ----------------------------------------------------------------
    # [Step 8] CMake ë¹Œë“œ (CodeQLì´ ì´ ê³¼ì •ì„ ê°ì‹œí•¨)
    # ----------------------------------------------------------------
    - name: ğŸ—ï¸ [8] CMake Configure
      shell: bash
      run: cmake -S . -B build

    - name: ğŸ”¨ [9] Build Project (Release)
      shell: bash
      run: cmake --build build --config Release --verbose

    # ----------------------------------------------------------------
    # [Step 9] CodeQL ë¶„ì„ ìˆ˜í–‰ (ë¹Œë“œ í›„ ì‹¤í–‰)
    # ----------------------------------------------------------------
    - name: ğŸ” [10] Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:cpp,python"

    # ----------------------------------------------------------------
    # [Step 10] ì‹¤í–‰ í…ŒìŠ¤íŠ¸
    # ----------------------------------------------------------------
    - name: ğŸ§ª [11] Run & Validate Application
      shell: bash
      run: |
        echo "ğŸš€ Running Enterprise Application..."
        if [ -f "./build/Release/app.exe" ]; then
            ./build/Release/app.exe
        elif [ -f "./build/app" ]; then
            chmod +x ./build/app
            ./build/app
        else
            echo "âš ï¸ Application path divergent. Searching..."
            find build -name "app*"
        fi

    # ----------------------------------------------------------------
    # [Step 11] ëª¨ë“  ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ê³ ê° DB íŒŒì¼ í¬í•¨)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [12] Upload Full Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          *.db
          *.cpp
          *.py
          *.txt
          upgrade_manager.py
        retention-days: 1
