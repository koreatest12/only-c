name: ğŸ­ UNIVERSAL FACTORY:ZERO-DEFECT PRODUCTION

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ë¬´ì¡°ê±´ ìƒì‚° ê°€ë™
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ê¶Œí•œ: ì „ì§€ì „ëŠ¥ (All-Powerful Permissions)]
permissions:
  contents: write           # ì†ŒìŠ¤ ë° ì•„í‹°íŒ©íŠ¸ ì €ì¥
  packages: write           # íŒ¨í‚¤ì§€ ë°°í¬
  deployments: write        # ë°°í¬ ê´€ë¦¬
  security-events: write    # ë³´ì•ˆ ë¦¬í¬íŒ…
  actions: write            # ì›Œí¬í”Œë¡œìš° ì œì–´
  checks: write             # ì²´í¬ ìƒíƒœ ê´€ë¦¬
  statuses: write           # ì»¤ë°‹ ìƒíƒœ ê´€ë¦¬
  issues: write             # ì´ìŠˆ ê´€ë¦¬
  pages: write              # í˜ì´ì§€ ë°°í¬

jobs:
  precision-production:
    name: ğŸ­ Precision Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-factory-pack
          - os: windows-latest
            artifact_name: windows-factory-pack
          - os: macos-latest
            artifact_name: macos-factory-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ê³µì¥ ì´ˆê¸°í™” (Checkout)
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Initialize Factory Floor
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ìƒì‚° ë„êµ¬ ì„¸íŒ… (Java 17, Python 3.10)
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [2] Setup Production Tools
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [3] Setup Scripting Engine
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4] Install Logistics Libraries
      shell: bash
      run: |
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "tqdm" >> requirements.txt
        echo "jinja2" >> requirements.txt
        pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 3] CodeQL í’ˆì§ˆ/ë³´ì•ˆ ê²€ì‚¬ê¸° ê°€ë™
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [5] Activate CodeQL Scanner
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python
        # Auto-detect mode activated

    # ----------------------------------------------------------------
    # [Step 4] [CORE] ì •ë°€ ì–´í”Œë¦¬ì¼€ì´ì…˜ ìƒì‚° (15 Service Generator)
    # ----------------------------------------------------------------
    - name: ğŸ­ [6] Run Precision Generator
      shell: bash
      run: |
        cat <<'EOF' > factory_manager.py
        import os
        import sys
        import random
        import datetime

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys"
        ]

        def safe_makedirs(path):
            if not os.path.exists(path): os.makedirs(path, exist_ok=True)

        def log(msg): print(f"[FACTORY] {msg}")

        # 1. ì†ŒìŠ¤ ì½”ë“œ ìƒì‚°
        def produce_source_code():
            log(f"ğŸš€ Manufacturing {len(SERVICES)} Services...")
            safe_makedirs("src/main/java/com/global")
            safe_makedirs("src/main/resources/config")
            
            for svc in SERVICES:
                base = f"src/main/java/com/global/{svc.lower()}"
                safe_makedirs(base)
                
                # Main App
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Online\"); }} }}")
                
                # Controllers & Configs
                for i in range(1, 11):
                    with open(f"{base}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.global.{svc.lower()};\npublic class {svc}Controller{i} {{ }}")
                
                # Config XML (ì•”í˜¸í™” ëŒ€ìƒ)
                with open(f"src/main/resources/config/{svc}_config.xml", "w") as f:
                    f.write(f"<config><service>{svc}</service><secret>KEY_{random.randint(1000,9999)}</secret></config>")

        # 2. C++ ì•”í˜¸í™” ì—”ì§„ (CryptoCore)
        def produce_crypto_engine():
            log("ğŸ” Forging C++ Crypto Engine...")
            safe_makedirs("cpp_core")
            # [FIX] í—¤ë” íŒŒì¼ ì£¼ì„ ì²˜ë¦¬ ë°©ì§€ë¥¼ ìœ„í•´ ëª…í™•í•œ ì¤„ë°”ê¿ˆ ì‚¬ìš©
            with open("cpp_core/crypto_core.cpp", "w") as f:
                f.write('#include <iostream>\n')
                f.write('#include <fstream>\n')
                f.write('#include <string>\n')
                f.write('void encrypt(std::string path) { std::ofstream o(path + ".enc"); o << "ENCRYPTED"; o.close(); }\n')
                f.write('int main(int c, char* v[]) { if(c>1) encrypt(v[1]); return 0; }')

        if __name__ == "__main__":
            produce_source_code()
            produce_crypto_engine()
            safe_makedirs("bin")
            safe_makedirs("release_pkg")
            safe_makedirs("logs")
            log("âœ… Production Ready.")
        EOF
        python factory_manager.py

    # ----------------------------------------------------------------
    # [Step 5] ë³´ì•ˆ ì›Œí„°ë§ˆí¬ ì£¼ì… (ì•ˆì „ ëª¨ë“œ)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [7] Apply Safety Watermarks
      shell: bash
      run: |
        cat <<'EOF' > security_injector.py
        import os
        import datetime

        # [CRITICAL FIX] ì¤„ë°”ê¿ˆ(\n)ì„ ëª…ì‹œí•˜ì—¬ C++ í—¤ë”ê°€ ì£¼ì„ì— ë¨¹íˆì§€ ì•Šë„ë¡ í•¨
        HEADER = f"// (C) {datetime.datetime.now().year} GLOBAL FACTORY. SECURE CODE.\n"

        def inject():
            print("[SEC] Injecting Watermarks...")
            for root, dirs, files in os.walk("."):
                if any(x in root for x in ["bin", ".git", "release_pkg"]): continue
                for file in files:
                    if file.endswith(('.java', '.cpp', '.xml')):
                        path = os.path.join(root, file)
                        try:
                            with open(path, 'r', encoding='utf-8') as f: content = f.read()
                            if "GLOBAL FACTORY" not in content:
                                with open(path, 'w', encoding='utf-8') as f:
                                    # í—¤ë” + ì¤„ë°”ê¿ˆ + ë‚´ìš©
                                    f.write(HEADER + content)
                        except: pass
        if __name__ == "__main__": inject()
        EOF
        python security_injector.py

    # ----------------------------------------------------------------
    # [Step 6] ì •ë°€ ë¹Œë“œ ë° ì•”í˜¸í™” íŒ¨í‚¤ì§•
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [8] Execute Factory Build
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ STARTING PRODUCTION LINE..."
        echo "=========================================="
        
        # 1. CryptoCore ì»´íŒŒì¼
        echo "ğŸ” Compiling CryptoCore..."
        if [[ "$RUNNER_OS" == "Windows" ]]; then
            g++ -o bin/CryptoCore.exe cpp_core/crypto_core.cpp
            CRYPTO_CMD="bin/CryptoCore.exe"
        else
            g++ -o bin/CryptoCore cpp_core/crypto_core.cpp
            CRYPTO_CMD="./bin/CryptoCore"
        fi
        
        # 2. Java ì„œë¹„ìŠ¤ ì»´íŒŒì¼
        echo "â˜• Compiling 15+ Services..."
        find src -name "*.java" > sources.txt
        javac -nowarn -d bin @sources.txt
        
        # 3. íŒ¨í‚¤ì§• ë° ì•”í˜¸í™”
        echo "ğŸ“¦ Packaging & Encrypting..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax Logistics HealthCare Metaverse AI_Core IoT_Network Education_Hub Energy_Grid Defense_Sys"
        
        for svc in $SERVICES; do
            # Mac í˜¸í™˜ ì†Œë¬¸ì ë³€í™˜
            svc_lower=$(echo "$svc" | tr '[:upper:]' '[:lower:]')
            
            # JAR ìƒì„±
            echo "Main-Class: com.global.${svc_lower}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
            
            # Config ì•”í˜¸í™” ì‹¤í–‰
            if [ -f "src/main/resources/config/${svc}_config.xml" ]; then
                cp "src/main/resources/config/${svc}_config.xml" "bin/${svc}_config.xml"
                $CRYPTO_CMD "bin/${svc}_config.xml"
            fi
            
            # ë¦´ë¦¬ì¦ˆ í´ë”ë¡œ ì´ë™
            mkdir -p release_pkg/${svc}_v1.0
            cp bin/${svc}App.jar release_pkg/${svc}_v1.0/
            cp bin/${svc}_config.xml.enc release_pkg/${svc}_v1.0/ 2>/dev/null || true
        done
        echo "âœ… Factory Build Completed."

    # ----------------------------------------------------------------
    # [Step 7] ì„œë²„ ë°°í¬ ì‹œë®¬ë ˆì´ì…˜ ë° ê²€ì¦
    # ----------------------------------------------------------------
    - name: ğŸŒ [9] Deploy & Verify
      shell: bash
      run: |
        # ë°°í¬ í´ë” ì¤€ë¹„
        mkdir -p deploy_root
        cp -r release_pkg/* deploy_root/
        
        # ì„œë²„ ìŠ¤í¬ë¦½íŠ¸
        cat <<'EOF' > deploy_monitor.py
        import http.server
        import socketserver
        import threading
        import time
        import os
        
        os.chdir("deploy_root")
        
        def start_server(port):
            try:
                with socketserver.TCPServer(("", port), http.server.SimpleHTTPRequestHandler) as httpd:
                    httpd.serve_forever()
            except: pass

        # 16ê°œ í¬íŠ¸ (8000~8015)
        for p in range(8000, 8016):
            t = threading.Thread(target=start_server, args=(p,))
            t.daemon = True
            t.start()
            time.sleep(0.05)
        
        time.sleep(30)
        EOF
        
        python deploy_monitor.py &
        SERVER_PID=$!
        sleep 5
        
        # ê²€ì¦ (curl)
        echo "ğŸ”„ Verifying Network..."
        function check_url() {
            url=$1
            for i in {1..5}; do
                if curl -s -f "$url" -o /dev/null; then echo "âœ… OK: $url"; return 0; fi
                sleep 2
            done
            echo "âŒ Failed: $url"
            return 1
        }
        
        # Banking (8000), AI (8010) ê²€ì¦
        check_url "http://localhost:8000/Banking_v1.0/BankingApp.jar" || exit 1
        check_url "http://localhost:8010/AI_Core_v1.0/AI_CoreApp.jar" || exit 1
        
        kill $SERVER_PID || true

    # ----------------------------------------------------------------
    # [Step 8] ëŒ€ì‹œë³´ë“œ ìƒì„± (Bash Syntax Fix: ê³µë°± ì œê±° ë° xargs ì‚¬ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ“Š [10] Generate Precision Dashboard
      shell: bash
      run: |
        # [CRITICAL FIX] ë³€ìˆ˜ í• ë‹¹ ì‹œ ê³µë°± ì œê±° ë° xargsë¡œ trim ì²˜ë¦¬
        # find ëª…ë ¹ì–´ë¡œ íŒŒì¼ ê°œìˆ˜ ì¹´ìš´íŠ¸. ì—†ìœ¼ë©´ 0 ë°˜í™˜
        JAR_COUNT=$(find release_pkg -name "*.jar" | wc -l | xargs)
        ENC_COUNT=$(find release_pkg -name "*.enc" | wc -l | xargs)
        
        # ìˆ«ìë§Œ ìˆëŠ”ì§€ í™•ì¸ (ë””ë²„ê¹…)
        echo "Debug: JAR_COUNT=[$JAR_COUNT], ENC_COUNT=[$ENC_COUNT]"
        
        DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
        
        # HTML ëŒ€ì‹œë³´ë“œ ì‘ì„±
        cat <<EOF > global_dashboard.html
        <!DOCTYPE html>
        <html>
        <head>
            <title>Global Factory Dashboard</title>
            <style>
                body { font-family: sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
                .metric { background: #1e1e1e; padding: 20px; margin: 10px; display: inline-block; border-radius: 8px; width: 200px; text-align: center; }
                .val { font-size: 2.5em; font-weight: bold; color: #bb86fc; }
                .lbl { color: #b0bec5; }
            </style>
        </head>
        <body>
            <h1>ğŸ­ Factory Output Report</h1>
            <p>Generated at: $DATE ($RUNNER_OS)</p>
            <div>
                <div class="metric"><div class="val">$JAR_COUNT</div><div class="lbl">Apps Built</div></div>
                <div class="metric"><div class="val">$ENC_COUNT</div><div class="lbl">Encrypted Files</div></div>
                <div class="metric"><div class="val">16</div><div class="lbl">Server Nodes</div></div>
            </div>
            <h3>ğŸ“‹ Status: ALL SYSTEMS OPERATIONAL</h3>
        </body>
        </html>
        EOF
        
        # GitHub Step Summary ì¶œë ¥
        echo "## ğŸ­ Factory Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
        echo "| **Applications** | $JAR_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| **Encrypted** | $ENC_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| **Network** | âœ… Verified |" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------------------
    # [Step 9] ê°•ì œ í‘¸ì‹œ (ëª¨ë“  ì‚°ì¶œë¬¼ ì €ì¥ì†Œ ë°˜ì˜)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [11] Force Push Assets
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        git config --global user.name "Factory-Bot"
        git config --global user.email "bot@factory.com"
        
        # [FIX] ëª¨ë“  ê²½ë¡œ ê°•ì œ ì¶”ê°€ (-f)
        git add -f src/ cpp_core/ release_pkg/ global_dashboard.html factory_manager.py *.py
        
        if git diff --staged --quiet; then
            echo "âœ… No changes."
        else
            git commit -m "ğŸ­ Factory Update: Full Sync [skip ci]"
            # ì¶©ëŒ ë°©ì§€ ì¬ì‹œë„ ë£¨í”„
            for i in {1..5}; do
                git pull --rebase && git push && break || sleep 5
            done
        fi

    # ----------------------------------------------------------------
    # [Step 10] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [12] Upload All Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          global_dashboard.html
          release_pkg/
          bin/CryptoCore*
          src/
          logs/
        retention-days: 1
