name: ğŸ’ ULTRA:REPO UPLOAD & PERMISSIONS

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ì¤‘ìš”] ê¶Œí•œ ëŒ€ëŸ‰ ë°˜ì˜ (Massive Permissions Reflection)
permissions:
  contents: write           # ì†ŒìŠ¤ ì½”ë“œ ì—…ë¡œë“œ(Git Push) í•„ìˆ˜ ê¶Œí•œ
  packages: write           # íŒ¨í‚¤ì§€ ë°°í¬ ê¶Œí•œ
  deployments: write        # ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ê¶Œí•œ
  security-events: write    # CodeQL ë³´ì•ˆ ë¦¬í¬íŠ¸ ì‘ì„± ê¶Œí•œ
  actions: write            # ì•¡ì…˜ ìƒíƒœ ê´€ë¦¬ ê¶Œí•œ
  checks: write             # ì²´í¬ ëŸ° ê´€ë¦¬ ê¶Œí•œ
  statuses: write           # ì»¤ë°‹ ìƒíƒœ ê´€ë¦¬ ê¶Œí•œ

jobs:
  repo-upload-ops:
    name: ğŸš€ Repo Upload Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-repo-pack
          - os: windows-latest
            artifact_name: windows-repo-pack
          - os: macos-latest
            artifact_name: macos-repo-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì²´í¬ì•„ì›ƒ (GitHub Token ì‚¬ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }} # ì“°ê¸° ê¶Œí•œì´ ìˆëŠ” í† í° ì‚¬ìš©

    # ----------------------------------------------------------------
    # [Step 2] ì˜ì¡´ì„± íŒŒì¼ ì„ í–‰ ìƒì„± (ì—ëŸ¬ ë°©ì§€ í•„ìˆ˜)
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Pre-Create Requirements
      shell: bash
      run: |
        echo "Creating requirements.txt for Setup-Python..."
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "tqdm" >> requirements.txt

    # ----------------------------------------------------------------
    # [Step 3] í™˜ê²½ ì„¤ì • (Java 17, Python 3.10)
    # ----------------------------------------------------------------
    - name: â˜• [3] Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [4] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4-Post] Install Dependencies
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] CodeQL ì´ˆê¸°í™”
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [5] Initialize CodeQL v4
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python
        build-mode: manual

    # ----------------------------------------------------------------
    # [Step 5] ì´ˆëŒ€í˜• ìƒì„±ê¸° (7ëŒ€ ì„œë¹„ìŠ¤ + íŒŒì¼ êµ¬ì¡°í™”)
    # ----------------------------------------------------------------
    - name: ğŸ­ [6] Run Universe Generator
      shell: bash
      run: |
        cat <<EOF > universe_generator.py
        import os
        import sys
        import sqlite3
        import random

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = ["Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax"]
        
        def safe_makedirs(path):
            if not os.path.exists(path):
                os.makedirs(path, exist_ok=True)

        def log(msg):
            print(f"[GEN] {msg}")

        # 1. Java ì†ŒìŠ¤ (ì„œë¹„ìŠ¤ë‹¹ 30ê°œ í´ë˜ìŠ¤)
        def generate_java():
            log("â˜• Generating Java Sources for Repository Upload...")
            safe_makedirs("src/main/java/com/enterprise")
            
            for svc in SERVICES:
                base = f"src/main/java/com/enterprise/{svc.lower()}"
                safe_makedirs(base)
                
                # Main App
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} System Online\"); }} }}")
                
                # Controllers
                for i in range(1, 31):
                    with open(f"{base}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Controller{i} {{ }}")

        # 2. SQL ë°ì´í„° ìŠ¤í‚¤ë§ˆ
        def generate_sql():
            log("ğŸ—ƒï¸ Generating SQL Schemas...")
            safe_makedirs("database_store")
            for svc in SERVICES:
                with open(f"database_store/{svc}_init.sql", "w") as f:
                    f.write(f"-- Auto-generated Schema for {svc}\\nCREATE TABLE {svc}_table (id INT);\\n")

        # 3. ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸
        def generate_scripts():
            log("ğŸ“œ Generating Ops Scripts...")
            safe_makedirs("ops_scripts")
            for svc in SERVICES:
                with open(f"ops_scripts/deploy_{svc}.sh", "w") as f:
                    f.write(f"#!/bin/bash\\necho Deploying {svc}...")

        # 4. C++ ì—”ì§„
        def generate_cpp():
            log("ğŸš€ Generating C++ Engine...")
            safe_makedirs("cpp_core")
            with open("cpp_core/core_engine.cpp", "w") as f:
                f.write('#include <iostream>\\nint main() { return 0; }')

        if __name__ == "__main__":
            generate_java()
            generate_sql()
            generate_scripts()
            generate_cpp()
            safe_makedirs("bin")
            log("âœ… Files Ready for Git Push.")
        EOF
        
        python universe_generator.py

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ (Java & C++)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [7] Build Ecosystem
      shell: bash
      run: |
        echo "ğŸ—ï¸ Compiling Sources..."
        find src -name "*.java" > sources.txt
        javac -d bin @sources.txt
        
        echo "ğŸ“¦ Packaging JARs..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax"
        for svc in $SERVICES; do
            echo "Main-Class: com.enterprise.${svc,,}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
        done
        
        echo "ğŸš€ Compiling C++..."
        g++ -o bin/CoreEngine cpp_core/core_engine.cpp

    # ----------------------------------------------------------------
    # [Step 7] [NEW] GitHub ì €ì¥ì†Œë¡œ ìë™ ì—…ë¡œë“œ (Git Push)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [8] Deploy to Repository (Auto-Upload)
      if: runner.os == 'Linux' && github.event_name != 'pull_request' # ë¦¬ëˆ…ìŠ¤ì—ì„œë§Œ, PRì´ ì•„ë‹ ë•Œ ì‹¤í–‰
      shell: bash
      run: |
        echo "========================================"
        echo "ğŸš€ UPLOADING GENERATED FILES TO REPO..."
        echo "========================================"
        
        # Git ì„¤ì •
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # ìƒì„±ëœ í´ë”ë“¤ ì¶”ê°€ (ë°”ì´ë„ˆë¦¬ ì œì™¸, ì†ŒìŠ¤ì½”ë“œ ìœ„ì£¼)
        git add src/ cpp_core/ ops_scripts/ database_store/*.sql universe_generator.py requirements.txt
        
        # ë³€ê²½ ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        if git diff --staged --quiet; then
            echo "âœ… No changes to commit."
        else
            echo "ğŸ“ Committing changes..."
            # [skip ci]ë¥¼ ì¶”ê°€í•˜ì—¬ ë¬´í•œ ë¹Œë“œ ë£¨í”„ ë°©ì§€
            git commit -m "ğŸš€ Auto-Deploy: Enterprise 7-Service Source Code [skip ci]"
            
            echo "ğŸ“¤ Pushing to repository..."
            git push
            echo "âœ… Upload Complete: https://github.com/${{ github.repository }}"
        fi

    # ----------------------------------------------------------------
    # [Step 8] ê³µì‹ ì„œë²„ ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [9] Official Download Verification
      shell: bash
      run: |
        echo "ğŸŒ Launching Verification Server..."
        mkdir -p dist
        cp bin/*.jar dist/
        mkdir -p downloads
        
        cd dist
        python3 -m http.server 8000 &
        PID=$!
        cd ..
        
        sleep 5
        echo "â¬‡ï¸ Downloading BankingApp.jar..."
        curl -f http://localhost:8000/BankingApp.jar -o downloads/BankingApp.jar
        
        kill $PID || true
        
        if [ -f "downloads/BankingApp.jar" ]; then
            echo "âœ… Download Success."
        else
            echo "âŒ Download Failed."
            exit 1
        fi

    # ----------------------------------------------------------------
    # [Step 9] Summary Report (í™”ë©´ ì¶œë ¥)
    # ----------------------------------------------------------------
    - name: ğŸ“Š [10] Update Summary
      run: |
        echo "### ğŸš€ Deployment & Upload Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Repo Upload:** âœ… Completed (Source Codes Pushed to \`src/\`)" >> $GITHUB_STEP_SUMMARY
        echo "- **Permissions:** âœ… Write Access Granted (Mass Reflection)" >> $GITHUB_STEP_SUMMARY
        echo "- **Services:** 7 (Banking, Stock, Insurance, Public, Crypto, RealEstate, GovTax)" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------------------
    # [Step 10] CodeQL ë¶„ì„
    # ----------------------------------------------------------------
    - name: ğŸ” [11] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 11] Artifacts Upload
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [12] Upload Build Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          bin/*.jar
          bin/CoreEngine*
          downloads/
        retention-days: 1
