name: ğŸ’ GRAND UNIFIED:JAVA, DB, MAKE & DEPLOY

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_ROOT_USER_ACTION: ignore

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  grand-ops:
    name: ğŸš€ Grand Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-grand-package
          - os: windows-latest
            artifact_name: windows-grand-package
          - os: macos-latest
            artifact_name: macos-grand-package

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì²´í¬ì•„ì›ƒ ë° í™˜ê²½ ì¤€ë¹„
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] Java JDK 17 ì„¤ì • (ì—”í„°í”„ë¼ì´ì¦ˆ ì•±ìš©)
    # ----------------------------------------------------------------
    - name: â˜• [2] Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # ----------------------------------------------------------------
    # [Step 3] Python ì„¤ì • ë° ì˜ì¡´ì„± í•´ê²°
    # ----------------------------------------------------------------
    - name: ğŸ“ [3] Init Dependencies
      shell: bash
      run: |
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "âœ… Dependencies ready."

    - name: ğŸ [4] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4-Post] Install Python Libs
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] CodeQL v4 (Java, C++, Python ë³´ì•ˆ ìŠ¤ìº”)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [5] Initialize CodeQL v4
      uses: github/codeql-action/init@v4
      with:
        languages: cpp, python, java
        queries: security-extended, security-and-quality

    # ----------------------------------------------------------------
    # [Step 5] ëŒ€ëŸ‰ ìƒì„±ê¸° (Java, SQL, DB, Make) ì‹¤í–‰
    # ----------------------------------------------------------------
    - name: ğŸ­ [6] Run Grand Generator
      shell: bash
      run: |
        cat <<EOF > grand_generator.py
        import os
        import sys
        import sqlite3
        import random
        import time

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = ["Banking", "Stock", "Insurance", "PublicData"]
        SRC_DIR = "src"

        def log(msg):
            print(f"[GRAND-GEN] {msg}")

        def create_dir(path):
            if not os.path.exists(path):
                os.makedirs(path)

        # 1. Java ì–´í”Œë¦¬ì¼€ì´ì…˜ ëŒ€ëŸ‰ ìƒì„±
        def generate_java_app():
            log("â˜• Generating Massive Java Spring Boot Structure...")
            
            for svc in SERVICES:
                package_path = f"{SRC_DIR}/main/java/com/enterprise/{svc.lower()}"
                create_dir(package_path)
                
                # ë©”ì¸ í´ë˜ìŠ¤
                with open(f"{package_path}/{svc}Application.java", "w") as f:
                    f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Started\"); }} }}")
                
                # ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤, ëª¨ë¸ ëŒ€ëŸ‰ ìƒì„± (ê° 50ê°œì”©)
                for i in range(1, 21): 
                    # Model
                    with open(f"{package_path}/Model{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class Model{i} {{ private int id; private String data; }}")
                    # Service
                    with open(f"{package_path}/Service{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class Service{i} {{ public void process() {{ }} }}")
                    # Controller
                    with open(f"{package_path}/Controller{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class Controller{i} {{ }}")
            
            log(f"âœ… Generated 200+ Java Files.")

        # 2. SQL ë° DB ëŒ€ëŸ‰ ìƒì„±
        def generate_db_sql():
            log("ğŸ—ƒï¸ Generating SQL Dumps & SQLite DBs...")
            create_dir("database_store")
            
            for svc in SERVICES:
                # SQL íŒŒì¼ ìƒì„±
                sql_content = f"-- Migration for {svc}\nCREATE TABLE {svc}_users (id INT, name VARCHAR(100));\n"
                for i in range(100):
                    sql_content += f"INSERT INTO {svc}_users VALUES ({i}, 'User_{i}');\n"
                
                with open(f"database_store/{svc}_schema.sql", "w") as f:
                    f.write(sql_content)
                
                # SQLite DB ìƒì„±
                conn = sqlite3.connect(f"database_store/{svc}.db")
                cur = conn.cursor()
                cur.execute(f"CREATE TABLE IF NOT EXISTS {svc}_log (id INTEGER, msg TEXT)")
                # ëŒ€ëŸ‰ ë°ì´í„°
                data = [(i, f"Log entry {i} for {svc}") for i in range(500)]
                cur.executemany(f"INSERT INTO {svc}_log VALUES (?, ?)", data)
                conn.commit()
                conn.close()
            
            log("âœ… Generated SQL scripts and DB binaries.")

        # 3. C++ ê³ ì„±ëŠ¥ ì—”ì§„ ìƒì„±
        def generate_cpp_engine():
            log("ğŸš€ Generating C++ Calculation Engine...")
            create_dir("cpp_core")
            cpp_code = """
        #include <iostream>
        #include <vector>
        int main() { 
            std::cout << "High Performance Engine Loaded." << std::endl; 
            return 0; 
        }
            """
            with open("cpp_core/main.cpp", "w") as f: f.write(cpp_code)

        # 4. Make ë¹Œë“œ ì‹œìŠ¤í…œ ìƒì„± (Makefile)
        def generate_makefile():
            log("ğŸ”¨ Generating Makefile for Build Automation...")
            makefile_content = """
        all: java_build cpp_build

        java_build:
        \t@echo "Compiling Java Sources..."
        \tfind src -name "*.java" > sources.txt
        \tjavac -d bin @sources.txt || echo "Java Compile Simulation OK"
        \t@echo "âœ… Java Build Complete."

        cpp_build:
        \t@echo "Compiling C++ Core..."
        \tg++ -o bin/core_engine cpp_core/main.cpp || echo "C++ Compile Simulation OK"
        \t@echo "âœ… C++ Build Complete."
            """
            # Windows í˜¸í™˜ì„±ì„ ìœ„í•´ íƒ­ ë¬¸ì ì²˜ë¦¬ ì£¼ì˜ í•„ìš”í•˜ì§€ë§Œ CIí™˜ê²½ì—ì„  ì‰˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ëŒ€ì²´ ê°€ëŠ¥
            # ì—¬ê¸°ì„œëŠ” íŒŒì¼ë§Œ ìƒì„±í•´ë‘ 
            with open("Makefile", "w") as f:
                f.write(makefile_content)

        if __name__ == "__main__":
            create_dir("bin")
            generate_java_app()
            generate_db_sql()
            generate_cpp_engine()
            generate_makefile()
        EOF
        
        # ìƒì„±ê¸° ì‹¤í–‰
        python grand_generator.py

    # ----------------------------------------------------------------
    # [Step 6] Make ë¹Œë“œ (ì „ì²´ ì„œë¹„ìŠ¤ ì»´íŒŒì¼)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [7] Execute Make Build System
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ STARTING MASSIVE BUILD PROCESS"
        echo "=========================================="
        
        mkdir -p bin
        
        # Java ì»´íŒŒì¼ (ëŒ€ëŸ‰ íŒŒì¼)
        echo "â˜• Compiling Java Sources (Banking, Stock, Insurance)..."
        find src -name "*.java" > sources.txt
        javac -d bin @sources.txt
        
        # Java Jar íŒ¨í‚¤ì§• ì‹œë®¬ë ˆì´ì…˜
        echo "ğŸ“¦ Packaging JAR files..."
        jar cf bin/EnterpriseApp.jar -C bin .
        
        # C++ ì»´íŒŒì¼
        echo "ğŸš€ Compiling C++ Core..."
        g++ -o bin/CoreEngine cpp_core/main.cpp
        
        echo "âœ… Build Process Finished."

    # ----------------------------------------------------------------
    # [Step 7] ì„œë²„ ë°°í¬ ë° ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
    # ----------------------------------------------------------------
    - name: ğŸŒ [8] Server Deploy & Download Check
      shell: bash
      run: |
        mkdir -p release_server
        cp bin/EnterpriseApp.jar release_server/
        cp bin/CoreEngine* release_server/
        cp database_store/*.db release_server/
        
        # ì„œë²„ ê°€ë™ (ë°±ê·¸ë¼ìš´ë“œ)
        cd release_server
        python3 -m http.server 9999 &
        SERVER_PID=$!
        cd ..
        
        sleep 3
        echo "â¬‡ï¸ Testing Official Download..."
        curl -f http://localhost:9999/EnterpriseApp.jar -o downloaded_app.jar
        
        kill $SERVER_PID || true
        echo "âœ… Deployment Verified."

    # ----------------------------------------------------------------
    # [Step 8] CodeQL v4 ë¶„ì„ ìˆ˜í–‰
    # ----------------------------------------------------------------
    - name: ğŸ” [9] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 9] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (í™”ë©´ì— ë³´ì´ë„ë¡ ì„¤ì •)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [10] Upload ALL Artifacts (Display on Screen)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          bin/                  # ì»´íŒŒì¼ëœ ì‹¤í–‰ íŒŒì¼ë“¤
          database_store/       # ìƒì„±ëœ SQL ë° DB íŒŒì¼
          src/                  # ìƒì„±ëœ Java ì†ŒìŠ¤ ì½”ë“œ
          downloaded_app.jar    # ì„œë²„ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼
        retention-days: 1
