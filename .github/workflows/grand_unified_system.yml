name: Grand Unified System (Virtual Account & Mass Data)

on:
  push:
    branches: [ "main", "master" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GCC_FLAGS: "-O3 -Wall -Wextra -std=c++17 -pthread"

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  # ----------------------------------------------------------------
  # JOB 1: í†µí•© ë¹Œë“œ & ê°€ìƒê³„ì¢Œ ëŒ€ëŸ‰ ìƒì„± (Windows/Linux)
  # ----------------------------------------------------------------
  unified-build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ì•„í‹°íŒ©íŠ¸ ì´ë¦„ ê³ ì • (ì—ëŸ¬ ë°©ì§€ìš©)
    - name: Set Artifact Name
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          echo "ARTIFACT_NAME=Binary-Linux" >> $GITHUB_ENV
        else
          echo "ARTIFACT_NAME=Binary-Windows" >> $GITHUB_ENV
        fi

    - name: Setup Environment
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck tree g++
        fi

    # ì†ŒìŠ¤ì½”ë“œ ìƒì„± (ê°€ìƒê³„ì¢Œ ë¡œì§ ì¶”ê°€ë¨)
    - name: Generate Source Files
      run: |
        echo "ğŸ“ Generating Source Code with Virtual Account Logic..."
        
        # [Makefile]
        cat <<EOF > Makefile
        CXX = g++
        CXXFLAGS = $GCC_FLAGS
        TARGET = server_app_gcc
        SRCS = enterprise_main.cpp
        all: \$(TARGET)
        \$(TARGET): \$(SRCS)
        	\$(CXX) \$(CXXFLAGS) \$(SRCS) -o \$(TARGET)
        clean:
        	rm -f \$(TARGET)
        EOF

        # [CMakeLists.txt]
        cat <<EOF > CMakeLists.txt
        cmake_minimum_required(VERSION 3.10)
        project(UnifiedServer)
        set(CMAKE_CXX_STANDARD 17)
        add_executable(enterprise_main enterprise_main.cpp)
        if(UNIX)
            add_compile_options(-O3 -Wall -Wextra -pthread)
        endif()
        if(WIN32)
            set_target_properties(enterprise_main PROPERTIES OUTPUT_NAME "enterprise_main")
        endif()
        EOF

        # [C++ Source] - ê°€ìƒê³„ì¢Œ ëŒ€ëŸ‰ ìƒì„± í´ë˜ìŠ¤ ì¶”ê°€
        cat <<EOF > enterprise_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>
        #include <iomanip>
        
        namespace fs = std::filesystem;
        
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        // [ì‹ ê·œ ê¸°ëŠ¥] ê°€ìƒê³„ì¢Œ ê´€ë¦¬ì
        class VirtualAccountManager {
        public:
            static void generateMassiveVirtualAccounts() {
                const int COUNT = 500000; // 50ë§Œ ê±´ ìƒì„±
                std::cout << "ğŸ’³ [VA Service] Generating " << COUNT << " Virtual Account records..." << std::endl;
                
                fs::create_directories("output/data");
                std::ofstream file("output/data/virtual_accounts_dump.csv");
                
                // í—¤ë” ì‘ì„± (ì€í–‰ì½”ë“œ, ê°€ìƒê³„ì¢Œë²ˆí˜¸, ì˜ˆê¸ˆì£¼, ê¸ˆì•¡, ë§Œë£Œì¼, ìƒíƒœ, ë°œê¸‰í‚¤)
                file << "BankCode,VirtualAccountNum,HolderName,Amount,ExpiryDate,Status,IssueKey" << std::endl;
                
                for(int i=0; i < COUNT; ++i) {
                    // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„±
                    std::string bankCode = (i % 2 == 0) ? "004(KB)" : "088(Shinhan)";
                    long long amount = (i * 1000) + 5000;
                    
                    file << bankCode << ","
                         << "562000-" << std::setw(6) << std::setfill('0') << i << "-999," 
                         << "User_" << i << "," 
                         << amount << ","
                         << "2025-12-31 23:59:59," 
                         << "WAITING_DEPOSIT,"
                         << "vkey_" << i << "_secure_hash" << std::endl;
                }
                file.close();
                std::cout << "âœ… [VA Service] Completed. File size optimized." << std::endl;
            }
        };

        class BigDataManager {
        public:
            static void generateMassiveTransactions() {
                const int COUNT = 300000;
                std::cout << "ğŸ“Š [Data] Generating " << COUNT << " transactions..." << std::endl;
                fs::create_directories("output/data");
                std::ofstream file("output/data/mass_transactions.csv");
                file << "TxID,UserID,Amount,Type,Timestamp,Meta" << std::endl;
                for(int i=0; i < COUNT; ++i) {
                    file << "TX_" << i << ",User_" << (i%1000) << "," << (i*10) 
                         << ",DEPOSIT," << getCurrentTime() << ",meta_" << i << std::endl;
                }
                file.close();
            }
            static void generateMassiveLogs() {
                const int COUNT = 100000;
                std::cout << "ğŸ“ [Logs] Generating " << COUNT << " logs..." << std::endl;
                fs::create_directories("output/logs");
                std::ofstream log("output/logs/audit.log");
                for(int i=0; i < COUNT; ++i) log << "[INFO] " << getCurrentTime() << " Action:OK" << std::endl;
                log.close();
            }
        };

        int main(int argc, char* argv[]) {
            if (argc > 1 && std::string(argv[1]) == "--test") return 0;
            
            std::cout << "ğŸš€ [Grand Unified Server] Starting Mass Generation..." << std::endl;
            
            // 1. ê°€ìƒê³„ì¢Œ ëŒ€ëŸ‰ ë°œê¸‰ (ì‹ ê·œ)
            VirtualAccountManager::generateMassiveVirtualAccounts();
            
            // 2. ê¸°ì¡´ ë°ì´í„° ìƒì„±
            BigDataManager::generateMassiveTransactions();
            BigDataManager::generateMassiveLogs();
            
            std::cout << "ğŸ”— Follow: https://github.com/koreatest12/only-c" << std::endl;
            return 0;
        }
        EOF

    # 3. ì •ì  ë¶„ì„ (Linux)
    - name: Static Analysis
      if: runner.os == 'Linux'
      run: cppcheck --enable=all --inconclusive --force enterprise_main.cpp || true

    # 4. ë¹Œë“œ ì‹¤í–‰
    - name: Build Application
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          echo "ğŸ”¨ Running Make (GCC)..."
          make all
          chmod +x server_app_gcc
        else
          echo "ğŸ”¨ Running CMake (Windows)..."
          mkdir -p build
          cd build
          cmake ..
          cmake --build . --config Release
        fi

    # 5. ì‹¤í–‰ ë° íŒŒì¼ ì •ë¦¬
    - name: Run & Prepare Artifacts
      run: |
        echo "â–¶ï¸ Running & Generating Data..."
        
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          ./server_app_gcc
          cp server_app_gcc final_binary
          if [ -d "output" ]; then mv output output_data; fi
        else
          ./build/Release/enterprise_main.exe
          cp build/Release/enterprise_main.exe final_binary.exe
          
          if [ -d "output" ]; then mv output output_data
          elif [ -d "build/output" ]; then mv build/output output_data
          else mkdir -p output_data; echo "Dummy" > output_data/dummy.txt; fi
        fi
        
        # ê°€ìƒê³„ì¢Œ íŒŒì¼ ìƒì„± í™•ì¸
        ls -lh output_data/data/virtual_accounts_dump.csv || echo "Warning: VA File missing"

    # 6. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì´ë¦„ ê³ ì •)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          final_binary*
          output_data/
          enterprise_main.cpp

  # ----------------------------------------------------------------
  # JOB 2: Docker ë¹Œë“œ
  # ----------------------------------------------------------------
  docker-publish:
    name: Dockerize & Publish
    needs: unified-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Binary-Linux

      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          WORKDIR /app
          COPY final_binary /app/server_app
          RUN chmod +x /app/server_app
          LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}
          CMD ["./server_app"]
          EOF

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest

  # ----------------------------------------------------------------
  # JOB 3: ë¦´ë¦¬ì¦ˆ íŒ¨í‚¤ì§•
  # ----------------------------------------------------------------
  release-all:
    name: Create Final Release
    needs: [unified-build, docker-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: Binary-Linux
          path: linux_pkg

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: Binary-Windows
          path: windows_pkg

      - name: Package Assets
        run: |
          mkdir release_assets
          cp windows_pkg/final_binary.exe release_assets/server_app.exe
          cp linux_pkg/final_binary release_assets/server_app_linux
          cp -r linux_pkg/output_data release_assets/mass_data
          
          cd release_assets
          zip -r ../virtual_account_release_v${{ github.run_number }}.zip .

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v9.0.${{ github.run_number }}
          name: ğŸš€ Virtual Account System v9.0.${{ github.run_number }}
          body: |
            ## ğŸ’³ Virtual Account Update
            
            ëŒ€ëŸ‰ì˜ ê°€ìƒê³„ì¢Œ(Virtual Account) ë°œê¸‰ ì‹œë®¬ë ˆì´ì…˜ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ğŸ“Š Data Stats
            - **Virtual Accounts:** 500,000 Records (CSV)
            - **Transactions:** 300,000 Records
            - **Logs:** 100,000 Records
            
            ### ğŸ“¦ Files
            - `output_data/data/virtual_accounts_dump.csv`: ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì •ë³´
            
            ğŸ‘‰ **https://github.com/koreatest12/only-c**
          files: virtual_account_release_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
