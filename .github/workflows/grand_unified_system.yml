name: ğŸ­ OPTIMIZED FACTORY:DISK CLEANER & MASSIVE OPS

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  LC_ALL: en_US.UTF-8
  # Docker ë¹Œë“œ ì‹œ ê³µê°„ ì ˆì•½ì„ ìœ„í•œ ì„¤ì •
  DOCKER_BUILDKIT: 1

permissions:
  contents: write
  packages: write
  deployments: write
  security-events: write
  actions: write
  checks: write
  statuses: write

jobs:
  optimized-ops:
    name: ğŸš€ Optimized Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest] # ë””ìŠ¤í¬ í™•ë³´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Ubuntuì— ìµœì í™”ë¨ (Windows/Macì€ OS ê´€ë¦¬ë¡œ ëŒ€ì²´)
        include:
          - os: ubuntu-latest
            artifact_name: linux-optimized-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 0] [CRITICAL] ë””ìŠ¤í¬ ê³µê°„ ëŒ€ëŸ‰ í™•ë³´ (ì—ëŸ¬ í•´ê²°ì˜ í•µì‹¬)
    # ----------------------------------------------------------------
    - name: ğŸ§¹ [0] Free Disk Space (Maximize Storage)
      if: runner.os == 'Linux'
      run: |
        echo "=============================================================================="
        echo "ğŸ§¹ STARTING DISK CLEANUP TO PREVENT 'NO SPACE LEFT ON DEVICE' ERROR..."
        echo "=============================================================================="
        
        # 1. ì´ˆê¸° ìƒíƒœ í™•ì¸
        df -h
        
        # 2. ë¶ˆí•„ìš”í•œ ì‚¬ì „ ì„¤ì¹˜ ì†Œí”„íŠ¸ì›¨ì–´ ì‚­ì œ (Android, .NET, Haskell, CodeQL ìºì‹œ ë“±)
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        
        # 3. Docker ì´ë¯¸ì§€ ì •ë¦¬
        docker system prune -af
        
        # 4. í™•ë³´ í›„ ìƒíƒœ í™•ì¸
        echo "âœ… Disk Space After Cleanup:"
        df -h
        echo "=============================================================================="

    # ----------------------------------------------------------------
    # [Step 1] ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ëŸ°íƒ€ì„ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [2] Setup Runtimes
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [3] Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    # ----------------------------------------------------------------
    # [Step 3] ê´€ë¦¬í˜• ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë””ìŠ¤í¬ ê´€ë¦¬ì í¬í•¨)
    # ----------------------------------------------------------------
    - name: ğŸ“‚ [4] Bootstrap Ops Scripts
      shell: bash
      run: |
        mkdir -p ops_scripts
        
        # 1. ì˜ì¡´ì„±
        cat <<'EOF' > ops_scripts/requirements.txt
        colorama
        requests
        tqdm
        jinja2
        Pillow
        psutil
        EOF
        
        # 2. [NEW] ë””ìŠ¤í¬ ë° ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ì
        cat <<'EOF' > ops_scripts/resource_manager.py
        import os
        import shutil
        import psutil

        def check_disk():
            total, used, free = shutil.disk_usage("/")
            print(f"ğŸ’¾ [DISK] Total: {total // (2**30)}GB | Used: {used // (2**30)}GB | Free: {free // (2**30)}GB")
            
            # 1GB ë¯¸ë§Œì´ë©´ ê²½ê³  ë° ê¸´ê¸‰ ì²­ì†Œ
            if free < (1 * 1024 * 1024 * 1024):
                print("âš ï¸ [WARNING] Low Disk Space! Cleaning temp files...")
                os.system("rm -rf /tmp/*")
                os.system("docker system prune -f")

        def monitor_memory():
            mem = psutil.virtual_memory()
            print(f"ğŸ§  [MEM] Total: {mem.total // (2**20)}MB | Available: {mem.available // (2**20)}MB")

        if __name__ == "__main__":
            check_disk()
            monitor_memory()
        EOF

        # 3. íŒ©í† ë¦¬ ë§¤ë‹ˆì € (ëŒ€ëŸ‰ ìƒì„± ë¡œì§)
        cat <<'EOF' > ops_scripts/factory_manager.py
        import os, sys, random, datetime
        from PIL import Image, ImageDraw

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys"
        ]
        COLLECTORS = ["Log_Aggregator", "Metric_Beat", "Trace_Collector", "Security_Auditor"]

        def safe_makedirs(path):
            if not os.path.exists(path): os.makedirs(path, exist_ok=True)

        def produce_assets():
            print(f"ğŸš€ [FACTORY] Generating {len(SERVICES) + len(COLLECTORS)} Services...")
            safe_makedirs("src/main/java/com/global/core")
            safe_makedirs("src/main/java/com/global/collection")
            safe_makedirs("docs/images")
            safe_makedirs("cpp_core")

            all_svcs = SERVICES + COLLECTORS
            for i, svc in enumerate(all_svcs):
                kind = 'core' if svc in SERVICES else 'collection'
                base = f"src/main/java/com/global/{kind}/{svc.lower()}"
                safe_makedirs(base)
                
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.{kind}.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Ready\"); }} }}")

            # Image Gen
            img = Image.new('RGB', (400, 200), color=(50, 50, 50))
            d = ImageDraw.Draw(img)
            d.text((20, 90), f"System Architecture {datetime.datetime.now().year}", fill="yellow")
            img.save("docs/images/architecture.png")

            # C++
            with open("cpp_core/crypto.cpp", "w") as f:
                f.write('#include <iostream>\nint main() { return 0; }')

        if __name__ == "__main__":
            produce_assets()
        EOF

        # 4. ë³´ì•ˆ ì¸ì í„°
        cat <<'EOF' > ops_scripts/security_injector.py
        import os, datetime
        HEADER = f"// (C) {datetime.datetime.now().year} SECURE OPS.\n"
        def inject():
            for root, dirs, files in os.walk("."):
                if "bin" in root or ".git" in root: continue
                for file in files:
                    if file.endswith(('.java', '.cpp')):
                        try:
                            path = os.path.join(root, file)
                            with open(path, 'r+', encoding='utf-8') as f:
                                content = f.read()
                                if "SECURE OPS" not in content:
                                    f.seek(0, 0)
                                    f.write(HEADER + content)
                        except: pass
        if __name__ == "__main__": inject()
        EOF
        
        # 5. ë°°í¬ ì‹œë®¬ë ˆì´í„°
        cat <<'EOF' > ops_scripts/deploy_simulator.py
        import http.server, socketserver, threading, time, os
        def run():
            if not os.path.exists("deploy_root"): os.makedirs("deploy_root")
            os.chdir("deploy_root")
            def serve(p):
                try:
                    with socketserver.TCPServer(("", p), http.server.SimpleHTTPRequestHandler) as h: h.serve_forever()
                except: pass
            for p in range(8000, 8005):
                t = threading.Thread(target=serve, args=(p,))
                t.daemon = True
                t.start()
            time.sleep(5)
            print("âœ… Simulation Online.")
        if __name__ == "__main__": run()
        EOF

    # ----------------------------------------------------------------
    # [Step 4] ì˜ì¡´ì„± ì„¤ì¹˜ & CodeQL Init
    # ----------------------------------------------------------------
    - name: ğŸ“¦ [5] Install Deps
      run: pip install -r ops_scripts/requirements.txt

    - name: ğŸ›¡ï¸ [6] CodeQL Init
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python

    # ----------------------------------------------------------------
    # [Step 5] íŒ©í† ë¦¬ ê°€ë™ (ë¦¬ì†ŒìŠ¤ ì²´í¬ í¬í•¨)
    # ----------------------------------------------------------------
    - name: ğŸ­ [7] Execute Factory & Security
      run: |
        python ops_scripts/resource_manager.py
        python ops_scripts/factory_manager.py
        python ops_scripts/security_injector.py
        python ops_scripts/resource_manager.py

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ (Docker í¬í•¨)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [8] Build System
      shell: bash
      run: |
        echo "ğŸ—ï¸ Building Binaries..."
        g++ -o bin/Crypto cpp_core/crypto.cpp
        find src -name "*.java" > sources.txt
        javac -nowarn -d bin @sources.txt
        jar cf bin/CoreApp.jar -C bin .
        
        # Docker Build (ê³µê°„ ì ˆì•½ì„ ìœ„í•´ ë¹Œë“œ í›„ ì¦‰ì‹œ ì •ë¦¬)
        echo "ğŸ³ Building Docker Image..."
        echo "FROM scratch" > Dockerfile
        docker build -t global/app:latest .
        docker rmi global/app:latest # ë¹Œë“œ ê²€ì¦ í›„ ë°”ë¡œ ì‚­ì œí•˜ì—¬ ê³µê°„ í™•ë³´

    # ----------------------------------------------------------------
    # [Step 7] ë°°í¬ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [9] Run Simulation
      run: |
        mkdir -p deploy_root
        cp bin/*.jar deploy_root/
        python ops_scripts/deploy_simulator.py

    # ----------------------------------------------------------------
    # [Step 8] SCM Sync (Autostash)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [10] SCM Sync (Robust)
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        git config --global user.name "Ops-Bot"
        git config --global user.email "bot@ops.com"
        
        # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
        python ops_scripts/resource_manager.py
        
        # íŒŒì¼ ì¶”ê°€
        git add -A
        git add -f ops_scripts/ src/ docs/ bin/Crypto*
        
        if git diff --staged --quiet; then
            echo "âœ… No changes."
        else
            git commit -m "ğŸ­ Factory Update: Optimized Storage [skip ci]"
            
            # Rebase Loop
            for i in {1..5}; do
                git pull --rebase --autostash origin main && git push origin main && break || sleep 5
            done
        fi

    # ----------------------------------------------------------------
    # [Step 9] CodeQL Analysis
    # ----------------------------------------------------------------
    - name: ğŸ” [11] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 10] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì••ì¶•í•˜ì—¬ ìš©ëŸ‰ ì ˆì•½)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [12] Upload Optimized Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ops_scripts/
          bin/
          src/
          docs/
        retention-days: 1
        compression-level: 9 # ìµœëŒ€ ì••ì¶•
