name: üè≠ Ultimate DB Factory (Polyglot & Console)

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "db-factory-v3"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] Î©ÄÌã∞ DB Îç∞Ïù¥ÌÑ∞ ÏÉùÏÇ∞ Î∞è ÏäàÌçº ÏΩòÏÜî Íµ¨Ï∂ï
  # ==============================================================================
  polyglot-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    # Ïã§Ï†ú Ïó∞Í≤∞ ÌÖåÏä§Ìä∏Î•º ÏúÑÌïú Í≤ΩÎüâ Ïª®ÌÖåÏù¥ÎÑà
    services:
      redis:
        image: redis:alpine
        ports: ["6379:6379"]
      mongo:
        image: mongo:4.4
        ports: ["27017:27017"]

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
    # ----------------------------------------------------------------
    - name: üßπ System Purge
      run: |
        echo "üßπ Purging system for DB cluster..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "‚úÖ Ready."

    # ----------------------------------------------------------------
    # [Step 2] ÏóîÏßÑ ÏÑ§Ï†ï
    # ----------------------------------------------------------------
    - name: üõ†Ô∏è Setup Python
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: üì¶ Install Deps
      run: pip install flask flask-cors gunicorn faker pandas requests jinja2 psutil pymongo redis

    # ----------------------------------------------------------------
    # [Step 3] üè≠ ÌÜµÌï© DB ÏóîÏßÑ (RDB + NoSQL + Graph + TSDB)
    # ----------------------------------------------------------------
    - name: üè≠ Run Polyglot Data Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > db_engine.py
        import os, shutil, json, random, uuid, sqlite3, time
        from datetime import datetime, timedelta
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        
        # 1. RDB (SQLite & SQL Dumps)
        def gen_rdb():
            path = "data/rdb/finance"
            os.makedirs(path, exist_ok=True)
            
            # Ïã§Ï†ú SQLite DB ÏÉùÏÑ±
            conn = sqlite3.connect(f"{path}/ledger.db")
            c = conn.cursor()
            c.execute('''CREATE TABLE txs (id text, date text, amount real, user text)''')
            for _ in range(1000):
                c.execute("INSERT INTO txs VALUES (?,?,?,?)", 
                          (str(uuid.uuid4()), str(datetime.now()), random.uniform(10,9999), fake.name()))
            conn.commit()
            conn.close()
            
            # MySQL Dump ÏãúÎÆ¨Î†àÏù¥ÏÖò
            with open(f"{path}/dump.sql", "w") as f:
                f.write("-- MySQL DUMP \n")
                for _ in range(500): f.write(f"INSERT INTO users VALUES ('{fake.name()}', '{fake.email()}');\n")
            
            return {"type": "RDB", "count": 1500, "status": "Online"}

        # 2. NoSQL (MongoDB JSONs)
        def gen_nosql():
            path = "data/nosql/users"
            os.makedirs(path, exist_ok=True)
            docs = []
            for _ in range(500):
                doc = {
                    "_id": str(uuid.uuid4()),
                    "profile": fake.profile(),
                    "preferences": {"theme": "dark", "notifications": random.choice([True, False])},
                    "history": [fake.url() for _ in range(5)]
                }
                docs.append(doc)
            
            with open(f"{path}/collection.json", "w") as f: json.dump(docs, f)
            return {"type": "NoSQL", "count": 500, "status": "Active"}

        # 3. Time-Series (InfluxDB Line Protocol)
        def gen_tsdb():
            path = "data/tsdb/sensors"
            os.makedirs(path, exist_ok=True)
            with open(f"{path}/metrics.lp", "w") as f:
                for i in range(1000):
                    ts = int(time.time() * 1e9) + (i * 1000000)
                    f.write(f"cpu,host=server01 usage={random.randint(20,90)} {ts}\n")
                    f.write(f"mem,host=server01 free={random.randint(1000,8000)} {ts}\n")
            return {"type": "TSDB", "count": 2000, "status": "Collecting"}

        # 4. Graph DB (Neo4j CSV)
        def gen_graph():
            path = "data/graph/social"
            os.makedirs(path, exist_ok=True)
            with open(f"{path}/nodes.csv", "w") as f:
                f.write("id:ID,name,group\n")
                for i in range(100): f.write(f"u{i},{fake.first_name()},{random.choice(['A','B'])}\n")
            with open(f"{path}/edges.csv", "w") as f:
                f.write(":START_ID,:END_ID,type\n")
                for _ in range(200): f.write(f"u{random.randint(0,99)},u{random.randint(0,99)},FOLLOWS\n")
            return {"type": "Graph", "count": 300, "status": "Mapped"}

        if __name__ == "__main__":
            print("üöÄ Generating Polyglot Data...")
            
            summary = [gen_rdb(), gen_nosql(), gen_tsdb(), gen_graph()]
            
            # ÏïïÏ∂ï
            shutil.make_archive(f"{OUTPUT_DIR}/db_cluster_backup", 'zip', "data")
            shutil.rmtree("data")
            
            data = {
                "system_status": "OPTIMAL",
                "generated_at": str(datetime.now()),
                "databases": summary
            }
            with open("dashboard_data.json", "w") as f: json.dump(data, f)
            print("‚úÖ DB Engine Finished.")
        EOF
        
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 4] üåê ÌîÑÎ°†Ìä∏ÏóîÎìú: DB ÌÑ∞ÎØ∏ÎÑêÏù¥ Ìè¨Ìï®Îêú ÏäàÌçº ÏΩòÏÜî
    # ----------------------------------------------------------------
    - name: üé® Build DB Console
      shell: bash
      run: |
        mkdir -p _web_portal/static/css
        mkdir -p _web_portal/templates
        
        # HTML: ÌÉ≠ + Í≥†Í∏â ÌÑ∞ÎØ∏ÎÑê Î°úÏßÅ
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>DB MASTER CONSOLE</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
            <style>
                body { background-color: #0c0c0c; color: #e0e0e0; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
                .tab-btn { padding: 10px 20px; border-bottom: 2px solid transparent; opacity: 0.6; cursor: pointer; transition: 0.2s; }
                .tab-btn:hover, .tab-active { opacity: 1; border-color: #f59e0b; color: #f59e0b; }
                .panel { height: calc(100vh - 120px); overflow-y: auto; padding: 20px; display: none; }
                .panel.active { display: block; }
                
                /* Terminal Styles */
                .term-window { background: #1e1e1e; border: 1px solid #333; height: 100%; border-radius: 6px; padding: 15px; font-size: 14px; overflow-y: auto; }
                .prompt-sql { color: #3b82f6; }   /* Blue for SQL */
                .prompt-mongo { color: #10b981; } /* Green for Mongo */
                .prompt-redis { color: #ef4444; } /* Red for Redis */
                .cmd-input { background: transparent; border: none; outline: none; color: white; width: 80%; }
            </style>
        </head>
        <body class="flex flex-col h-screen">
            
            <header class="bg-black border-b border-gray-800 p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <h1 class="text-xl font-bold tracking-tighter">FACTORY <span class="text-yellow-500">DB_OPS</span></h1>
                </div>
                <div class="text-xs text-gray-500 font-bold" id="clock">--:--:--</div>
            </header>

            <nav class="bg-[#111] border-b border-gray-800 flex px-4">
                <div onclick="setTab('dash')" id="btn-dash" class="tab-btn tab-active">üìä CLUSTER OVERVIEW</div>
                <div onclick="setTab('db')" id="btn-db" class="tab-btn">üõ¢Ô∏è DB EXPLORER</div>
                <div onclick="setTab('term')" id="btn-term" class="tab-btn">üíª ROOT TERMINAL</div>
            </nav>

            <main class="flex-1 bg-[#0c0c0c]">
                
                <div id="view-dash" class="panel active">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-[#1a1a1a] p-5 rounded border border-gray-800 col-span-1">
                            <h3 class="text-gray-500 text-xs mb-1">TOTAL RECORDS</h3>
                            <p class="text-3xl font-bold text-white">4,500+</p>
                        </div>
                        <div class="bg-[#1a1a1a] p-5 rounded border border-gray-800 col-span-1">
                            <h3 class="text-gray-500 text-xs mb-1">ACTIVE NODES</h3>
                            <p class="text-3xl font-bold text-green-400">5 / 5</p>
                        </div>
                        <div class="bg-[#1a1a1a] p-5 rounded border border-gray-800 col-span-2 row-span-2">
                            <h3 class="text-gray-500 text-xs mb-4">WRITE IOPS (Real-time)</h3>
                            <canvas id="iopsChart"></canvas>
                        </div>
                        <div class="col-span-2 grid grid-cols-2 gap-4" id="db-cards">
                            </div>
                    </div>
                </div>

                <div id="view-db" class="panel">
                    <h2 class="text-xl font-bold text-yellow-500 mb-4 border-b border-gray-800 pb-2">DATA WAREHOUSE SCHEMA</h2>
                    <div class="grid grid-cols-3 gap-6">
                        <div class="bg-[#111] p-4 border border-blue-900 rounded">
                            <h3 class="text-blue-400 font-bold mb-2">üü¶ RDB (MySQL/SQLite)</h3>
                            <ul class="text-sm text-gray-400 space-y-1 list-disc list-inside">
                                <li>Table: <code>users</code> (id, email)</li>
                                <li>Table: <code>ledger_txs</code> (amount, date)</li>
                            </ul>
                        </div>
                        <div class="bg-[#111] p-4 border border-green-900 rounded">
                            <h3 class="text-green-400 font-bold mb-2">üü© NoSQL (MongoDB)</h3>
                            <ul class="text-sm text-gray-400 space-y-1 list-disc list-inside">
                                <li>Coll: <code>user_profiles</code> (JSON)</li>
                                <li>Coll: <code>activity_logs</code> (BSON)</li>
                            </ul>
                        </div>
                        <div class="bg-[#111] p-4 border border-purple-900 rounded">
                            <h3 class="text-purple-400 font-bold mb-2">üü™ Graph (Neo4j)</h3>
                            <ul class="text-sm text-gray-400 space-y-1 list-disc list-inside">
                                <li>Nodes: <code>(:User)</code>, <code>(:Group)</code></li>
                                <li>Rel: <code>[:FOLLOWS]</code>, <code>[:LIKES]</code></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="view-term" class="panel">
                    <div class="term-window" id="term-box" onclick="document.getElementById('cmd').focus()">
                        <div class="text-gray-500">FactoryOS v3.0 - Database Shell Interface</div>
                        <div class="text-gray-500">Try commands: <span class="text-white">help, connect mysql, connect mongo, scan</span></div>
                        <br>
                        <div id="term-output"></div>
                        <div class="flex mt-1">
                            <span id="prompt" class="mr-2 text-yellow-500">root@factory:~#</span>
                            <input type="text" id="cmd" class="cmd-input" autocomplete="off" autofocus>
                        </div>
                    </div>
                </div>

            </main>

            <script>
                // --- Data Loading ---
                async function init() {
                    const res = await fetch('/api/stats').catch(()=>fetch('dashboard_data.json'));
                    const data = await res.json();
                    
                    const dbCards = document.getElementById('db-cards');
                    data.databases.forEach(db => {
                        let color = 'text-gray-400';
                        if(db.type==='RDB') color='text-blue-400';
                        if(db.type==='NoSQL') color='text-green-400';
                        if(db.type==='TSDB') color='text-orange-400';
                        
                        dbCards.innerHTML += `
                        <div class="bg-[#1a1a1a] p-4 rounded border border-gray-800">
                            <div class="flex justify-between">
                                <span class="${color} font-bold">${db.type}</span>
                                <span class="bg-green-900 text-green-300 text-xs px-2 rounded">${db.status}</span>
                            </div>
                            <p class="text-2xl mt-2 text-white">${db.count}</p>
                            <p class="text-xs text-gray-600">RECORDS GENERATED</p>
                        </div>`;
                    });

                    // Chart
                    new Chart(document.getElementById('iopsChart'), {
                        type: 'line',
                        data: {
                            labels: Array(20).fill(''),
                            datasets: [{ label: 'IOPS', data: Array(20).fill(0).map(()=>Math.random()*500), borderColor: '#f59e0b', tension: 0.4 }]
                        },
                        options: { plugins:{legend:false}, scales:{x:{display:false}, y:{grid:{color:'#222'}}} }
                    });
                }

                // --- Terminal Logic ---
                const cmdInput = document.getElementById('cmd');
                const termOut = document.getElementById('term-output');
                const prompt = document.getElementById('prompt');
                let mode = 'shell'; // shell, mysql, mongo

                cmdInput.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter') {
                        const val = cmdInput.value.trim();
                        printLine(val, true);
                        cmdInput.value = '';
                        execute(val);
                    }
                });

                function printLine(text, isInput=false) {
                    const div = document.createElement('div');
                    if(isInput) {
                        div.innerHTML = `<span class="${prompt.className}">${prompt.innerText}</span> ${text}`;
                    } else {
                        div.innerHTML = text; // Allow HTML
                    }
                    termOut.appendChild(div);
                    document.getElementById('view-term').scrollTo(0, 9999); // Scroll panel
                    document.getElementById('term-box').scrollTo(0, 9999);  // Scroll div
                }

                function execute(cmd) {
                    if (mode === 'shell') {
                        if (cmd === 'help') printLine("Available: <span class='text-white'>scan, connect [db], clear, status</span>");
                        else if (cmd === 'clear') termOut.innerHTML = '';
                        else if (cmd === 'scan') {
                            printLine("Scanning network for open ports...");
                            setTimeout(()=>printLine("Found: <span class='text-blue-400'>MySQL:3306</span> (Open)"), 500);
                            setTimeout(()=>printLine("Found: <span class='text-green-400'>MongoDB:27017</span> (Open)"), 1000);
                            setTimeout(()=>printLine("Found: <span class='text-red-400'>Redis:6379</span> (Open)"), 1500);
                        }
                        else if (cmd.startsWith('connect ')) {
                            const target = cmd.split(' ')[1];
                            if(target === 'mysql') {
                                mode = 'mysql';
                                prompt.innerText = 'mysql>';
                                prompt.className = 'mr-2 prompt-sql';
                                printLine("Welcome to the MySQL monitor. Commands end with ;");
                            } else if(target === 'mongo') {
                                mode = 'mongo';
                                prompt.innerText = 'mongo>';
                                prompt.className = 'mr-2 prompt-mongo';
                                printLine("MongoDB shell version v4.4.6");
                            } else if(target === 'redis') {
                                mode = 'redis';
                                prompt.innerText = '127.0.0.1:6379>';
                                prompt.className = 'mr-2 prompt-redis';
                            } else {
                                printLine(`Unknown database: ${target}`);
                            }
                        }
                        else if (cmd !== '') printLine(`bash: ${cmd}: command not found`);
                    }
                    // MySQL Mode
                    else if (mode === 'mysql') {
                        if (cmd === 'exit') { mode='shell'; resetPrompt(); }
                        else if (cmd.toUpperCase().startsWith('SELECT')) printLine("+------+-----------+\n| id   | name      |\n+------+-----------+\n| 1    | admin     |\n| 2    | factory   |\n+------+-----------+\n2 rows in set (0.00 sec)", false).replace(/\n/g, '<br>');
                        else if (cmd.toUpperCase() === 'SHOW TABLES;') printLine("Tables_in_factory\n-----------------\nusers\nledger_txs");
                        else printLine("Query OK, 0 rows affected (0.01 sec)");
                    }
                    // Mongo Mode
                    else if (mode === 'mongo') {
                        if (cmd === 'exit') { mode='shell'; resetPrompt(); }
                        else if (cmd === 'show dbs') printLine("admin   0.000GB\nlocal   0.000GB\nfactory 0.150GB");
                        else if (cmd.startsWith('db.') && cmd.endsWith('.find()')) printLine('{ "_id" : ObjectId("..."), "name" : "user1" }<br>{ "_id" : ObjectId("..."), "name" : "user2" }');
                        else printLine("ReferenceError: syntax error");
                    }
                    // Redis Mode
                    else if (mode === 'redis') {
                         if (cmd === 'exit') { mode='shell'; resetPrompt(); }
                         else if (cmd.toUpperCase().startsWith('GET')) printLine('"value_123"');
                         else if (cmd.toUpperCase().startsWith('SET')) printLine('OK');
                         else printLine("(error) ERR unknown command");
                    }
                }

                function resetPrompt() {
                    prompt.innerText = 'root@factory:~#';
                    prompt.className = 'mr-2 text-yellow-500';
                }

                function setTab(id) {
                    document.querySelectorAll('.panel').forEach(e=>e.classList.remove('active'));
                    document.getElementById('view-'+id).classList.add('active');
                    document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('tab-active'));
                    document.getElementById('btn-'+id).classList.add('tab-active');
                }
                
                setInterval(()=>document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
                init();
            </script>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 5] Flask ÏÑúÎ≤Ñ Ï§ÄÎπÑ (Î°úÍ∑∏ ÏñµÏ†ú)
    # ----------------------------------------------------------------
    - name: ‚öôÔ∏è Build Server
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        @app.route('/')
        def home(): return render_template('index.html')
        @app.route('/api/stats')
        def stats():
            try: return jsonify(json.load(open('../dashboard_data.json')))
            except: return jsonify({"databases": []})
        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        # Gunicorn Config (ÏóêÎü¨ ÏñµÏ†ú)
        cat <<'EOF' > _web_portal/gunicorn_config.py
        bind = "0.0.0.0:5000"
        workers = 2
        loglevel = "error" 
        errorlog = "server_error.log"
        accesslog = "/dev/null"
        EOF

    # ----------------------------------------------------------------
    # [Step 6] üöÄ ÏÑúÎ≤Ñ ÌÖåÏä§Ìä∏ & Î∞∞Ìè¨
    # ----------------------------------------------------------------
    - name: üß™ Clean Test
      run: |
        cd _web_portal
        gunicorn -c gunicorn_config.py app:app > /dev/null 2>&1 &
        PID=$!
        sleep 5
        curl -4 -s http://127.0.0.1:5000/api/stats > /dev/null
        echo "‚úÖ API Checked."
        kill -TERM $PID
        wait $PID 2>/dev/null || true

    - name: üìÑ Build & Upload
      run: |
        mkdir -p _site
        cp _web_portal/templates/index.html _site/index.html
        cp dashboard_data.json _site/dashboard_data.json

    - name: üì§ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: db-console-package
        path: |
          _web_portal/
          _data_warehouse/

    - name: üì§ Upload Pages
      uses: actions/upload-pages-artifact@v3
      with: { path: _site/ }

  # ==============================================================================
  # [Job 2] GitHub Pages Deploy
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: polyglot-ops
    steps:
      - name: üöÄ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
