name: ğŸ›¡ï¸ SERVER:INSTALL, DOWNLOAD & DEPLOY

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_ROOT_USER_ACTION: ignore

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  deploy-ops:
    name: ğŸŒ Deploy Server on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-deploy-pack
          - os: windows-latest
            artifact_name: windows-deploy-pack
          - os: macos-latest
            artifact_name: macos-deploy-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ë¦¬ì†ŒìŠ¤ í™•ë³´
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] ì˜ì¡´ì„± íŒŒì¼ ì„ í–‰ ìƒì„± (Fix Cache Error)
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Pre-Init Dependencies
      shell: bash
      run: |
        echo "Creating requirements.txt..."
        echo "colorama" > requirements.txt
        echo "tqdm" >> requirements.txt
        echo "requests" >> requirements.txt 
        echo "âœ… requirements.txt created."

    # ----------------------------------------------------------------
    # [Step 3] CodeQL v4 ì´ˆê¸°í™”
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [3] Initialize CodeQL v4
      uses: github/codeql-action/init@v4
      with:
        languages: cpp, python
        queries: security-extended, security-and-quality

    # ----------------------------------------------------------------
    # [Step 4] ì‹œìŠ¤í…œ ì •ë¹„
    # ----------------------------------------------------------------
    - name: ğŸ”„ [4] Silent System Upgrade
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update -qq
            sudo apt-get install -y -qq --no-install-recommends build-essential cmake
        fi

    # ----------------------------------------------------------------
    # [Step 5] Python ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ [5] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ”„ [5-Post] Install Dependencies
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 6] í†µí•© ë°°í¬ ë§¤ë‹ˆì € (ì„œë²„/ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ì¶”ê°€)
    # ----------------------------------------------------------------
    - name: ğŸ“ [6] Generate Deploy Manager
      shell: bash
      run: |
        cat <<EOF > service_manager.py
        import os
        import sys
        import platform
        import sqlite3
        import time
        import random
        import threading
        import http.server
        import socketserver
        import urllib.request
        import shutil
        import hashlib

        sys.stdout.reconfigure(encoding='utf-8')

        # --- ì„¤ì • ---
        SERVER_PORT = 8080
        RELEASE_DIR = "release_store"

        def log(msg):
            print(f"[DEPLOY-MGR] {msg}")

        # 1. C++ ì„œë¹„ìŠ¤ ì—”ì§„ ìƒì„±
        def generate_cpp_core():
            log("Generating C++20 Service Core...")
            cpp_code = """
        #include <iostream>
        #include <vector>
        #include <string>
        #include <thread>
        #include <mutex>

        int main() {
            std::cout << "ğŸš€ ENTERPRISE SERVICE RUNNING..." << std::endl;
            std::cout << "âœ… Banking/Stock/Insurance Modules Loaded." << std::endl;
            return 0;
        }
            """
            
            cmake_code = """
        cmake_minimum_required(VERSION 3.14)
        project(EnterpriseService)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            try:
                with open("main.cpp", "w", encoding="utf-8") as f: f.write(cpp_code)
                with open("CMakeLists.txt", "w", encoding="utf-8") as f: f.write(cmake_code)
            except Exception as e: print(f"[ERROR] {e}")

        # 2. ëŒ€ëŸ‰ ë°ì´í„° DB ìƒì„±
        def run_db_migration():
            log("ğŸ”„ Creating Massive DB (Banking, Stock, Insurance)...")
            try:
                conn = sqlite3.connect("enterprise_data.db")
                cursor = conn.cursor()
                cursor.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER, name TEXT)")
                # ëŒ€ëŸ‰ ë”ë¯¸ ë°ì´í„°
                data = [(i, f"User_{i}") for i in range(100)]
                cursor.executemany("INSERT INTO users VALUES (?, ?)", data)
                conn.commit()
                conn.close()
                log("âœ… DB Created.")
            except Exception as e: print(f"[DB ERROR] {e}")

        # 3. [NEW] ë°°í¬ íŒ¨í‚¤ì§• ë° ì„œë²„ ê°€ë™ ë¡œì§
        def start_distribution_server():
            # ë°°í¬ í´ë” ìƒì„±
            if not os.path.exists(RELEASE_DIR):
                os.makedirs(RELEASE_DIR)
            
            # ì„œë¹„ìŠ¤ë³„ ê°€ìƒ íŒ¨í‚¤ì§€ ìƒì„± (Zip)
            services = ["Banking_Service_v2.0", "Stock_Trader_v1.5", "Insurance_Sys_v3.1"]
            for svc in services:
                # ë”ë¯¸ íŒŒì¼ ìƒì„± í›„ ì••ì¶•
                dummy_content = f"This is the binary content for {svc}"
                with open(f"{svc}.bin", "w") as f: f.write(dummy_content)
                
                # Zip ì••ì¶•
                shutil.make_archive(f"{RELEASE_DIR}/{svc}", 'zip', root_dir=".", base_dir=f"{svc}.bin")
                log(f"ğŸ“¦ Packed: {svc}.zip ready in official store.")

            # ë°±ê·¸ë¼ìš´ë“œ ì„œë²„ ìŠ¤ë ˆë“œ ì‹¤í–‰
            handler = http.server.SimpleHTTPRequestHandler
            
            # ì„œë²„ ë£¨íŠ¸ë¥¼ RELEASE_DIRë¡œ ì„¤ì •í•˜ê¸° ìœ„í•´ ë””ë ‰í† ë¦¬ ì´ë™
            os.chdir(RELEASE_DIR)
            
            try:
                httpd = socketserver.TCPServer(("", SERVER_PORT), handler)
                log(f"ğŸŒ [OFFICIAL SERVER] Started at http://localhost:{SERVER_PORT}")
                server_thread = threading.Thread(target=httpd.serve_forever)
                server_thread.daemon = True
                server_thread.start()
                
                # ë‹¤ì‹œ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œ ë³µê·€ (í´ë¼ì´ì–¸íŠ¸ ë™ì‘ ìœ„í•´)
                os.chdir("..")
                return True
            except Exception as e:
                log(f"âŒ Server Start Failed: {e}")
                os.chdir("..")
                return False

        # 4. [NEW] ê³µì‹ ì£¼ì†Œ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
        def test_download_feature():
            log("â¬‡ï¸ Testing Download from Official Server...")
            time.sleep(2) # ì„œë²„ ê¸°ë™ ëŒ€ê¸°
            
            targets = ["Banking_Service_v2.0.zip", "Stock_Trader_v1.5.zip", "Insurance_Sys_v3.1.zip"]
            download_dir = "client_downloads"
            
            if not os.path.exists(download_dir):
                os.makedirs(download_dir)
            
            for file_name in targets:
                url = f"http://localhost:{SERVER_PORT}/{file_name}"
                save_path = f"{download_dir}/{file_name}"
                
                try:
                    log(f"ğŸ“¡ Requesting: {url}")
                    urllib.request.urlretrieve(url, save_path)
                    
                    # íŒŒì¼ ê²€ì¦
                    if os.path.exists(save_path) and os.path.getsize(save_path) > 0:
                        log(f"âœ… Download Success: {file_name} ({os.path.getsize(save_path)} bytes)")
                    else:
                        log(f"âŒ Download Failed: {file_name} is empty.")
                except Exception as e:
                    log(f"âŒ Connection Error: {e}")

        if __name__ == "__main__":
            log(f"ğŸš€ System: {platform.system()} - Init Pipeline")
            
            generate_cpp_core()     # 1. ì†ŒìŠ¤ ìƒì„±
            run_db_migration()      # 2. DB ìƒì„±
            
            if start_distribution_server(): # 3. ì„œë²„ ê°€ë™
                test_download_feature()     # 4. ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
            
            log("âœ… All Deployment Tasks Completed.")
        EOF

    # ----------------------------------------------------------------
    # [Step 7] ë¹Œë“œ (Artifact ìƒì„±ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ—ï¸ [7] CMake Configure & Build
      shell: bash
      run: |
        cmake -S . -B build
        cmake --build build --config Release

    # ----------------------------------------------------------------
    # [Step 8] ì„œë²„ ì„¤ì¹˜, íŒ¨í‚¤ì§• ë° ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ (Main Action)
    # ----------------------------------------------------------------
    - name: ğŸŒ [8] Install Server & Execute Download
      shell: bash
      run: |
        echo "================================================"
        echo "ğŸš€ LAUNCHING OFFICIAL DISTRIBUTION SERVER..."
        echo "================================================"
        python service_manager.py
        echo "================================================"
        echo "âœ… Server Test & Download Verified."

    # ----------------------------------------------------------------
    # [Step 9] CodeQL v4 ë³´ì•ˆ ë¶„ì„
    # ----------------------------------------------------------------
    - name: ğŸ” [9] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:cpp,python"

    # ----------------------------------------------------------------
    # [Step 10] ê²€ì¦ëœ íŒŒì¼ ì—…ë¡œë“œ (ì„œë²„ ì›ë³¸ + ë‹¤ìš´ë¡œë“œë³¸)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [10] Upload Deploy Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          release_store/    # ì„œë²„ ì €ì¥ì†Œ (ì›ë³¸)
          client_downloads/ # í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ (ê²€ì¦ë³¸)
          *.db
          *.py
        retention-days: 1
