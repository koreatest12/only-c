name: ğŸ­ FINAL PERFECT FACTORY:SELF-HEALING & FUTURE TECH

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ë¬´í•œ ê°€ë™
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  LC_ALL: en_US.UTF-8
  # Docker ë¹Œë“œ ìµœì í™”
  DOCKER_BUILDKIT: 1

permissions:
  contents: write
  packages: write
  deployments: write
  security-events: write
  actions: write
  checks: write
  statuses: write

jobs:
  perfect-ops:
    name: ğŸ’ Perfect Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest] # ë””ìŠ¤í¬ ìµœì í™”ë¥¼ ìœ„í•´ Ubuntu ì§‘ì¤‘
        include:
          - os: ubuntu-latest
            artifact_name: linux-perfect-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 0] ë””ìŠ¤í¬ ê³µê°„ ëŒ€ëŸ‰ í™•ë³´ (No Space Error ë°©ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ§¹ [0] Deep Disk Cleanup
      if: runner.os == 'Linux'
      run: |
        echo "ğŸ§¹ Cleaning up disk space..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        docker system prune -af
        echo "âœ… Disk Space Freed."

    # ----------------------------------------------------------------
    # [Step 1] ê³µì¥ ì´ˆê¸°í™”
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ìƒì‚° ë„êµ¬ ì¤€ë¹„
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [2] Setup Runtimes
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [3] Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    # ----------------------------------------------------------------
    # [Step 3] ê´€ë¦¬í˜• ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ (ëŒ€ëŸ‰ ì„œë¹„ìŠ¤ ì •ì˜)
    # ----------------------------------------------------------------
    - name: ğŸ“‚ [4] Bootstrap Scripts
      shell: bash
      run: |
        mkdir -p ops_scripts
        
        # 1. ì˜ì¡´ì„±
        cat <<'EOF' > ops_scripts/requirements.txt
        colorama
        requests
        tqdm
        jinja2
        Pillow
        psutil
        EOF

        # 2. íŒ©í† ë¦¬ ë§¤ë‹ˆì € (ë¯¸ë˜ ê¸°ìˆ  ì„œë¹„ìŠ¤ í¬í•¨)
        cat <<'EOF' > ops_scripts/factory_manager.py
        import os, sys, random, datetime
        from PIL import Image, ImageDraw

        sys.stdout.reconfigure(encoding='utf-8')

        # ê¸°ì¡´ ì—”í„°í”„ë¼ì´ì¦ˆ + ë¯¸ë˜ ê¸°ìˆ  + ìˆ˜ì§‘ ì„œë²„
        SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys",
            "Quantum_Compute", "Bio_Tech", "Space_Ops", "Nano_Bot", "Fusion_Energy",
            "Genomic_Seq", "Autonomous_Vehicle", "Smart_City", "Drone_Delivery", "Robotics"
        ]
        COLLECTORS = ["Log_Aggregator", "Metric_Beat", "Trace_Collector", "Security_Auditor", "Deep_Packet_Inspector"]

        def safe_makedirs(path):
            if not os.path.exists(path): os.makedirs(path, exist_ok=True)

        def produce_assets():
            print(f"ğŸš€ [FACTORY] Generating {len(SERVICES) + len(COLLECTORS)} Systems...")
            
            # 1. ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ë³´
            safe_makedirs("src/main/java/com/global/core")
            safe_makedirs("src/main/java/com/global/future")
            safe_makedirs("src/main/java/com/global/collection")
            safe_makedirs("docs/images")
            safe_makedirs("cpp_core")
            safe_makedirs("bin") # [ì¤‘ìš”] Python ë ˆë²¨ì—ì„œë„ ìƒì„±

            # 2. Java ì½”ë“œ ìƒì„±
            all_svcs = SERVICES + COLLECTORS
            for svc in all_svcs:
                # ë¶„ë¥˜
                if svc in SERVICES:
                    kind = 'future' if svc in ["Quantum_Compute", "Bio_Tech"] else 'core'
                else:
                    kind = 'collection'
                
                base = f"src/main/java/com/global/{kind}/{svc.lower()}"
                safe_makedirs(base)
                
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.{kind}.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Active\"); }} }}")

            # 3. ì•„í‚¤í…ì²˜ ì‹œê°í™” (ì´ë¯¸ì§€ ìƒì„±)
            try:
                img = Image.new('RGB', (600, 300), color=(10, 20, 40))
                d = ImageDraw.Draw(img)
                d.rectangle([(20, 20), (580, 280)], outline="cyan", width=2)
                d.text((50, 50), f"Global System v{datetime.datetime.now().year}", fill="white")
                d.text((50, 100), f"Active Nodes: {len(all_svcs)}", fill="green")
                d.text((50, 150), "Status: SELF-HEALING ACTIVE", fill="yellow")
                img.save("docs/images/architecture_v2.png")
            except: pass

            # 4. C++ ì—”ì§„ ì†ŒìŠ¤
            with open("cpp_core/crypto.cpp", "w") as f:
                f.write('#include <iostream>\n#include <string>\n')
                f.write('int main(int argc, char* argv[]) { std::cout << "Crypto Engine v2.0 Online" << std::endl; return 0; }')

        if __name__ == "__main__":
            produce_assets()
        EOF

        # 3. ìê°€ ë³µêµ¬í˜• ë°°í¬ ì‹œë®¬ë ˆì´í„°
        cat <<'EOF' > ops_scripts/deploy_simulator.py
        import http.server, socketserver, threading, time, os, sys
        
        def run_sim():
            print("ğŸŒ [DEPLOY] Starting Self-Healing Server Farm...")
            if not os.path.exists("deploy_root"): os.makedirs("deploy_root")
            os.chdir("deploy_root")
            
            # í¬íŠ¸ ì¶©ëŒ ì‹œ ìë™ ìš°íšŒ ë¡œì§
            def start_node(p):
                retries = 3
                current_port = p
                while retries > 0:
                    try:
                        with socketserver.TCPServer(("", current_port), http.server.SimpleHTTPRequestHandler) as h:
                            h.serve_forever()
                        break
                    except OSError:
                        print(f"âš ï¸ Port {current_port} busy, healing...")
                        current_port += 100 # í¬íŠ¸ ë³€ê²½
                        retries -= 1
            
            # 20ê°œ ë…¸ë“œ ê¸°ë™
            for p in range(8000, 8020):
                t = threading.Thread(target=start_node, args=(p,))
                t.daemon = True
                t.start()
            
            time.sleep(5)
            print("âœ… [DEPLOY] 20+ Nodes Active.")

        if __name__ == "__main__":
            run_sim()
        EOF

        # 4. ë³´ì•ˆ ì¸ì í„°
        cat <<'EOF' > ops_scripts/security_injector.py
        import os, datetime
        HEADER = f"// (C) {datetime.datetime.now().year} FUTURE OPS. SECURE.\n"
        def inject():
            for root, dirs, files in os.walk("."):
                if any(x in root for x in ["bin", ".git", "docs"]): continue
                for file in files:
                    if file.endswith(('.java', '.cpp')):
                        try:
                            path = os.path.join(root, file)
                            with open(path, 'r+', encoding='utf-8') as f:
                                c = f.read()
                                if "FUTURE OPS" not in c:
                                    f.seek(0, 0)
                                    f.write(HEADER + c)
                        except: pass
        if __name__ == "__main__": inject()
        EOF

    # ----------------------------------------------------------------
    # [Step 4] ì˜ì¡´ì„± ì„¤ì¹˜ & CodeQL Init
    # ----------------------------------------------------------------
    - name: ğŸ“¦ [5] Install Deps
      run: pip install -r ops_scripts/requirements.txt

    - name: ğŸ›¡ï¸ [6] CodeQL Init
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python

    # ----------------------------------------------------------------
    # [Step 5] íŒ©í† ë¦¬ ê°€ë™ (íŒŒì¼ ìƒì„±)
    # ----------------------------------------------------------------
    - name: ğŸ­ [7] Execute Factory
      run: |
        python ops_scripts/factory_manager.py
        python ops_scripts/security_injector.py

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ (ì—ëŸ¬ ì™„ë²½ ìˆ˜ì •: mkdir -p bin ì¶”ê°€)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [8] Build System (Robust)
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ BUILDING BINARIES & SERVICES..."
        echo "=========================================="
        
        # [CRITICAL FIX] ì¶œë ¥ ë””ë ‰í† ë¦¬ ê°•ì œ ìƒì„± (ld ì—ëŸ¬ ë°©ì§€)
        mkdir -p bin
        mkdir -p deploy_root
        
        # 1. C++ ì»´íŒŒì¼ (ì´ì œ bin í´ë”ê°€ í™•ì‹¤íˆ ì¡´ì¬í•¨)
        echo "ğŸ” Compiling C++ Crypto Engine..."
        g++ -o bin/Crypto cpp_core/crypto.cpp
        
        # 2. Java ì»´íŒŒì¼ (ëŒ€ëŸ‰ ì†ŒìŠ¤)
        echo "â˜• Compiling 30+ Services..."
        find src -name "*.java" > sources.txt
        javac -nowarn -d bin @sources.txt
        
        # 3. íŒ¨í‚¤ì§• (JAR)
        echo "ğŸ“¦ Packaging Artifacts..."
        jar cf bin/CoreServices.jar -C bin .
        
        # ë°°í¬ìš© íŒŒì¼ ë³µì‚¬
        cp bin/*.jar deploy_root/
        cp bin/Crypto deploy_root/
        
        echo "âœ… Build Complete."

    # ----------------------------------------------------------------
    # [Step 7] Docker ì´ë¯¸ì§€ ë¹Œë“œ (ê³µê°„ ì ˆì•½ ëª¨ë“œ)
    # ----------------------------------------------------------------
    - name: ğŸ³ [9] Build Containers
      if: runner.os == 'Linux'
      shell: bash
      run: |
        echo "FROM scratch" > Dockerfile
        docker build -t global/future-tech:latest .
        docker rmi global/future-tech:latest # ì¦‰ì‹œ ì‚­ì œë¡œ ê³µê°„ í™•ë³´

    # ----------------------------------------------------------------
    # [Step 8] ìê°€ ë³µêµ¬í˜• ë°°í¬ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [10] Run Self-Healing Sim
      run: python ops_scripts/deploy_simulator.py

    # ----------------------------------------------------------------
    # [Step 9] ëŒ€ì‹œë³´ë“œ ìƒì„±
    # ----------------------------------------------------------------
    - name: ğŸ“Š [11] Generate Dashboard
      shell: bash
      run: |
        JAR_SZ=$(du -sh bin/CoreServices.jar | cut -f1)
        IMG_COUNT=$(ls docs/images/*.png | wc -l)
        
        cat <<EOF > ops_dashboard.html
        <html><body><h1>Future Ops Status</h1><p>Core Jar: $JAR_SZ</p><p>Images: $IMG_COUNT</p></body></html>
        EOF
        
        echo "## ğŸ’ Perfect Ops Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Services** | 30+ (Quantum, Bio, etc) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Build Status** | âœ… Success (bin/Crypto created) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Self-Healing** | âœ… Active |" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------------------
    # [Step 10] CodeQL ë¶„ì„ (Push ì „ ìˆ˜í–‰)
    # ----------------------------------------------------------------
    - name: ğŸ” [12] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 11] SCM Sync (Rebase & Autostash)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [13] Robust SCM Sync
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        echo "ğŸ”„ STARTING SCM SYNC..."
        git config --global user.name "Future-Bot"
        git config --global user.email "bot@future.com"
        
        # ê°•ì œ ì¶”ê°€
        git add -A
        git add -f ops_scripts/ src/ docs/ bin/Crypto* *.html
        
        if git diff --staged --quiet; then
            echo "âœ… No changes."
        else
            git commit -m "ğŸ’ Factory Update: Future Tech & Self-Healing [skip ci]"
            
            # Rebase Loop
            for i in {1..5}; do
                echo "Attempt $i..."
                git pull --rebase --autostash origin main && git push origin main && break || sleep 5
            done
        fi

    # ----------------------------------------------------------------
    # [Step 12] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ìµœì í™”)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [14] Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ops_dashboard.html
          ops_scripts/
          bin/
          src/
          docs/
        retention-days: 1
        compression-level: 9
