name: ğŸš€ Full-Force Cross-Platform Build System

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# ì „ì—­ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì¸ì½”ë”© ë¬¸ì œ ì›ì²œ ì°¨ë‹¨)
env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1

jobs:
  build-and-execute:
    name: ğŸ”¥ Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-artifacts
          - os: windows-latest
            artifact_name: windows-artifacts
          - os: macos-latest
            artifact_name: macos-artifacts

    steps:
    # ----------------------------------------------------------------
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # 2. Python ì…‹ì—…
    # ----------------------------------------------------------------
    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # ----------------------------------------------------------------
    # 3. [í•µì‹¬] ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¬´ì¡°ê±´ ê°•ì œ ìƒì„± (Skip ì—†ìŒ)
    #    Windows í˜¸í™˜ì„±ì„ ìœ„í•´ encoding='utf-8' ëª…ì‹œ
    # ----------------------------------------------------------------
    - name: ğŸ“ Force Generate All Scripts (No Skip)
      shell: bash
      run: |
        echo "ğŸ”¥ Force creating requirements.txt..."
        echo "colorama" > requirements.txt

        echo "ğŸ”¥ Force creating upgrade_manager.py with UTF-8 support..."
        cat <<EOF > upgrade_manager.py
        import os
        import sys

        # ì¸ì½”ë”© ë¬¸ì œ ë°©ì§€ìš© UTF-8 ì„¤ì •
        sys.stdout.reconfigure(encoding='utf-8')

        def create_cpp_files():
            print("[MANAGER] ğŸš€ Generating C++20 Source Code...")
            
            # ë©”ì¸ ì†ŒìŠ¤ì½”ë“œ (ì´ëª¨ì§€ í¬í•¨)
            main_code = """
        #include <iostream>
        #include <vector>
        #include <string>

        int main() {
            // Windows ì½˜ì†” ì¶œë ¥ì„ ìœ„í•œ ì½”ë“œ í˜ì´ì§€ ì„¤ì • (ì„ íƒì )
            #ifdef _WIN32
            system("chcp 65001");
            #endif

            std::cout << "ğŸš€ Professional C++ Build Successful!" << std::endl;
            std::cout << "os: Processed by GitHub Actions Matrix" << std::endl;
            return 0;
        }
            """
            
            # CMakeLists.txt
            cmake_code = """
        cmake_minimum_required(VERSION 3.10)
        project(ProfessionalBuild)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            # [FIX] encoding='utf-8' ì¶”ê°€í•˜ì—¬ Windows ì—ëŸ¬ í•´ê²°
            print("[MANAGER] Writing main.cpp...")
            with open("main.cpp", "w", encoding="utf-8") as f:
                f.write(main_code)
            
            print("[MANAGER] Writing CMakeLists.txt...")
            with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                f.write(cmake_code)
                
            print("[MANAGER] âœ… All files generated successfully.")

        if __name__ == "__main__":
            create_cpp_files()
        EOF

    # ----------------------------------------------------------------
    # 4. ì˜ì¡´ì„± ì„¤ì¹˜ ë° Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    # ----------------------------------------------------------------
    - name: ğŸ“¦ Install & Run Generator
      shell: bash
      run: |
        pip install -r requirements.txt
        python upgrade_manager.py

    # ----------------------------------------------------------------
    # 5. C++ ë¹Œë“œ ë„êµ¬ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Build Environment (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: ğŸ› ï¸ Setup Build Environment (Windows)
      if: matrix.os == 'windows-latest'
      uses: microsoft/setup-msbuild@v1.1

    # ----------------------------------------------------------------
    # 6. CMake ë¹Œë“œ ë° ì‹¤í–‰ (ëª¨ë‘ ì‹¤í–‰)
    # ----------------------------------------------------------------
    - name: ğŸ—ï¸ CMake Configure
      shell: bash
      run: cmake -S . -B build

    - name: ğŸ”¨ Build Project
      shell: bash
      run: cmake --build build --config Release

    - name: ğŸ§ª Run Application (Linux/Mac)
      if: runner.os != 'Windows'
      run: ./build/app

    - name: ğŸ§ª Run Application (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: build\Release\app.exe

    # ----------------------------------------------------------------
    # 7. ëª¨ë“  ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload All Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          *.cpp
          *.txt
          *.py
        retention-days: 1
