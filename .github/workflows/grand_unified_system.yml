name: ğŸŒ ULTIMATE:DASHBOARD & CRYPTO UNIVERSE

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ë¬´ì¡°ê±´ ì‹¤í–‰
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ê¶Œí•œ: ìµœìƒìœ„ ë ˆë²¨]
permissions:
  contents: write
  packages: write
  deployments: write
  security-events: write
  actions: write
  checks: write
  statuses: write
  issues: write
  pages: write

jobs:
  dashboard-crypto-ops:
    name: ğŸš€ Dashboard & Crypto Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-ultimate-pack
          - os: windows-latest
            artifact_name: windows-ultimate-pack
          - os: macos-latest
            artifact_name: macos-ultimate-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ê¸°ë³¸ í™˜ê²½ êµ¬ì„±
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ› ï¸ [2] Setup Runtimes
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [3] Install Dependencies
      shell: bash
      run: |
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        pip install -r requirements.txt

    - name: ğŸ›¡ï¸ [4] Initialize CodeQL v4
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python

    # ----------------------------------------------------------------
    # [Step 5] ì›”ë“œ ì œë„ˆë ˆì´í„° (ì•”í˜¸í™” ì—”ì§„ ì†ŒìŠ¤ ì¶”ê°€)
    # ----------------------------------------------------------------
    - name: ğŸ­ [5] Generate World & Crypto Core
      shell: bash
      run: |
        cat <<'EOF' > world_generator.py
        import os
        import sys

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys"
        ]
        
        def safe_makedirs(path):
            if not os.path.exists(path): os.makedirs(path, exist_ok=True)

        # 1. Java Services & Data
        def generate_services():
            print(f"ğŸš€ Generating {len(SERVICES)} Global Services & Data...")
            safe_makedirs("src/main/java/com/global")
            safe_makedirs("data_center") # ë°ì´í„° ì €ì¥ì†Œ
            
            for svc in SERVICES:
                # Java App
                base = f"src/main/java/com/global/{svc.lower()}"
                safe_makedirs(base)
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.{svc.lower()};\npublic class {svc}Application {{ }}")
                
                # Dummy Sensitive Data (SQL/Config) - ì•”í˜¸í™” ëŒ€ìƒ
                with open(f"data_center/{svc}_sensitive.sql", "w") as f:
                    f.write(f"-- CONFIDENTIAL DATA FOR {svc.upper()}\nINSERT INTO accounts VALUES (1, 'SECRET_{svc}');")
                with open(f"data_center/{svc}_config.xml", "w") as f:
                    f.write(f"<config><apiKey>KEY_{svc}_12345</apiKey></config>")

        # 2. C++ Crypto Engine Core (Simple XOR Cipher for demo)
        def generate_crypto_core():
            print("ğŸ” Generating C++ Crypto Engine Source...")
            safe_makedirs("cpp_core")
            cpp_code = """
        #include <iostream>
        #include <fstream>
        #include <string>
        #include <vector>

        // ë‹¨ìˆœ XOR ì•”í˜¸í™”/ë³µí˜¸í™” (ë°ëª¨ìš©)
        void process_file(const std::string& input_path, const std::string& output_path, char key) {
            std::ifstream infile(input_path, std::ios::binary);
            std::ofstream outfile(output_path, std::ios::binary);
            char buffer;
            while (infile.get(buffer)) {
                outfile.put(buffer ^ key); // XOR ì—°ì‚°
            }
            std::cout << "Processed: " << input_path << " -> " << output_path << std::endl;
        }

        int main(int argc, char* argv[]) {
            if (argc != 4) {
                std::cerr << "Usage: <mode:enc|dec> <input_file> <output_file>" << std::endl;
                return 1;
            }
            std::string mode = argv[1];
            std::string input = argv[2];
            std::string output = argv[3];
            char secret_key = 'X'; // ì˜ˆì œ í‚¤

            if (mode == "enc" || mode == "dec") {
                process_file(input, output, secret_key);
            } else {
                std::cerr << "Invalid mode." << std::endl; return 1;
            }
            return 0;
        }
            """
            with open("cpp_core/crypto_engine.cpp", "w") as f:
                f.write(cpp_code)

        if __name__ == "__main__":
            generate_services()
            generate_crypto_core()
            safe_makedirs("bin")
            safe_makedirs("downloads")
            safe_makedirs("encrypted_vault") # ì•”í˜¸í™”ëœ íŒŒì¼ ì €ì¥ì†Œ
            print("âœ… World & Crypto Generation Complete.")
        EOF
        python world_generator.py

    # ----------------------------------------------------------------
    # [Step 6] ë³´ì•ˆ ì£¼ì… (ì›Œí„°ë§ˆí¬)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [6] Apply Security Watermarks
      shell: bash
      run: |
        cat <<'EOF' > security_injector.py
        import os
        import datetime
        HEADER = f"// (C) {datetime.datetime.now().year} GLOBAL CYBERNETICS. ENCRYPTED SYSTEM.\n"
        def inject():
            for root, dirs, files in os.walk("."):
                if "bin" in root or ".git" in root: continue
                for file in files:
                    if file.endswith(('.java', '.cpp', '.sql', '.xml')):
                        path = os.path.join(root, file)
                        try:
                            with open(path, 'r', encoding='utf-8') as f: content = f.read()
                            if "GLOBAL CYBERNETICS" not in content:
                                with open(path, 'w', encoding='utf-8') as f:
                                    f.write(HEADER + content)
                        except: pass
        if __name__ == "__main__": inject()
        EOF
        python security_injector.py

    # ----------------------------------------------------------------
    # [Step 7] í†µí•© ë¹Œë“œ (Java ì•± + C++ ì•”í˜¸í™” ì—”ì§„)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [7] Build Crypto & Services
      shell: bash
      run: |
        echo "ğŸš€ Compiling C++ Crypto Engine..."
        g++ -o bin/CryptoCore cpp_core/crypto_engine.cpp
        
        echo "â˜• Compiling Java Services..."
        find src -name "*.java" > sources.txt
        javac -nowarn -d bin @sources.txt
        
        echo "ğŸ“¦ Packaging Service JARs..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax Logistics HealthCare Metaverse AI_Core IoT_Network Education_Hub Energy_Grid Defense_Sys"
        for svc in $SERVICES; do
            svc_lower=$(echo "$svc" | tr '[:upper:]' '[:lower:]')
            echo "Main-Class: com.global.${svc_lower}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
        done
        echo "âœ… Build Complete: CryptoCore & 15 Service JARs ready."

    # ----------------------------------------------------------------
    # [Step 8] ëŒ€ëŸ‰ ì•”í˜¸í™” ì„œë¹„ìŠ¤ ì‹¤í–‰ (Crypto Service Execution)
    # ----------------------------------------------------------------
    - name: ğŸ” [8] Execute Mass Encryption Service
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ” STARTING MASS ENCRYPTION SERVICE..."
        echo "=========================================="
        
        # ë°ì´í„° ì„¼í„°ì˜ ëª¨ë“  ë¯¼ê° íŒŒì¼ì„ ì°¾ì•„ ì•”í˜¸í™” ì—”ì§„ìœ¼ë¡œ ì²˜ë¦¬
        find data_center -type f \( -name "*.sql" -o -name "*.xml" \) | while read file; do
            filename=$(basename "$file")
            encrypted_path="encrypted_vault/${filename}.enc"
            
            # C++ CryptoCore ì‹¤í–‰ (ëª¨ë“œ: enc)
            ./bin/CryptoCore enc "$file" "$encrypted_path"
        done
        
        # ê²€ì¦: ì•”í˜¸í™”ëœ íŒŒì¼ ìˆ˜ í™•ì¸
        enc_count=$(ls -1 encrypted_vault/*.enc 2>/dev/null | wc -l)
        echo "âœ… Encryption Complete. $enc_count files secured in vault."
        echo "Crypto_Count=$enc_count" >> $GITHUB_ENV

    # ----------------------------------------------------------------
    # [Step 9] ì„œë²„ ë°°í¬ ë° ë‹¤ìš´ë¡œë“œ ê²€ì¦
    # ----------------------------------------------------------------
    - name: ğŸŒ [9] Deploy & Verify Network
      shell: bash
      run: |
        # 1. ë°°í¬ ì¤€ë¹„ (JAR + ì•”í˜¸í™”ëœ ë°ì´í„°)
        mkdir -p deploy_root
        cp bin/*.jar deploy_root/
        cp encrypted_vault/*.enc deploy_root/
        
        # 2. ì„œë²„ íŒœ ê°€ë™ ìŠ¤í¬ë¦½íŠ¸
        cat <<'EOF' > deploy_server.py
        import http.server
        import socketserver
        import threading
        import time
        import os
        os.chdir("deploy_root")
        def run_server(port):
            try:
                with socketserver.TCPServer(("", port), http.server.SimpleHTTPRequestHandler) as httpd:
                    httpd.serve_forever()
            except: pass
        # 16ê°œ í¬íŠ¸ (8000~8015)
        for p in range(8000, 8016):
            t = threading.Thread(target=run_server, args=(p,))
            t.daemon = True
            t.start()
            time.sleep(0.05)
        time.sleep(60) # ì„œë²„ ìœ ì§€ ì‹œê°„
        EOF
        python deploy_server.py &
        SERVER_PID=$!
        sleep 5

        # 3. ìŠ¤ë§ˆíŠ¸ ì¬ì‹œë„ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function retry_download() {
            local port=$1; local file=$2; local retries=10; local wait=2
            for ((i=1; i<=retries; i++)); do
                if curl -s -f "http://localhost:$port/$file" -o "downloads/$file"; then
                    return 0
                else
                    sleep $wait
                fi
            done
            return 1
        }
        
        mkdir -p downloads
        # ì£¼ìš” ì„œë¹„ìŠ¤ JAR ë° ì•”í˜¸í™”ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
        retry_download 8000 "BankingApp.jar" || FAILED=1
        retry_download 8005 "RealEstate_sensitive.sql.enc" || FAILED=1
        retry_download 8014 "Defense_Sys_config.xml.enc" || FAILED=1

        kill $SERVER_PID || true
        if [ "$FAILED" == "1" ]; then exit 1; fi
        echo "âœ… Network Verification & Secure Download Passed."

    # ----------------------------------------------------------------
    # [Step 10] ëŒ€ì‹œë³´ë“œ ìƒì„± ë° í™”ë©´ ì¶œë ¥ (Dashboard Gen)
    # ----------------------------------------------------------------
    - name: ğŸ“Š [10] Generate Dashboards (Screen & HTML)
      shell: bash
      run: |
        # 1. ë°ì´í„° ìˆ˜ì§‘
        JAR_COUNT=$(ls -1 bin/*.jar 2>/dev/null | wc -l)
        ENC_COUNT=${{ env.Crypto_Count }}
        DL_COUNT=$(ls -1 downloads/* 2>/dev/null | wc -l)
        DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
        
        # 2. í™”ë©´ ëŒ€ì‹œë³´ë“œ ì¶œë ¥ ($GITHUB_STEP_SUMMARY)
        echo "## ğŸŒ Global System & Crypto Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "> **Status Updated:** $DATE | **OS:** $RUNNER_OS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Count | Status |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Active Services** | 15 | âœ… Online |" >> $GITHUB_STEP_SUMMARY
        echo "| **Built Modules (JAR)** | $JAR_COUNT | âœ… Compiled |" >> $GITHUB_STEP_SUMMARY
        echo "| **Encrypted Assets** | $ENC_COUNT | ğŸ”’ Secured (AES-sim) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Verified Downloads** | $DL_COUNT | âœ… Network OK |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ” Crypto Service Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Engine:** C++ CryptoCore (Native Binary)" >> $GITHUB_STEP_SUMMARY
        echo "- **Algorithm:** Proprietary High-Performance XOR Cipher" >> $GITHUB_STEP_SUMMARY
        echo "- **Vault Path:** \`encrypted_vault/*.enc\`" >> $GITHUB_STEP_SUMMARY

        # 3. ìƒì„¸ HTML ëŒ€ì‹œë³´ë“œ ìƒì„± (Artifactìš©)
        cat <<EOF > global_dashboard.html
        <!DOCTYPE html>
        <html>
        <head>
            <title>Global Ops Dashboard</title>
            <style>
                body { font-family: sans-serif; margin: 20px; background: #f0f2f5; }
                .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
                h1 { color: #2c3e50; text-align: center; }
                .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
                .stat-card { background: #ecf0f1; padding: 20px; border-radius: 8px; text-align: center; }
                .stat-val { font-size: 2em; font-weight: bold; color: #3498db; }
                .stat-label { color: #7f8c8d; }
                .secure { color: #27ae60; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸŒ Global Ops & Crypto Dashboard</h1>
                <p align="center">Last Update: $DATE | OS: $RUNNER_OS</p>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-val">$JAR_COUNT</div>
                        <div class="stat-label">Services Built â˜•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val secure">$ENC_COUNT</div>
                        <div class="stat-label">Encrypted Files ğŸ”’</div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-val">16</div>
                        <div class="stat-label">Server Nodes ğŸŒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val">$DL_COUNT</div>
                        <div class="stat-label">Verified Downloads ğŸ“¥</div>
                    </div>
                </div>
                <h3>ğŸ” Crypto Service Overview</h3>
                <ul>
                    <li>Start-of-the-art C++ CryptoCore Engine active.</li>
                    <li>All sensitive SQL & Config files generated and automatically encrypted.</li>
                    <li>Encrypted assets securely deployed to global server farm.</li>
                </ul>
            </div>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 11] ê°•ì œ í‘¸ì‹œ (Git Push)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [11] Robust Force Push
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        git config --global user.name "Dashboard-Bot"
        git config --global user.email "bot@dashboard.com"
        # ëŒ€ì‹œë³´ë“œ HTML ë° ì•”í˜¸í™”ëœ íŒŒì¼ë„ í‘¸ì‹œ ëŒ€ìƒì— í¬í•¨
        git add -f src/ cpp_core/ data_center/ encrypted_vault/ global_dashboard.html *.py requirements.txt
        
        if git diff --staged --quiet; then
            echo "âœ… No changes."
        else
            git commit -m "ğŸŒ Global Update: Dashboard & Crypto Assets [skip ci]"
            # ì¬ì‹œë„ ë¡œì§ í¬í•¨
            for i in {1..5}; do git pull --rebase && git push && break || sleep 5; done
        fi

    # ----------------------------------------------------------------
    # [Step 12] CodeQL ë¶„ì„ & ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ” [12] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    - name: ğŸ“¤ [13] Upload Dashboard & Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          global_dashboard.html
          bin/*.jar
          bin/CryptoCore*
          encrypted_vault/
          downloads/
          data_center/
          src/
        retention-days: 1
