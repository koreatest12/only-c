name: ğŸ’ FIXED:CODEQL MIXED MODE & MASSIVE DEPLOY

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ì¤‘ìš”] ê¶Œí•œ ëŒ€ëŸ‰ ë°˜ì˜ (Git Push, CodeQL, ë°°í¬ ë“±)
permissions:
  contents: write
  packages: write
  deployments: write
  security-events: write
  actions: write
  checks: write
  statuses: write
  issues: write

jobs:
  grand-universe-fix:
    name: ğŸš€ Grand Universe Fix on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-universe-pack
          - os: windows-latest
            artifact_name: windows-universe-pack
          - os: macos-latest
            artifact_name: macos-universe-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì²´í¬ì•„ì›ƒ (ì „ì²´ íˆìŠ¤í† ë¦¬ ë° í† í° ì‚¬ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ì˜ì¡´ì„± íŒŒì¼ ì„ í–‰ ìƒì„± (Setup-Python ìºì‹œ ì—ëŸ¬ ë°©ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Pre-Create Requirements
      shell: bash
      run: |
        echo "Creating requirements.txt..."
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "tqdm" >> requirements.txt
        echo "âœ… requirements.txt created."

    # ----------------------------------------------------------------
    # [Step 3] í™˜ê²½ ì„¤ì • (Java 17 & Python 3.10)
    # ----------------------------------------------------------------
    - name: â˜• [3] Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [4] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4-Post] Install Dependencies
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] CodeQL ì´ˆê¸°í™” (ì—ëŸ¬ ìˆ˜ì • ì™„ë£Œ)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [5] Initialize CodeQL v4
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python
        # [CRITICAL FIX] build-mode: manual ì˜µì…˜ ì‚­ì œ
        # Pythonì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ ì˜µì…˜ì„ ì“°ë©´ ì•ˆ ë©ë‹ˆë‹¤.
        # CodeQLì´ ìë™ìœ¼ë¡œ Java/C++ ë¹Œë“œ ëª…ë ¹ì„ ê°ì§€í•˜ê³  Pythonì„ ìŠ¤ìº”í•©ë‹ˆë‹¤.

    # ----------------------------------------------------------------
    # [Step 5] ì´ˆëŒ€í˜• ìƒì„±ê¸° (7ëŒ€ ì„œë¹„ìŠ¤ + êµ¬ì¡° ìƒì„±)
    # ----------------------------------------------------------------
    - name: ğŸ­ [6] Run Universe Generator
      shell: bash
      run: |
        cat <<EOF > universe_generator.py
        import os
        import sys
        import sqlite3
        import random

        sys.stdout.reconfigure(encoding='utf-8')

        SERVICES = ["Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax"]
        
        def safe_makedirs(path):
            if not os.path.exists(path):
                os.makedirs(path, exist_ok=True)

        def log(msg):
            print(f"[GEN] {msg}")

        # 1. Java ì†ŒìŠ¤ ëŒ€ëŸ‰ ìƒì„± (ì„œë¹„ìŠ¤ë‹¹ 30ê°œ í´ë˜ìŠ¤)
        def generate_java_ecosystem():
            log("â˜• Generating Java Sources for 7 Services...")
            safe_makedirs("src/main/java/com/enterprise")
            
            for svc in SERVICES:
                base = f"src/main/java/com/enterprise/{svc.lower()}"
                safe_makedirs(base)
                
                # Main Application
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} System Online\"); }} }}")
                
                # Components
                for i in range(1, 31):
                    with open(f"{base}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Controller{i} {{ public String status() {{ return \"Active\"; }} }}")

        # 2. ë°ì´í„° ìŠ¤í‚¤ë§ˆ (SQL)
        def generate_sql_assets():
            log("ğŸ—ƒï¸ Generating SQL Assets...")
            safe_makedirs("database_store")
            for svc in SERVICES:
                with open(f"database_store/{svc}_schema.sql", "w") as f:
                    f.write(f"-- Schema for {svc}\\nCREATE TABLE {svc}_records (id INT, data TEXT);\\n")

        # 3. ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸
        def generate_ops_scripts():
            log("ğŸ“œ Generating Ops Scripts...")
            safe_makedirs("ops_scripts")
            for svc in SERVICES:
                with open(f"ops_scripts/deploy_{svc}.sh", "w") as f:
                    f.write(f"#!/bin/bash\\necho Deploying {svc} Service...")

        # 4. C++ ê³ ì„±ëŠ¥ ì—”ì§„
        def generate_cpp_core():
            log("ğŸš€ Generating C++ Core Engine...")
            safe_makedirs("cpp_core")
            with open("cpp_core/engine.cpp", "w") as f:
                f.write('#include <iostream>\\nint main() { std::cout << "Core Engine Ready" << std::endl; return 0; }')

        if __name__ == "__main__":
            generate_java_ecosystem()
            generate_sql_assets()
            generate_ops_scripts()
            generate_cpp_core()
            # [ì¤‘ìš”] ë¹Œë“œ í´ë” ë¯¸ë¦¬ ìƒì„±í•˜ì—¬ 'Artifact not found' ì—ëŸ¬ ë°©ì§€
            safe_makedirs("bin")
            safe_makedirs("downloads")
            log("âœ… All Generators Completed.")
        EOF
        
        # ì‹¤í–‰
        python universe_generator.py

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ ì‹¤í–‰ (CodeQL ì¶”ì  ëŒ€ìƒ)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [7] Build Everything
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ BUILDING SOURCE CODE..."
        echo "=========================================="
        
        # 1. Java ì»´íŒŒì¼
        echo "â˜• Compiling Java Sources..."
        find src -name "*.java" > sources.txt
        javac -d bin @sources.txt
        
        # 2. Jar íŒ¨í‚¤ì§• (ë¹ˆ íŒŒì¼ ì—ëŸ¬ ë°©ì§€ìš©)
        echo "ğŸ“¦ Packaging JARs..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax"
        for svc in $SERVICES; do
            echo "Main-Class: com.enterprise.${svc,,}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
        done
        
        # 3. C++ ì»´íŒŒì¼
        echo "ğŸš€ Compiling C++ Engine..."
        g++ -o bin/CoreEngine cpp_core/engine.cpp
        
        echo "âœ… Build Completed Successfully."

    # ----------------------------------------------------------------
    # [Step 7] GitHub ì €ì¥ì†Œ ìë™ ì—…ë¡œë“œ (Git Push)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [8] Auto-Upload to Repository
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸš€ PUSHING GENERATED FILES TO REPO..."
        echo "=========================================="
        
        git config --global user.name "Enterprise-Bot"
        git config --global user.email "bot@enterprise.com"
        
        # ìƒì„±ëœ ì†ŒìŠ¤ì½”ë“œ ë° ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
        git add src/ cpp_core/ ops_scripts/ database_store/*.sql universe_generator.py requirements.txt
        
        # ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --staged --quiet; then
            echo "âœ… No changes to commit."
        else
            echo "ğŸ“ Committing changes..."
            git commit -m "ğŸš€ Auto-Deploy: 7-Service Enterprise Source Code [skip ci]"
            
            echo "ğŸ“¤ Pushing..."
            git push
            echo "âœ… Push Complete."
        fi

    # ----------------------------------------------------------------
    # [Step 8] ê³µì‹ ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [9] Verify Official Download
      shell: bash
      run: |
        echo "ğŸŒ Launching Verification Server..."
        mkdir -p dist_server
        cp bin/*.jar dist_server/
        
        # ë‹¤ìš´ë¡œë“œ í´ë” í™•ì‹¤í•˜ê²Œ ìƒì„±
        mkdir -p downloads
        
        cd dist_server
        python3 -m http.server 8000 &
        PID=$!
        cd ..
        
        sleep 5
        echo "â¬‡ï¸ Downloading CryptoApp.jar..."
        curl -f http://localhost:8000/CryptoApp.jar -o downloads/CryptoApp.jar
        
        kill $PID || true
        
        if [ -f "downloads/CryptoApp.jar" ]; then
            echo "âœ… Official Download Verified."
        else
            echo "âŒ Download Verification Failed."
            # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš° ì „ì²´ê°€ ì£½ì§€ ì•Šë„ë¡ ê²½ê³ ë§Œ í•˜ê³  í†µê³¼ì‹œí‚¬ ìˆ˜ë„ ìˆìœ¼ë‚˜
            # ì—¬ê¸°ì„œëŠ” í™•ì‹¤í•œ ê²€ì¦ì„ ìœ„í•´ exit 1 ìœ ì§€ (ë¹Œë“œê°€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ íŒŒì¼ì€ ë°˜ë“œì‹œ ìˆìŒ)
            exit 1
        fi

    # ----------------------------------------------------------------
    # [Step 9] CodeQL ë¶„ì„ (ìˆ˜ë™ ëª¨ë“œ í•´ì œë¡œ ì •ìƒ ì‘ë™ ì˜ˆìƒ)
    # ----------------------------------------------------------------
    - name: ğŸ” [10] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 10] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ê²½ë¡œ ì¡´ì¬ ë³´ì¥ë¨)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [11] Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          bin/*.jar
          bin/CoreEngine*
          downloads/
          ops_scripts/
          database_store/
          src/
        retention-days: 1
