name: ğŸš€ ULTIMATE CROSS-PLATFORM BUILD (No Skip)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# [ê¸€ë¡œë²Œ ì„¤ì •] ì¸ì½”ë”© ê°•ì œ ì„¤ì • (Windows ì´ëª¨ì§€ ì—ëŸ¬ ë°©ì§€)
env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8

jobs:
  all-process-execution:
    name: ğŸ”¥ Run All on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-artifacts
          - os: windows-latest
            artifact_name: windows-artifacts
          - os: macos-latest
            artifact_name: macos-artifacts

    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ [Step 1] Checkout Repository
      uses: actions/checkout@v4

    # 2. ì‹œìŠ¤í…œ í™˜ê²½ ì •ë°€ ì§„ë‹¨ (ëŒ€ëŸ‰ ì •ë³´ ì¶œë ¥)
    - name: ğŸ–¥ï¸ [Step 2] System Diagnostic
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ” HOST SYSTEM INFORMATION"
        echo "=========================================="
        echo "OS Details: $(uname -a)" 2>/dev/null || echo "Windows Detected"
        echo "Python Version check..."
        python --version || echo "Python not found yet"
        echo "CMake Version check..."
        cmake --version || echo "CMake not found yet"
        echo "=========================================="

    # 3. Python 3.10 ì„¤ì¹˜
    - name: ğŸ [Step 3] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    # 4. [í•µì‹¬] ëª¨ë“  í•„ìˆ˜ íŒŒì¼ ê°•ì œ ì¬ìƒì„± (ì¡°ê±´ë¬¸ ì—†ìŒ, ë¬´ì¡°ê±´ ë®ì–´ì“°ê¸°)
    - name: ğŸ“ [Step 4] Force Generate Scripts (UTF-8 Safe)
      shell: bash
      run: |
        echo "ğŸ”¥ Force regenerating requirements.txt..."
        echo "colorama" > requirements.txt

        echo "ğŸ”¥ Force regenerating upgrade_manager.py..."
        # Windows ì¸ì½”ë”© ë¬¸ì œë¥¼ ì™„ë²½ í•´ê²°í•œ Python ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
        cat <<EOF > upgrade_manager.py
        import os
        import sys
        import platform

        # 1. í‘œì¤€ ì¶œë ¥(Console) UTF-8 ê°•ì œ ì„¤ì •
        sys.stdout.reconfigure(encoding='utf-8')

        def create_cpp_files():
            print(f"[MANAGER] ğŸš€ Current OS: {platform.system()}")
            print("[MANAGER] ğŸ”„ Generating C++20 Source Files...")
            
            # C++ Source Code (ì´ëª¨ì§€ í¬í•¨)
            main_code = """
        #include <iostream>
        #include <vector>
        #include <string>

        int main() {
            // Windows Console Code Page Fix
            #ifdef _WIN32
            system("chcp 65001 > nul");
            #endif

            std::cout << "========================================" << std::endl;
            std::cout << "ğŸš€ PROFESSIONAL BUILD SUCCESSFUL" << std::endl;
            std::cout << "========================================" << std::endl;
            std::cout << "Target OS: All Platforms (Win/Lin/Mac)" << std::endl;
            return 0;
        }
            """
            
            # CMakeLists.txt
            cmake_code = """
        cmake_minimum_required(VERSION 3.10)
        project(ProfessionalBuild)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            # 2. íŒŒì¼ ì“°ê¸° ì‹œ UTF-8 ì¸ì½”ë”© ëª…ì‹œ (Windows ì—ëŸ¬ í•´ê²° í•µì‹¬)
            try:
                print("[MANAGER] Writing main.cpp...")
                with open("main.cpp", "w", encoding="utf-8") as f:
                    f.write(main_code)
                
                print("[MANAGER] Writing CMakeLists.txt...")
                with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                    f.write(cmake_code)
                    
                print("[MANAGER] âœ… Files generated successfully.")
            except Exception as e:
                print(f"[ERROR] File write failed: {e}")
                exit(1)

        if __name__ == "__main__":
            create_cpp_files()
        EOF

    # 5. ìƒì„±ê¸° ì‹¤í–‰ (ì†ŒìŠ¤ ì½”ë“œ ìƒì„±)
    - name: ğŸš€ [Step 5] Install Deps & Run Generator
      shell: bash
      run: |
        pip install -r requirements.txt
        python upgrade_manager.py

    # 6. ìƒì„±ëœ ì†ŒìŠ¤ í™•ì¸ (ê²€ì¦)
    - name: ğŸ” [Step 6] Verify Source Code
      shell: bash
      run: |
        echo "ğŸ“‚ Current Directory Structure:"
        ls -R
        echo "ğŸ“„ Checking main.cpp content head:"
        head -n 5 main.cpp

    # 7. ë¹Œë“œ ë„êµ¬ ì¤€ë¹„ (OSë³„ ì„¤ì •)
    - name: ğŸ› ï¸ [Step 7] Setup Build Tools
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update && sudo apt-get install -y build-essential cmake
        elif [ "$RUNNER_OS" == "Windows" ]; then
          echo "Windows uses pre-installed MSVC/CMake."
        elif [ "$RUNNER_OS" == "macOS" ]; then
          echo "macOS uses pre-installed Clang/CMake."
        fi

    - name: ğŸ› ï¸ Setup MSVC (Windows Specific)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v1.1

    # 8. CMake ì„¤ì • (Configure)
    - name: ğŸ—ï¸ [Step 8] CMake Configure
      shell: bash
      run: cmake -S . -B build

    # 9. ë¹Œë“œ ì‹¤í–‰ (Build)
    - name: ğŸ”¨ [Step 9] Build Project (Release)
      shell: bash
      run: cmake --build build --config Release

    # 10. ë¹Œë“œëœ í”„ë¡œê·¸ë¨ ì‹¤í–‰ (Run)
    - name: ğŸ§ª [Step 10] Execute Application
      shell: bash
      run: |
        echo "ğŸš€ Executing the built binary..."
        if [ "$RUNNER_OS" == "Windows" ]; then
          ./build/Release/app.exe
        else
          chmod +x ./build/app
          ./build/app
        fi

    # 11. ëª¨ë“  ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    - name: ğŸ“¤ [Step 11] Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          *.cpp
          *.txt
          *.py
        retention-days: 1
