name: ğŸ­ Enterprise Full-Stack Factory

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  enterprise-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì¸í”„ë¼ í´ë¦°ë£¸ (Clean Room)
    # ----------------------------------------------------------------
    - name: ğŸ§¹ Infrastructure Cleanup
      run: |
        echo "ğŸ§¹ Purging disk space for massive production..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "âœ… Infrastructure Cleaned."

    # ----------------------------------------------------------------
    # [Step 2] ëŸ°íƒ€ì„ ë° ì˜ì¡´ì„± ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Python 3.10
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: ğŸ“¦ Install Enterprise Deps
      run: |
        # gunicorn: í”„ë¡œë•ì…˜ìš© WSGI ì„œë²„ ì¶”ê°€
        pip install flask flask-cors gunicorn faker pandas requests jinja2 psutil

    # ----------------------------------------------------------------
    # [Step 3] ğŸ­ ë°±ì—”ë“œ: ëŒ€ëŸ‰ ë°ì´í„° ìƒì‚° ì—”ì§„ (ì—…ê·¸ë ˆì´ë“œ)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Backend Engine (Massive Stream)
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > backend_engine.py
        import os, shutil, json, random, time, uuid
        from datetime import datetime
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        SERVICES = ["Auth_Core", "Billing_Gateway", "Ops_Monitor", "AI_Inference", "Log_Aggregator", "DB_Shard_01", "DB_Shard_02"]
        REGIONS = ["Global_Common", "Asia_Seoul", "US_Virginia", "EU_Frankfurt"]

        def generate_production_data():
            print("ğŸš€ [Backend] Initializing Massive Data Stream...")
            metadata = []
            
            for region in REGIONS:
                for svc in SERVICES:
                    base_path = f"data/{region}/{svc}"
                    os.makedirs(base_path, exist_ok=True)
                    
                    # 1. Transaction Logs (CSV)
                    with open(f"{base_path}/transactions.csv", "w") as f:
                        f.write("id,timestamp,user_id,amount,status,latency_ms\n")
                        for _ in range(500):
                            f.write(f"{uuid.uuid4()},{datetime.now()},{fake.user_name()},{random.uniform(10,999):.2f},SUCCESS,{random.randint(10,200)}\n")
                    
                    # 2. System Metrics (JSON)
                    metrics = {
                        "cpu_usage": random.randint(20, 80),
                        "memory_usage": random.randint(40, 90),
                        "active_threads": random.randint(100, 5000),
                        "uptime_seconds": random.randint(10000, 999999)
                    }
                    with open(f"{base_path}/metrics.json", "w") as f:
                        json.dump(metrics, f, indent=2)

                    # 3. ì••ì¶• ë° ì‚­ì œ
                    zip_name = f"{region}_{svc}"
                    shutil.make_archive(f"{OUTPUT_DIR}/{zip_name}", 'zip', base_path)
                    shutil.rmtree(base_path)
                    
                    metadata.append({
                        "id": str(uuid.uuid4())[:8],
                        "service": svc,
                        "region": region,
                        "status": "Healthy",
                        "size": "Optimized"
                    })

            # Dashboardìš© ë°ì´í„° ë¤í”„
            dashboard_data = {
                "system_status": "OPERATIONAL",
                "last_update": str(datetime.now().strftime("%Y-%m-%d %H:%M:%S")),
                "total_nodes": len(SERVICES) * len(REGIONS),
                "active_alerts": 0,
                "services": metadata
            }
            with open("dashboard_data.json", "w") as f:
                json.dump(dashboard_data, f)
            
            print("âœ… [Backend] Production Data Ready.")

        if __name__ == "__main__": generate_production_data()
        EOF
        
        python backend_engine.py

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ: ì—”í„°í”„ë¼ì´ì¦ˆ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Enterprise Web Portal
      shell: bash
      run: |
        mkdir -p _web_portal/static/css
        mkdir -p _web_portal/templates
        
        # HTML: ì‚¬ì´ë²„í‘í¬/ë‹¤í¬ í…Œë§ˆì˜ ê´€ì œ ëŒ€ì‹œë³´ë“œ
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OPS COMMAND CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                body { background-color: #0b0c10; color: #c5c6c7; font-family: 'Courier New', Courier, monospace; }
                .neon-text { color: #66fcf1; text-shadow: 0 0 5px #45a29e; }
                .card { background-color: #1f2833; border: 1px solid #45a29e; }
                .status-ok { color: #00ff00; }
                .grid-bg { background-image: linear-gradient(#1f2833 1px, transparent 1px), linear-gradient(90deg, #1f2833 1px, transparent 1px); background-size: 20px 20px; opacity: 0.2; position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1;}
            </style>
        </head>
        <body class="h-screen overflow-hidden flex flex-col">
            <div class="grid-bg"></div>
            
            <header class="p-4 border-b border-gray-700 flex justify-between items-center bg-opacity-90 bg-gray-900">
                <h1 class="text-3xl font-bold neon-text">ğŸ­ FACTORY OPS :: COMMAND CENTER</h1>
                <div class="text-right">
                    <p id="clock" class="text-xl font-bold">--:--:--</p>
                    <p class="text-sm text-green-400">SYSTEM NORMAL</p>
                </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto grid grid-cols-4 gap-6">
                <div class="card p-4 rounded col-span-1">
                    <h3 class="text-gray-400 text-sm">TOTAL NODES</h3>
                    <p class="text-4xl font-bold text-white mt-2" id="node-count">Loading...</p>
                </div>
                <div class="card p-4 rounded col-span-1">
                    <h3 class="text-gray-400 text-sm">NETWORK LOAD</h3>
                    <p class="text-4xl font-bold text-blue-400 mt-2">42.5 TB/s</p>
                </div>
                <div class="card p-4 rounded col-span-1">
                    <h3 class="text-gray-400 text-sm">ACTIVE ALERTS</h3>
                    <p class="text-4xl font-bold text-red-500 mt-2">0</p>
                </div>
                <div class="card p-4 rounded col-span-1">
                    <h3 class="text-gray-400 text-sm">UPTIME</h3>
                    <p class="text-4xl font-bold text-green-400 mt-2">99.999%</p>
                </div>

                <div class="card p-4 rounded col-span-2 row-span-2">
                    <h3 class="text-gray-400 mb-4">REAL-TIME THROUGHPUT</h3>
                    <canvas id="mainChart"></canvas>
                </div>

                <div class="card p-4 rounded col-span-2 row-span-2 overflow-y-auto max-h-96">
                    <h3 class="text-gray-400 mb-4">DEPLOYMENT STATUS</h3>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-800 text-cyan-400">
                            <tr>
                                <th class="p-2">ID</th>
                                <th class="p-2">REGION</th>
                                <th class="p-2">SERVICE</th>
                                <th class="p-2">STATUS</th>
                            </tr>
                        </thead>
                        <tbody id="svc-table"></tbody>
                    </table>
                </div>
            </main>

            <script>
                // Clock
                setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);

                // Load Data
                fetch('/api/stats')
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('node-count').innerText = data.total_nodes;
                        const tbody = document.getElementById('svc-table');
                        data.services.forEach(s => {
                            tbody.innerHTML += `<tr class="border-b border-gray-700 hover:bg-gray-800">
                                <td class="p-2 font-mono text-xs">${s.id}</td>
                                <td class="p-2">${s.region}</td>
                                <td class="p-2 font-bold">${s.service}</td>
                                <td class="p-2 status-ok">â— ${s.status}</td>
                            </tr>`;
                        });
                    });

                // Chart
                new Chart(document.getElementById('mainChart'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 10}, (_, i) => i),
                        datasets: [{
                            label: 'I/O Operations',
                            data: Array.from({length: 10}, () => Math.floor(Math.random() * 100)),
                            borderColor: '#66fcf1',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(102, 252, 241, 0.1)'
                        }]
                    },
                    options: { scales: { x: {display:false}, y: {grid: {color: '#333'}} } }
                });
            </script>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 5] ğŸ–¥ï¸ í”„ë¡œë•ì…˜ ì„œë²„ êµ¬ì¶• (Gunicorn + Flask)
    # ----------------------------------------------------------------
    - name: âš™ï¸ Build Production Server
      shell: bash
      run: |
        # 1. Flask App
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify
        import json, os

        app = Flask(__name__)

        @app.route('/')
        def home():
            return render_template('index.html')

        @app.route('/api/stats')
        def stats():
            try:
                with open('../dashboard_data.json', 'r') as f:
                    return jsonify(json.load(f))
            except:
                return jsonify({"error": "No Data"})

        # Gunicornì´ ì°¾ì„ ìˆ˜ ìˆë„ë¡ app ê°ì²´ ë…¸ì¶œ
        application = app 
        EOF

        # 2. Gunicorn Config (í”„ë¡œë•ì…˜ ì„¤ì •)
        cat <<'EOF' > _web_portal/gunicorn_config.py
        bind = "0.0.0.0:5000"
        workers = 2
        threads = 4
        timeout = 30
        loglevel = "info"
        EOF

    # ----------------------------------------------------------------
    # [Step 6] ğŸ§ª ì„œë²„ ê°€ë™ ë° ê²€ì¦ (ì—ëŸ¬ ì™„ë²½ ìˆ˜ì •)
    # ----------------------------------------------------------------
    - name: ğŸš€ Launch & Verify Server
      run: |
        echo "ğŸŸ¢ Starting Gunicorn Server (Production Mode)..."
        cd _web_portal
        
        # Gunicorn ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
        gunicorn -c gunicorn_config.py app:app &
        PID=$!
        
        echo "â³ Waiting for server to initialize..."
        # ìŠ¤ë§ˆíŠ¸ í—¬ìŠ¤ ì²´í¬ ë£¨í”„ (ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°)
        for i in {1..10}; do
          if curl -s http://127.0.0.1:5000/ > /dev/null; then
            echo "âœ… Server is UP!"
            break
          fi
          echo "zzZ... ($i/10)"
          sleep 1
        done
        
        echo "ğŸ” Testing API (Forcing IPv4)..."
        # [ìˆ˜ì •] localhost ëŒ€ì‹  127.0.0.1 ì‚¬ìš© + -4 ì˜µì…˜ìœ¼ë¡œ IPv6 ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨
        curl -4 -v http://127.0.0.1:5000/api/stats
        
        echo "ğŸ” Testing Homepage..."
        curl -4 -I http://127.0.0.1:5000/
        
        echo "âœ… System Verification Passed."
        kill $PID || true

    # ----------------------------------------------------------------
    # [Step 7] ê²°ê³¼ë¬¼ íŒ¨í‚¤ì§• ë° ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload Enterprise Package
      uses: actions/upload-artifact@v4
      with:
        name: enterprise-ops-portal
        path: |
          _web_portal/
          _data_warehouse/
          dashboard_data.json
        retention-days: 1
