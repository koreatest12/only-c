name: ğŸŒ WORLD-SCALE:INFINITE UNIVERSE & SECURITY

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ì „ ì„¸ê³„ ì„œë¹„ìŠ¤ ê°±ì‹ 
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ê¶Œí•œ: ì „ì§€ì „ëŠ¥] ëª¨ë“  ì‘ì—…ì— ëŒ€í•œ ìµœìƒìœ„ ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write           # ì†ŒìŠ¤ì½”ë“œ ìˆ˜ì • ë° í‘¸ì‹œ
  packages: write           # íŒ¨í‚¤ì§€ ë°°í¬
  deployments: write        # ë°°í¬ í™˜ê²½ ê´€ë¦¬
  security-events: write    # ë³´ì•ˆ ë¦¬í¬íŠ¸ ë“±ë¡
  actions: write            # ì•¡ì…˜ ì œì–´
  checks: write             # ì²´í¬ëŸ° ì œì–´
  statuses: write           # ìƒíƒœê°’ ì œì–´
  issues: write             # ì´ìŠˆ ìƒì„±
  pages: write              # í˜ì´ì§€ ë°°í¬
  pull-requests: write      # PR ì œì–´
  id-token: write           # OIDC í† í°

jobs:
  world-scale-ops:
    name: ğŸŒ World Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-world-pack
          - os: windows-latest
            artifact_name: windows-world-pack
          - os: macos-latest
            artifact_name: macos-world-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì „ì²´ ë¦¬ì†ŒìŠ¤ ë° íˆìŠ¤í† ë¦¬ í™•ë³´
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout World Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ì˜ì¡´ì„± íŒŒì¼ ì„ í–‰ ìƒì„± (í•„ìˆ˜)
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Init Requirements
      shell: bash
      run: |
        echo "Creating dependency definition..."
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "tqdm" >> requirements.txt
        echo "âœ… Requirements ready."

    # ----------------------------------------------------------------
    # [Step 3] ê¸€ë¡œë²Œ ëŸ°íƒ€ì„ í™˜ê²½ ì„¤ì •
    # ----------------------------------------------------------------
    - name: â˜• [3] Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [4] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [4-Post] Install Libs
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] CodeQL ë³´ì•ˆ ì—”ì§„ ê°€ë™
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [5] Initialize CodeQL v4
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python
        # Build Mode: Auto-Detect (ìˆ˜ë™ ëª¨ë“œ í•´ì œë¡œ Python ì—ëŸ¬ ë°©ì§€)

    # ----------------------------------------------------------------
    # [Step 5] [WORLD-GEN] ì „ ì„¸ê³„ ì„œë¹„ìŠ¤ ëŒ€ëŸ‰ ìƒì„±ê¸°
    # ----------------------------------------------------------------
    - name: ğŸ­ [6] Run World-Scale Generator
      shell: bash
      run: |
        cat <<'EOF' > world_generator.py
        import os
        import sys
        import sqlite3
        import random

        sys.stdout.reconfigure(encoding='utf-8')

        # [ì „ ì„¸ê³„/ì „ ë¶„ì•¼ ì„œë¹„ìŠ¤ ëª©ë¡ í™•ì¥]
        SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys"
        ]
        
        def safe_makedirs(path):
            if not os.path.exists(path):
                os.makedirs(path, exist_ok=True)

        def log(msg):
            print(f"[WORLD-GEN] {msg}")

        # 1. Full-Stack Ecosystem ìƒì„±
        def generate_ecosystem():
            log(f"ğŸš€ Generating {len(SERVICES)} Global Services...")
            
            # ê²½ë¡œ ìƒì„±
            safe_makedirs("src/main/java/com/global")
            safe_makedirs("src/main/resources/static")
            safe_makedirs("src/main/resources/config")
            safe_makedirs("global_configs")
            
            for svc in SERVICES:
                base = f"src/main/java/com/global/{svc.lower()}"
                safe_makedirs(base)
                
                # Main Application
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Service Global Online\"); }} }}")
                
                # ëŒ€ëŸ‰ íŒŒì¼ ìƒì„± (Controller, Service, DTO)
                for i in range(1, 21):
                    with open(f"{base}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.global.{svc.lower()};\npublic class {svc}Controller{i} {{ }}")
                
                # Global Configs
                with open(f"global_configs/{svc}_prod.yaml", "w") as f:
                    f.write(f"service: {svc}\nregion: global\nmode: production")

        # 2. Big Data Database Cluster
        def generate_data_cluster():
            log("ğŸ—ƒï¸ Generating Big Data Cluster...")
            safe_makedirs("data_center")
            
            for svc in SERVICES:
                # SQL Schema
                with open(f"data_center/{svc}_schema_v3.sql", "w") as f:
                    f.write(f"CREATE TABLE {svc}_global (id BIGINT, region VARCHAR(50), data TEXT);\n")
                
                # SQLite Live Data (ëŒ€ëŸ‰ ë°ì´í„° ì£¼ì…)
                try:
                    conn = sqlite3.connect(f"data_center/{svc}_shard_01.db")
                    cur = conn.cursor()
                    cur.execute(f"CREATE TABLE {svc}_audit (id INT, hash TEXT)")
                    # 1000ê±´ ë°ì´í„° ì£¼ì…
                    cur.executemany(f"INSERT INTO {svc}_audit VALUES (?, ?)", [(k, f"Hash_{k}") for k in range(1000)])
                    conn.commit()
                    conn.close()
                except: pass

        # 3. C++ High-Performance Core (Safe Init)
        def generate_cpp_core():
            log("ğŸš€ Generating C++ Core Engine...")
            safe_makedirs("cpp_core")
            # [ì¤‘ìš”] ì´ˆê¸° íŒŒì¼ ìƒì„± ì‹œ í—¤ë”ê°€ ë§¨ ìœ—ì¤„ì— ì˜¤ë„ë¡ ë³´ì¥
            with open("cpp_core/world_engine.cpp", "w") as f:
                f.write('#include <iostream>\n')
                f.write('int main() { std::cout << "World Engine Active" << std::endl; return 0; }')

        if __name__ == "__main__":
            generate_ecosystem()
            generate_data_cluster()
            generate_cpp_core()
            
            # ë°°í¬ìš© ë””ë ‰í† ë¦¬ ì‚¬ì „ í™•ë³´
            safe_makedirs("bin")
            safe_makedirs("downloads")
            safe_makedirs("deploy_logs")
            log("âœ… World Generation Complete.")
        EOF
        
        python world_generator.py

    # ----------------------------------------------------------------
    # [Step 6] ë³´ì•ˆ ëª¨ë“ˆ (ì›Œí„°ë§ˆí¬ ì•ˆì „ ì£¼ì… - Fix ì™„ë£Œ)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [7] Apply Safe Security Injection
      shell: bash
      run: |
        cat <<'EOF' > security_injector.py
        import os
        import datetime

        # [FIX] C++ ì»´íŒŒì¼ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ëª…í™•í•œ ì¤„ë°”ê¿ˆ(\n) í¬í•¨
        COPYRIGHT_HEADER = f"// (C) {datetime.datetime.now().year} GLOBAL ENTERPRISE. STRICTLY PROTECTED.\n"

        def inject_security():
            print("[SEC] Injecting Safe Watermarks...")
            for root, dirs, files in os.walk("."):
                if any(x in root for x in ["bin", ".git", "__pycache__"]): continue
                
                for file in files:
                    if file.endswith(('.java', '.cpp', '.js', '.yaml', '.sql')):
                        path = os.path.join(root, file)
                        try:
                            with open(path, 'r', encoding='utf-8') as f:
                                content = f.read()
                            
                            # ì¤‘ë³µ ë°©ì§€ ì²´í¬
                            if "STRICTLY PROTECTED" not in content:
                                with open(path, 'w', encoding='utf-8') as f:
                                    # [CRITICAL FIX] í—¤ë” + ì¤„ë°”ê¿ˆ + ì›ë³¸ ìˆœì„œë¡œ ê²°í•©
                                    f.write(COPYRIGHT_HEADER + "\n" + content)
                        except Exception as e:
                            print(f"Skipped {file}: {e}")
            print("[SEC] Injection Completed.")

        if __name__ == "__main__":
            inject_security()
        EOF
        
        python security_injector.py
        
        # [DEBUG] C++ íŒŒì¼ ë‚´ìš© ê²€ì¦
        echo "ğŸ” Verifying cpp_core/world_engine.cpp:"
        cat cpp_core/world_engine.cpp

    # ----------------------------------------------------------------
    # [Step 7] ê¸€ë¡œë²Œ í†µí•© ë¹Œë“œ (OS í˜¸í™˜ì„± ì ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [8] Global Build Execution
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ BUILDING WORLD SYSTEM..."
        echo "=========================================="
        
        echo "â˜• Compiling Java Sources (15+ Services)..."
        find src -name "*.java" > sources.txt
        # -nowarn ì˜µì…˜ìœ¼ë¡œ ìì˜í•œ ê²½ê³  ë¬´ì‹œ
        javac -nowarn -d bin @sources.txt
        
        echo "ğŸ“¦ Packaging JARs..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax Logistics HealthCare Metaverse AI_Core IoT_Network Education_Hub Energy_Grid Defense_Sys"
        
        for svc in $SERVICES; do
            # [FIX] Mac/Linux/Win ê³µí†µ ì†Œë¬¸ì ë³€í™˜ (tr ì‚¬ìš©)
            svc_lower=$(echo "$svc" | tr '[:upper:]' '[:lower:]')
            
            echo "Main-Class: com.global.${svc_lower}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
            echo "âœ… Built: ${svc}App.jar"
        done
        
        echo "ğŸš€ Compiling C++ Core..."
        # ì—ëŸ¬ ìˆ˜ì •ë¨: ì›Œí„°ë§ˆí¬ê°€ #includeë¥¼ ë°©í•´í•˜ì§€ ì•ŠìŒ
        g++ -o bin/WorldEngine cpp_core/world_engine.cpp
        
        echo "âœ… All Systems Built."

    # ----------------------------------------------------------------
    # [Step 8] ê¸€ë¡œë²Œ ì„œë²„ íŒœ(Server Farm) ë°°í¬ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [9] Deploy Global Server Farm (Ports 8000-8015)
      shell: bash
      run: |
        cat <<'EOF' > global_deployer.py
        import http.server
        import socketserver
        import threading
        import time
        import os

        if not os.path.exists("deploy_root"): os.makedirs("deploy_root")
        os.system("cp bin/*.jar deploy_root/")
        os.system("cp data_center/*.db deploy_root/")
        os.chdir("deploy_root")

        # 16ê°œ í¬íŠ¸ ë™ì‹œ ê°œë°© (ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„° ì‹œë®¬ë ˆì´ì…˜)
        PORTS = range(8000, 8016) 
        
        def run_server(port):
            try:
                Handler = http.server.SimpleHTTPRequestHandler
                # ë¦¬ì†ŒìŠ¤ ì ˆì•½ì„ ìœ„í•´ ë¡œê·¸ ì–µì œ ê°€ëŠ¥í•˜ë‚˜ ì—¬ê¸°ì„  ì¶œë ¥
                with socketserver.TCPServer(("", port), Handler) as httpd:
                    # print(f"ğŸŒ Node Active: {port}")
                    httpd.serve_forever()
            except: pass

        for p in PORTS:
            t = threading.Thread(target=run_server, args=(p,))
            t.daemon = True
            t.start()
            time.sleep(0.1)

        print("âœ… Global Server Farm (16 Nodes) is Online. Waiting 10s...")
        time.sleep(10)
        EOF
        
        python global_deployer.py &
        SERVER_PID=$!
        
        echo "â³ Validating Network..."
        sleep 5
        
        echo "ğŸ”„ Performing Distributed Download Test..."
        mkdir -p downloads
        
        # ë¶„ì‚° ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸
        curl -s -f http://localhost:8000/BankingApp.jar -o downloads/Banking.jar
        curl -s -f http://localhost:8010/AI_CoreApp.jar -o downloads/AI.jar
        curl -s -f http://localhost:8014/Defense_SysApp.jar -o downloads/Defense.jar
        
        # ì¢…ë£Œ
        kill $SERVER_PID || true
        
        if [ -f "downloads/AI.jar" ]; then
            echo "âœ… Global Network Verification Passed."
        else
            echo "âŒ Network Error."
            exit 1
        fi

    # ----------------------------------------------------------------
    # [Step 9] ëª¨ë“  ì •ì‹ ì£¼ì†Œ/ê²½ë¡œ ê°•ì œ í‘¸ì‹œ (Git Push)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [10] Force Push Everything
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        echo "ğŸš€ UPLOADING ALL GLOBAL ASSETS..."
        git config --global user.name "World-Bot"
        git config --global user.email "bot@world.com"
        
        # [CRITICAL] -f ì˜µì…˜ìœ¼ë¡œ ëª¨ë“  ìƒì„± íŒŒì¼ ê°•ì œ ìŠ¤í…Œì´ì§•
        # ëª¨ë“  ê²½ë¡œ, ëª¨ë“  ì£¼ì†Œ ë°˜ì˜
        git add -f src/ 
        git add -f cpp_core/ 
        git add -f data_center/ 
        git add -f global_configs/ 
        git add -f world_generator.py 
        git add -f security_injector.py
        git add -f global_deployer.py
        git add -f requirements.txt
        
        if git diff --staged --quiet; then
            echo "âœ… No changes needed."
        else
            echo "ğŸ“ Committing World Updates..."
            git commit -m "ğŸŒ World Update: 15+ Services & Security Patch [skip ci]"
            
            echo "ğŸ“¤ Pushing to Repository..."
            # ë§¤íŠ¸ë¦­ìŠ¤ ì‹¤í–‰ ê°„ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ pull rebase ì‹œë„
            git pull --rebase || echo "Rebase skipped"
            git push || echo "Push skipped due to concurrency (Target is eventually consistent)"
            echo "âœ… Upload Sequence Finished."
        fi

    # ----------------------------------------------------------------
    # [Step 10] CodeQL ìµœì¢… ë¶„ì„
    # ----------------------------------------------------------------
    - name: ğŸ” [11] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 11] ëª¨ë“  ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [12] Upload Global Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          bin/*.jar
          bin/WorldEngine*
          downloads/
          data_center/
          global_configs/
          src/
        retention-days: 1
