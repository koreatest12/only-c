name: ğŸš€ HYPER-ROBUST CROSS-PLATFORM BUILD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# [ê¸€ë¡œë²Œ í™˜ê²½ ì„¤ì •] ëª¨ë“  OSì—ì„œ ì¸ì½”ë”©/ì–¸ì–´ ì„¤ì • í†µì¼
env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8

jobs:
  hyper-build:
    name: âš¡ Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-pkg
          - os: windows-latest
            artifact_name: windows-pkg
          - os: macos-latest
            artifact_name: macos-pkg

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] (í•µì‹¬ ìˆ˜ì •) Python ì„¤ì • ì „ì— íŒŒì¼ ë¨¼ì € ê°•ì œ ìƒì„±
    # ì´ë ‡ê²Œ í•´ì•¼ setup-pythonì˜ cache ê¸°ëŠ¥ì´ ì—ëŸ¬ë¥¼ ë±‰ì§€ ì•ŠìŠµë‹ˆë‹¤.
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Initialize Requirements (Avoid Cache Error)
      shell: bash
      run: |
        echo "ğŸ”§ Initializing requirements.txt..."
        echo "colorama" > requirements.txt
        echo "âœ… requirements.txt created successfully."
        ls -l requirements.txt

    # ----------------------------------------------------------------
    # [Step 3] Python ì„¤ì • (íŒŒì¼ì´ ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ ì—†ìŒ)
    # ----------------------------------------------------------------
    - name: ğŸ [3] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip' # Step 2 ë•ë¶„ì— ì´ì œ ì•ˆì „í•˜ê²Œ ì‘ë™í•¨

    # ----------------------------------------------------------------
    # [Step 4] ë§¤ë‹ˆì € ìŠ¤í¬ë¦½íŠ¸ ê°•ì œ ìƒì„± (UTF-8 ì•ˆì „ ëª¨ë“œ)
    # ----------------------------------------------------------------
    - name: ğŸ“ [4] Generate Upgrade Manager Script
      shell: bash
      run: |
        echo "ğŸ”§ Generating upgrade_manager.py..."
        
        # Python ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (Windows ì¸ì½”ë”© ë¬¸ì œ í•´ê²° ì½”ë“œ í¬í•¨)
        cat <<EOF > upgrade_manager.py
        import os
        import sys
        import platform

        # í‘œì¤€ ì¶œë ¥ ì¸ì½”ë”© ê°•ì œ (Windows Console Fix)
        sys.stdout.reconfigure(encoding='utf-8')

        def main():
            os_name = platform.system()
            print(f"[MANAGER] ğŸš€ Operating System Detected: {os_name}")
            
            # C++ Source Content
            cpp_code = """
        #include <iostream>
        #include <vector>
        
        int main() {
            #ifdef _WIN32
            system("chcp 65001 > nul");
            #endif
            
            std::cout << "==================================" << std::endl;
            std::cout << "ğŸš€ BUILD SUCCESS: " << "$os_name" << std::endl;
            std::cout << "==================================" << std::endl;
            return 0;
        }
            """
            
            # CMake Content
            cmake_code = """
        cmake_minimum_required(VERSION 3.10)
        project(HyperBuild)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            try:
                print("[MANAGER] ğŸ“„ Creating main.cpp...")
                with open("main.cpp", "w", encoding="utf-8") as f:
                    f.write(cpp_code)

                print("[MANAGER] ğŸ“„ Creating CMakeLists.txt...")
                with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                    f.write(cmake_code)
                    
                print("[MANAGER] âœ… All source files generated.")
            except Exception as e:
                print(f"[ERROR] {e}")
                sys.exit(1)

        if __name__ == "__main__":
            main()
        EOF

    # ----------------------------------------------------------------
    # [Step 5] ì˜ì¡´ì„± ì„¤ì¹˜ ë° C++ ì†ŒìŠ¤ ìƒì„± ì‹¤í–‰
    # ----------------------------------------------------------------
    - name: ğŸš€ [5] Install & Generate
      shell: bash
      run: |
        pip install -r requirements.txt
        python upgrade_manager.py
        echo "ğŸ” File Check:"
        ls -F

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜ (OSë³„ ë¶„ê¸°)
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [6-Linux] Install Build Tools
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y build-essential cmake

    - name: ğŸ› ï¸ [6-Windows] Setup MSVC
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v1.1

    # ----------------------------------------------------------------
    # [Step 7] CMake ë¹Œë“œ (ì „ì²´ OS ê³µí†µ)
    # ----------------------------------------------------------------
    - name: ğŸ—ï¸ [7] Configure CMake
      shell: bash
      run: cmake -S . -B build

    - name: ğŸ”¨ [8] Build Release
      shell: bash
      run: cmake --build build --config Release

    # ----------------------------------------------------------------
    # [Step 8] ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (ê²½ë¡œ ìë™ ê°ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ§ª [9] Test Application
      shell: bash
      run: |
        echo "ğŸš€ Running Application..."
        if [ -f "./build/Release/app.exe" ]; then
          ./build/Release/app.exe
        elif [ -f "./build/app" ]; then
          chmod +x ./build/app
          ./build/app
        else
          echo "âš ï¸ Executable not found in expected paths. Searching..."
          find build -name "app*"
        fi

    # ----------------------------------------------------------------
    # [Step 9] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [10] Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          *.cpp
          *.py
          *.txt
        retention-days: 1
