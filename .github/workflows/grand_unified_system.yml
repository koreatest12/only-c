name: ğŸ’ ULTIMATE:FIXED CODEQL & MASSIVE DEPLOY

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  grand-universe-ops:
    name: ğŸŒŒ Grand Universe Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-universe-pack
          - os: windows-latest
            artifact_name: windows-universe-pack
          - os: macos-latest
            artifact_name: macos-universe-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] í™˜ê²½ ì„¤ì • (Java 17, Python 3.10)
    # ----------------------------------------------------------------
    - name: â˜• [2] Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [3] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“ [3-Pre] Init Dependencies
      run: |
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] CodeQL ì´ˆê¸°í™” (ë¹Œë“œ ì§ì „ í•„ìˆ˜ ì‹¤í–‰)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [4] Initialize CodeQL v4 (Must Run Before Build)
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python
        # ìˆ˜ë™ ë¹Œë“œ ëª¨ë“œ ëª…ì‹œ (ìš°ë¦¬ê°€ ì§ì ‘ javac/g++ì„ í˜¸ì¶œí•˜ë¯€ë¡œ)
        build-mode: manual 

    # ----------------------------------------------------------------
    # [Step 5] ì´ˆëŒ€í˜• ìƒì„±ê¸° ì‹¤í–‰ (ì†ŒìŠ¤ì½”ë“œ ë° ë°ì´í„° ìƒì„±)
    # ----------------------------------------------------------------
    - name: ğŸ­ [5] Run Massive Universe Generator
      shell: bash
      run: |
        cat <<EOF > universe_generator.py
        import os
        import sys
        import sqlite3
        import random

        sys.stdout.reconfigure(encoding='utf-8')

        # í™•ì¥ëœ 7ëŒ€ ì„œë¹„ìŠ¤
        SERVICES = ["Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax"]
        
        def safe_makedirs(path):
            if not os.path.exists(path):
                os.makedirs(path, exist_ok=True)

        def log(msg):
            print(f"[UNIVERSE-GEN] {msg}")

        # 1. Java ì†ŒìŠ¤ ëŒ€ëŸ‰ ìƒì„± (ì„œë¹„ìŠ¤ë‹¹ 50ê°œ í´ë˜ìŠ¤)
        def generate_massive_java():
            log("â˜• Generating Massive Java Ecosystem...")
            safe_makedirs("src/main/java/com/enterprise")
            
            for svc in SERVICES:
                base = f"src/main/java/com/enterprise/{svc.lower()}"
                safe_makedirs(base)
                
                # Main Application
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Running...\"); }} }}")
                
                # Controllers, Services, Repositories (ê° 10~20ê°œ)
                for i in range(1, 21):
                    with open(f"{base}/{svc}Controller{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Controller{i} {{ public String handle() {{ return \"Data {i}\"; }} }}")
                    with open(f"{base}/{svc}Service{i}.java", "w") as f:
                        f.write(f"package com.enterprise.{svc.lower()};\npublic class {svc}Service{i} {{ public void process() {{ }} }}")

        # 2. DB ë° SQL ìƒì„±
        def generate_data_layer():
            log("ğŸ—ƒï¸ Generating Data Layer (SQL + SQLite)...")
            safe_makedirs("database_store")
            
            for svc in SERVICES:
                # SQL Dump
                with open(f"database_store/{svc}_schema.sql", "w") as f:
                    f.write(f"CREATE TABLE {svc}_ledger (id BIGINT, hash VARCHAR(255));\n")
                    for k in range(100):
                        f.write(f"INSERT INTO {svc}_ledger VALUES ({k}, 'hash_{k}');\n")
                
                # SQLite Binary
                try:
                    conn = sqlite3.connect(f"database_store/{svc}.db")
                    cur = conn.cursor()
                    cur.execute(f"CREATE TABLE {svc}_tx (id INT, amt REAL)")
                    cur.executemany(f"INSERT INTO {svc}_tx VALUES (?, ?)", [(x, x*10.5) for x in range(100)])
                    conn.commit()
                    conn.close()
                except:
                    pass

        # 3. C++ ì—”ì§„ ì†ŒìŠ¤
        def generate_cpp_core():
            log("ğŸš€ Generating C++ High-Freq Engine...")
            safe_makedirs("cpp_core")
            with open("cpp_core/engine.cpp", "w") as f:
                f.write('#include <iostream>\\nint main() { std::cout << "Engine Online"; return 0; }')

        # 4. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (Shell/Bat)
        def generate_ops_scripts():
            log("ğŸ“œ Generating Ops Scripts...")
            safe_makedirs("ops_scripts")
            for svc in SERVICES:
                with open(f"ops_scripts/start_{svc}.sh", "w") as f:
                    f.write(f"#!/bin/bash\\njava -jar ../bin/{svc}App.jar\\n")
                with open(f"ops_scripts/start_{svc}.bat", "w") as f:
                    f.write(f"@echo off\\njava -jar ..\\bin\\{svc}App.jar\\n")

        if __name__ == "__main__":
            generate_massive_java()
            generate_data_layer()
            generate_cpp_core()
            generate_ops_scripts()
            safe_makedirs("bin") # ë¹Œë“œ í´ë” ì‚¬ì „ ìƒì„±
            log("âœ… Universe Generation Complete.")
        EOF
        
        # ì‹¤í–‰
        python universe_generator.py

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ ì‹¤í–‰ (CodeQLì´ ì´ ê³¼ì •ì„ ëª¨ë‹ˆí„°ë§í•¨)
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [6] Build Everything (Traced by CodeQL)
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ STARTING TRACED BUILD..."
        echo "=========================================="
        
        # 1. Java ì»´íŒŒì¼
        echo "â˜• Compiling 500+ Java Files..."
        find src -name "*.java" > sources.txt
        javac -d bin @sources.txt
        
        # 2. Jar íŒ¨í‚¤ì§• (ê° ì„œë¹„ìŠ¤ë³„)
        echo "ğŸ“¦ Packaging Enterprise JARs..."
        SERVICES="Banking Stock Insurance PublicData Crypto RealEstate GovTax"
        for svc in $SERVICES; do
            echo "Main-Class: com.enterprise.${svc,,}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
        done
        
        # 3. C++ ì»´íŒŒì¼
        echo "ğŸš€ Compiling C++ Core..."
        g++ -o bin/CoreEngine cpp_core/engine.cpp
        
        echo "âœ… Build Complete (Ready for Analysis)."

    # ----------------------------------------------------------------
    # [Step 7] ì„œë²„ ê°€ë™ ë° ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
    # ----------------------------------------------------------------
    - name: ğŸŒ [7] Official Distribution Server
      shell: bash
      run: |
        echo "ğŸŒ Launching Official Server..."
        mkdir -p dist_server
        cp bin/*.jar dist_server/
        cp database_store/*.db dist_server/
        
        # ë‹¤ìš´ë¡œë“œ ë°›ì„ í´ë”
        mkdir -p client_downloads
        
        # ì„œë²„ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
        cd dist_server
        python3 -m http.server 9999 &
        PID=$!
        cd ..
        
        sleep 5
        
        # ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (Crypto App)
        echo "â¬‡ï¸ Downloading CryptoApp.jar..."
        curl -f http://localhost:9999/CryptoApp.jar -o client_downloads/CryptoApp.jar
        
        # ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (RealEstate DB)
        echo "â¬‡ï¸ Downloading RealEstate.db..."
        curl -f http://localhost:9999/RealEstate.db -o client_downloads/RealEstate.db
        
        # ì„œë²„ ì¢…ë£Œ
        kill $PID || true
        
        echo "âœ… Download Simulation Verified."

    # ----------------------------------------------------------------
    # [Step 8] CodeQL ë¶„ì„ (ë¹Œë“œ í›„ ì‹¤í–‰ í•„ìˆ˜)
    # ----------------------------------------------------------------
    - name: ğŸ” [8] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 9] íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ìµœì¢… ê²€ì¦ (ë””ë²„ê¹…)
    # ----------------------------------------------------------------
    - name: ğŸ§ [9] Verify Artifacts
      shell: bash
      run: |
        echo "ğŸ” Checking Artifact Locations..."
        ls -l bin/*.jar
        ls -l database_store/
        ls -l client_downloads/

    # ----------------------------------------------------------------
    # [Step 10] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (í™”ë©´ í‘œì‹œìš©)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [10] Upload Massive Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          bin/*.jar
          bin/CoreEngine*
          database_store/
          ops_scripts/
          src/
          client_downloads/
        retention-days: 1
