name: ğŸ­ FINAL ZERO-ERROR:FACTORY, UPGRADE & SCM

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ë¬´ì¡°ê±´ ì‹¤í–‰
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  DEBIAN_FRONTEND: noninteractive

# [ê¶Œí•œ: ì „ì²´ í—ˆìš©]
permissions:
  contents: write           # ì½”ë“œ ì»¤ë°‹/í‘¸ì‹œ
  packages: write           # íŒ¨í‚¤ì§€ ë°°í¬
  deployments: write        # ë°°í¬ ê´€ë¦¬
  security-events: write    # CodeQL ë¦¬í¬íŠ¸ (í•„ìˆ˜)
  actions: write
  checks: write
  statuses: write
  issues: write
  pages: write

jobs:
  factory-ops-final:
    name: ğŸ­ Factory Ops on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-final-pack
          - os: windows-latest
            artifact_name: windows-final-pack
          - os: macos-latest
            artifact_name: macos-final-pack

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ê³µì¥ ì´ˆê¸°í™” (Deep Fetch í•„ìˆ˜)
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Initialize Factory
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # CodeQL ë° Git Rebaseë¥¼ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”
        token: ${{ secrets.GITHUB_TOKEN }}

    # ----------------------------------------------------------------
    # [Step 2] ì˜ì¡´ì„± íŒŒì¼ ì„ í–‰ ìƒì„± (Setup ì—ëŸ¬ ë°©ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Init Requirements
      shell: bash
      run: |
        echo "Creating dependency manifest..."
        echo "colorama" > requirements.txt
        echo "requests" >> requirements.txt
        echo "tqdm" >> requirements.txt
        echo "jinja2" >> requirements.txt
        echo "âœ… Requirements ready."

    # ----------------------------------------------------------------
    # [Step 3] ëŸ°íƒ€ì„ í™˜ê²½ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ [3] Setup Toolchain
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ [4] Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ [5] Install Libs
      shell: bash
      run: pip install -r requirements.txt

    # ----------------------------------------------------------------
    # [Step 4] CodeQL ì´ˆê¸°í™” (ë¹Œë“œ ì „ ì‹¤í–‰)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [6] CodeQL Init
      uses: github/codeql-action/init@v4
      with:
        languages: java, cpp, python
        # Build Mode: Auto-Detect (Manual ì œê±°)

    # ----------------------------------------------------------------
    # [Step 5] ì´ˆëŒ€í˜• ìœ ë‹ˆë²„ìŠ¤ ìƒì„±ê¸° (ìˆ˜ì§‘/ì—…ê·¸ë ˆì´ë“œ/ì„œë¹„ìŠ¤)
    # ----------------------------------------------------------------
    - name: ğŸ­ [7] Run Massive Generator
      shell: bash
      run: |
        cat <<'EOF' > factory_manager.py
        import os
        import sys
        import random
        import datetime
        import json

        sys.stdout.reconfigure(encoding='utf-8')

        # 1. í•µì‹¬ ì„œë¹„ìŠ¤ (Core Services)
        CORE_SERVICES = [
            "Banking", "Stock", "Insurance", "PublicData", "Crypto", "RealEstate", "GovTax",
            "Logistics", "HealthCare", "Metaverse", "AI_Core", "IoT_Network", 
            "Education_Hub", "Energy_Grid", "Defense_Sys"
        ]
        
        # 2. ìˆ˜ì§‘ ì„œë²„ (Collection Squad)
        COLLECTORS = [
            "Log_Aggregator", "Metric_Beat", "Trace_Collector", "User_Activity_Tracker",
            "Network_Sniffer", "Security_Auditor", "Market_Feeder", "Error_Catcher"
        ]

        def safe_makedirs(path):
            if not os.path.exists(path): os.makedirs(path, exist_ok=True)

        def log(msg): print(f"[FACTORY] {msg}")

        # A. ì†ŒìŠ¤ ì½”ë“œ ìƒì‚°
        def produce_code():
            log("ğŸš€ Manufacturing Services & Collectors...")
            safe_makedirs("src/main/java/com/global/core")
            safe_makedirs("src/main/java/com/global/collection")
            safe_makedirs("src/main/resources/config")
            
            # Core Services
            for svc in CORE_SERVICES:
                base = f"src/main/java/com/global/core/{svc.lower()}"
                safe_makedirs(base)
                with open(f"{base}/{svc}Application.java", "w") as f:
                    f.write(f"package com.global.core.{svc.lower()};\npublic class {svc}Application {{ public static void main(String[] args) {{ System.out.println(\"{svc} Online\"); }} }}")
                
                # Config with Logic
                with open(f"src/main/resources/config/{svc}_config.xml", "w") as f:
                    f.write(f"<config><name>{svc}</name><port>{8000 + CORE_SERVICES.index(svc)}</port></config>")

            # Collectors
            for svc in COLLECTORS:
                base = f"src/main/java/com/global/collection/{svc.lower()}"
                safe_makedirs(base)
                with open(f"{base}/{svc}Agent.java", "w") as f:
                    f.write(f"package com.global.collection.{svc.lower()};\npublic class {svc}Agent {{ public void run() {{ }} }}")

        # B. ì—…ê·¸ë ˆì´ë“œ ì‹œìŠ¤í…œ ìƒì‚°
        def produce_upgrade_sys():
            log("â¬†ï¸ Generating Upgrade Manager...")
            safe_makedirs("infra/upgrade")
            
            manifest = {
                "patch_version": f"v{datetime.datetime.now().year}.{random.randint(1,100)}",
                "targets": CORE_SERVICES + COLLECTORS,
                "rollback_enabled": True
            }
            with open("infra/upgrade/manifest.json", "w") as f:
                json.dump(manifest, f, indent=4)
                
            with open("infra/upgrade/patch_runner.py", "w") as f:
                f.write("print('Applying Kernel Patches...'); print('Restarting Clusters...');")

        # C. C++ ì•”í˜¸í™” ì—”ì§„
        def produce_cpp_core():
            log("ğŸ” Forging Crypto Engine...")
            safe_makedirs("cpp_core")
            # [Fix] í—¤ë” ì¤„ë°”ê¿ˆ ëª…ì‹œ
            with open("cpp_core/crypto.cpp", "w") as f:
                f.write('#include <iostream>\n')
                f.write('#include <fstream>\n')
                f.write('void encrypt(std::string f) { std::ofstream o(f+".enc"); o<<"ENC"; o.close(); }\n')
                f.write('int main(int c, char* v[]) { if(c>1) encrypt(v[1]); return 0; }')

        if __name__ == "__main__":
            produce_code()
            produce_upgrade_sys()
            produce_cpp_core()
            safe_makedirs("bin")
            safe_makedirs("release_pkg")
            safe_makedirs("logs")
            log("âœ… Factory Output Ready.")
        EOF
        
        python factory_manager.py

    # ----------------------------------------------------------------
    # [Step 6] ë³´ì•ˆ ì›Œí„°ë§ˆí¬ (í—¤ë” íŒŒê´´ ë°©ì§€ ì ìš©)
    # ----------------------------------------------------------------
    - name: ğŸ›¡ï¸ [8] Apply Watermark
      shell: bash
      run: |
        cat <<'EOF' > watermark.py
        import os
        import datetime
        # [CRITICAL] ì¤„ë°”ê¿ˆ ëª…ì‹œ
        HEADER = f"// (C) {datetime.datetime.now().year} GLOBAL FACTORY. SECURE.\n"

        def inject():
            for root, dirs, files in os.walk("."):
                if any(x in root for x in ["bin", ".git", "release_pkg"]): continue
                for file in files:
                    if file.endswith(('.java', '.cpp', '.xml', '.py')):
                        path = os.path.join(root, file)
                        try:
                            with open(path, 'r', encoding='utf-8') as f: content = f.read()
                            if "GLOBAL FACTORY" not in content:
                                with open(path, 'w', encoding='utf-8') as f:
                                    f.write(HEADER + content)
                        except: pass
        if __name__ == "__main__": inject()
        EOF
        python watermark.py

    # ----------------------------------------------------------------
    # [Step 7] ì •ë°€ ë¹Œë“œ & ì—…ê·¸ë ˆì´ë“œ & ì•”í˜¸í™”
    # ----------------------------------------------------------------
    - name: ğŸ”¨ [9] Build & Upgrade
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸ—ï¸ FACTORY BUILD & UPGRADE..."
        echo "=========================================="
        
        # 1. C++ ì»´íŒŒì¼
        echo "ğŸ” Compiling Crypto..."
        if [[ "$RUNNER_OS" == "Windows" ]]; then
            g++ -o bin/Crypto.exe cpp_core/crypto.cpp
            CRYPTO="bin/Crypto.exe"
        else
            g++ -o bin/Crypto cpp_core/crypto.cpp
            CRYPTO="./bin/Crypto"
        fi
        
        # 2. Java ì»´íŒŒì¼ (Core + Collection)
        echo "â˜• Compiling All Services..."
        find src -name "*.java" > sources.txt
        javac -nowarn -d bin @sources.txt
        
        # 3. íŒ¨í‚¤ì§• ë° ì•”í˜¸í™”
        echo "ğŸ“¦ Packaging..."
        
        # Core Services
        CORE="Banking Stock Insurance PublicData Crypto RealEstate GovTax Logistics HealthCare Metaverse AI_Core IoT_Network Education_Hub Energy_Grid Defense_Sys"
        for svc in $CORE; do
            svc_lower=$(echo "$svc" | tr '[:upper:]' '[:lower:]')
            echo "Main-Class: com.global.core.${svc_lower}.${svc}Application" > Manifest.txt
            jar cf bin/${svc}App.jar Manifest.txt -C bin .
            
            # Config ì•”í˜¸í™”
            if [ -f "src/main/resources/config/${svc}_config.xml" ]; then
                cp "src/main/resources/config/${svc}_config.xml" "bin/${svc}_config.xml"
                $CRYPTO "bin/${svc}_config.xml"
            fi
        done
        
        # Collection Agents
        COLL="Log_Aggregator Metric_Beat Trace_Collector User_Activity_Tracker Network_Sniffer Security_Auditor Market_Feeder Error_Catcher"
        for svc in $COLL; do
            jar cf bin/${svc}Agent.jar -C bin .
        done
        
        # 4. ì—…ê·¸ë ˆì´ë“œ ì‹œë®¬ë ˆì´ì…˜
        echo "â¬†ï¸ Running Upgrade Simulation..."
        python infra/upgrade/patch_runner.py
        
        echo "âœ… All Systems Built & Upgraded."

    # ----------------------------------------------------------------
    # [Step 8] CodeQL ë¶„ì„ (Git Push *ì´ì „*ì— ìˆ˜í–‰í•˜ì—¬ ì—ëŸ¬ ë°©ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ” [10] Perform CodeQL Analysis v4
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java,cpp,python"

    # ----------------------------------------------------------------
    # [Step 9] ëŒ€ì‹œë³´ë“œ ë¦¬í¬íŠ¸
    # ----------------------------------------------------------------
    - name: ğŸ“Š [11] Generate Dashboard
      shell: bash
      run: |
        JAR_COUNT=$(find bin -name "*.jar" | wc -l | xargs)
        ENC_COUNT=$(find bin -name "*.enc" | wc -l | xargs)
        
        cat <<EOF > factory_dashboard.html
        <html><body><h1>Factory Status</h1><p>Apps: $JAR_COUNT</p><p>Encrypted: $ENC_COUNT</p></body></html>
        EOF
        
        echo "## ğŸ­ Factory Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Services** | $JAR_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| **Encrypted** | $ENC_COUNT |" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------------------
    # [Step 10] Git ì €ì¥ì†Œ ê°•ì œ ë™ê¸°í™” (CodeQL ì´í›„ ì‹¤í–‰)
    # ----------------------------------------------------------------
    - name: ğŸ’¾ [12] Force Push Assets (Autostash)
      if: runner.os == 'Linux' && github.event_name != 'pull_request'
      shell: bash
      run: |
        echo "ğŸ”„ STARTING SCM SYNC..."
        git config --global user.name "Factory-Bot"
        git config --global user.email "bot@factory.com"
        
        # ëª¨ë“  íŒŒì¼ ê°•ì œ ì¶”ê°€
        git add -A
        git add -f src/ infra/ database/ cpp_core/ factory_manager.py *.html bin/*.enc
        
        if git diff --staged --quiet; then
            echo "âœ… No changes."
        else
            git commit -m "ğŸ­ Factory Update: Core+Collectors+Upgrade [skip ci]"
            
            # Rebase & Push Loop with Autostash (ì¶©ëŒ ë°©ì§€ í•µì‹¬)
            for i in {1..5}; do
                echo "ğŸ”„ Sync Attempt ($i/5)..."
                if git pull --rebase --autostash origin main; then
                    if git push origin main; then
                        echo "âœ… Push Success."
                        break
                    else
                        echo "âš ï¸ Push failed, retrying..."
                        sleep 5
                    fi
                else
                    echo "âš ï¸ Pull failed, aborting rebase & retrying..."
                    git rebase --abort || true
                    sleep 5
                fi
            done
        fi

    # ----------------------------------------------------------------
    # [Step 11] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [13] Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          factory_dashboard.html
          bin/*.jar
          bin/*.enc
          src/
          infra/
        retention-days: 1
