name: ğŸ­ Ultimate Ops Factory (Expert Console)

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "ultimate-factory"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ëŒ€ëŸ‰ ë°ì´í„° ìƒì‚° ë° ì „ë¬¸ê°€ìš© í¬í„¸ êµ¬ì¶•
  # ==============================================================================
  expert-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 90 # ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‹œê°„ ì—°ì¥
    
    steps:
    # ----------------------------------------------------------------
    # [Step 1] í´ë¦°ë£¸ ì´ˆê¸°í™”
    # ----------------------------------------------------------------
    - name: ğŸ§¹ Deep Clean
      run: |
        echo "ğŸ§¹ Purging system for massive generation..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "âœ… System Ready."

    # ----------------------------------------------------------------
    # [Step 2] ì—”ì§„ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: ğŸ“¦ Install Deps
      run: pip install flask flask-cors gunicorn faker pandas requests jinja2 psutil pyyaml

    # ----------------------------------------------------------------
    # [Step 3] ğŸ­ ë°±ì—”ë“œ: ì „ë¬¸ê°€ìš© ë°ì´í„° ì—”ì§„ (ì†ŒìŠ¤ì½”ë“œ/ë°”ì´ë„ˆë¦¬/ìŠ¤í™)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Expert Data Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > expert_engine.py
        import os, shutil, json, random, uuid, yaml
        from datetime import datetime
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        
        # í™•ì¥ëœ ì„œë¹„ìŠ¤ ëª©ë¡ (ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜)
        DOMAINS = ["Payment", "Auth", "Inventory", "Logistics", "AI_Core", "Search", "Recommendation", "User", "Notification", "Analytics"]
        ENVIRONMENTS = ["Dev", "Stage", "Prod", "DR"]
        
        def generate_source_code(path, svc):
            """ê°œë°œììš© ì†ŒìŠ¤ì½”ë“œ ì‹œë®¬ë ˆì´ì…˜"""
            # Python Code
            with open(f"{path}/app.py", "w") as f:
                f.write(f"# Service: {svc}\nimport os\n\ndef main():\n    print('Starting {svc}...')\n")
            # Config YAML
            with open(f"{path}/config.yaml", "w") as f:
                yaml.dump({"service": svc, "replicas": random.randint(1,5), "db": "postgres"}, f)
            # Dockerfile
            with open(f"{path}/Dockerfile", "w") as f:
                f.write(f"FROM python:3.9-slim\nCMD ['python', 'app.py']\n")

        def generate_expert_data():
            print("ğŸš€ Generating Massive Expert Data...")
            metadata = []
            
            for env in ENVIRONMENTS:
                for domain in DOMAINS:
                    svc_id = f"{domain}_{env}_{random.randint(100,999)}"
                    base_path = f"data/{env}/{domain}/{svc_id}"
                    os.makedirs(base_path, exist_ok=True)
                    
                    # 1. ì†ŒìŠ¤ì½”ë“œ ë° ì„¤ì • (ê°œë°œììš©)
                    generate_source_code(base_path, svc_id)
                    
                    # 2. ë°”ì´ë„ˆë¦¬ ë¤í”„ (ì‹œìŠ¤í…œìš©)
                    with open(f"{base_path}/core.bin", "wb") as f:
                        f.write(os.urandom(1024 * 10)) # 10KB Binary
                        
                    # 3. API ìŠ¤í™ (OpenAPI/Swagger ì‹œë®¬ë ˆì´ì…˜)
                    api_spec = {
                        "openapi": "3.0.0",
                        "info": {"title": svc_id, "version": "1.0.0"},
                        "paths": {f"/api/v1/{domain.lower()}": {"get": {"summary": "Fetch Data"}}}
                    }
                    with open(f"{base_path}/openapi.json", "w") as f:
                        json.dump(api_spec, f, indent=2)

                    # 4. ì••ì¶• ë° ì‚­ì œ (ê³µê°„ ë°©ì–´)
                    zip_name = f"{env}_{domain}_{svc_id}"
                    shutil.make_archive(f"{OUTPUT_DIR}/{zip_name}", 'zip', base_path)
                    shutil.rmtree(base_path)
                    
                    metadata.append({
                        "id": str(uuid.uuid4())[:8],
                        "service": svc_id,
                        "env": env,
                        "status": random.choice(["Running", "Deploying", "Stopped"]),
                        "type": "Microservice",
                        "files": ["app.py", "config.yaml", "openapi.json", "core.bin"]
                    })

            # ì „ë¬¸ê°€ìš© ëŒ€ì‹œë³´ë“œ ë°ì´í„°
            data = {
                "system_status": "OPTIMAL",
                "generated_at": str(datetime.now()),
                "total_artifacts": len(metadata),
                "services": metadata
            }
            with open("dashboard_data.json", "w") as f:
                json.dump(data, f)
        
        if __name__ == "__main__": generate_expert_data()
        EOF
        
        python expert_engine.py

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ: ì „ë¬¸ê°€ ì½˜ì†” (Web Terminal & Explorer)
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Expert Console
      shell: bash
      run: |
        mkdir -p _web_portal/static/css
        mkdir -p _web_portal/templates
        
        # HTML: íƒ­ ì¸í„°í˜ì´ìŠ¤ + ì›¹ í„°ë¯¸ë„ + ë°ì´í„° ê·¸ë¦¬ë“œ
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>DEV OPS CONSOLE</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { background-color: #0d1117; color: #c9d1d9; font-family: 'Fira Code', monospace; }
                .tab-active { border-bottom: 2px solid #58a6ff; color: #58a6ff; }
                .terminal { background: #000; color: #0f0; padding: 20px; border-radius: 5px; height: 400px; overflow-y: auto; border: 1px solid #30363d; }
                .cursor { animation: blink 1s step-end infinite; }
                @keyframes blink { 50% { opacity: 0; } }
                .data-row:hover { background-color: #161b22; }
            </style>
        </head>
        <body class="h-screen flex flex-col overflow-hidden">
            
            <header class="p-4 border-b border-gray-700 bg-gray-900 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-white">ğŸ­ FACTORY_OPS :: <span class="text-blue-400">EXPERT_MODE</span></h1>
                    <span class="bg-green-900 text-green-300 px-2 py-0.5 rounded text-xs">KERNEL: ONLINE</span>
                </div>
                <div class="text-xs text-gray-400" id="clock">Loading...</div>
            </header>

            <nav class="flex gap-6 px-6 border-b border-gray-800 bg-gray-900 text-sm">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="py-3 tab-active hover:text-white transition">ğŸ“Š DASHBOARD</button>
                <button onclick="switchTab('terminal')" id="tab-terminal" class="py-3 hover:text-white transition">ğŸ’» TERMINAL</button>
                <button onclick="switchTab('datalake')" id="tab-datalake" class="py-3 hover:text-white transition">ğŸ›¢ï¸ DATA EXPLORER</button>
                <button onclick="switchTab('api')" id="tab-api" class="py-3 hover:text-white transition">ğŸ”Œ API DOCS</button>
            </nav>

            <main class="flex-1 p-6 overflow-y-auto bg-[#0d1117]">
                
                <div id="view-dashboard" class="space-y-6">
                    <div class="grid grid-cols-4 gap-6">
                        <div class="bg-gray-800 p-4 rounded border border-gray-700">
                            <h3 class="text-xs text-gray-400">TOTAL ARTIFACTS</h3>
                            <p class="text-3xl font-bold text-white mt-1" id="dash-total">--</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded border border-gray-700">
                            <h3 class="text-xs text-gray-400">SYSTEM HEALTH</h3>
                            <p class="text-3xl font-bold text-green-400 mt-1">100%</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded border border-gray-700 col-span-2">
                            <h3 class="text-xs text-gray-400">PRODUCTION RATE</h3>
                            <div class="h-16 mt-2"><canvas id="miniChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="view-terminal" class="hidden h-full flex flex-col">
                    <div class="terminal flex-1 text-sm font-mono shadow-lg" id="console-output">
                        <div>Welcome to OpsShell v2.5.0</div>
                        <div>Type 'help' for available commands.</div>
                        <div>-----------------------------------</div>
                        <br>
                    </div>
                    <div class="mt-2 flex bg-gray-800 p-2 rounded">
                        <span class="text-green-400 mr-2">$</span>
                        <input type="text" id="console-input" class="bg-transparent outline-none flex-1 text-white font-mono" placeholder="Enter command..." autocomplete="off">
                    </div>
                </div>

                <div id="view-datalake" class="hidden">
                    <div class="bg-gray-800 rounded border border-gray-700 overflow-hidden">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-900 text-gray-400 border-b border-gray-700">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">ENV</th>
                                    <th class="p-3">SERVICE</th>
                                    <th class="p-3">FILES</th>
                                    <th class="p-3">STATUS</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="view-api" class="hidden">
                    <div class="bg-gray-800 p-6 rounded border border-gray-700">
                        <h2 class="text-xl font-bold mb-4">REST API Endpoints</h2>
                        <div class="space-y-4">
                            <div class="p-3 bg-gray-900 rounded border-l-4 border-green-500">
                                <span class="bg-green-700 text-white px-2 py-0.5 rounded text-xs font-bold mr-2">GET</span>
                                <span class="font-mono">/api/stats</span>
                                <p class="text-xs text-gray-400 mt-1">Returns full system telemetry and service registry.</p>
                            </div>
                            <div class="p-3 bg-gray-900 rounded border-l-4 border-blue-500">
                                <span class="bg-blue-700 text-white px-2 py-0.5 rounded text-xs font-bold mr-2">GET</span>
                                <span class="font-mono">/dashboard_data.json</span>
                                <p class="text-xs text-gray-400 mt-1">Static data access for GitHub Pages mode.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>

            <script>
                // --- CORE LOGIC ---
                let globalData = null;

                // Tab Switcher
                function switchTab(tabName) {
                    ['dashboard', 'terminal', 'datalake', 'api'].forEach(t => {
                        document.getElementById('view-'+t).classList.add('hidden');
                        document.getElementById('tab-'+t).classList.remove('tab-active');
                    });
                    document.getElementById('view-'+tabName).classList.remove('hidden');
                    document.getElementById('tab-'+tabName).classList.add('tab-active');
                }

                // Data Loader
                async function init() {
                    try {
                        const res = await fetch('/api/stats').catch(() => fetch('./dashboard_data.json'));
                        globalData = await res.json();
                        
                        // Dashboard Populate
                        document.getElementById('dash-total').innerText = globalData.total_artifacts;
                        
                        // Data Lake Populate
                        const tbody = document.getElementById('data-table-body');
                        globalData.services.slice(0, 50).forEach(s => { // Show top 50
                            tbody.innerHTML += `<tr class="data-row border-b border-gray-700">
                                <td class="p-3 font-mono text-gray-500">${s.id}</td>
                                <td class="p-3"><span class="bg-gray-700 px-2 py-0.5 rounded text-xs">${s.env}</span></td>
                                <td class="p-3 font-bold text-white">${s.service}</td>
                                <td class="p-3 font-mono text-xs text-blue-300">[${s.files.join(', ')}]</td>
                                <td class="p-3 text-green-400">${s.status}</td>
                            </tr>`;
                        });
                        
                        renderChart();

                    } catch(e) { console.error("Boot failed", e); }
                }

                // Terminal Logic (Simulation)
                const input = document.getElementById('console-input');
                const output = document.getElementById('console-output');

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cmd = input.value.trim().toLowerCase();
                        log(`$ ${cmd}`);
                        input.value = '';
                        processCommand(cmd);
                    }
                });

                function log(text) {
                    const div = document.createElement('div');
                    div.innerText = text;
                    output.appendChild(div);
                    output.scrollTop = output.scrollHeight;
                }

                function processCommand(cmd) {
                    if (cmd === 'help') {
                        log("Available commands: help, status, ls, clear, date, version");
                    } else if (cmd === 'status') {
                        log("System Status: OPERATIONAL");
                        log("Active Services: " + (globalData ? globalData.total_artifacts : "Unknown"));
                    } else if (cmd === 'ls') {
                        log("Listing mounted volumes...");
                        log("drwxr-xr-x  root  _data_warehouse");
                        log("drwxr-xr-x  root  _web_portal");
                    } else if (cmd === 'clear') {
                        output.innerHTML = '';
                    } else if (cmd === 'date') {
                        log(new Date().toString());
                    } else if (cmd === 'version') {
                        log("OpsShell v2.5.0 (Factory Edition)");
                    } else if (cmd === '') {
                        // do nothing
                    } else {
                        log(`Command not found: ${cmd}`);
                    }
                }

                // Chart
                function renderChart() {
                    new Chart(document.getElementById('miniChart'), {
                        type: 'line',
                        data: {
                            labels: Array(10).fill(''),
                            datasets: [{
                                data: [10, 25, 40, 35, 50, 65, 80, 75, 90, 100],
                                borderColor: '#58a6ff', borderWidth: 2, tension: 0.4, pointRadius: 0
                            }]
                        },
                        options: { plugins: {legend: false}, scales: {x:{display:false}, y:{display:false}} }
                    });
                }
                
                setInterval(() => document.getElementById('clock').innerText = new Date().toISOString(), 1000);
                init();
            </script>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 5] Flask ì„œë²„ ì¤€ë¹„ (ë¡œì»¬ ì‹¤í–‰ìš©)
    # ----------------------------------------------------------------
    - name: âš™ï¸ Build Server
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        @app.route('/')
        def home(): return render_template('index.html')
        @app.route('/api/stats')
        def stats():
            try: return jsonify(json.load(open('../dashboard_data.json')))
            except: return jsonify({})
        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        echo 'bind = "0.0.0.0:5000"' > _web_portal/gunicorn_config.py

    # ----------------------------------------------------------------
    # [Step 6] ğŸš€ ì„œë²„ í…ŒìŠ¤íŠ¸ (IPv4)
    # ----------------------------------------------------------------
    - name: ğŸ§ª Test Server
      run: |
        cd _web_portal
        gunicorn -c gunicorn_config.py app:app &
        sleep 5
        curl -4 -v http://127.0.0.1:5000/api/stats
        pkill gunicorn || true

    # ----------------------------------------------------------------
    # [Step 7] GitHub Pages ì¤€ë¹„
    # ----------------------------------------------------------------
    - name: ğŸ“„ Build Static Site
      run: |
        mkdir -p _site
        cp _web_portal/templates/index.html _site/index.html
        cp dashboard_data.json _site/dashboard_data.json

    # ----------------------------------------------------------------
    # [Step 8] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: expert-console-package
        path: |
          _web_portal/
          _data_warehouse/
          dashboard_data.json

    - name: ğŸ“¤ Upload Pages
      uses: actions/upload-pages-artifact@v3
      with: { path: _site/ }

  # ==============================================================================
  # [Job 2] ë°°í¬
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: expert-ops
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
