name: ğŸ›¡ï¸ 2025 Secure Enterprise System (DevSecOps)

on:
  push:
    branches: ["main", "master"]
    tags: ['v*']
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # [ë³´ì•ˆ ê°•í™”] ì»´íŒŒì¼ëŸ¬ ë³´ì•ˆ í”Œë˜ê·¸ (Stack Protection, ASLR, Read-only Relocations)
  # -fstack-protector-strong: ìŠ¤íƒ ë²„í¼ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€
  # -D_FORTIFY_SOURCE=2: ë©”ëª¨ë¦¬ ì†ìƒ ë°©ì§€ ë§¤í¬ë¡œ
  # -Wl,-z,relro,-z,now: GOT ë®ì–´ì“°ê¸° ê³µê²© ë°©ì§€ (Full RELRO)
  SECURITY_FLAGS: "-O3 -Wall -Wextra -std=c++20 -pthread -march=native -fstack-protector-strong -D_FORTIFY_SOURCE=2 -fPIE -pie -Wl,-z,relro,-z,now"
  PYTHONIOENCODING: "utf-8"

# [ìµœì†Œ ê¶Œí•œ ì›ì¹™] ëª¨ë“  ê¶Œí•œì„ ì œê±°í•˜ê³  í•„ìš”í•œ ê²ƒë§Œ ëª…ì‹œ
permissions: read-all

jobs:
  # ----------------------------------------------------------------
  # JOB 1: ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„ (SAST) - CodeQL & Dependency Review
  # ----------------------------------------------------------------
  security-audit:
    name: ğŸ•µï¸ Security Audit (SAST)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write # GitHub Security íƒ­ì— ë¦¬í¬íŠ¸ ì—…ë¡œë“œ ê¶Œí•œ
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: c-cpp, python
          queries: security-extended, security-and-quality

      # ì‹¤ì œ ë¹Œë“œ ê³¼ì •ì´ ì—†ìœ¼ë©´ CodeQL ë¶„ì„ì´ ë¶€ì •í™•í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°„ë‹¨í•œ ë¹Œë“œ ìˆ˜í–‰
      - name: Dummy Build for Analysis
        run: |
          # ì½”ë“œ íŒŒì¼ ìƒì„± (ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ ë³µì‚¬)
          cat <<EOF > enterprise_main.cpp
          #include <iostream>
          int main() { return 0; }
          EOF
          g++ -std=c++20 enterprise_main.cpp -o enterprise_main

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ----------------------------------------------------------------
  # JOB 2: ë³´ì•ˆ ë¹Œë“œ & ì•„í‹°íŒ©íŠ¸ ìƒì„± (Hardened Build)
  # ----------------------------------------------------------------
  secure-build:
    name: ğŸ”’ Hardened Build (${{ matrix.os }})
    needs: security-audit
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      contents: read # ì†ŒìŠ¤ ì½ê¸° ì „ìš©
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip' # ìºì‹œ ì‚¬ìš©í•˜ì—¬ ì†ë„/ë³´ì•ˆ í–¥ìƒ

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install Pillow qrcode

      # [ì†ŒìŠ¤ ìƒì„±] ì›ë³¸ ë¡œì§ ìœ ì§€
      - name: Generate Source Code
        shell: bash
        run: |
          cat <<EOF > enterprise_main.cpp
          #include <iostream>
          #include <fstream>
          #include <filesystem>
          #include <vector>
          #include <string>
          #include <thread>
          #include <chrono>
          #include <iomanip>
          #include <format>
          namespace fs = std::filesystem;
          void optimizeIO() { std::ios_base::sync_with_stdio(false); std::cin.tie(NULL); }
          class VirtualAccountManager {
          public:
              static void generate() {
                  fs::create_directories("output/data");
                  std::ofstream file("output/data/va_dump_2025.csv");
                  file << "Bank,Account,Holder,Amount,Expiry" << std::endl;
                  for(int i=0; i<100; ++i) { file << "KB-2025,562-" << i << ",User_" << i << ",1000,2030-12-31" << std::endl; }
                  file.close();
              }
          };
          class VirtualCardManager {
          public:
              static void generate() {
                  fs::create_directories("output/data");
                  std::ofstream file("output/data/card_dump_2025.csv");
                  file << "CardNum,CVC,Expiry,Type" << std::endl;
                  for(int i=0; i<100; ++i) { file << "4222-2025-" << i << ",123,12/30,VISA" << std::endl; }
                  file.close();
              }
          };
          int main() {
              optimizeIO();
              std::cout << "ğŸš€ Secure System 2025..." << std::endl;
              VirtualAccountManager::generate();
              VirtualCardManager::generate();
              return 0;
          }
          EOF

      # [ë¹Œë“œ] ë³´ì•ˆ í”Œë˜ê·¸ ì ìš©
      - name: Build with Security Flags
        shell: bash
        run: |
          mkdir -p output_data
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            echo "ğŸ§ Linux Hardened Build..."
            # ë³´ì•ˆ í”Œë˜ê·¸($SECURITY_FLAGS)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»´íŒŒì¼
            g++ ${{ env.SECURITY_FLAGS }} enterprise_main.cpp -o final_binary
            chmod +x final_binary
            ./final_binary
          else
            echo "ğŸªŸ Windows Build..."
            # WindowsëŠ” MSVC ê¸°ë³¸ ë³´ì•ˆ ì˜µì…˜ ì‚¬ìš© (/GS ë“±)
            g++ -O2 -Wall -std=c++20 enterprise_main.cpp -o final_binary.exe
            ./final_binary.exe
          fi
          
          # ë°ì´í„° ë³µì‚¬
          if [ -d "output" ]; then cp -r output/* output_data/; fi

      # [Python ì´ë¯¸ì§€ ìƒì„±]
      - name: Generate Assets
        shell: bash
        run: |
          cat <<EOF > gen_assets.py
          import os, qrcode
          from PIL import Image, ImageDraw
          os.makedirs("output_data/data/va_images", exist_ok=True)
          img = Image.new('RGB', (100, 100), color='red')
          img.save("output_data/data/va_images/sample.png")
          print("Assets Generated")
          EOF
          python gen_assets.py

      # [ë¬´ê²°ì„± ê²€ì¦] SHA-512 í•´ì‹œ ìƒì„± (SHA-256ë³´ë‹¤ ê°•ë ¥)
      - name: Generate SHA-512 Checksum
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sha512sum final_binary > checksum.sha512
          else
            sha512sum final_binary.exe > checksum.sha512
          fi
          cat checksum.sha512

      - name: Upload Secure Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Secure-Binary-${{ matrix.os }}
          path: |
            final_binary*
            checksum.sha512
            output_data/
          retention-days: 1 # ë³´ì•ˆì„ ìœ„í•´ ìµœì†Œ ë³´ê´€

  # ----------------------------------------------------------------
  # JOB 3: ì»¨í…Œì´ë„ˆ ë³´ì•ˆ (Trivy Scan & Cosign Signing)
  # ----------------------------------------------------------------
  secure-container:
    name: ğŸ³ Secure Container Build
    needs: secure-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write # [ì¤‘ìš”] Cosign Keyless ì„œëª…ì„ ìœ„í•œ OIDC ê¶Œí•œ
      security-events: write # Trivy ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: Secure-Binary-ubuntu-latest

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Dockerfile ìƒì„± (Distroless ì‚¬ìš© ê³ ë ¤ ê°€ëŠ¥í•˜ë‚˜ í˜¸í™˜ì„± ìœ„í•´ Ubuntu ì‚¬ìš©)
      - name: Create Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:24.04
          # ë³´ì•ˆ ì—…ë°ì´íŠ¸ ì ìš©
          RUN apt-get update && apt-get upgrade -y && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
          WORKDIR /app
          COPY final_binary /app/server_app
          COPY output_data /app/data
          RUN chmod +x /app/server_app
          # Non-root ìœ ì €ë¡œ ì‹¤í–‰ (ì»¨í…Œì´ë„ˆ ë³´ì•ˆ í•µì‹¬)
          RUN useradd -m appuser
          USER appuser
          CMD ["./server_app"]
          EOF

      - name: Build and Push Docker Image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}

      # [ë³´ì•ˆ ìŠ¤ìº”] Trivyë¡œ ì´ë¯¸ì§€ ì·¨ì•½ì  ë¶„ì„ (CRITICAL ë°œê²¬ ì‹œ ë¹Œë“œ ì‹¤íŒ¨)
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: 'table'
          exit-code: '1' # ì·¨ì•½ì  ë°œê²¬ ì‹œ ì—ëŸ¬ ì½”ë“œ 1 ë°˜í™˜ (íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨)
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # [ì´ë¯¸ì§€ ì„œëª…] Cosignì„ ì‚¬ìš©í•œ í‚¤ë¦¬ìŠ¤(Keyless) ì„œëª…
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.3.0

      - name: Sign the published Docker image
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build-and-push.outputs.digest }}
          echo "âœ… Docker Image Signed successfully via OIDC"

  # ----------------------------------------------------------------
  # JOB 4: ìµœì¢… ë°°í¬ (ë¦´ë¦¬ì¦ˆ)
  # ----------------------------------------------------------------
  secure-release:
    name: ğŸš€ Final Secure Release
    needs: [secure-container, secure-build]
    runs-on: ubuntu-latest
    permissions:
      contents: write # ë¦´ë¦¬ì¦ˆ ìƒì„± ê¶Œí•œ

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Secure-Binary-ubuntu-latest
          path: linux_pkg
      
      - uses: actions/download-artifact@v4
        with:
          name: Secure-Binary-windows-latest
          path: windows_pkg

      - name: Create Release Info
        run: |
          echo "## ğŸ”’ Secure Release v${{ github.run_number }}" > release_note.md
          echo "This release has passed strict security audits." >> release_note.md
          echo "### âœ… Security Checks" >> release_note.md
          echo "- **SAST:** CodeQL Analysis Passed" >> release_note.md
          echo "- **Hardening:** Stack Protector & ASLR Enabled" >> release_note.md
          echo "- **Container:** Trivy Scanned & Cosign Signed" >> release_note.md
          echo "- **Integrity:** SHA-512 Checksums Included" >> release_note.md

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v2025.secure.${{ github.run_number }}
          name: ğŸ”’ Secure Release v${{ github.run_number }}
          body_path: release_note.md
          files: |
            linux_pkg/final_binary
            linux_pkg/checksum.sha512
            windows_pkg/final_binary.exe
            windows_pkg/checksum.sha512
