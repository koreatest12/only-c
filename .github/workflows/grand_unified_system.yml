name: ğŸ­ Enterprise Factory (Link Visible)

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  link-visible-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì¸í”„ë¼ í´ë¦°ë£¸
    # ----------------------------------------------------------------
    - name: ğŸ§¹ Infrastructure Cleanup
      run: |
        echo "ğŸ§¹ Purging disk space..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "âœ… Ready."

    # ----------------------------------------------------------------
    # [Step 2] ëŸ°íƒ€ì„ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Python 3.10
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: ğŸ“¦ Install Deps
      run: pip install flask flask-cors gunicorn faker pandas requests jinja2 psutil

    # ----------------------------------------------------------------
    # [Step 3] ë°±ì—”ë“œ ë°ì´í„° ì—”ì§„ (ê¸°ì¡´ ëŒ€ëŸ‰ ìƒì„± ë¡œì§ ìœ ì§€)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Backend Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > backend_engine.py
        import os, shutil, json, random, uuid
        from datetime import datetime
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        SERVICES = ["Auth_Core", "Billing_Gateway", "Ops_Monitor", "AI_Inference"]
        REGIONS = ["Global_Common", "Asia_Seoul", "US_Virginia"]

        def generate():
            print("ğŸš€ Generating Data...")
            metadata = []
            for region in REGIONS:
                for svc in SERVICES:
                    base_path = f"data/{region}/{svc}"
                    os.makedirs(base_path, exist_ok=True)
                    
                    # Dummy CSV
                    with open(f"{base_path}/log.csv", "w") as f:
                        f.write("id,ts,val\n")
                        for _ in range(100): f.write(f"{uuid.uuid4()},{datetime.now()},{random.randint(0,100)}\n")

                    zip_name = f"{region}_{svc}"
                    shutil.make_archive(f"{OUTPUT_DIR}/{zip_name}", 'zip', base_path)
                    shutil.rmtree(base_path)
                    
                    metadata.append({"id": str(uuid.uuid4())[:8], "service": svc, "region": region, "status": "Healthy"})

            with open("dashboard_data.json", "w") as f:
                json.dump({"system_status": "OPERATIONAL", "services": metadata}, f)
        
        if __name__ == "__main__": generate()
        EOF
        
        python backend_engine.py

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ: ë§í¬ íŒ¨ë„ì´ ì¶”ê°€ëœ ëŒ€ì‹œë³´ë“œ
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Dashboard with Server Link
      shell: bash
      run: |
        mkdir -p _web_portal/static/css
        mkdir -p _web_portal/templates
        
        # HTML: ì„œë²„ ë§í¬ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OPS COMMAND CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                body { background-color: #0b0c10; color: #c5c6c7; font-family: 'Courier New', monospace; }
                .neon-text { color: #66fcf1; text-shadow: 0 0 5px #45a29e; }
                .card { background-color: #1f2833; border: 1px solid #45a29e; }
                .status-ok { color: #00ff00; }
                .link-box { background: #000; border: 1px dashed #66fcf1; padding: 10px; font-family: monospace; color: #66fcf1; }
            </style>
        </head>
        <body class="h-screen overflow-hidden flex flex-col">
            
            <header class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900">
                <h1 class="text-3xl font-bold neon-text">ğŸ­ FACTORY OPS :: COMMAND CENTER</h1>
                <div class="text-right">
                    <p class="text-sm text-green-400">SYSTEM NORMAL</p>
                </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto grid grid-cols-4 gap-6">
                
                <div class="card p-4 rounded col-span-4 bg-gray-900 border-2 border-green-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-green-400 font-bold text-lg">ğŸŒ SERVER CONNECTION ESTABLISHED</h3>
                            <p class="text-xs text-gray-400">Secure Uplink Active via Gunicorn WSGI</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-green-900 text-green-300 px-3 py-1 rounded text-xs">LIVE</span>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-4">
                        <div>
                            <p class="text-gray-500 text-xs">LOCAL ACCESS (IPv4)</p>
                            <div class="link-box mt-1 select-all cursor-pointer hover:bg-gray-800" onclick="copyToClipboard('http://127.0.0.1:5000')">
                                http://127.0.0.1:5000
                            </div>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">NETWORK ACCESS</p>
                            <div class="link-box mt-1 select-all cursor-pointer hover:bg-gray-800" onclick="copyToClipboard('http://0.0.0.0:5000')">
                                http://0.0.0.0:5000
                            </div>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs">API ENDPOINT</p>
                            <div class="link-box mt-1 select-all cursor-pointer hover:bg-gray-800">
                                /api/stats
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-4 rounded col-span-1">
                    <h3 class="text-gray-400 text-sm">TOTAL SERVICES</h3>
                    <p class="text-4xl font-bold text-white mt-2" id="node-count">--</p>
                </div>
                <div class="card p-4 rounded col-span-3">
                     <h3 class="text-gray-400 text-sm mb-2">SERVICE REGISTRY</h3>
                     <table class="w-full text-xs text-left">
                        <tbody id="svc-table"></tbody>
                     </table>
                </div>

            </main>

            <script>
                function copyToClipboard(text) {
                    navigator.clipboard.writeText(text);
                    alert("Copied: " + text);
                }

                fetch('/api/stats').then(r => r.json()).then(data => {
                    document.getElementById('node-count').innerText = data.services.length;
                    const tbody = document.getElementById('svc-table');
                    data.services.forEach(s => {
                        tbody.innerHTML += `<tr class="border-b border-gray-700">
                            <td class="p-2 text-green-400">${s.id}</td>
                            <td class="p-2">${s.region}</td>
                            <td class="p-2 font-bold text-white">${s.service}</td>
                            <td class="p-2 text-blue-400">${s.status}</td>
                        </tr>`;
                    });
                });
            </script>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 5] ğŸ–¥ï¸ í”„ë¡œë•ì…˜ ì„œë²„ êµ¬ì¶•
    # ----------------------------------------------------------------
    - name: âš™ï¸ Build Server App
      shell: bash
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify
        import json
        app = Flask(__name__)

        @app.route('/')
        def home(): return render_template('index.html')

        @app.route('/api/stats')
        def stats():
            try:
                with open('../dashboard_data.json', 'r') as f: return jsonify(json.load(f))
            except: return jsonify({"services": []})
        EOF
        
        cat <<'EOF' > _web_portal/gunicorn_config.py
        bind = "0.0.0.0:5000"
        workers = 2
        loglevel = "info"
        EOF

    # ----------------------------------------------------------------
    # [Step 6] ğŸš€ ì„œë²„ ê°€ë™ ë° ë§í¬ í™•ì¸ (í•˜ì´ë¼ì´íŠ¸)
    # ----------------------------------------------------------------
    - name: ğŸš€ Launch & Verify (With Link Display)
      run: |
        echo "ğŸŸ¢ Starting Server..."
        cd _web_portal
        gunicorn -c gunicorn_config.py app:app &
        PID=$!
        
        # ìŠ¤ë§ˆíŠ¸ ëŒ€ê¸°
        for i in {1..10}; do
          if curl -s -4 http://127.0.0.1:5000/ > /dev/null; then
            echo "âœ… Server UP!"
            break
          fi
          sleep 1
        done
        
        echo "==================================================="
        echo "ğŸŒ SERVER IS LIVE AT:"
        echo "   ğŸ‘‰ Local:   http://127.0.0.1:5000"
        echo "   ğŸ‘‰ Network: http://0.0.0.0:5000"
        echo "==================================================="
        
        # API í…ŒìŠ¤íŠ¸
        curl -4 -s http://127.0.0.1:5000/api/stats | head -c 100
        echo "..."
        
        kill $PID || true

    # ----------------------------------------------------------------
    # [Step 7] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
    # ----------------------------------------------------------------
    - name: ğŸ“¤ Upload Package
      uses: actions/upload-artifact@v4
      with:
        name: ops-portal-v1
        path: |
          _web_portal/
          _data_warehouse/
          dashboard_data.json
        retention-days: 1

    # ----------------------------------------------------------------
    # [Step 8] ìµœì¢… ìš”ì•½ì— ë§í¬ í‘œì‹œ
    # ----------------------------------------------------------------
    - name: ğŸ“Š Summary Report with Link
      if: always()
      run: |
        echo "# ğŸ­ Factory Ops Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Server Connection Info" >> $GITHUB_STEP_SUMMARY
        echo "The web portal has been generated. When deployed locally, access it via:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Type | URL | Status |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Localhost** | \`http://127.0.0.1:5000\` | âœ… Verified |" >> $GITHUB_STEP_SUMMARY
        echo "| **Network** | \`http://0.0.0.0:5000\` | âœ… Open |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> **How to run:** Download the artifact, go to \`_web_portal\`, and run \`python app.py\` (Dev) or \`gunicorn app:app\` (Prod)." >> $GITHUB_STEP_SUMMARY
