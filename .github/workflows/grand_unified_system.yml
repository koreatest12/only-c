name: ğŸ­ Ops Control Center (Error-Free)

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "ops-control-final"
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # [Job 1] ë°ì´í„° ìƒì‚° ë° ê´€ì œ ì„¼í„° êµ¬ì¶•
  # ==============================================================================
  control-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    # ----------------------------------------------------------------
    - name: ğŸ§¹ System Purge
      run: |
        echo "ğŸ§¹ Purging system..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        docker system prune -af
        echo "âœ… Ready."

    # ----------------------------------------------------------------
    # [Step 2] ì—”ì§„ ì„¤ì •
    # ----------------------------------------------------------------
    - name: ğŸ› ï¸ Setup Python
      uses: actions/setup-python@v5
      with: { python-version: '3.10' }
    
    - name: ğŸ“¦ Install Deps
      run: pip install flask flask-cors gunicorn faker pandas requests jinja2 psutil pymongo redis

    # ----------------------------------------------------------------
    # [Step 3] ğŸ­ í†µí•© ë°ì´í„° ì—”ì§„ (ì—ëŸ¬ ìˆ˜ì •ë¨)
    # ----------------------------------------------------------------
    - name: ğŸ­ Run Stable Data Engine
      shell: bash
      run: |
        mkdir -p _data_warehouse
        
        cat <<'EOF' > db_engine.py
        import os, shutil, json, random, uuid, sqlite3, time
        from datetime import datetime, date
        from decimal import Decimal
        from faker import Faker
        fake = Faker()

        OUTPUT_DIR = "_data_warehouse"
        
        # [í•µì‹¬ ìˆ˜ì •] JSON ì§ë ¬í™” í—¬í¼ í•¨ìˆ˜
        def json_serial(obj):
            """JSON serializer for objects not serializable by default json code"""
            if isinstance(obj, (datetime, date)):
                return obj.isoformat()
            if isinstance(obj, Decimal):
                return float(obj) # Decimalì„ floatìœ¼ë¡œ ë³€í™˜
            raise TypeError (f"Type {type(obj)} not serializable")

        # 1. RDB (SQLite & SQL Dumps)
        def gen_rdb():
            path = "data/rdb/finance"
            os.makedirs(path, exist_ok=True)
            conn = sqlite3.connect(f"{path}/ledger.db")
            c = conn.cursor()
            c.execute('''CREATE TABLE txs (id text, date text, amount real, user text)''')
            for _ in range(100):
                c.execute("INSERT INTO txs VALUES (?,?,?,?)", 
                          (str(uuid.uuid4()), str(datetime.now()), random.uniform(10,9999), fake.name()))
            conn.commit()
            conn.close()
            return {"type": "RDB", "count": 100, "status": "Online"}

        # 2. NoSQL (MongoDB JSONs - ì—ëŸ¬ ìˆ˜ì •ë¨)
        def gen_nosql():
            path = "data/nosql/users"
            os.makedirs(path, exist_ok=True)
            docs = []
            for _ in range(100):
                # fake.profile() ë‚´ë¶€ì— Decimalì´ í¬í•¨ë  ìˆ˜ ìˆìŒ
                profile = fake.profile()
                doc = {
                    "_id": str(uuid.uuid4()),
                    "profile": profile, 
                    "history": [fake.url() for _ in range(3)]
                }
                docs.append(doc)
            
            # [í•µì‹¬ ìˆ˜ì •] default=json_serial ì¶”ê°€í•˜ì—¬ Decimal ì˜¤ë¥˜ í•´ê²°
            with open(f"{path}/collection.json", "w") as f: 
                json.dump(docs, f, default=json_serial)
            
            return {"type": "NoSQL", "count": 100, "status": "Active"}

        # 3. Graph & TSDB
        def gen_others():
            return [{"type": "Graph", "count": 50, "status": "Mapped"}, 
                    {"type": "TSDB", "count": 500, "status": "Collecting"}]

        # 4. ì„œë¹„ìŠ¤ ìƒíƒœ ë° ì´ë²¤íŠ¸ ë¡œê·¸ ìƒì„± (ì¬ì‹œë„ ê¸°ëŠ¥ìš©)
        def gen_services_with_events():
            services = []
            regions = ["KR-Seoul", "US-East", "EU-West"]
            domains = ["Payment", "Auth", "Order", "Delivery"]
            errors = ["Connection Timeout", "Heap OOM", "Disk Full"]

            for r in regions:
                for d in domains:
                    is_down = random.random() < 0.2
                    status = "CRITICAL" if is_down else "ACTIVE"
                    svc_id = f"{d}-{r}-{random.randint(100,999)}"
                    
                    events = []
                    # ì •ìƒ ë¡œê·¸
                    for _ in range(3):
                        events.append({"ts": str(fake.date_time_this_month()), "level": "INFO", "msg": "Health check ok"})
                    
                    # ì—ëŸ¬ ë¡œê·¸
                    if is_down:
                        events.append({"ts": str(datetime.now()), "level": "ERROR", "msg": random.choice(errors)})
                    
                    services.append({
                        "id": svc_id, "region": r, "domain": d, "status": status, 
                        "events": sorted(events, key=lambda x: x['ts'], reverse=True)
                    })
            return services

        if __name__ == "__main__":
            print("ğŸš€ Generating Stable Data...")
            
            try:
                db_stats = [gen_rdb(), gen_nosql()] + gen_others()
                services = gen_services_with_events()
                
                # ì••ì¶•
                if os.path.exists("data"):
                    shutil.make_archive(f"{OUTPUT_DIR}/db_backup", 'zip', "data")
                    shutil.rmtree("data")
                
                data = {
                    "generated_at": str(datetime.now()),
                    "databases": db_stats,
                    "services": services
                }
                
                with open("dashboard_data.json", "w") as f:
                    json.dump(data, f, default=json_serial)
                print("âœ… Engine Finished Successfully.")
                
            except Exception as e:
                print(f"âš ï¸ Partial Failure handled: {e}")
                # ì‹¤íŒ¨ ì‹œ ìµœì†Œí•œì˜ ë°ì´í„°ë¼ë„ ìƒì„±
                with open("dashboard_data.json", "w") as f:
                    json.dump({"services": [], "databases": []}, f)
        EOF
        
        python db_engine.py

    # ----------------------------------------------------------------
    # [Step 4] ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ: í†µí•© ê´€ì œ ì„¼í„° (ì„œë²„ ì¬ì‹œë„ + ì´ë²¤íŠ¸ ìƒí™©íŒ)
    # ----------------------------------------------------------------
    - name: ğŸ¨ Build Control Center UI
      shell: bash
      run: |
        mkdir -p _web_portal/static
        mkdir -p _web_portal/templates
        
        # HTML: ì´ë²¤íŠ¸ ë¡œê·¸ ë° ì¬ì‹œë„ ê¸°ëŠ¥ì´ í¬í•¨ëœ UI
        cat <<'EOF' > _web_portal/templates/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>OPS CONTROL CENTER</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; overflow: hidden; }
                .scroll-y { overflow-y: auto; height: 100%; }
                .status-active { color: #4ade80; }
                .status-critical { color: #f87171; font-weight: bold; animation: pulse 2s infinite; }
                @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
                
                .log-ERROR { color: #fca5a5; border-left: 2px solid #ef4444; padding-left: 8px; }
                .log-INFO { color: #86efac; border-left: 2px solid #22c55e; padding-left: 8px; }
                
                .btn-retry { background: #1e293b; border: 1px solid #475569; padding: 4px 10px; cursor: pointer; border-radius: 4px; font-size: 0.75rem; }
                .btn-retry:hover { background: #334155; color: white; }
                .spinning { display: inline-block; animation: spin 1s linear infinite; }
                @keyframes spin { 100% { transform: rotate(360deg); } }
            </style>
        </head>
        <body class="flex flex-col h-screen">
            <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between">
                <h1 class="text-xl font-bold text-white tracking-widest">ğŸ­ OPS CONTROL <span class="text-blue-400">CENTER</span></h1>
                <div class="text-xs flex gap-4">
                    <span class="text-red-400 border border-red-900 px-2 py-1 rounded bg-red-900/20">CRITICAL: <span id="cnt-crit">0</span></span>
                    <span class="text-green-400 border border-green-900 px-2 py-1 rounded bg-green-900/20">ACTIVE: <span id="cnt-active">0</span></span>
                </div>
            </header>

            <main class="flex-1 flex overflow-hidden">
                <div class="w-2/3 border-r border-slate-700 flex flex-col">
                    <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700">SERVICE FLEET</div>
                    <div class="flex-1 scroll-y p-4">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="text-slate-500 border-b border-slate-700 sticky top-0 bg-[#0f172a]">
                                <tr><th class="p-2">ID</th><th class="p-2">REGION</th><th class="p-2">STATUS</th><th class="p-2 text-center">ACTION</th></tr>
                            </thead>
                            <tbody id="svc-table" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>

                <div class="w-1/3 flex flex-col bg-slate-900/50">
                    <div class="p-3 bg-slate-800 text-xs text-slate-400 font-bold border-b border-slate-700">ğŸš¨ EVENT SITUATION ROOM</div>
                    <div class="flex-1 scroll-y p-4 space-y-3" id="event-board">
                        <div class="text-center text-slate-600 mt-10">Select a service to view live logs...</div>
                    </div>
                </div>
            </main>

            <script>
                let globalData = [];

                async function loadData() {
                    // Try API first, then Static file
                    const res = await fetch('/api/stats').catch(()=>fetch('dashboard_data.json'));
                    const data = await res.json();
                    globalData = data.services || [];
                    render();
                }

                function render() {
                    const tbody = document.getElementById('svc-table');
                    tbody.innerHTML = '';
                    let crit = 0; let active = 0;

                    globalData.forEach((svc, idx) => {
                        if(svc.status === 'CRITICAL') crit++; else active++;
                        const statusClass = svc.status === 'CRITICAL' ? 'status-critical' : 'status-active';
                        
                        // Reboot Button Logic
                        const btn = svc.status === 'CRITICAL' 
                            ? `<button class="btn-retry text-red-300" onclick="reboot('${svc.id}', ${idx}, event)">â™»ï¸ REBOOT SERVER</button>` 
                            : `<span class="text-slate-600 text-xs">NO ACTION NEEDED</span>`;

                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-800 transition cursor-pointer" onclick="showEvents(${idx})">
                            <td class="p-3 font-bold text-slate-300">${svc.id}</td>
                            <td class="p-3 text-xs text-slate-400">${svc.region}</td>
                            <td class="p-3 ${statusClass}">${svc.status}</td>
                            <td class="p-3 text-center">${btn}</td>
                        </tr>`;
                    });

                    document.getElementById('cnt-crit').innerText = crit;
                    document.getElementById('cnt-active').innerText = active;
                }

                function showEvents(idx) {
                    const svc = globalData[idx];
                    const board = document.getElementById('event-board');
                    board.innerHTML = `<div class="mb-4 text-xs text-slate-500 border-b border-slate-700 pb-2">LOGS FOR: <span class="text-white font-bold">${svc.id}</span></div>`;
                    
                    svc.events.forEach(e => {
                        board.innerHTML += `
                        <div class="text-xs mb-2 log-${e.level}">
                            <div class="opacity-50 text-[10px]">${e.ts}</div>
                            <div class="font-bold">[${e.level}] ${e.msg}</div>
                        </div>`;
                    });
                }

                async function reboot(id, idx, e) {
                    e.stopPropagation(); // Prevent row click
                    const row = document.getElementById('svc-table').children[idx];
                    row.children[3].innerHTML = `<span class="text-yellow-500 text-xs"><span class="spinning">âš™ï¸</span> REBOOTING...</span>`;
                    
                    try {
                        // 1. API Call (Local Server)
                        await fetch('/api/retry/' + id, {method: 'POST'});
                        loadData();
                    } catch(err) {
                        // 2. Simulation (Static Page)
                        console.log("Simulating Reboot...");
                        setTimeout(() => {
                            globalData[idx].status = "ACTIVE";
                            globalData[idx].events.unshift({ts: new Date().toISOString(), level: "INFO", msg: "Manual Reboot Successful"});
                            render();
                            showEvents(idx);
                        }, 1500);
                    }
                }

                loadData();
            </script>
        </body>
        </html>
        EOF

    # ----------------------------------------------------------------
    # [Step 5] Flask ì„œë²„ ì¤€ë¹„ (ì¬ì‹œë„ API í¬í•¨)
    # ----------------------------------------------------------------
    - name: âš™ï¸ Build Server API
      run: |
        cat <<'EOF' > _web_portal/app.py
        from flask import Flask, render_template, jsonify, send_from_directory
        import json
        app = Flask(__name__)
        DATA_FILE = '../dashboard_data.json'

        @app.route('/')
        def home(): return render_template('index.html')

        @app.route('/api/stats')
        def stats():
            try: return jsonify(json.load(open(DATA_FILE)))
            except: return jsonify({"services": []})

        # [í•µì‹¬] ì¬ì‹œë„ API
        @app.route('/api/retry/<id>', methods=['POST'])
        def retry(id):
            try:
                with open(DATA_FILE, 'r') as f: data = json.load(f)
                for s in data['services']:
                    if s['id'] == id:
                        s['status'] = 'ACTIVE'
                        s['events'].insert(0, {"ts": "NOW", "level": "INFO", "msg": "Rebooted via API"})
                with open(DATA_FILE, 'w') as f: json.dump(data, f)
                return jsonify({"status": "ok"})
            except: return jsonify({"error": "failed"}), 500

        @app.route('/dashboard_data.json')
        def static_data(): return send_from_directory('..', 'dashboard_data.json')
        EOF
        
        # Gunicorn Config (ì—ëŸ¬ ì–µì œ)
        cat <<'EOF' > _web_portal/gunicorn_config.py
        bind = "0.0.0.0:5000"
        workers = 1
        loglevel = "error"
        accesslog = "/dev/null"
        errorlog = "/dev/null"
        EOF

    # ----------------------------------------------------------------
    # [Step 6] ğŸš€ ì„œë²„ í…ŒìŠ¤íŠ¸ & ë°°í¬ ì¤€ë¹„
    # ----------------------------------------------------------------
    - name: ğŸ§ª Test & Build
      run: |
        cd _web_portal
        gunicorn -c gunicorn_config.py app:app > /dev/null 2>&1 &
        PID=$!
        sleep 5
        curl -4 -s http://127.0.0.1:5000/api/stats > /dev/null
        kill -TERM $PID
        wait $PID 2>/dev/null || true
        
        # ì •ì  ì‚¬ì´íŠ¸ ë¹Œë“œ
        mkdir -p ../_site
        cp templates/index.html ../_site/index.html
        cp ../dashboard_data.json ../_site/dashboard_data.json

    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ops-control-package
        path: |
          _web_portal/
          _data_warehouse/
          dashboard_data.json

    - name: ğŸ“¤ Upload Pages
      uses: actions/upload-pages-artifact@v3
      with: { path: _site/ }

  # ==============================================================================
  # [Job 2] ë°°í¬
  # ==============================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: control-ops
    steps:
      - name: ğŸš€ Deploy
        id: deployment
        uses: actions/deploy-pages@v4
