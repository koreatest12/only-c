name: ğŸš€ ULTIMATE MSVC & FULL BUILD PIPELINE

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# [ê¸€ë¡œë²Œ í™˜ê²½ ì„¤ì •] ì¸ì½”ë”© ë° ì–¸ì–´ ì„¤ì • (Windows í˜¸í™˜ì„± í•„ìˆ˜)
env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  # MSVC ì»´íŒŒì¼ëŸ¬ê°€ ìƒ‰ìƒ ì¶œë ¥ì„ í•˜ë„ë¡ ì„¤ì •
  VSINSTALLDIR: 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise'

jobs:
  heavy-duty-build:
    name: ğŸ”¥ Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: linux-final-build
          - os: windows-latest
            artifact_name: windows-msvc-build
          - os: macos-latest
            artifact_name: macos-final-build

    steps:
    # ----------------------------------------------------------------
    # [Step 1] ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    # ----------------------------------------------------------------
    - name: ğŸ“¥ [1] Checkout Source Code
      uses: actions/checkout@v4

    # ----------------------------------------------------------------
    # [Step 2] (ì ˆëŒ€ ìˆœì„œ ë³€ê²½ ê¸ˆì§€) Python ì„¤ì • ì „ íŒŒì¼ ê°•ì œ ìƒì„±
    # setup-pythonì´ requirements.txtë¥¼ ì°¾ì§€ ëª»í•´ ì£½ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
    # ----------------------------------------------------------------
    - name: ğŸ“ [2] Force Create Requirements (No Skip)
      shell: bash
      run: |
        echo "ğŸ”§ [INIT] Creating requirements.txt forcefully..."
        echo "colorama" > requirements.txt
        echo "âœ… requirements.txt created."
        ls -l requirements.txt

    # ----------------------------------------------------------------
    # [Step 3] Python ì„¤ì • (ì´ì œ íŒŒì¼ì´ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•¨)
    # ----------------------------------------------------------------
    - name: ğŸ [3] Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip' # ìºì‹œ ì‚¬ìš© (Step 2 ë•ë¶„ì— ì—ëŸ¬ ì—†ìŒ)

    # ----------------------------------------------------------------
    # [Step 4] ë§¤ë‹ˆì € ìŠ¤í¬ë¦½íŠ¸ ë° C++ ì†ŒìŠ¤ ìƒì„±ê¸° ì‘ì„± (UTF-8)
    # ----------------------------------------------------------------
    - name: ğŸ“ [4] Generate Upgrade Manager (UTF-8 Safe)
      shell: bash
      run: |
        echo "ğŸ”§ [INIT] Writing upgrade_manager.py..."
        
        # Windows ì¸ì½”ë”© ì—ëŸ¬ ë°©ì§€ìš© Python ì½”ë“œ ì‘ì„±
        cat <<EOF > upgrade_manager.py
        import os
        import sys
        import platform

        sys.stdout.reconfigure(encoding='utf-8')

        def run_manager():
            os_type = platform.system()
            print(f"[MANAGER] ğŸš€ System Detected: {os_type}")
            print(f"[MANAGER] ğŸ› ï¸ Prepare C++ Sources...")

            cpp_src = """
        #include <iostream>
        #include <vector>
        
        int main() {
            #ifdef _WIN32
            system("chcp 65001 > nul");
            #endif
            std::cout << "======================================" << std::endl;
            std::cout << "ğŸš€ MSVC / G++ / Clang BUILD SUCCESS!" << std::endl;
            std::cout << "======================================" << std::endl;
            return 0;
        }
            """
            
            # CMakeLists.txt (C++ Standard 20)
            cmake_src = """
        cmake_minimum_required(VERSION 3.10)
        project(HeavyBuild)
        set(CMAKE_CXX_STANDARD 20)
        add_executable(app main.cpp)
            """

            try:
                with open("main.cpp", "w", encoding="utf-8") as f:
                    f.write(cpp_src)
                with open("CMakeLists.txt", "w", encoding="utf-8") as f:
                    f.write(cmake_src)
                print("[MANAGER] âœ… Files created successfully.")
            except Exception as e:
                print(f"[ERROR] {e}")
                sys.exit(1)

        if __name__ == "__main__":
            run_manager()
        EOF

    # ----------------------------------------------------------------
    # [Step 5] ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì†ŒìŠ¤ ì½”ë“œ ìƒì„±)
    # ----------------------------------------------------------------
    - name: ğŸš€ [5] Run Generator
      shell: bash
      run: |
        pip install -r requirements.txt
        python upgrade_manager.py
        echo "ğŸ” Checking generated files:"
        ls -F

    # ----------------------------------------------------------------
    # [Step 6] ë¹Œë“œ í™˜ê²½ ì„¤ì • (MSVC & Linux Tools)
    # ----------------------------------------------------------------
    # [Linux]
    - name: ğŸ› ï¸ [6-Linux] Install Build Essentials
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y build-essential cmake

    # [Windows] MSVC ì„¤ì • (ê°€ì¥ ì¤‘ìš”)
    - name: ğŸ› ï¸ [6-Windows] Setup MSVC (Visual Studio)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v2 # v2ë¡œ ì—…ê·¸ë ˆì´ë“œ (ë” ê°•ë ¥í•¨)

    # [Windows] MSVC ì»´íŒŒì¼ëŸ¬(cl.exe) í™•ì¸ - ë””ë²„ê¹…ìš©
    - name: ğŸ§ [6-Check] Check Compiler Existence
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        echo "Checking MSVC environment..."
        where msbuild
        echo "Ready to build."

    # ----------------------------------------------------------------
    # [Step 7] ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ (Clean Build & Verbose)
    # ----------------------------------------------------------------
    - name: ğŸ§¹ [7] Clean Previous Builds
      shell: bash
      run: rm -rf build

    - name: ğŸ—ï¸ [8] CMake Configure
      shell: bash
      run: cmake -S . -B build

    # [ëŒ€ëŸ‰ ìˆ˜ì • ë°˜ì˜] --verbose ì˜µì…˜ ì¶”ê°€í•˜ì—¬ ë¹Œë“œ ë¡œê·¸ ì „ì²´ ì¶œë ¥
    - name: ğŸ”¨ [9] Build Project (Detailed Log)
      shell: bash
      run: cmake --build build --config Release --verbose

    # ----------------------------------------------------------------
    # [Step 8] ì‹¤í–‰ í…ŒìŠ¤íŠ¸
    # ----------------------------------------------------------------
    - name: ğŸ§ª [10] Execute Application
      shell: bash
      run: |
        echo "ğŸš€ Executing Binary..."
        if [ -f "./build/Release/app.exe" ]; then
          ./build/Release/app.exe
        elif [ -f "./build/app" ]; then
          chmod +x ./build/app
          ./build/app
        else
          echo "âš ï¸ Binary not found directly. Searching tree..."
          find build -name "app*"
        fi

    # ----------------------------------------------------------------
    # [Step 9] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ì‹¤íŒ¨í•´ë„ ì—…ë¡œë“œ ì‹œë„)
    # ----------------------------------------------------------------
    - name: ğŸ“¤ [11] Upload Artifacts
      if: always() # ë¹Œë“œê°€ ì‹¤íŒ¨í•´ë„ ë¡œê·¸ë¥¼ ë³´ê¸° ìœ„í•´ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          build/
          *.cpp
          *.py
          *.txt
        retention-days: 1
