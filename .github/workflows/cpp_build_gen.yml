name: Server Operation & Release System

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€

permissions:
  contents: write  # ë¦´ë¦¬ì¦ˆ ìƒì„±ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìˆ˜
  packages: write

jobs:
  # ìŠ¤í¬ë¦°ìƒ·ì˜ "ì„œë²„ ìš´ì˜" ì´ë¦„ ë°˜ì˜
  server-operation:
    name: ì„œë²„ ìš´ì˜ 
    runs-on: ubuntu-latest

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ë° í™˜ê²½ ì„¤ì •
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make g++ tree zip

    # 2. C++ ì†ŒìŠ¤ì½”ë“œ ìë™ ìƒì„± (í™ë³´ ë§í¬ ê¸°ëŠ¥ í¬í•¨)
    - name: Generate Source with Follow Link
      run: |
        echo "ğŸ“ Generating C++ Source..."
        
        cat <<EOF > server_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>

        namespace fs = std::filesystem;

        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        int main() {
            std::cout << "ğŸš€ [Server] Initializing operation..." << std::endl;
            
            // ë°ì´í„° ìƒì„±
            fs::create_directories("output/data");
            std::ofstream file("output/data/transaction_log.csv");
            file << "ID,Status,Time" << std::endl;
            for(int i=0; i<500; ++i) file << i << ",OK," << getCurrentTime() << std::endl;
            file.close();

            // ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ì‹œë®¬ë ˆì´ì…˜
            std::cout << "ğŸ”„ [System] Performing automated upgrade..." << std::endl;
            std::this_thread::sleep_for(std::chrono::milliseconds(200));
            std::cout << "âœ… [Success] Upgrade Complete." << std::endl;

            // [ìš”ì²­ ì‚¬í•­] ì™¸ë¶€ ë§í¬ íŒ”ë¡œìš° í™ë³´ ë©”ì‹œì§€ ì¶œë ¥
            std::cout << "\n=============================================" << std::endl;
            std::cout << "ğŸ“¢ [Notice] Official Repository & Community" << std::endl;
            std::cout << "ğŸ”— Follow us at: https://github.com/koreatest12/only-c" << std::endl;
            std::cout << "=============================================\n" << std::endl;

            return 0;
        }
        EOF

    # 3. Makefile ìƒì„± ë° ë¹Œë“œ
    - name: Generate Makefile & Build
      run: |
        echo "CC = g++" > Makefile
        echo "CFLAGS = -std=c++17 -Wall" >> Makefile
        echo "TARGET = server_app" >> Makefile
        echo -e "all: \$(TARGET)\n" >> Makefile
        echo -e "\$(TARGET): server_main.cpp\n\t\$(CC) \$(CFLAGS) server_main.cpp -o \$(TARGET)" >> Makefile
        
        make all
        chmod +x server_app

    # 4. ì„œë²„ ì‹¤í–‰ (ë¡œê·¸ì— ë§í¬ ì¶œë ¥ë¨)
    - name: Run Server
      run: ./server_app

    # 5. [ìŠ¤í¬ë¦°ìƒ· ìš”ì²­] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì´ë¦„: ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ê²°ê³¼)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ê²°ê³¼
        path: |
          output/
          server_app
          server_main.cpp

    # 6. [ì¶”ê°€ ìš”ì²­] ë¦´ë¦¬ì¦ˆ íŒ¨í‚¤ì§• (Zip ì••ì¶•)
    - name: Package Release
      run: |
        mkdir -p release_package
        cp server_app release_package/
        cp server_main.cpp release_package/
        zip -r server_package.zip release_package/

    # 7. [ì¶”ê°€ ìš”ì²­] GitHub Release ìë™ ì¶œì‹œ ë° ë§í¬ í™ë³´
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        tag_name: v1.0.${{ github.run_number }} # ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ë²„ì „ ë²ˆí˜¸ ì¦ê°€ (ì˜ˆ: v1.0.1, v1.0.2)
        name: ğŸš€ ì •ê¸° ì„œë²„ ì—…ë°ì´íŠ¸ v1.0.${{ github.run_number }}
        body: |
          ## ğŸ“¦ ì„œë²„ ì—…ê·¸ë ˆì´ë“œ íŒ¨í‚¤ì§€
          ìë™í™”ëœ ë¹Œë“œ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤.
          
          ### ğŸ“¢ ì»¤ë®¤ë‹ˆí‹° ë° íŒ”ë¡œìš°
          ìµœì‹  ì†Œì‹ì€ ì•„ë˜ ë§í¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”:
          ğŸ‘‰ **https://github.com/koreatest12/only-c**
          
          ### ğŸ“‹ í¬í•¨ëœ íŒŒì¼
          - Server Binary (server_app)
          - Source Code (server_main.cpp)
        files: server_package.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
