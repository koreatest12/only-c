name: Server Upgrade Simulation & Makefile Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  server-ops:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    # 1. ê¸°ë³¸ í™˜ê²½ ì„¤ì •
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make g++ tree

    # 2. [ê¸°ëŠ¥ 1] C++ ì†ŒìŠ¤ì½”ë“œ ìƒì„± (ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ê¸°ëŠ¥ ì¶”ê°€ë¨)
    - name: Generate C++ Source Code
      run: |
        echo "ğŸ“ Creating C++ Source with Server Upgrade Logic..."
        
        cat <<EOF > server_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>

        namespace fs = std::filesystem;

        // ìœ í‹¸ë¦¬í‹°: í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        // [ê¸°ëŠ¥ 1] ëŒ€ëŸ‰ ë¦¬ì†ŒìŠ¤ ìƒì„± í´ë˜ìŠ¤
        class ResourceManager {
        public:
            void generateData() {
                std::cout << "[Resource] Generating mass data files..." << std::endl;
                fs::create_directories("output/data");
                
                std::ofstream file("output/data/user_transactions.csv");
                file << "UserID,Action,Timestamp,Status" << std::endl;
                for(int i=0; i<2000; ++i) {
                    file << "User_" << i << ",Login," << getCurrentTime() << ",Success" << std::endl;
                }
                file.close();
            }
        };

        // [ê¸°ëŠ¥ 2] ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ì‹œë®¬ë ˆì´ì…˜ í´ë˜ìŠ¤
        class ServerManager {
        public:
            void performUpgrade(std::string version) {
                std::cout << "\nğŸš€ [System] Starting Server Upgrade to v" << version << "..." << std::endl;
                fs::create_directories("output/logs");
                fs::create_directories("output/backup");

                std::ofstream log("output/logs/upgrade_history.log", std::ios::app);
                log << "[" << getCurrentTime() << "] Upgrade process initiated (Target: " << version << ")" << std::endl;

                // 1ë‹¨ê³„: ë°±ì—…
                std::cout << "ğŸ“¦ [Step 1] Backing up current configuration..." << std::endl;
                std::this_thread::sleep_for(std::chrono::milliseconds(500)); // ì‘ì—… ì§€ì—° ì‹œë®¬ë ˆì´ì…˜
                std::ofstream backup("output/backup/config_backup.bak");
                backup << "Backup_Data_Hex_Stream_Example..." << std::endl;
                backup.close();
                log << "[" << getCurrentTime() << "] Backup completed successfully." << std::endl;

                // 2ë‹¨ê³„: íŒ¨ì¹˜ ì ìš©
                std::cout << "ğŸ› ï¸ [Step 2] Applying security patches..." << std::endl;
                std::this_thread::sleep_for(std::chrono::milliseconds(500));
                log << "[" << getCurrentTime() << "] Patch set KB-2024-X applied." << std::endl;

                // 3ë‹¨ê³„: ì‹œìŠ¤í…œ ì¬ì‹œì‘ ë° ì™„ë£Œ
                std::cout << "ğŸ”„ [Step 3] Restarting services..." << std::endl;
                std::cout << "âœ… [Success] Server upgraded to version " << version << "!" << std::endl;
                log << "[" << getCurrentTime() << "] Upgrade finished. System Stable." << std::endl;
                log.close();
            }
        };

        int main() {
            ResourceManager resources;
            resources.generateData();

            ServerManager server;
            server.performUpgrade("2.5.0_stable");

            return 0;
        }
        EOF

    # 3. [ê¸°ëŠ¥ 2] Makefile ìë™ ìƒì„±
    # make ëª…ë ¹ì–´ ì‚¬ìš©ì„ ìœ„í•´ íƒ­(Tab) ë¬¸ìê°€ ì¤‘ìš”í•˜ì§€ë§Œ, 
    # ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ ê³µë°±ìœ¼ë¡œ ì²˜ë¦¬ í›„ sedë¡œ íƒ­ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
    - name: Generate Makefile
      run: |
        echo "ğŸ› ï¸ Creating Makefile..."
        
        # Makefile ë‚´ìš© ì‘ì„± (íƒ­ ë¬¸ì ëŒ€ì‹  \t ì‚¬ìš© ë¶ˆê°€í•˜ë¯€ë¡œ ì„ì‹œ ë¬¸ì ì‚¬ìš© í›„ ì¹˜í™˜)
        cat <<EOF > Makefile
        CC = g++
        CFLAGS = -std=c++17 -Wall
        TARGET = server_app
        SRCS = server_main.cpp

        all: \$(TARGET)

        \$(TARGET): \$(SRCS)
        	\$(CC) \$(CFLAGS) \$(SRCS) -o \$(TARGET)

        clean:
        	rm -f \$(TARGET) output/
        EOF
        
        # ì¤‘ìš”: Makefileì˜ ë“¤ì—¬ì“°ê¸°ëŠ” ë°˜ë“œì‹œ Tabì´ì–´ì•¼ í•©ë‹ˆë‹¤. 
        # ìœ„ì—ì„œ ì‘ì„±ëœ ê³µë°±ì„ íƒ­ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.
        sed -i 's/^        /\t/' Makefile

    # 4. ë¹Œë“œ (Make ì‚¬ìš©)
    - name: Build with Make
      run: |
        echo "ğŸ”¨ Building project using Make..."
        make all

    # 5. ì‹¤í–‰
    - name: Run Server Application
      run: |
        echo "â–¶ï¸ Running Server Application..."
        ./server_app

    # 6. ê²°ê³¼ í™•ì¸ ë° ì—…ë¡œë“œ
    - name: Verify & Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: server-upgrade-results
        path: |
          output/
          server_main.cpp
          Makefile
        retention-days: 5
