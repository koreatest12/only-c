name: Auto Generate Resources (Guaranteed)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  force-generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    # 1. ê¸°ë³¸ í™˜ê²½ ì„¤ì •
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ tree

    # 2. [í•µì‹¬] C++ ì†ŒìŠ¤ì½”ë“œ ê°•ì œ ìƒì„± (íŒŒì¼ì´ ì—†ì–´ë„ ì—¬ê¸°ì„œ ë§Œë“¦)
    # ì´ ë‹¨ê³„ê°€ "No .cpp files found" ì—ëŸ¬ë¥¼ ì™„ë²½í•˜ê²Œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
    - name: Inject C++ Generator Code
      run: |
        echo "ğŸ“‚ Injecting C++ source code..."
        
        cat <<EOF > resource_generator.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <ctime>

        namespace fs = std::filesystem;

        // í˜„ì¬ ì‹œê°„ ë¬¸ìì—´ ë°˜í™˜ í•¨ìˆ˜
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        int main() {
            std::cout << "ğŸš€ Starting Resource Generation Process..." << std::endl;

            // 1. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
            std::vector<std::string> dirs = {"output_resources/data", "output_resources/logs", "output_resources/config"};
            for (const auto& dir : dirs) {
                if (fs::create_directories(dir)) {
                    std::cout << "âœ… Created directory: " << dir << std::endl;
                }
            }

            // 2. ëŒ€ëŸ‰ ë°ì´í„°(CSV) íŒŒì¼ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
            std::ofstream csvFile("output_resources/data/mass_data.csv");
            csvFile << "ID,Type,Value,Timestamp,Status" << std::endl;
            for (int i = 1; i <= 1000; ++i) {
                csvFile << i << ",Transaction," << (i * 100) << "," << getCurrentTime() << ",Confirmed" << std::endl;
            }
            csvFile.close();
            std::cout << "âœ… Generated CSV with 1000 records." << std::endl;

            // 3. ì„¤ì •(JSON) íŒŒì¼ ìƒì„±
            std::ofstream jsonFile("output_resources/config/settings.json");
            jsonFile << "{\n  \"system_status\": \"active\",\n  \"encryption\": true,\n  \"max_users\": 5000\n}" << std::endl;
            jsonFile.close();
            std::cout << "âœ… Generated JSON configuration." << std::endl;

            // 4. ë¡œê·¸ íŒŒì¼ ìƒì„±
            std::ofstream logFile("output_resources/logs/system.log");
            logFile << "[INFO] " << getCurrentTime() << " System initialized." << std::endl;
            logFile << "[INFO] " << getCurrentTime() << " Batch processing started." << std::endl;
            logFile << "[WARN] " << getCurrentTime() << " Storage check passed." << std::endl;
            logFile.close();
            std::cout << "âœ… Generated System Logs." << std::endl;

            std::cout << "ğŸ‰ All resources generated successfully!" << std::endl;
            return 0;
        }
        EOF

    # 3. ì»´íŒŒì¼ (C++17 í‘œì¤€ ì‚¬ìš©)
    - name: Compile Generator Program
      run: |
        echo "ğŸ”¨ Compiling C++ code..."
        g++ -std=c++17 resource_generator.cpp -o run_generator
        chmod +x run_generator

    # 4. í”„ë¡œê·¸ë¨ ì‹¤í–‰ (ì‹¤ì œë¡œ íŒŒì¼ë“¤ì´ ìƒì„±ë¨)
    - name: Execute Generator
      run: |
        echo "â–¶ï¸ Running Generator..."
        ./run_generator

    # 5. ìƒì„±ëœ íŒŒì¼ í™•ì¸ (ë””ë²„ê¹…)
    - name: Verify Output
      run: |
        echo "ğŸ” Checking generated structure:"
        tree output_resources

    # 6. ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ (Artifact)
    # ì›Œí¬í”Œë¡œìš°ê°€ ëë‚˜ë„ 'generated-files'ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ë©´ íŒŒì¼ë“¤ì´ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: generated-resources
        path: output_resources/
        retention-days: 5
