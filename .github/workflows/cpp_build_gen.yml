name: Enterprise CI/CD & Mass Gen System

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  # ----------------------------------------------------------------
  # JOB 1: ë©€í‹° í”Œë«í¼ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ì •ì  ë¶„ì„, ëŒ€ëŸ‰ ë¦¬ì†ŒìŠ¤ ìƒì„±
  # ----------------------------------------------------------------
  build-test-generate:
    name: Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest] # ìœˆë„ìš°ì™€ ë¦¬ëˆ…ìŠ¤ ë™ì‹œ ë¹Œë“œ

    defaults:
      run:
        shell: bash # ìœˆë„ìš°ì—ì„œë„ bash ì‰˜ì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ í†µì¼

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. í™˜ê²½ë³„ ì˜ì¡´ì„± ì„¤ì¹˜ (ì •ì  ë¶„ì„ ë„êµ¬ í¬í•¨)
    - name: Install Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake cppcheck tree

    # 2. í†µí•© ì†ŒìŠ¤ì½”ë“œ ìƒì„± (í…ŒìŠ¤íŠ¸ + ëŒ€ëŸ‰ ìƒì„± + DBíŒ¨ì¹˜ + í™ë³´)
    - name: Generate Enterprise Source Code
      run: |
        echo "ğŸ“ Generating Source Code with Mass Gen & Testing..."
        
        cat <<EOF > enterprise_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <cassert>
        #include <chrono>
        #include <thread>

        namespace fs = std::filesystem;

        // [ìœ í‹¸ë¦¬í‹°] í˜„ì¬ ì‹œê°„
        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 1] ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± ì„œë¹„ìŠ¤ (Massive Data Service)
        // ---------------------------------------------------------
        class BigDataManager {
        public:
            void generateMassiveTransactions() {
                std::cout << "ğŸ“Š [Data Service] Generating 50,000 transaction records..." << std::endl;
                fs::create_directories("output/data");
                std::ofstream file("output/data/mass_transactions.csv");
                file << "TxID,UserID,Amount,Type,Timestamp,Hash" << std::endl;
                
                // ëŒ€ëŸ‰ ìƒì„± ë£¨í”„ (5ë§Œ ê±´)
                for(int i=0; i<50000; ++i) {
                    file << "TX_" << i << ",User_" << (i%1000) << "," 
                         << (i*50) << ",DEPOSIT," << getCurrentTime() 
                         << ",hash_value_" << i << std::endl;
                }
                file.close();
                std::cout << "âœ… [Data Service] 50,000 Records Generated." << std::endl;
            }

            void generateMassiveLogs() {
                std::cout << "ğŸ“ [Log Service] Generating System Audit Logs..." << std::endl;
                fs::create_directories("output/logs");
                std::ofstream log("output/logs/audit_trace.log");
                
                // ëŒ€ëŸ‰ ë¡œê·¸ ìƒì„± (1ë§Œ ê±´)
                for(int i=0; i<10000; ++i) {
                    log << "[INFO] " << getCurrentTime() << " Process_ID:" << i 
                        << " Action:Validate Status:OK" << std::endl;
                }
                log.close();
            }
        };

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 2] DB íŒ¨ì¹˜ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ (DB Patch Service)
        // ---------------------------------------------------------
        class DBPatchManager {
        public:
            bool applyPatch(std::string version) {
                std::cout << "\nğŸ—„ï¸ [DB Service] Starting DB Patch to " << version << "..." << std::endl;
                fs::create_directories("output/db");
                
                // ëŒ€ëŸ‰ SQL ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
                std::ofstream sql("output/db/migration_script.sql");
                sql << "-- Automated Migration Script " << version << std::endl;
                for(int i=0; i<5000; ++i) {
                    sql << "ALTER TABLE users_" << i << " ADD COLUMN secure_flag BOOLEAN;" << std::endl;
                }
                sql.close();
                
                std::cout << "âœ… [DB Service] Schema migration scripts generated for 5,000 tables." << std::endl;
                return true; // ì„±ê³µ ë°˜í™˜ (í…ŒìŠ¤íŠ¸ìš©)
            }
        };

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 3] ìœ ë‹› í…ŒìŠ¤íŠ¸ (Unit Testing)
        // ---------------------------------------------------------
        void runUnitTests() {
            std::cout << "\nğŸ§ª [Testing] Running Internal Unit Tests..." << std::endl;
            
            // í…ŒìŠ¤íŠ¸ 1: ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„± í…ŒìŠ¤íŠ¸
            fs::create_directories("test_dir");
            if(fs::exists("test_dir")) std::cout << "   [PASS] Directory Creation" << std::endl;
            else { std::cerr << "   [FAIL] Directory Creation" << std::endl; exit(1); }
            
            // í…ŒìŠ¤íŠ¸ 2: ê°„ë‹¨í•œ ì—°ì‚° í…ŒìŠ¤íŠ¸
            int a = 10, b = 20;
            if((a + b) == 30) std::cout << "   [PASS] Math Calculation" << std::endl;
            else { std::cerr << "   [FAIL] Math Logic" << std::endl; exit(1); }
            
            std::cout << "âœ… [Testing] All Unit Tests Passed." << std::endl;
        }

        // ---------------------------------------------------------
        // MAIN FUNCTION
        // ---------------------------------------------------------
        int main(int argc, char* argv[]) {
            // 1. ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ í”„ë¡œê·¸ë¨ ì¢…ë£Œ)
            if (argc > 1 && std::string(argv[1]) == "--test") {
                runUnitTests();
                return 0;
            }

            std::cout << "ğŸš€ [Enterprise System] Starting Production Workflow..." << std::endl;

            // 2. ì„œë¹„ìŠ¤ë³„ ëŒ€ëŸ‰ ìƒì„± ì‹¤í–‰
            BigDataManager dataMgr;
            dataMgr.generateMassiveTransactions();
            dataMgr.generateMassiveLogs();

            DBPatchManager dbMgr;
            dbMgr.applyPatch("v3.0.0_Enterprise");

            // 3. ì™¸ë¶€ íŒ”ë¡œìš° í™ë³´
            std::cout << "\n=============================================" << std::endl;
            std::cout << "ğŸ“¢ [Notice] Official Repository" << std::endl;
            std::cout << "ğŸ”— Follow us at: https://github.com/koreatest12/only-c" << std::endl;
            std::cout << "=============================================\n" << std::endl;

            return 0;
        }
        EOF

    # 3. ì •ì  ì½”ë“œ ë¶„ì„ (Static Analysis) - ë¦¬ëˆ…ìŠ¤ ì „ìš©
    - name: Run Static Analysis (Cppcheck)
      if: runner.os == 'Linux'
      run: |
        echo "ğŸ” Running Static Code Analysis..."
        cppcheck --enable=all --inconclusive --error-exitcode=1 enterprise_main.cpp
        echo "âœ… Code Quality Check Passed."

    # 4. ë¹Œë“œ (CMake Cross-Platform)
    - name: Build Application
      run: |
        echo "ğŸ”¨ Building Application..."
        mkdir build
        cd build
        cmake ..
        cmake --build . --config Release

    # 5. ìë™í™” í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ (Unit Test)
    - name: Run Automated Tests
      run: |
        echo "ğŸ§ª Executing Unit Tests..."
        cd build
        # ìœˆë„ìš°/ë¦¬ëˆ…ìŠ¤ ì‹¤í–‰ íŒŒì¼ëª… ì°¨ì´ ì²˜ë¦¬
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          ./Release/enterprise_main.exe --test
        else
          ./enterprise_main --test
        fi

    # 6. ì‹¤ì œ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ë° ëŒ€ëŸ‰ ë¦¬ì†ŒìŠ¤ ìƒì„±
    - name: Run & Generate Resources
      run: |
        echo "â–¶ï¸ Running Main Application (Mass Generation)..."
        cd build
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          ./Release/enterprise_main.exe
          cp ./Release/enterprise_main.exe ../server_app.exe
        else
          ./enterprise_main
          cp ./enterprise_main ../server_app_linux
        fi
        
        # ìƒì„±ëœ ë°ì´í„° ìƒìœ„ í´ë”ë¡œ ì´ë™ (ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œìš©)
        cp -r output ../output_data

    # 7. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (OSë³„ ë¶„ë¦¬ ì €ì¥)
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifact-${{ matrix.os }}
        path: |
          server_app*
          output_data/
          enterprise_main.cpp

  # ----------------------------------------------------------------
  # JOB 2: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ (Docker Build) - ë¦¬ëˆ…ìŠ¤ ê²°ê³¼ ê¸°ë°˜
  # ----------------------------------------------------------------
  docker-build:
    name: Dockerize Application
    needs: build-test-generate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ì´ì „ ë¹Œë“œ ì‘ì—…ì—ì„œ ìƒì„±ëœ ë¦¬ëˆ…ìŠ¤ ì‹¤í–‰ íŒŒì¼ê³¼ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-ubuntu-latest

      - name: Create Dockerfile
        run: |
          echo "ğŸ³ Generating Dockerfile..."
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          WORKDIR /app
          COPY server_app_linux /app/server_app
          RUN chmod +x /app/server_app
          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ ì„œë²„ í”„ë¡œê·¸ë¨ ìë™ ì‹œì‘
          CMD ["./server_app"]
          EOF

      - name: Build Docker Image
        run: |
          echo "ğŸ—ï¸ Building Docker Image..."
          docker build -t enterprise-server:v${{ github.run_number }} .
          echo "âœ… Docker Image Built Successfully."
          # ì‹¤ì œ ë°°í¬ ì‹œ: docker push enterprise-server:v...

  # ----------------------------------------------------------------
  # JOB 3: í†µí•© ë¦´ë¦¬ì¦ˆ ë° íŒ¨í‚¤ì§€ ë°°í¬
  # ----------------------------------------------------------------
  release-package:
    name: Publish Release
    needs: [build-test-generate, docker-build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4

      - name: Prepare Release Package
        run: |
          mkdir release_pkg
          # ìœˆë„ìš°, ë¦¬ëˆ…ìŠ¤ ì‹¤í–‰ íŒŒì¼ ë° ë°ì´í„° í†µí•©
          cp build-artifact-windows-latest/server_app.exe release_pkg/
          cp build-artifact-ubuntu-latest/server_app_linux release_pkg/
          cp -r build-artifact-ubuntu-latest/output_data release_pkg/data_samples
          
          # ì••ì¶•
          cd release_pkg
          zip -r ../enterprise_release_v${{ github.run_number }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v3.0.${{ github.run_number }}
          name: ğŸš€ Enterprise Server v3.0.${{ github.run_number }} (Win/Linux/Docker)
          body: |
            ## ğŸ“¦ Enterprise Release
            
            ì´ ë¦´ë¦¬ì¦ˆëŠ” **Windows, Linux, Docker** í™˜ê²½ì„ ëª¨ë‘ ì§€ì›í•˜ë©°, 
            ìë™í™”ëœ **Unit Test**ì™€ **Static Analysis**ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤.
            
            ### âœ… ì£¼ìš” ê¸°ëŠ¥ (ëŒ€ëŸ‰ ìƒì„± ë°˜ì˜)
            - **Massive Data:** 50,000ê±´ì˜ íŠ¸ëœì­ì…˜ ë°ì´í„° ìë™ ìƒì„±
            - **DB Patch:** 5,000ê°œ í…Œì´ë¸”ì— ëŒ€í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
            - **Audit Logs:** 10,000ë¼ì¸ì˜ ì‹œìŠ¤í…œ ê°ì‚¬ ë¡œê·¸ ìƒì„±
            
            ### ğŸ–¥ï¸ ì§€ì› í”Œë«í¼
            - ğŸ§ **Linux:** `server_app_linux`
            - ğŸªŸ **Windows:** `server_app.exe`
            - ğŸ³ **Docker:** Image build complete
            
            ### ğŸ“¢ ì»¤ë®¤ë‹ˆí‹°
            ğŸ‘‰ **https://github.com/koreatest12/only-c**
          files: enterprise_release_v${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
