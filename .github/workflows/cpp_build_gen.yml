name: C++ Build & Generate Files

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-run-generate:
    runs-on: ubuntu-latest
    
    # ê¶Œí•œ ì„¤ì •: ì›Œí¬í”Œë¡œìš°ê°€ ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ ì„¤ì •
    permissions:
      contents: read
      actions: write

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout Source Code
      uses: actions/checkout@v4

    # 2. ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜ (g++, cmake, make)
    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake g++ tree

    # 3. ì‘ì—… ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ë³´ (íŒŒì¼ ìƒì„± ì˜¤ë¥˜ ë°©ì§€)
    - name: Ensure Write Permissions
      run: chmod -R 777 .

    # 4. í†µí•© ë¹Œë“œ ë° ì‹¤í–‰ ë¡œì§ (íŒŒì¼ ìƒì„± ì‹œë‚˜ë¦¬ì˜¤ í¬í•¨)
    - name: Build and Run Program
      run: |
        echo "ğŸ“‚ Starting Build Process..."
        
        # ì‹¤í–‰ íŒŒì¼ì´ ìƒì„±ë  ë””ë ‰í† ë¦¬ ì¤€ë¹„
        mkdir -p output_data 

        if [ -f "CMakeLists.txt" ]; then
          echo "âœ… [Mode] CMake Build Detected"
          mkdir -p build
          cd build
          cmake ..
          cmake --build .
          
          # ë¹Œë“œëœ ì‹¤í–‰ íŒŒì¼ ì°¾ê¸° ë° ì‹¤í–‰ (ê°€ì¥ ìµœê·¼ ìƒì„±ëœ ì‹¤í–‰ íŒŒì¼)
          EXECUTABLE=$(find . -maxdepth 1 -type f -executable | head -n 1)
          
          if [ -n "$EXECUTABLE" ]; then
            echo "ğŸš€ Executing: $EXECUTABLE"
            # ì‹¤í–‰ ì‹œ output_data í´ë”ê°€ ìˆë‹¤ë©´ ê·¸ìª½ì„ í™œìš©í•˜ë„ë¡ ìœ ë„í•˜ê±°ë‚˜, 
            # í”„ë¡œê·¸ë¨ì´ í˜„ì¬ ìœ„ì¹˜ì— íŒŒì¼ì„ ìƒì„±í•˜ë„ë¡ ì‹¤í–‰
            $EXECUTABLE
          else
            echo "âŒ Build success but no executable found."
            exit 1
          fi
          
          # ë¹Œë“œ í´ë”ì—ì„œ ìƒìœ„ë¡œ ì´ë™ (Artifact ì—…ë¡œë“œë¥¼ ìœ„í•´)
          cd ..
          
        else
          echo "âœ… [Mode] Direct g++ Build Detected"
          SRC_FILES=$(find . -maxdepth 1 -name "*.cpp")
          
          if [ -z "$SRC_FILES" ]; then
            echo "âŒ No .cpp files found."
            exit 1
          fi
          
          g++ $SRC_FILES -o generator_program
          
          echo "ğŸš€ Executing generator_program..."
          chmod +x generator_program
          ./generator_program
        fi

    # 5. ìƒì„±ëœ íŒŒì¼ ë° êµ¬ì¡° í™•ì¸ (ë””ë²„ê¹…ìš©)
    - name: Verify Generated Files
      run: |
        echo "ğŸ” Checking generated file structure:"
        # tree ëª…ë ¹ì–´ë¡œ í˜„ì¬ í´ë” êµ¬ì¡°ë¥¼ íŠ¸ë¦¬ í˜•íƒœë¡œ ì¶œë ¥í•˜ì—¬ ìƒì„± ì—¬ë¶€ í™•ì¸
        tree -L 3

    # 6. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (Artifact)
    # í”„ë¡œê·¸ë¨ì´ ìƒì„±í•œ íŒŒì¼ì´ ì†ì‹¤ë˜ì§€ ì•Šë„ë¡ GitHubì— ì €ì¥í•©ë‹ˆë‹¤.
    - name: Upload Generated Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-results
        path: |
          ./**/*.txt
          ./**/*.json
          ./**/*.csv
          ./**/*.cpp
          ./**/*.h
          ./output_data/
          !./build/** # ë¹Œë“œ ì¤‘ê°„ íŒŒì¼ì€ ì œì™¸ (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
          !.git/** # git íŒŒì¼ ì œì™¸
        retention-days: 5 # 5ì¼ê°„ ë³´ê´€
