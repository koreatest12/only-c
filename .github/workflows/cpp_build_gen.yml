name: C++ Build & Generate Files (Fixed)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-run-generate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4

    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake g++ tree

    # [ë””ë²„ê¹…] í˜„ì¬ íŒŒì¼ êµ¬ì¡°ë¥¼ ì¶œë ¥í•˜ì—¬ ì†ŒìŠ¤ì½”ë“œê°€ ì–´ë”” ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    - name: Check File Structure (Debug)
      run: |
        echo "ğŸ“‚ Current Directory Structure:"
        tree -L 3

    - name: Ensure Write Permissions
      run: chmod -R 777 .

    - name: Build and Run Program
      run: |
        echo "ğŸ“‚ Starting Build Process..."
        mkdir -p output_data

        if [ -f "CMakeLists.txt" ]; then
          echo "âœ… [Mode] CMake Build Detected"
          mkdir -p build
          cd build
          cmake ..
          cmake --build .
          
          # í•˜ìœ„ í´ë” í¬í•¨í•˜ì—¬ ì‹¤í–‰ íŒŒì¼ ì°¾ê¸°
          EXECUTABLE=$(find . -type f -executable ! -path "*/.*" | head -n 1)
          
          if [ -n "$EXECUTABLE" ]; then
            echo "ğŸš€ Executing: $EXECUTABLE"
            $EXECUTABLE
          else
            echo "âŒ Build success but no executable found."
            exit 1
          fi
          cd ..
          
        else
          echo "âœ… [Mode] Direct g++ Build Detected (Recursive Search)"
          
          # [ìˆ˜ì •ë¨] í•˜ìœ„ í´ë”ê¹Œì§€ í¬í•¨í•˜ì—¬ ëª¨ë“  .cpp íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
          SRC_FILES=$(find . -type f -name "*.cpp")
          
          if [ -z "$SRC_FILES" ]; then
            echo "âŒ Critical Error: No .cpp files found anywhere in the repository."
            echo "Please check if you pushed the files correctly."
            exit 1
          fi
          
          echo "ğŸ“‚ Found source files: $SRC_FILES"
          
          # ì°¾ì€ ëª¨ë“  íŒŒì¼ì„ ì»´íŒŒì¼í•©ë‹ˆë‹¤.
          g++ $SRC_FILES -o generator_program
          
          echo "ğŸš€ Executing generator_program..."
          chmod +x generator_program
          ./generator_program
        fi

    - name: Verify Generated Files
      run: |
        echo "ğŸ” Checking generated file structure:"
        tree -L 3

    - name: Upload Generated Artifacts
      if: always() # ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë¡œê·¸ë‚˜ ë¶€ë¶„ ê²°ê³¼ë¬¼ì„ ì˜¬ë¦¼
      uses: actions/upload-artifact@v4
      with:
        name: generated-results
        path: |
          ./**/*.txt
          ./**/*.json
          ./**/*.csv
          ./**/*.cpp
          ./**/*.h
          ./output_data/
          !./build/**
          !.git/**
        retention-days: 5
