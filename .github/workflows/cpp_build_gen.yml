name: Server Operation & Release System

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write  # ë¦´ë¦¬ì¦ˆ ë° íƒœê·¸ ìƒì„±ì„ ìœ„í•œ ê¶Œí•œ
  packages: write  # íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ê¶Œí•œ

jobs:
  server-operation-db-patch:
    name: ì„œë²„ ìš´ì˜ ë° DB íŒ¨ì¹˜
    runs-on: ubuntu-latest

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ë° í™˜ê²½ ì„¤ì •
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make g++ tree zip

    # 2. C++ ì†ŒìŠ¤ì½”ë“œ ìƒì„± (DB íŒ¨ì¹˜ ëª¨ë“ˆ ì¶”ê°€ë¨)
    - name: Generate Source with DB Patch
      run: |
        echo "ğŸ“ Generating C++ Source with DB Patch Logic..."
        
        cat <<EOF > server_main.cpp
        #include <iostream>
        #include <fstream>
        #include <filesystem>
        #include <vector>
        #include <string>
        #include <thread>
        #include <chrono>

        namespace fs = std::filesystem;

        std::string getCurrentTime() {
            time_t now = time(0);
            char buf[80];
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);
        }

        // [ì‹ ê·œ ê¸°ëŠ¥] DB íŒ¨ì¹˜ ë§¤ë‹ˆì €
        class DBPatchManager {
        public:
            void runPatch(std::string version) {
                std::cout << "\nğŸ—„ï¸ [Database] Starting Database Patch (Target: " << version << ")..." << std::endl;
                
                fs::create_directories("output/db_backup");
                fs::create_directories("output/db_logs");

                // 1. DB ë°±ì—… ì‹œë®¬ë ˆì´ì…˜
                std::cout << "ğŸ’¾ [DB-Step 1] Creating snapshot backup..." << std::endl;
                std::ofstream backup("output/db_backup/full_backup.sql");
                backup << "-- Full Database Backup Timestamp: " << getCurrentTime() << std::endl;
                backup << "INSERT INTO users VALUES (1, 'admin');" << std::endl;
                backup.close();
                std::this_thread::sleep_for(std::chrono::milliseconds(300));

                // 2. ìŠ¤í‚¤ë§ˆ ë³€ê²½(íŒ¨ì¹˜) ì‹œë®¬ë ˆì´ì…˜
                std::cout << "âš¡ [DB-Step 2] Applying Schema Migrations..." << std::endl;
                std::ofstream migration("output/db_logs/migration_v2.log");
                migration << "[INFO] " << getCurrentTime() << " ALTER TABLE transactions ADD COLUMN status VARCHAR(20);" << std::endl;
                migration << "[INFO] " << getCurrentTime() << " CREATE INDEX idx_user_id ON users(id);" << std::endl;
                migration.close();

                std::cout << "âœ… [DB-Success] Database patched successfully to " << version << "!" << std::endl;
            }
        };

        int main() {
            std::cout << "ğŸš€ [Server] Initializing System..." << std::endl;
            
            // 1. ì¼ë°˜ ë°ì´í„° ìƒì„±
            fs::create_directories("output/data");
            std::ofstream file("output/data/transaction_log.csv");
            file << "ID,Status,Time" << std::endl;
            for(int i=0; i<100; ++i) file << i << ",Confirmed," << getCurrentTime() << std::endl;
            file.close();

            // 2. DB íŒ¨ì¹˜ ìˆ˜í–‰ (ì‹ ê·œ ê¸°ëŠ¥)
            DBPatchManager db;
            db.runPatch("v2.5.0_Hotfix");

            // 3. ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ ë©”ì‹œì§€
            std::cout << "\nğŸ”„ [System] Server logic execution completed." << std::endl;

            // 4. í™ë³´ ë§í¬ ì¶œë ¥
            std::cout << "\n=============================================" << std::endl;
            std::cout << "ğŸ“¢ [Notice] Official Repository & Community" << std::endl;
            std::cout << "ğŸ”— Follow us at: https://github.com/koreatest12/only-c" << std::endl;
            std::cout << "=============================================\n" << std::endl;

            return 0;
        }
        EOF

    # 3. Makefile ìƒì„± ë° ë¹Œë“œ
    - name: Generate Makefile & Build
      run: |
        echo "CC = g++" > Makefile
        echo "CFLAGS = -std=c++17 -Wall" >> Makefile
        echo "TARGET = server_app" >> Makefile
        echo -e "all: \$(TARGET)\n" >> Makefile
        echo -e "\$(TARGET): server_main.cpp\n\t\$(CC) \$(CFLAGS) server_main.cpp -o \$(TARGET)" >> Makefile
        
        make all
        chmod +x server_app

    # 4. ì„œë²„ ì‹¤í–‰ (DB íŒ¨ì¹˜ ë¡œê·¸ ì¶œë ¥)
    - name: Run Server & DB Patch
      run: ./server_app

    # 5. [ê²°ê³¼ë¬¼] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (DB ë¡œê·¸ í¬í•¨)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ì„œë²„_ë°_DBíŒ¨ì¹˜_ê²°ê³¼
        path: |
          output/
          server_app
          server_main.cpp

    # 6. [íŒ¨í‚¤ì§€] ë°°í¬ìš© íŒ¨í‚¤ì§€(Zip) ìƒì„±
    - name: Create Deploy Package
      run: |
        echo "ğŸ“¦ Packaging binaries and database scripts..."
        mkdir -p deploy_package
        cp server_app deploy_package/
        cp server_main.cpp deploy_package/
        cp -r output/db_logs deploy_package/
        
        # ë‚ ì§œ ê¸°ë°˜ì˜ ìœ ë‹ˆí¬í•œ íŒ¨í‚¤ì§€ëª… ìƒì„±
        zip -r release_package.zip deploy_package/

    # 7. [ê²Œì‹œ] GitHub Release ë° íŒ¨í‚¤ì§€ ì¶œì‹œ
    - name: Publish Release & Package
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        tag_name: v2.5.${{ github.run_number }}
        name: ğŸš€ ì„œë²„ íŒ¨í‚¤ì§€ ë° DB íŒ¨ì¹˜ v2.5.${{ github.run_number }}
        body: |
          ## ğŸ“¦ ì •ê¸° ë°°í¬ (Server & Database Patch)
          
          ì´ ë¦´ë¦¬ì¦ˆëŠ” ìë™í™” ì‹œìŠ¤í…œì— ì˜í•´ **íŒ¨í‚¤ì§• ë° ê²Œì‹œ(Publish)** ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### ğŸ› ï¸ ë³€ê²½ ì‚¬í•­ (Changelog)
          - **DB Patch Applied:** `v2.5.0_Hotfix` (Schema Migration included)
          - **Server Binary Updated**
          
          ### ğŸ“¢ ì»¤ë®¤ë‹ˆí‹°
          ê°œë°œ ê´€ë ¨ ì†Œì‹ì€ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”:
          ğŸ‘‰ **https://github.com/koreatest12/only-c**
          
          ---
          *Generated by GitHub Actions Workflow*
        files: release_package.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
